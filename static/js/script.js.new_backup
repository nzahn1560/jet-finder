// Jet Finder JavaScript

// Global variables
let map;
let circle;
let marker;
let geocoder;
let aircraftData = [];
let selectedAircraft = new Set();
let activePriorityColumn = 'as';
let activeFilters = {};
let routeMarkers = [];
let routeLegs = [];
let totalDistance = 0;
let selectedAirport = null;
let rangeMode = 'average'; // 'average' or 'full'
let financialInputs = {
    depreciationRate: 5,
    yearsOwnership: 10,
    jetAPrice: 5.50,
    avgasPrice: 6.50,
    avgTripLength: 500,
    numTrips: 50,
    plannedPassengers: 4,
    passengerPay: 0,
    charterRate: 50,
    charterTripLength: 600,
    charterTrips: 0,
    charterProfit: 50000
};
let visibleColumns = new Set([
    'model', 'manufacturer', 'type', 'multiEngine', 'dateRange',
    'range', 'cruiseSpeed', 'passengers', 'price', 'totalHourlyCost'
]);
let multiSelectValues = {
    'aircraft-type': ['All'],
    'multi-engine': ['All'],
    'min-crew': ['All']
};
// Store unique values from the data for autocomplete and dropdowns
let uniqueManufacturers = new Set();
let uniqueTypes = new Set();
let uniqueMultiEngineValues = new Set();
let uniqueMinCrewValues = new Set();

// Add new global variables
let aircraftRangeCircles = new Map(); // Map to store range circles for each aircraft
let routePairs = []; // Array to store all route pairs
let allRouteLines = new Map(); // Map to store route lines for each pair

// Add to global variables at the top
// rangeMode is already declared globally

// Initialize the application when the DOM is loaded
document.addEventListener('DOMContentLoaded', function () {
    console.log('DOM fully loaded');

    // Set current year in footer
    document.getElementById('current-year').textContent = new Date().getFullYear();

    // Initialize the map
    initMap();
    console.log('Map initialized');

    // Load aircraft data
    loadAircraftData();
    console.log('Aircraft data loading started');

    // Set up event listeners
    console.log('Setting up event listeners from DOMContentLoaded');
    setupEventListeners();
    console.log('Event listeners setup completed');

    // Initialize GSAP animations
    initAnimations();

    // Add flying aircraft animations
    addFlyingAircraft();

    // Load ranking columns
    loadRankingColumns();

    // Load saved financial inputs if available
    loadSavedFinancialInputs();

    // Ensure all financial inputs are displayed with default values
    updateFinancialInputsDisplay();

    // Initialize custom multi-select inputs
    initCustomMultiSelect();

    // Initialize custom dropdowns
    initCustomDropdowns();

    // Initialize column selector
    initColumnSelector();

    // Initialize range slider
    initRangeSlider();

    console.log('Initialization complete');

    let selectedFromAirport = null;
    let selectedToAirport = null;
    let homeAirport = null;
    let rangeCircle = null;
});

// Add flying aircraft animations
function addFlyingAircraft() {
    const main = document.querySelector('main');

    // Create 3 flying aircraft
    for (let i = 0; i < 3; i++) {
        const aircraft = document.createElement('div');
        aircraft.className = 'aircraft-fly';
        main.appendChild(aircraft);
    }
}

// Initialize the map with airport search and range circles
function initMap() {
    console.log('Initializing map...');

    // Create map centered on San Francisco
    map = L.map('map', {
        center: [37.7749, -122.4194],
        zoom: 3,
        worldCopyJump: true,
        minZoom: 2
    });

    // Add custom grayscale tile layer
    L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
        subdomains: 'abcd',
        maxZoom: 19,
        className: 'grayscale-tiles'
    }).addTo(map);

    // Add CSS filter for grayscale effect
    const style = document.createElement('style');
    style.textContent = `
        .grayscale-tiles {
            filter: grayscale(100%) brightness(90%) contrast(90%);
        }
        .leaflet-container {
            background: #1a1a1a;
        }
    `;
    document.head.appendChild(style);

    // Initialize range slider
    const rangeSlider = document.getElementById('range-slider');
    if (rangeSlider) {
        rangeSlider.addEventListener('input', function () {
            const range = parseInt(this.value);
            document.getElementById('range-value').textContent = range;

            // Update range circle if home airport is set
            if (homeAirport && rangeCircle) {
                rangeCircle.setRadius(range * 1852); // Convert nm to meters
            }

            // Update range-min input and trigger aircraft data reload
            const rangeMinInput = document.getElementById('range-min');
            if (rangeMinInput) {
                rangeMinInput.value = range;
                loadAircraftData();
            }
        });
    }

    // Add home airport search functionality
    const homeAirportSearch = document.getElementById('home-airport-search');
    const searchHomeBtn = document.getElementById('search-home-btn');
    const homeAirportResults = document.getElementById('home-airport-results');
    const homeAirportList = document.getElementById('home-airport-list');

    if (homeAirportSearch) {
        homeAirportSearch.addEventListener('input', function () {
            const query = this.value.trim();
            if (query.length >= 2) {
                searchHomeAirport(query, homeAirportList, homeAirportResults);
            } else {
                homeAirportResults.classList.add('d-none');
            }
        });
    }

    if (searchHomeBtn) {
        searchHomeBtn.addEventListener('click', function () {
            const query = homeAirportSearch.value.trim();
            if (query.length >= 2) {
                searchHomeAirport(query, homeAirportList, homeAirportResults);
            }
        });
    }

    // Load aircraft ranges
    loadAircraftRanges();

    // Add geocoder for airport search
    geocoder = L.Control.geocoder({
        defaultMarkGeocode: false,
        placeholder: 'Search for airports or locations...',
        errorMessage: 'Nothing found.',
        suggestMinLength: 3,
        suggestTimeout: 250,
        queryMinLength: 1
    }).on('markgeocode', function (e) {
        const latlng = e.geocode.center;
        map.setView(latlng, 10);
    }).addTo(map);
}

function searchHomeAirport(query, resultsList, resultsContainer) {
    if (!query.trim()) {
        resultsContainer.classList.add('d-none');
        return;
    }

    resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Searching...</div>';
    resultsContainer.classList.remove('d-none');

    fetch(`/api/airports?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(airports => {
            resultsList.innerHTML = '';

            if (airports.length === 0) {
                resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">No airports found</div>';
                return;
            }

            airports.forEach(airport => {
                const item = document.createElement('button');
                item.type = 'button';
                item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary';
                item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${airport.iata ? `<strong class="me-2">${airport.iata}</strong>` : ''}
                            ${airport.icao ? `<span class="text-info">${airport.icao}</span>` : ''}
                        </div>
                        ${airport.size ? `<span class="badge bg-danger">${airport.size}</span>` : ''}
                    </div>
                    <div class="text-truncate">${airport.name}</div>
                    <small class="text-secondary text-truncate d-block">${airport.city}, ${airport.country}</small>
                `;

                item.addEventListener('click', function () {
                    setHomeAirport(airport);
                    resultsContainer.classList.add('d-none');
                    document.getElementById('home-airport-search').value = `${airport.iata} - ${airport.city}`;
                });

                resultsList.appendChild(item);
            });
        })
        .catch(error => {
            console.error('Error searching airports:', error);
            resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Error searching airports</div>';
        });
}

function setHomeAirport(airport) {
    homeAirport = airport;

    // Remove existing range circle if any
    if (rangeCircle) {
        map.removeLayer(rangeCircle);
    }

    // Create new range circle
    const range = parseInt(document.getElementById('range-slider').value);
    rangeCircle = L.circle([airport.lat, airport.lon], {
        color: '#FF0000',
        fillColor: 'transparent',
        fillOpacity: 0,
        weight: 2,
        radius: range * 1852 // Convert nm to meters
    }).addTo(map);

    // Center map on airport
    map.setView([airport.lat, airport.lon], 6);

    // Update all aircraft range circles to new center
    aircraftRangeCircles.forEach(circle => {
        circle.setLatLng([airport.lat, airport.lon]);
    });

    // Show success message
    showToast(`Home airport set to ${airport.iata} - ${airport.city}`, 'success');

    // Update home airport display
    document.getElementById('home-airport-search').value = `${airport.iata} - ${airport.city}`;
    document.getElementById('home-airport-results').classList.add('d-none');
}

// Load aircraft ranges and create circles
function loadAircraftRanges() {
    fetch('/api/aircraft-ranges')
        .then(response => response.json())
        .then(data => {
            // Clear existing circles
            aircraftRangeCircles.forEach(circle => {
                if (circle) {
                    map.removeLayer(circle);
                }
            });
            aircraftRangeCircles.clear();

            // Get current range requirement from slider
            const requiredRange = parseInt(document.getElementById('range-slider').value);

            // Create circles for all aircraft
            data.forEach(aircraft => {
                const aircraftKey = `${aircraft.manufacturer} ${aircraft.model}`;
                const circle = L.circle(homeAirport ? [homeAirport.lat, homeAirport.lon] : [37.7749, -122.4194], {
                    color: getColorForRange(aircraft.range),
                    fillColor: 'transparent',
                    fillOpacity: 0,
                    weight: 2,
                    radius: aircraft.range * 1852 // Convert nautical miles to meters
                });

                // Add popup with aircraft info
                circle.bindPopup(`
                    <strong>${aircraft.manufacturer} ${aircraft.model}</strong><br>
                    Range: ${aircraft.range} nm
                `);

                // Store circle in map
                aircraftRangeCircles.set(aircraftKey, circle);

                // Only show circle if aircraft meets range requirement
                if (aircraft.range >= requiredRange) {
                    circle.addTo(map);
                }
            });
        })
        .catch(error => console.error('Error loading aircraft ranges:', error));
}

// Function to update range circles visibility based on range requirement
function updateRangeCircles(requiredRange) {
    aircraftRangeCircles.forEach((circle, aircraftKey) => {
        const aircraft = aircraftData.find(a => `${a.manufacturer} ${a.model}` === aircraftKey);
        if (aircraft) {
            let effectiveRange = aircraft.range;
            // In full range mode, we want to show the actual maximum range
            // to visualize which aircraft can reach the destination in one leg
            if (rangeMode === 'full') {
                effectiveRange = aircraft.range;
            }

            if (effectiveRange >= requiredRange) {
                // For full range mode, make the circles more prominent
                if (rangeMode === 'full') {
                    circle.setStyle({
                        weight: 3,
                        opacity: 0.9
                    });
                } else {
                    circle.setStyle({
                        weight: 2,
                        opacity: 0.8
                    });
                }
                circle.addTo(map);
            } else {
                map.removeLayer(circle);
            }
        }
    });
}

// Function to calculate average route distance
function calculateAverageRouteDistance() {
    if (routePairs.length === 0) return 0;

    const totalDistance = routePairs.reduce((sum, route) => sum + route.distance, 0);
    return Math.round(totalDistance / routePairs.length);
}

// Function to calculate longest route distance
function calculateLongestRouteDistance() {
    if (routePairs.length === 0) return 0;
    return Math.max(...routePairs.map(route => route.distance));
}

// Modify the updateRangeSlider function
function updateRangeSlider(newRange, source = 'auto') {
    const rangeSlider = document.getElementById('range-slider');
    const rangeValue = document.getElementById('range-value');
    const rangeValue2 = document.getElementById('range-value-2');
    const rangeMinInput = document.getElementById('range-min');

    // Calculate range based on mode if auto source
    if (source === 'auto') {
        if (rangeMode === 'average' && routePairs.length > 0) {
            newRange = calculateAverageRouteDistance();
        } else if (rangeMode === 'full' && routePairs.length > 0) {
            newRange = calculateLongestRouteDistance();
        }
    }

    // Only update if the value has changed significantly (more than 10%) or is 0
    const currentValue = parseInt(rangeSlider.value);
    if (source === 'manual' || Math.abs(currentValue - newRange) / Math.max(currentValue, 1) > 0.1 || currentValue === 0) {
        rangeSlider.value = newRange;
        rangeValue.textContent = newRange;
        if (rangeValue2) rangeValue2.textContent = newRange;

        // Update range circle visibility
        updateRangeCircles(newRange);

        // Update range-min input and trigger aircraft data reload
        if (rangeMinInput) {
            rangeMinInput.value = newRange;
            loadAircraftData();
        }
    }
}

// Modify the initRangeSlider function
function initRangeSlider() {
    const rangeSlider = document.getElementById('range-slider');
    const resetRangeBtn = document.getElementById('reset-range-btn');
    const avgTripBtn = document.getElementById('avg-trip-btn');
    const fullRangeBtn = document.getElementById('full-range-btn');
    const rangeModeText = document.getElementById('range-mode');

    // Set initial active button and text based on global rangeMode
    if (rangeModeText) {
        rangeModeText.textContent = rangeMode === 'average' ? 'Average Trip Length' : 'Seats Full Range';
        if (avgTripBtn && fullRangeBtn) {
            if (rangeMode === 'average') {
                avgTripBtn.classList.add('active');
                fullRangeBtn.classList.remove('active');
            } else {
                fullRangeBtn.classList.add('active');
                avgTripBtn.classList.remove('active');
            }
        }
    }

    if (rangeSlider) {
        rangeSlider.addEventListener('input', function () {
            const range = parseInt(this.value);
            document.getElementById('range-value').textContent = range;

            // Update range circle if home airport is set
            if (homeAirport && rangeCircle) {
                rangeCircle.setRadius(range * 1852); // Convert nm to meters
            }

            // Update range-min input and trigger aircraft data reload
            const rangeMinInput = document.getElementById('range-min');
            if (rangeMinInput) {
                rangeMinInput.value = range;
                loadAircraftData();
            }
        });
    }

    if (resetRangeBtn) {
        resetRangeBtn.addEventListener('click', function () {
            updateRangeSlider(0, 'auto');
        });
    }

    if (avgTripBtn) {
        avgTripBtn.addEventListener('click', function () {
            rangeMode = 'average';
            avgTripBtn.classList.add('active');
            fullRangeBtn.classList.remove('active');
            rangeModeText.textContent = 'Average Trip Length';

            // Update range automatically
            updateRangeSlider(0, 'auto');
        });
    }

    if (fullRangeBtn) {
        fullRangeBtn.addEventListener('click', function () {
            rangeMode = 'full';
            fullRangeBtn.classList.add('active');
            avgTripBtn.classList.remove('active');
            rangeModeText.textContent = 'Seats Full Range';

            // Update range automatically
            updateRangeSlider(0, 'auto');

            if (routePairs.length > 0) {
                // Find the longest route for map centering
                const longestRouteIndex = routePairs.reduce((maxIndex, route, index, array) =>
                    route.distance > array[maxIndex].distance ? index : maxIndex, 0);

                const longestRoute = routePairs[longestRouteIndex];

                // Center map on the longest route
                const bounds = L.latLngBounds([
                    [longestRoute.from.lat, longestRoute.from.lon],
                    [longestRoute.to.lat, longestRoute.to.lon]
                ]);
                map.fitBounds(bounds, { padding: [50, 50] });
            }
        });
    }

    // Modify the updateAverageLegDistance function
    function updateAverageLegDistance() {
        if (routePairs.length > 0 && rangeMode === 'average') {
            const totalDistance = routePairs.reduce((sum, route) => sum + route.distance, 0);
            const averageDistance = Math.round(totalDistance / routePairs.length);
            updateRangeSlider(averageDistance, 'auto');
        }
    }

    // Update range slider when range-min input changes
    document.getElementById('range-min').addEventListener('change', function () {
        const range = parseInt(this.value);
        if (!isNaN(range)) {
            updateRangeSlider(range, 'manual');
        }
    });

    // Get color based on range
    function getColorForRange(range) {
        // Create a color scale from red to blue based on range
        const minRange = 500;  // Minimum expected range
        const maxRange = 7000; // Maximum expected range

        // Normalize range between 0 and 1
        const normalized = Math.min(Math.max((range - minRange) / (maxRange - minRange), 0), 1);

        // Create RGB color (red to blue gradient)
        const r = Math.round(255 * (1 - normalized));
        const b = Math.round(255 * normalized);

        return `rgb(${r}, 0, ${b})`;
    }

    // Add a new route pair
    function addRoutePair(fromAirport, toAirport) {
        if (!fromAirport || !toAirport) return;

        // Calculate distance in both directions to find the most efficient
        const distanceForward = calculateDistance(fromAirport.lat, fromAirport.lon, toAirport.lat, toAirport.lon);
        const distanceReverse = calculateDistance(toAirport.lat, toAirport.lon, fromAirport.lat, fromAirport.lon);

        // The distances should be identical for a true great circle calculation, but keep the code for clarity
        let actualFrom, actualTo, distance;
        if (distanceForward <= distanceReverse) {
            // Forward direction is more efficient
            actualFrom = fromAirport;
            actualTo = toAirport;
            distance = distanceForward;
        } else {
            // Reverse direction is more efficient
            actualFrom = toAirport;
            actualTo = fromAirport;
            distance = distanceReverse;
        }

        const routePair = {
            id: `${actualFrom.iata}-${actualTo.iata}-${Date.now()}`,
            from: actualFrom,
            to: actualTo,
            distance: distance
        };

        routePairs.push(routePair);

        // Draw route line
        const line = L.polyline(
            [[actualFrom.lat, actualFrom.lon], [actualTo.lat, actualTo.lon]],
            {
                color: '#F05545',
                weight: 2,
                opacity: 0.8
            }
        ).addTo(map);

        // Add markers for each airport
        const fromMarker = L.marker([actualFrom.lat, actualFrom.lon], {
            icon: L.divIcon({
                className: 'airport-marker',
                html: `<div class="airport-icon">${actualFrom.iata}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            })
        }).addTo(map);

        const toMarker = L.marker([actualTo.lat, actualTo.lon], {
            icon: L.divIcon({
                className: 'airport-marker',
                html: `<div class="airport-icon">${actualTo.iata}</div>`,
                iconSize: [40, 40],
                iconAnchor: [20, 20]
            })
        }).addTo(map);

        // Store line and markers
        allRouteLines.set(routePair.id, {
            line: line,
            markers: [fromMarker, toMarker]
        });

        // Show optimization message if the direction was changed
        if (actualFrom !== fromAirport) {
            showToast(`Route direction optimized: ${actualFrom.iata} → ${actualTo.iata} is more efficient`, 'info');
        }

        // Update routes display
        updateRoutesDisplay();

        // Update range slider based on current mode - send 'auto' to recalculate
        updateRangeSlider(0, 'auto');
    }

    // Update routes display
    function updateRoutesDisplay() {
        const routesContainer = document.getElementById('routes-container');
        routesContainer.innerHTML = '';

        routePairs.forEach((route, index) => {
            routePairs.forEach((route, index) => {
                const routeElement = document.createElement('div');
                routeElement.className = 'route-item d-flex justify-content-between align-items-center p-2 border-bottom';

                routeElement.innerHTML = `
            <div>
                <strong>${route.from.iata} → ${route.to.iata}</strong>
                <small class="d-block text-secondary">${route.distance.toFixed(0)} nm</small>
            </div>
            <button class="btn btn-sm btn-outline-danger delete-route" data-id="${route.id}">×</button>
        `;

                // Add delete handler
                routeElement.querySelector('.delete-route').addEventListener('click', () => {
                    deleteRoutePair(route.id);
                });

                routesContainer.appendChild(routeElement);
            });

            // Update total distance
            const totalDistance = routePairs.reduce((sum, route) => sum + route.distance, 0);
            document.getElementById('total-distance').textContent = totalDistance.toFixed(0);
        }

        // Delete a route pair and update the range automatically
        function deleteRoutePair(pairId) {
                // Remove from routePairs array
                routePairs = routePairs.filter(route => route.id !== pairId);

                // Remove line and markers from map
                const routeElements = allRouteLines.get(pairId);
                if (routeElements) {
                    map.removeLayer(routeElements.line);
                    routeElements.markers.forEach(marker => map.removeLayer(marker));
                    allRouteLines.delete(pairId);
                }

                // Update routes display
                updateRoutesDisplay();

                // Update range slider based on current mode
                updateRangeSlider(0, 'auto');
            }

        // Clear all routes and reset range
        function clearAllRoutes() {
                // Remove all lines and markers from map
                allRouteLines.forEach(route => {
                    map.removeLayer(route.line);
                    map.removeLayer(route.markers[0]);
                    map.removeLayer(route.markers[1]);
                });

                // Clear arrays and maps
                routePairs = [];
                allRouteLines.clear();

                // Update routes display
                updateRoutesDisplay();

                // Reset range to default
                updateRangeSlider(500, 'auto');
            }

        // Toggle aircraft range circles
        function toggleAircraftRanges(visible) {
                aircraftRangeCircles.forEach(circle => {
                    if (visible) {
                        circle.addTo(map);
                    } else {
                        map.removeLayer(circle);
                    }
                });
            }

        // Update range circle centers
        function updateRangeCircleCenters(lat, lon) {
                aircraftRangeCircles.forEach(circle => {
                    circle.setLatLng([lat, lon]);
                });
            }

        // Search for airports
        function searchAirports(query, resultsList, resultsContainer, type = 'from') {
                if (!query.trim()) {
                    resultsContainer.classList.add('d-none');
                    return;
                }

                // Show loading state
                resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Searching...</div>';
                resultsContainer.classList.remove('d-none');

                // Fetch airports from API
                fetch(`/api/airports?q=${encodeURIComponent(query)}`)
                    .then(response => response.json())
                    .then(airports => {
                        resultsList.innerHTML = '';

                        if (airports.length === 0) {
                            resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">No airports found</div>';
                            return;
                        }

                        airports.forEach(airport => {
                            const item = document.createElement('button');
                            item.type = 'button';
                            item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary';

                            item.innerHTML = `
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            ${airport.iata ? `<strong class="me-2">${airport.iata}</strong>` : ''}
                            ${airport.icao ? `<span class="text-info">${airport.icao}</span>` : ''}
                        </div>
                        ${airport.size ? `<span class="badge bg-danger">${airport.size}</span>` : ''}
                    </div>
                    <div class="text-truncate">${airport.name}</div>
                    <small class="text-secondary text-truncate d-block">${airport.city}, ${airport.country}</small>
                `;

                            item.addEventListener('click', function () {
                                if (type === 'from') {
                                    selectedFromAirport = airport;
                                    document.getElementById('from-airport').value = `${airport.iata} - ${airport.city}`;
                                } else {
                                    selectedToAirport = airport;
                                    document.getElementById('to-airport').value = `${airport.iata} - ${airport.city}`;
                                }
                                resultsContainer.classList.add('d-none');
                            });

                            resultsList.appendChild(item);
                        });
                    })
                    .catch(error => {
                        console.error('Error searching airports:', error);
                        resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Error searching airports</div>';
                    });
            }

        // Select an airport
        function selectAirport(airport) {
                // Store selected airport
                selectedAirport = airport;

                // Update map to show the selected airport
                const latlng = L.latLng(airport.lat, airport.lon);

                // Don't reset the view if we already have a route
                if (routeLegs.length === 0) {
                    map.setView(latlng, 10);
                }

                // Hide airport results
                document.getElementById('airport-results').classList.add('d-none');

                // Clear airport search input
                document.getElementById('airport-search').value = '';

                // Show airport on map with a temporary marker
                const tempMarker = L.marker(latlng, {
                    icon: L.divIcon({
                        className: 'airport-marker',
                        html: `<div class="airport-icon">${airport.iata || airport.icao}</div>`,
                        iconSize: [40, 40],
                        iconAnchor: [20, 20]
                    })
                }).addTo(map);

                // Add popup with airport info
                tempMarker.bindPopup(`
        <strong>${airport.iata || airport.icao}</strong><br>
        ${airport.name}<br>
        ${airport.city}, ${airport.country}<br>
        <button class="btn btn-sm btn-danger mt-2 add-to-route-btn">Add to Route</button>
    `).openPopup();

                // Add event listener to add to route button
                tempMarker.on('popupopen', function () {
                    const addBtn = tempMarker.getPopup().getElement().querySelector('.add-to-route-btn');
                    if (addBtn) {
                        addBtn.addEventListener('click', function () {
                            addLegToRoute(airport);
                            map.removeLayer(tempMarker);
                        });
                    }
                });

                // Remove the temporary marker after 10 seconds if not added to route
                setTimeout(() => {
                    if (map.hasLayer(tempMarker)) {
                        map.removeLayer(tempMarker);
                    }
                }, 10000);
            }

        // Add leg to route
        function addLegToRoute(airport) {
                // Add airport to route legs
                routeLegs.push(airport);

                // Update route on map
                updateRouteOnMap();

                // Update route legs display
                updateRouteLegsDisplay();

                // Calculate total distance
                calculateTotalDistance();

                // Show success message
                showToast(`Added ${airport.iata || airport.icao} to route`, 'success');
            }

        // Update route on map
        function updateRouteOnMap() {
                // Clear existing route markers and lines
                routeMarkers.forEach(marker => map.removeLayer(marker));
                allRouteLines.forEach(line => map.removeLayer(line));
                routeMarkers = [];
                allRouteLines = [];

                // Add markers for each airport in route
                routeLegs.forEach((airport, index) => {
                    const latlng = L.latLng(airport.lat, airport.lon);

                    // Create marker
                    const airportMarker = L.marker(latlng, {
                        icon: L.divIcon({
                            className: 'route-marker',
                            html: `<div class="route-icon">${index + 1}</div>`,
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        })
                    }).addTo(map);

                    // Add popup with airport info
                    airportMarker.bindPopup(`
            <strong>${airport.iata || airport.icao}</strong><br>
            ${airport.name}<br>
            ${airport.city}, ${airport.country}<br>
            <button class="btn btn-sm btn-danger mt-2 remove-from-route-btn" data-index="${index}">Remove</button>
        `);

                    // Add event listener to remove button when popup is opened
                    airportMarker.on('popupopen', function () {
                        const removeBtn = airportMarker.getPopup().getElement().querySelector('.remove-from-route-btn');
                        if (removeBtn) {
                            removeBtn.addEventListener('click', function () {
                                const legIndex = parseInt(this.dataset.index);
                                removeRouteleg(legIndex);
                                airportMarker.closePopup();
                            });
                        }
                    });

                    routeMarkers.push(airportMarker);
                });

                // Add lines between airports
                for (let i = 0; i < routeLegs.length - 1; i++) {
                    const from = L.latLng(routeLegs[i].lat, routeLegs[i].lon);
                    const to = L.latLng(routeLegs[i + 1].lat, routeLegs[i + 1].lon);

                    const line = L.polyline([from, to], {
                        color: '#F05545',
                        weight: 3,
                        opacity: 0.7,
                        dashArray: '5, 10'
                    }).addTo(map);

                    // Add distance popup to line
                    const distance = calculateDistance(
                        routeLegs[i].lat, routeLegs[i].lon,
                        routeLegs[i + 1].lat, routeLegs[i + 1].lon
                    );

                    const midpoint = L.latLng(
                        (parseFloat(routeLegs[i].lat) + parseFloat(routeLegs[i + 1].lat)) / 2,
                        (parseFloat(routeLegs[i].lon) + parseFloat(routeLegs[i + 1].lon)) / 2
                    );

                    const distanceMarker = L.marker(midpoint, {
                        icon: L.divIcon({
                            className: 'distance-marker',
                            html: `<div class="distance-label">${distance.toFixed(0)} nm</div>`,
                            iconSize: [80, 20],
                            iconAnchor: [40, 10]
                        })
                    }).addTo(map);

                    routeMarkers.push(distanceMarker);
                    allRouteLines.push(line);
                }

                // Fit map to route if there are at least 2 legs
                if (routeLegs.length >= 2) {
                    const bounds = L.latLngBounds(routeLegs.map(airport => L.latLng(airport.lat, airport.lon)));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

        // Update route legs display
        function updateRouteLegsDisplay() {
                const routeLegsContainer = document.getElementById('route-legs');
                routeLegsContainer.innerHTML = '';

                if (routeLegs.length === 0) {
                    routeLegsContainer.innerHTML = '<div class="text-secondary text-center">No route legs added</div>';
                    return;
                }

                // Create a container for the route list
                const routeList = document.createElement('div');
                routeList.className = 'route-list';

                // Add each leg to display
                routeLegs.forEach((airport, index) => {
                    const legElement = document.createElement('div');
                    legElement.className = 'route-leg d-flex justify-content-between align-items-center p-1 border-bottom border-secondary';

                    // Calculate distance to next leg
                    let distanceText = '';
                    if (index < routeLegs.length - 1) {
                        const nextAirport = routeLegs[index + 1];
                        const distance = calculateDistance(
                            airport.lat, airport.lon,
                            nextAirport.lat, nextAirport.lon
                        );
                        distanceText = `${distance.toFixed(0)} nm →`;
                    }

                    legElement.innerHTML = `
            <div>
                <strong>${index + 1}. ${airport.iata || airport.icao}</strong>
                <small class="d-block text-secondary">${airport.city}</small>
            </div>
            <div class="d-flex align-items-center">
                <span class="text-danger me-2">${distanceText}</span>
                <button class="btn btn-sm btn-outline-danger remove-leg-btn" data-index="${index}">×</button>
            </div>
        `;

                    // Add event listener to remove button
                    legElement.querySelector('.remove-leg-btn').addEventListener('click', function () {
                        const legIndex = parseInt(this.dataset.index);
                        removeRouteleg(legIndex);
                    });

                    routeList.appendChild(legElement);
                });

                // Add route list to container
                routeLegsContainer.appendChild(routeList);

                // Add route summary if there are at least 2 legs
                if (routeLegs.length >= 2) {
                    const summaryElement = document.createElement('div');
                    summaryElement.className = 'route-summary mt-2 p-2 bg-dark border border-secondary rounded';

                    summaryElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <strong>Total Distance:</strong> ${totalDistance.toFixed(0)} nm
                </div>
                <button class="btn btn-sm btn-outline-light save-route-btn">Save Route</button>
            </div>
        `;

                    // Add event listener to save route button
                    summaryElement.querySelector('.save-route-btn').addEventListener('click', function () {
                        saveRoute();
                    });

                    routeLegsContainer.appendChild(summaryElement);
                }
            }

        // Save current route
        function saveRoute() {
                if (routeLegs.length < 2) {
                    showToast('Route must have at least 2 airports', 'danger');
                    return;
                }

                // Prompt user for route name
                const routeName = prompt('Enter a name for this route:',
                    `${routeLegs[0].iata || routeLegs[0].icao} to ${routeLegs[routeLegs.length - 1].iata || routeLegs[routeLegs.length - 1].icao}`);

                // If user cancels, don't save
                if (routeName === null) {
                    return;
                }

                // Get saved routes from local storage
                let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');

                // Limit to 50 routes
                if (savedRoutes.length >= 50) {
                    savedRoutes.pop(); // Remove oldest route
                }

                // Create new route object
                const newRoute = {
                    id: Date.now(),
                    name: routeName,
                    legs: routeLegs,
                    distance: totalDistance,
                    date: new Date().toISOString()
                };

                // Add to saved routes
                savedRoutes.unshift(newRoute); // Add to beginning

                // Save to local storage
                localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));

                // Update saved routes display
                updateSavedRoutesDisplay();

                // Show success message
                showToast(`Route "${routeName}" saved successfully`, 'success');
            }

        // Update saved routes display
        function updateSavedRoutesDisplay() {
                const savedRoutesContainer = document.getElementById('saved-routes');

                // Get saved routes from local storage
                const savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');

                if (savedRoutes.length === 0) {
                    savedRoutesContainer.innerHTML = '<div class="text-secondary text-center">No saved routes</div>';
                    return;
                }

                // Clear container
                savedRoutesContainer.innerHTML = '';

                // Create a list for saved routes
                const routesList = document.createElement('div');
                routesList.className = 'saved-routes-list';

                // Add each saved route
                savedRoutes.forEach(route => {
                    const routeElement = document.createElement('div');
                    routeElement.className = 'saved-route p-2 mb-2 border border-secondary rounded';

                    // Format date
                    const date = new Date(route.date);
                    const formattedDate = `${date.toLocaleDateString()} ${date.toLocaleTimeString(undefined, { hour: '2-digit', minute: '2-digit' })}`;

                    // Create route summary (first and last airport)
                    let routeSummary = '';
                    if (route.legs && route.legs.length >= 2) {
                        const firstAirport = route.legs[0];
                        const lastAirport = route.legs[route.legs.length - 1];
                        routeSummary = `${firstAirport.iata || firstAirport.icao} → ${lastAirport.iata || lastAirport.icao}`;
                    }

                    // Create waypoints summary
                    let waypointsSummary = '';
                    if (route.legs && route.legs.length > 2) {
                        const waypoints = route.legs.slice(1, -1);
                        waypointsSummary = waypoints.map(wp => wp.iata || wp.icao).join(' → ');
                    }

                    routeElement.innerHTML = `
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <strong class="d-block">${route.name || routeSummary}</strong>
                    ${waypointsSummary ? `<small class="text-secondary d-block">via ${waypointsSummary}</small>` : ''}
                    <small class="text-secondary d-block">${route.distance.toFixed(0)} nm · ${route.legs.length} airports</small>
                    <small class="text-secondary d-block">${formattedDate}</small>
                </div>
                <div class="d-flex">
                    <button class="btn btn-sm btn-outline-info me-1 load-route-btn" data-id="${route.id}">Load</button>
                    <button class="btn btn-sm btn-outline-danger delete-route-btn" data-id="${route.id}">×</button>
                </div>
            </div>
        `;

                    // Add event listeners
                    routeElement.querySelector('.load-route-btn').addEventListener('click', function () {
                        loadRoute(route.id);
                    });

                    routeElement.querySelector('.delete-route-btn').addEventListener('click', function () {
                        deleteRoute(route.id);
                    });

                    routesList.appendChild(routeElement);
                });

                savedRoutesContainer.appendChild(routesList);
            }

        // Load a saved route
        function loadRoute(routeId) {
                // Get saved routes from local storage
                const savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');

                // Find the route with the given ID
                const route = savedRoutes.find(r => r.id === routeId);

                if (!route) {
                    showToast('Route not found', 'danger');
                    return;
                }

                // Clear current route
                clearRouteLegs();

                // Add each leg from the saved route
                route.legs.forEach(airport => {
                    routeLegs.push(airport);
                });

                // Update route on map
                updateRouteOnMap();

                // Update route legs display
                updateRouteLegsDisplay();

                // Calculate total distance
                calculateTotalDistance();

                // Show success message
                showToast(`Route "${route.name || 'Unnamed'}" loaded successfully`, 'success');

                // Fit map to route
                if (routeLegs.length >= 2) {
                    const bounds = L.latLngBounds(routeLegs.map(airport => L.latLng(airport.lat, airport.lon)));
                    map.fitBounds(bounds, { padding: [50, 50] });
                }
            }

        // Delete a saved route
        function deleteRoute(routeId) {
                // Get saved routes from local storage
                let savedRoutes = JSON.parse(localStorage.getItem('savedRoutes') || '[]');

                // Filter out the route
                savedRoutes = savedRoutes.filter(r => r.id !== routeId);

                // Save to local storage
                localStorage.setItem('savedRoutes', JSON.stringify(savedRoutes));

                // Update saved routes display
                updateSavedRoutesDisplay();

                // Show success message
                showToast('Route deleted', 'success');
            }

        // Remove route leg
        function removeRouteleg(index) {
                // Remove leg from array
                routeLegs.splice(index, 1);

                // Update route on map
                updateRouteOnMap();

                // Update route legs display
                updateRouteLegsDisplay();

                // Calculate total distance
                calculateTotalDistance();
            }

        // Clear all route legs
        function clearRouteLegs() {
                // Clear route legs array
                routeLegs = [];

                // Update route on map
                updateRouteOnMap();

                // Update route legs display
                updateRouteLegsDisplay();

                // Reset total distance
                totalDistance = 0;
                document.getElementById('total-distance').textContent = '0';
            }

        // Calculate distance between two points using the haversine formula (great circle distance)
        function calculateDistance(lat1, lon1, lat2, lon2) {
                // Convert degrees to radians
                const toRad = value => value * Math.PI / 180;

                // Convert to radians
                const radLat1 = toRad(lat1);
                const radLon1 = toRad(lon1);
                const radLat2 = toRad(lat2);
                const radLon2 = toRad(lon2);

                // Haversine formula for great circle distance
                const dlon = radLon2 - radLon1;
                const dlat = radLat2 - radLat1;
                const a = Math.sin(dlat / 2) * Math.sin(dlat / 2) +
                    Math.cos(radLat1) * Math.cos(radLat2) *
                    Math.sin(dlon / 2) * Math.sin(dlon / 2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
                const radius = 3440.065; // Radius of earth in nautical miles

                // Calculate distance - this is the shortest possible distance between two points on a sphere
                return radius * c;
            }

        // Calculate total distance of route
        function calculateTotalDistance() {
                totalDistance = 0;

                // Calculate distance between each leg
                for (let i = 0; i < routeLegs.length - 1; i++) {
                    const from = routeLegs[i];
                    const to = routeLegs[i + 1];

                    const distance = calculateDistance(
                        from.lat, from.lon,
                        to.lat, to.lon
                    );

                    totalDistance += distance;
                }

                // Update total distance display
                document.getElementById('total-distance').textContent = totalDistance.toFixed(0);

                // Automatically update range-min input with the total distance
                if (routeLegs.length >= 2) {
                    const rangeMinInput = document.getElementById('range-min');
                    const currentValue = parseInt(rangeMinInput.value) || 0;
                    const newValue = Math.round(totalDistance);

                    // Only update if the value has changed significantly (more than 10%)
                    if (Math.abs(currentValue - newValue) / Math.max(currentValue, 1) > 0.1 || currentValue === 0) {
                        rangeMinInput.value = newValue;

                        // Add a visual indicator that the value has been updated
                        rangeMinInput.classList.add('applied');
                        setTimeout(() => {
                            rangeMinInput.classList.remove('applied');
                        }, 2000);

                        // Show success message
                        showToast(`Range filter automatically updated to ${newValue} nm`, 'info');

                        // Reload aircraft data with new range
                        loadAircraftData();
                    }
                }
            }

        // Update average trip length and reload aircraft data
        function updateAverageTripLength(distance) {
                if (distance > 0) {
                    const avgTripLengthInput = document.getElementById('avg-trip-length');
                    const currentValue = parseInt(avgTripLengthInput.value);
                    const newValue = Math.round(distance);

                    // Only update if the value has changed significantly (more than 10%)
                    if (Math.abs(currentValue - newValue) / currentValue > 0.1 || isNaN(currentValue)) {
                        avgTripLengthInput.value = newValue;

                        // Show success message
                        showToast(`Average trip length automatically updated to ${newValue} nm`, 'info');

                        // Reload aircraft data with new trip length
                        updateFinancialCalculations();
                    }
                }
            }

        // Use total distance as average trip length
        function useDistanceAsAvgTrip() {
                if (totalDistance > 0) {
                    document.getElementById('avg-trip-length').value = Math.round(totalDistance);

                    // Show success message
                    showToast(`Average trip length updated to ${Math.round(totalDistance)} nm`, 'success');

                    // Reload aircraft data with new trip length
                    loadAircraftData();
                } else {
                    showToast('Please create a route first', 'danger');
                }
            }

        // Show toast message
        function showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = 'position-fixed bottom-0 end-0 p-3';
                toast.style.zIndex = 1050;
                toast.innerHTML = `
        <div class="toast show bg-${type} text-white" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header bg-${type} text-white">
                <strong class="me-auto">Notification</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
                document.body.appendChild(toast);

                // Remove toast after 3 seconds
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            }

        // Search for airport by IATA code or name
        function searchAirport(query) {
                // Use geocoder to search
                geocoder.geocode(query, function (results) {
                    if (results.length > 0) {
                        const result = results[0];
                        const latlng = result.center;
                        marker.setLatLng(latlng);
                        circle.setLatLng(latlng);
                        map.setView(latlng, 10);

                        // Add a visual feedback animation
                        const pulseCircle = L.circleMarker(latlng, {
                            color: '#FFD700',
                            fillColor: '#FFD700',
                            fillOpacity: 0.5,
                            radius: 20
                        }).addTo(map);

                        // Animate the pulse circle
                        let size = 20;
                        const pulseAnimation = setInterval(() => {
                            size += 5;
                            pulseCircle.setRadius(size);
                            pulseCircle.setStyle({
                                fillOpacity: Math.max(0, 0.5 - size / 100)
                            });

                            if (size > 100) {
                                clearInterval(pulseAnimation);
                                map.removeLayer(pulseCircle);
                            }
                        }, 50);
                    } else {
                        // If not found, show an error message
                        alert('Location or airport not found. Please try a different search term.');
                    }
                });
            }

        // Function to load aircraft data
        function loadAircraftData() {
                console.log('loadAircraftData called');

                // Show loading indicator
                document.getElementById('loading-indicator').classList.remove('d-none');

                // Disable the aircraft table to indicate loading
                const aircraftTable = document.getElementById('aircraft-table');
                if (aircraftTable) {
                    aircraftTable.classList.add('loading');
                }

                // Build query string from active filters
                const queryParams = new URLSearchParams();

                // Add active filters to query params
                for (const [key, value] of Object.entries(activeFilters)) {
                    queryParams.append(key, value);
                }

                // Get all input values
                const yearMin = document.getElementById('year-min').value;
                const rangeMinInput = document.getElementById('range-min');
                const rangeMinValue = parseInt(rangeMinInput.value);
                const passengersMin = document.getElementById('passengers-min').value;
                const priceMax = document.getElementById('price-max').value;
                const yearsOwnership = parseInt(document.getElementById('years-ownership').value) || 5;
                const numTrips = parseInt(document.getElementById('num-trips').value) || 50;

                // Add basic inputs to query params if they have values
                if (yearMin) queryParams.append('year_min', yearMin);
                if (passengersMin) queryParams.append('passengers_min', passengersMin);
                if (priceMax) queryParams.append('price_max', priceMax);

                // Add range filtering based on mode
                if (rangeMinValue) {
                    if (rangeMode === 'full') {
                        // In full range mode, use the actual range requirement
                        // We want aircraft that can complete the longest leg in one trip
                        queryParams.append('range_min', rangeMinValue);
                    } else {
                        queryParams.append('range_min', rangeMinValue);
                    }
                }

                // Get selected manufacturers
                const manufacturerContainer = document.getElementById('manufacturer-container');
                const selectedManufacturers = Array.from(manufacturerContainer.querySelectorAll('.option-item.selected'))
                    .map(option => option.getAttribute('data-value'))
                    .filter(value => value !== '');

                // Get selected aircraft types
                const aircraftTypeContainer = document.getElementById('aircraft-type-container');
                const selectedTypes = Array.from(aircraftTypeContainer.querySelectorAll('.option-item.selected'))
                    .map(option => option.getAttribute('data-value'))
                    .filter(value => value !== '');

                // Add multiple manufacturers to query params
                if (selectedManufacturers.length > 0) {
                    selectedManufacturers.forEach(manufacturer => {
                        queryParams.append('manufacturer_list', manufacturer);
                    });
                }

                // Add multiple aircraft types to query params
                if (selectedTypes.length > 0) {
                    selectedTypes.forEach(type => {
                        queryParams.append('aircraft_type', type);
                    });
                }

                // Get other advanced inputs
                const multiEngine = document.getElementById('multi-engine').value;
                const minCrew = document.getElementById('min-crew').value;
                const maxAltitude = document.getElementById('max-altitude')?.value;
                const balancedFieldLength = document.getElementById('balanced-field-length')?.value;
                const aircraftHeight = document.getElementById('aircraft-height')?.value;
                const aircraftWingspan = document.getElementById('aircraft-wingspan')?.value;
                const aircraftLength = document.getElementById('aircraft-length')?.value;
                const cabinHeight = document.getElementById('cabin-height')?.value;
                const cabinWidth = document.getElementById('cabin-width')?.value;
                const cabinLength = document.getElementById('cabin-length')?.value;
                const baggageVolume = document.getElementById('baggage-volume')?.value;
                const speedMin = document.getElementById('speed-min')?.value;
                const depreciationRate = parseFloat(document.getElementById('depreciation-rate').value) || 4;
                const jetAPrice = parseFloat(document.getElementById('jet-a-price').value) || 5.50;
                const avgasPrice = parseFloat(document.getElementById('avgas-price').value) || 6.50;
                const plannedPassengers = parseInt(document.getElementById('planned-passengers').value) || 4;
                const passengerPay = parseFloat(document.getElementById('passenger-pay').value) || 0;
                const charterTrips = parseInt(document.getElementById('charter-trips').value) || 0;

                // Add other advanced inputs to query params if they have values
                if (multiEngine) queryParams.append('multi_engine', multiEngine);
                if (minCrew) queryParams.append('min_crew', minCrew);
                if (maxAltitude) queryParams.append('max_altitude', maxAltitude);
                if (balancedFieldLength) queryParams.append('balanced_field_length', balancedFieldLength);
                if (aircraftHeight) queryParams.append('aircraft_height', aircraftHeight);
                if (aircraftWingspan) queryParams.append('aircraft_wingspan', aircraftWingspan);
                if (aircraftLength) queryParams.append('aircraft_length', aircraftLength);
                if (cabinHeight) queryParams.append('cabin_height', cabinHeight);
                if (cabinWidth) queryParams.append('cabin_width', cabinWidth);
                if (cabinLength) queryParams.append('cabin_length', cabinLength);
                if (baggageVolume) queryParams.append('baggage_volume', baggageVolume);
                if (speedMin) queryParams.append('speed_min', speedMin);

                // Add financial inputs to query params
                queryParams.append('depreciation_rate', depreciationRate);
                queryParams.append('years_ownership', yearsOwnership);
                queryParams.append('jet_a_price', jetAPrice);
                queryParams.append('avgas_price', avgasPrice);
                queryParams.append('avg_trip_length', document.getElementById('avg-trip-length')?.value || 500);
                queryParams.append('num_trips', numTrips);
                queryParams.append('planned_passengers', plannedPassengers);
                queryParams.append('passenger_pay', passengerPay);
                queryParams.append('charter_rate', document.getElementById('charter-rate')?.value || 50);
                queryParams.append('charter_trip_length', document.getElementById('charter-trip-length')?.value || 600);
                queryParams.append('charter_trips', charterTrips);
                queryParams.append('charter_profit', document.getElementById('charter-profit')?.value || 50000);

                // Add ranking column to query params
                queryParams.append('ranking_column', activePriorityColumn);

                // Build API URL
                const apiUrl = `/api/aircraft?${queryParams.toString()}`;
                console.log('Fetching aircraft data from:', apiUrl);

                // Fetch aircraft data
                fetch(apiUrl)
                    .then(response => {
                        console.log('Response status:', response.status);
                        return response.json();
                    })
                    .then(data => {
                        console.log('Received aircraft data:', data.length, 'items');
                        aircraftData = data;

                        // Extract unique values from the data for select elements
                        extractUniqueValuesFromData();

                        // Populate select elements with unique values
                        populateDataLists();

                        // Restore selected values
                        multiSelectValues['manufacturer'] = selectedManufacturers;
                        multiSelectValues['aircraft-type'] = selectedTypes;

                        // Render the aircraft table
                        renderAircraftTable();

                        // Update the results count
                        document.getElementById('results-count').textContent = data.length;

                        // Hide loading indicator
                        document.getElementById('loading-indicator').classList.add('d-none');

                        // Enable the aircraft table
                        if (aircraftTable) {
                            aircraftTable.classList.remove('loading');
                        }
                    })
                    .catch(error => {
                        console.error('Error fetching aircraft data:', error);
                        // Hide loading indicator
                        document.getElementById('loading-indicator').classList.add('d-none');
                        // Enable the aircraft table
                        if (aircraftTable) {
                            aircraftTable.classList.remove('loading');
                        }
                    });
            }

        // Helper function to restore selected values in a multi-select after repopulating options
        function restoreSelectedValues(selectElement, selectedValues) {
                if (!selectElement || !selectedValues || selectedValues.length === 0) return;

                // For each option in the select element
                Array.from(selectElement.options).forEach(option => {
                    // If the option's value is in the selectedValues array, select it
                    if (selectedValues.includes(option.value)) {
                        option.selected = true;
                    }
                });
            }

        // Function to extract unique values from aircraft data
        function extractUniqueValuesFromData() {
                console.log('Extracting unique values from aircraft data');

                // Clear existing sets
                uniqueManufacturers.clear();
                uniqueTypes.clear();
                uniqueMultiEngineValues.clear();
                uniqueMinCrewValues.clear();

                // Extract unique values from the aircraft data
                aircraftData.forEach(aircraft => {
                    if (aircraft.manufacturer) {
                        uniqueManufacturers.add(aircraft.manufacturer);
                    }
                    if (aircraft.type) {
                        uniqueTypes.add(aircraft.type);
                    }
                    uniqueMultiEngineValues.add(aircraft.multiEngine ? 'Yes' : 'No');
                    if (aircraft.minCrewRequired) {
                        uniqueMinCrewValues.add(aircraft.minCrewRequired.toString());
                    }
                });

                console.log(`Extracted ${uniqueManufacturers.size} unique manufacturers`);
                console.log(`Extracted ${uniqueTypes.size} unique aircraft types`);
            }

        // Function to update multi-select options based on data
        function updateMultiSelectOptions() {
                // Update manufacturer options
                updateMultiSelectOptionsForContainer('manufacturer-container', uniqueManufacturers);

                // Update aircraft type options
                updateMultiSelectOptionsForContainer('aircraft-type-container', uniqueTypes);

                // Update multi-engine options
                updateMultiSelectOptionsForContainer('multi-engine-container', uniqueMultiEngineValues);

                // Update min crew options
                updateMultiSelectOptionsForContainer('min-crew-container', uniqueMinCrewValues);
            }

        // Function to update options for a specific multi-select container
        function updateMultiSelectOptionsForContainer(containerId, uniqueValues) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const optionsList = container.querySelector('.options-list');
                if (!optionsList) return;

                // Get existing options
                const existingOptions = Array.from(optionsList.querySelectorAll('.option-item'))
                    .map(option => option.getAttribute('data-value'));

                // Clear existing options
                optionsList.innerHTML = '';

                // Add options for each unique value that doesn't already exist
                uniqueValues.forEach(value => {
                    // Skip if already exists
                    if (existingOptions.includes(value) && value !== 'All') {
                        return;
                    }

                    const option = document.createElement('div');
                    option.className = 'option-item';
                    option.setAttribute('data-value', value);
                    option.textContent = value;
                    optionsList.appendChild(option);
                });

                // Re-initialize the multi-select for this container
                const inputId = containerId.replace('-container', '');
                setupCustomMultiSelect(containerId, inputId);
            }

        // Function to update the financial inputs display
        function updateFinancialInputsDisplay() {
                console.log('Updating financial inputs display');

                // Set all advanced input values from the financialInputs object
                const advancedInputs = {
                    'max-altitude': document.getElementById('max-altitude'),
                    'balanced-field-length': document.getElementById('balanced-field-length'),
                    'aircraft-height': document.getElementById('aircraft-height'),
                    'aircraft-wingspan': document.getElementById('aircraft-wingspan'),
                    'aircraft-length': document.getElementById('aircraft-length'),
                    'cabin-height': document.getElementById('cabin-height'),
                    'cabin-width': document.getElementById('cabin-width'),
                    'cabin-length': document.getElementById('cabin-length'),
                    'baggage-volume': document.getElementById('baggage-volume'),
                    'speed-min': document.getElementById('speed-min'),
                    'depreciation-rate': document.getElementById('depreciation-rate'),
                    'years-ownership': document.getElementById('years-ownership'),
                    'jet-a-price': document.getElementById('jet-a-price'),
                    'avgas-price': document.getElementById('avgas-price'),
                    'avg-trip-length': document.getElementById('avg-trip-length'),
                    'num-trips': document.getElementById('num-trips'),
                    'planned-passengers': document.getElementById('planned-passengers'),
                    'passenger-pay': document.getElementById('passenger-pay'),
                    'charter-rate': document.getElementById('charter-rate'),
                    'charter-trip-length': document.getElementById('charter-trip-length'),
                    'charter-trips': document.getElementById('charter-trips'),
                    'charter-profit': document.getElementById('charter-profit')
                };

                // Set values for financial inputs
                if (advancedInputs['depreciation-rate']) advancedInputs['depreciation-rate'].value = financialInputs.depreciationRate;
                if (advancedInputs['years-ownership']) advancedInputs['years-ownership'].value = financialInputs.yearsOwnership;
                if (advancedInputs['jet-a-price']) advancedInputs['jet-a-price'].value = financialInputs.jetAPrice;
                if (advancedInputs['avgas-price']) advancedInputs['avgas-price'].value = financialInputs.avgasPrice;
                if (advancedInputs['avg-trip-length']) advancedInputs['avg-trip-length'].value = financialInputs.avgTripLength;
                if (advancedInputs['num-trips']) advancedInputs['num-trips'].value = financialInputs.numTrips;
                if (advancedInputs['planned-passengers']) advancedInputs['planned-passengers'].value = financialInputs.plannedPassengers;
                if (advancedInputs['passenger-pay']) advancedInputs['passenger-pay'].value = financialInputs.passengerPay;
                if (advancedInputs['charter-rate']) advancedInputs['charter-rate'].value = financialInputs.charterRate;
                if (advancedInputs['charter-trip-length']) advancedInputs['charter-trip-length'].value = financialInputs.charterTripLength;
                if (advancedInputs['charter-trips']) advancedInputs['charter-trips'].value = financialInputs.charterTrips;
                if (advancedInputs['charter-profit']) advancedInputs['charter-profit'].value = financialInputs.charterProfit;

                // Highlight the financial inputs that have been applied
                const avgTripLength = document.getElementById('avg-trip-length');
                if (avgTripLength) {
                    // Add a visual indicator that this value is being used
                    avgTripLength.classList.add('applied');
                    setTimeout(() => {
                        avgTripLength.classList.remove('applied');
                    }, 2000);
                }
            }

        // Function to load ranking columns
        function loadRankingColumns() {
                fetch('/api/ranking-columns')
                    .then(response => response.json())
                    .then(data => {
                        const rankingButtonsContainer = document.getElementById('ranking-buttons');
                        rankingButtonsContainer.innerHTML = '';

                        data.forEach(column => {
                            const button = document.createElement('button');
                            button.type = 'button';
                            button.className = 'priority-btn me-2 mb-2';
                            button.dataset.column = column.key;
                            button.textContent = column.label;

                            // Set active class if this is the active column
                            if (column.key === activePriorityColumn) {
                                button.classList.add('active');
                            }

                            // Add click event listener
                            button.addEventListener('click', () => {
                                // Remove active class from all buttons
                                document.querySelectorAll('.priority-btn').forEach(btn => {
                                    btn.classList.remove('active');
                                });

                                // Add active class to clicked button
                                button.classList.add('active');

                                // Update active column
                                activePriorityColumn = column.key;

                                // Reload aircraft data
                                loadAircraftData();
                            });

                            rankingButtonsContainer.appendChild(button);
                        });
                    })
                    .catch(error => {
                        console.error('Error loading ranking columns:', error);
                    });
            }

        // Function to render the aircraft table
        function renderAircraftTable() {
                console.log('Rendering aircraft table with', aircraftData.length, 'aircraft');

                // Update results count
                document.getElementById('results-count').textContent = aircraftData.length;

                // Get table body
                const tableBody = document.querySelector('#aircraft-table tbody');
                if (!tableBody) return;

                // Clear existing rows
                tableBody.innerHTML = '';

                // Update table header based on visible columns
                updateTableHeader();

                // Add rows for each aircraft
                aircraftData.forEach(aircraft => {
                    const row = document.createElement('tr');

                    // Add checkbox column
                    const checkboxCell = document.createElement('td');
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = selectedAircraft.has(aircraft.id);
                    checkbox.addEventListener('change', () => toggleAircraftSelection(aircraft.id));
                    checkboxCell.appendChild(checkbox);
                    row.appendChild(checkboxCell);

                    // Add data cells based on visible columns
                    addVisibleColumnCells(row, aircraft);

                    // Add row to table
                    tableBody.appendChild(row);
                });

                // Update selected count
                updateSelectedCount();
            }

        // Function to update table header based on visible columns
        function updateTableHeader() {
                const tableHeader = document.querySelector('#aircraft-table thead tr');
                if (!tableHeader) return;

                // Clear existing header cells except the first checkbox column
                while (tableHeader.children.length > 1) {
                    tableHeader.removeChild(tableHeader.lastChild);
                }

                // Define column definitions with display names
                const columnDefs = [
                    { id: 'model', name: 'Model' },
                    { id: 'manufacturer', name: 'Manufacturer' },
                    { id: 'type', name: 'Type' },
                    { id: 'multiEngine', name: 'Multi Engine' },
                    { id: 'dateRange', name: 'Date Range' },
                    { id: 'minCrewRequired', name: 'Min Crew' },
                    { id: 'maxOperatingAltitude', name: 'Max Alt (ft)' },
                    { id: 'balancedFieldLength', name: 'Balanced Field Length (ft)' },
                    { id: 'aircraftHeight', name: 'Height (ft)' },
                    { id: 'wingspan', name: 'Wingspan (ft)' },
                    { id: 'aircraftLength', name: 'Length (ft)' },
                    { id: 'aircraftVolume', name: 'Volume (cu ft)' },
                    { id: 'cabinHeight', name: 'Cabin Height (ft)' },
                    { id: 'cabinWidth', name: 'Cabin Width (ft)' },
                    { id: 'cabinLength', name: 'Cabin Length (ft)' },
                    { id: 'cabinVolume', name: 'Cabin Vol (cu ft)' },
                    { id: 'baggageVolume', name: 'Baggage Vol (cu ft)' },
                    { id: 'cabinAircraftVolumeRatio', name: 'Cabin/Aircraft Ratio' },
                    { id: 'range', name: 'Range (nm)' },
                    { id: 'cruiseSpeed', name: 'Speed (kts)' },
                    { id: 'passengers', name: 'Passengers' },
                    { id: 'price', name: 'Price ($M)' },
                    { id: 'speed_per_dollar', name: 'Speed/$' },
                    { id: 'range_per_dollar', name: 'Range/$' },
                    { id: 'annualCosts.total', name: 'Annual Cost ($)' },
                    { id: 'columnCalculations.as', name: 'Multi-Year Cost ($M)' },
                    { id: 'annualCosts.fuel', name: 'Annual Fuel Cost ($)' },
                    { id: 'columnCalculations.bd', name: 'Performance/$' },
                    { id: 'columnCalculations.bg', name: 'Efficiency/$' },
                    { id: 'columnCalculations.bj', name: 'All-Around/$' }
                ];

                // Add header cells for visible columns
                columnDefs.forEach(column => {
                    if (visibleColumns.has(column.id)) {
                        const th = document.createElement('th');
                        th.textContent = column.name;
                        tableHeader.appendChild(th);
                    }
                });
            }

        // Function to add cells for visible columns to a row
        function addVisibleColumnCells(row, aircraft) {
                // Helper function to get nested property value
                const getNestedValue = (obj, path) => {
                    const parts = path.split('.');
                    let value = obj;
                    for (const part of parts) {
                        if (value === null || value === undefined) return null;
                        value = value[part];
                    }
                    return value;
                };

                // Helper function to format cell value based on column type
                const formatCellValue = (columnId, value) => {
                    if (value === null || value === undefined) return '';

                    // Format based on column type
                    if (columnId === 'price') {
                        return formatCurrency(value / 1000000, 2); // Convert to millions
                    } else if (columnId === 'columnCalculations.as') {
                        return formatCurrency(value / 1000000, 2); // Convert to millions
                    } else if (columnId.includes('Cost')) {
                        return formatCurrency(value, 0);
                    } else if (columnId === 'multiEngine') {
                        return value ? 'Yes' : 'No';
                    } else if (typeof value === 'number') {
                        return formatNumber(value, 0);
                    }

                    return value;
                };

                // Define column definitions in display order
                const columnDefs = [
                    'model', 'manufacturer', 'type', 'multiEngine', 'dateRange',
                    'minCrewRequired', 'maxOperatingAltitude', 'balancedFieldLength',
                    'aircraftHeight', 'wingspan', 'aircraftLength', 'aircraftVolume',
                    'cabinHeight', 'cabinWidth', 'cabinLength', 'cabinVolume',
                    'baggageVolume', 'cabinAircraftVolumeRatio', 'range', 'cruiseSpeed',
                    'passengers', 'price', 'speed_per_dollar', 'range_per_dollar',
                    'annualCosts.total', 'columnCalculations.as', 'annualCosts.fuel',
                    'columnCalculations.bd', 'columnCalculations.bg', 'columnCalculations.bj'
                ];

                // Add cells for visible columns
                columnDefs.forEach(columnId => {
                    if (visibleColumns.has(columnId)) {
                        const cell = document.createElement('td');
                        const value = getNestedValue(aircraft, columnId);
                        cell.textContent = formatCellValue(columnId, value);
                        row.appendChild(cell);
                    }
                });
            }

        // Function to toggle aircraft selection
        function toggleAircraftSelection(aircraftId) {
                if (selectedAircraft.has(aircraftId)) {
                    selectedAircraft.delete(aircraftId);
                } else {
                    selectedAircraft.add(aircraftId);
                }

                // Update UI
                const checkbox = document.querySelector(`.aircraft-checkbox[data-id="${aircraftId}"]`);
                if (checkbox) {
                    const row = checkbox.closest('tr');
                    if (row) {
                        if (selectedAircraft.has(aircraftId)) {
                            row.classList.add('table-danger');
                        } else {
                            row.classList.remove('table-danger');
                        }
                    }
                }

                updateSelectedCount();
            }

        // Function to update selected count
        function updateSelectedCount() {
                const selectedCount = document.getElementById('selected-count');
                if (selectedCount) {
                    selectedCount.textContent = `${selectedAircraft.size} Selected`;
                }

                // Enable/disable compare button
                const compareBtn = document.getElementById('compare-btn');
                if (compareBtn) {
                    compareBtn.disabled = selectedAircraft.size < 2;
                }
            }

        // Function to show comparison view
        function showComparisonView() {
                // Hide aircraft table
                document.getElementById('aircraft-table-container').classList.add('d-none');
                document.getElementById('ranking-buttons').parentElement.classList.add('d-none');

                // Show comparison view
                document.getElementById('comparison-view').classList.remove('d-none');

                // Render comparison table
                renderComparisonTable();
            }

        // Function to show results view
        function showResultsView() {
                // Hide comparison view
                document.getElementById('comparison-view').classList.add('d-none');

                // Show aircraft table and ranking buttons
                document.getElementById('aircraft-table-container').classList.remove('d-none');
                document.getElementById('ranking-buttons').parentElement.classList.remove('d-none');
            }

        // Function to render comparison table
        function renderComparisonTable() {
                const comparisonTable = document.getElementById('comparison-table');
                comparisonTable.innerHTML = '';

                // Get selected aircraft
                const selectedAircraftData = aircraftData.filter(aircraft => selectedAircraft.has(aircraft.id));

                // Create table header
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');

                // Add property column
                const propertyHeader = document.createElement('th');
                propertyHeader.textContent = 'Property';
                headerRow.appendChild(propertyHeader);

                // Add aircraft columns
                selectedAircraftData.forEach(aircraft => {
                    const aircraftHeader = document.createElement('th');
                    aircraftHeader.textContent = `${aircraft.manufacturer} ${aircraft.model}`;
                    headerRow.appendChild(aircraftHeader);
                });

                thead.appendChild(headerRow);
                comparisonTable.appendChild(thead);

                // Create table body
                const tbody = document.createElement('tbody');

                // Define properties to compare
                const properties = [
                    { label: 'Type', key: 'type', format: value => value },
                    { label: 'Year Range', key: 'dateRange', format: value => value },
                    { label: 'Price ($M)', key: 'price', format: value => formatCurrency(value / 1000000, 2) },
                    { label: 'Range (nm)', key: 'range', format: value => formatNumber(value) },
                    { label: 'Speed (kts)', key: 'cruiseSpeed', format: value => formatNumber(value) },
                    { label: 'Passengers', key: 'passengers', format: value => value },
                    { label: 'Annual Operating Cost ($)', key: 'columnCalculations.ar', format: value => formatCurrency(value, 0) },
                    { label: 'Multi-Year Total Cost ($M)', key: 'columnCalculations.as', format: value => formatCurrency(value / 1000000, 2) },
                    { label: 'Annual Fuel Cost ($)', key: 'columnCalculations.at', format: value => formatCurrency(value, 0) },
                    { label: 'Speed/$', key: 'speed_per_dollar', format: value => formatNumber(value, 2) },
                    { label: 'Range/$', key: 'range_per_dollar', format: value => formatNumber(value, 2) },
                    { label: 'Performance/$', key: 'columnCalculations.bd', format: value => formatNumber(value, 2) },
                    { label: 'Efficiency/$', key: 'columnCalculations.bg', format: value => formatNumber(value, 2) },
                    { label: 'All-Around/$', key: 'columnCalculations.bj', format: value => formatNumber(value, 2) },
                    { label: 'Balanced Field Length (ft)', key: 'balancedFieldLength', format: value => formatNumber(value) },
                    { label: 'Baggage Volume (cu ft)', key: 'baggageVolume', format: value => formatNumber(value, 2) },
                    { label: 'Cabin Height (ft)', key: 'cabinHeight', format: value => formatNumber(value, 2) },
                    { label: 'Cabin Width (ft)', key: 'cabinWidth', format: value => formatNumber(value, 2) },
                    { label: 'Cabin Length (ft)', key: 'cabinLength', format: value => formatNumber(value, 2) },
                    { label: 'Cabin Volume (cu ft)', key: 'cabinVolume', format: value => formatNumber(value, 2) }
                ];

                // Add rows for each property
                properties.forEach(property => {
                    const row = document.createElement('tr');

                    // Add property label
                    const labelCell = document.createElement('td');
                    labelCell.textContent = property.label;
                    row.appendChild(labelCell);

                    // Add values for each aircraft
                    selectedAircraftData.forEach(aircraft => {
                        const valueCell = document.createElement('td');
                        const value = aircraft[property.key];
                        valueCell.textContent = value ? property.format(value) : 'N/A';
                        row.appendChild(valueCell);
                    });

                    tbody.appendChild(row);
                });

                comparisonTable.appendChild(tbody);
            }

        // Helper function to format currency
        function formatCurrency(value, decimals = 0) {
                return `$${formatNumber(value, decimals)}`;
            }

        // Helper function to format number
        function formatNumber(value, decimals = 0) {
                return Number(value).toLocaleString('en-US', {
                    minimumFractionDigits: decimals,
                    maximumFractionDigits: decimals
                });
            }

        // Update financial calculations based on user inputs
        function updateFinancialCalculations() {
                console.log('updateFinancialCalculations called');

                // Get values from input fields - both basic and advanced inputs
                const financialInputs = {
                    // Basic inputs
                    year_min: document.getElementById('year-min').value,
                    range_min: document.getElementById('range-min').value,
                    passengers_min: document.getElementById('passengers-min').value,
                    price_max: document.getElementById('price-max').value,
                    years_ownership: parseInt(document.getElementById('years-ownership').value) || 5,
                    num_trips: parseInt(document.getElementById('num-trips').value) || 50,

                    // Advanced inputs
                    manufacturer: document.getElementById('manufacturer')?.value,
                    aircraft_type: document.getElementById('aircraft-type')?.value,
                    multi_engine: document.getElementById('multi-engine')?.value,
                    min_crew: document.getElementById('min-crew')?.value,
                    max_altitude: document.getElementById('max-altitude')?.value,
                    balanced_field_length: document.getElementById('balanced-field-length')?.value,
                    aircraft_height: document.getElementById('aircraft-height')?.value,
                    aircraft_wingspan: document.getElementById('aircraft-wingspan')?.value,
                    aircraft_length: document.getElementById('aircraft-length')?.value,
                    cabin_height: document.getElementById('cabin-height')?.value,
                    cabin_width: document.getElementById('cabin-width')?.value,
                    cabin_length: document.getElementById('cabin-length')?.value,
                    baggage_volume: document.getElementById('baggage-volume')?.value,
                    speed_min: document.getElementById('speed-min')?.value,
                    depreciation_rate: parseFloat(document.getElementById('depreciation-rate').value) || 4,
                    jet_a_price: parseFloat(document.getElementById('jet-a-price').value) || 5.50,
                    avgas_price: parseFloat(document.getElementById('avgas-price').value) || 6.50,
                    planned_passengers: parseInt(document.getElementById('planned-passengers').value) || 4,
                    passenger_pay: parseFloat(document.getElementById('passenger-pay').value) || 0,
                    charter_trips: parseInt(document.getElementById('charter-trips').value) || 0,

                    // Fixed values
                    charter_rate: 50,
                    charter_trip_length: 600,
                    charter_profit: 50000
                };

                console.log('Financial inputs:', financialInputs);

                // Show loading animation
                const updateButton = document.getElementById('update-calculations');
                const originalText = updateButton.textContent;
                updateButton.textContent = 'Updating...';
                updateButton.disabled = true;

                // Add a visual indicator that calculations are being updated
                document.querySelectorAll('.financial-input-group').forEach(group => {
                    group.classList.add('updating');
                });

                // Store the current financial inputs in localStorage for persistence
                localStorage.setItem('financialInputs', JSON.stringify(financialInputs));

                console.log('Calling loadAircraftData()');

                // Use the loadAircraftData function to reload data with current filters and financial inputs
                loadAircraftData();

                // Reset button after a short delay
                setTimeout(() => {
                    updateButton.textContent = originalText;
                    updateButton.disabled = false;

                    // Remove the updating indicator
                    document.querySelectorAll('.financial-input-group').forEach(group => {
                        group.classList.remove('updating');
                    });

                    // Show success message
                    showToast('Calculations updated successfully', 'success');
                    console.log('Financial calculations update completed');
                }, 1000);
            }

        // Add filter
        function addFilter(key, value, label) {
                // Add to active filters
                activeFilters[key] = value;

                // Update filter badges
                renderFilterBadges();

                // Show active filters section
                document.getElementById('active-filters').classList.remove('d-none');

                // Reload aircraft data
                loadAircraftData();
            }

        // Remove filter
        function removeFilter(key) {
                // Remove from active filters
                delete activeFilters[key];

                // Update filter badges
                renderFilterBadges();

                // Hide active filters section if empty
                if (Object.keys(activeFilters).length === 0) {
                    document.getElementById('active-filters').classList.add('d-none');
                }

                // Reload aircraft data
                loadAircraftData();
            }

        // Render filter badges
        function renderFilterBadges() {
                const filterBadgesContainer = document.getElementById('filter-badges');

                // Clear existing badges
                filterBadgesContainer.innerHTML = '';

                // Create badges for each active filter
                Object.entries(activeFilters).forEach(([key, value]) => {
                    const badge = document.createElement('div');
                    badge.className = 'filter-badge animate__animated animate__fadeIn';

                    let label;
                    switch (key) {
                        case 'range_min':
                            label = `Range ≥ ${value} nm`;
                            break;
                        case 'passengers_min':
                            label = `Passengers ≥ ${value}`;
                            break;
                        case 'price_max':
                            label = `Price ≤ $${value}M`;
                            break;
                        case 'year_min':
                            label = `Year ≥ ${value}`;
                            break;
                        case 'speed_min':
                            label = `Speed ≥ ${value} kts`;
                            break;
                        case 'hourly_cost_max':
                            label = `Hourly Cost ≤ $${value}`;
                            break;
                        default:
                            label = `${key}: ${value}`;
                    }

                    badge.innerHTML = `
            ${label}
            <span class="close-btn" data-key="${key}">&times;</span>
        `;

                    filterBadgesContainer.appendChild(badge);
                });

                // Add event listeners to close buttons
                document.querySelectorAll('.filter-badge .close-btn').forEach(button => {
                    button.addEventListener('click', function () {
                        const key = this.dataset.key;
                        removeFilter(key);
                    });
                });
            }

        // Initialize GSAP animations
        function initAnimations() {
                // Animate header elements
                gsap.from("header .container", {
                    y: -50,
                    opacity: 0,
                    duration: 1,
                    ease: "power3.out"
                });

                // Animate cards on scroll
                gsap.registerPlugin(ScrollTrigger);

                gsap.utils.toArray('.card').forEach((card, i) => {
                    gsap.from(card, {
                        y: 50,
                        opacity: 0,
                        duration: 0.8,
                        delay: i * 0.1,
                        scrollTrigger: {
                            trigger: card,
                            start: "top bottom-=100",
                            toggleActions: "play none none none"
                        }
                    });
                });

                // Add hover animations for interactive elements
                document.querySelectorAll('.priority-btn').forEach(btn => {
                    btn.addEventListener('mouseenter', () => {
                        gsap.to(btn, {
                            y: -5,
                            duration: 0.2,
                            ease: "power1.out"
                        });
                    });

                    btn.addEventListener('mouseleave', () => {
                        if (!btn.classList.contains('active')) {
                            gsap.to(btn, {
                                y: 0,
                                duration: 0.2,
                                ease: "power1.out"
                            });
                        }
                    });
                });
            }

        // Function to reset financial inputs to default values
        function resetFinancialInputs() {
                console.log('Resetting financial inputs to defaults');

                // Reset basic inputs
                document.getElementById('year-min').value = '';
                document.getElementById('range-min').value = '';
                document.getElementById('passengers-min').value = '';
                document.getElementById('price-max').value = '';
                document.getElementById('years-ownership').value = '5';
                document.getElementById('num-trips').value = '50';

                // Reset multi-select inputs
                resetCustomDropdown('manufacturer-container', 'manufacturer');
                resetCustomDropdown('aircraft-type-container', 'aircraft-type');

                // Reset dropdown selects
                document.getElementById('multi-engine').value = '';
                document.getElementById('min-crew').value = '';

                // Reset advanced inputs
                document.getElementById('max-altitude').value = '';
                document.getElementById('balanced-field-length').value = '';
                document.getElementById('aircraft-height').value = '';
                document.getElementById('aircraft-wingspan').value = '';
                document.getElementById('aircraft-length').value = '';
                document.getElementById('cabin-height').value = '';
                document.getElementById('cabin-width').value = '';
                document.getElementById('cabin-length').value = '';
                document.getElementById('baggage-volume').value = '';
                document.getElementById('speed-min').value = '';
                document.getElementById('depreciation-rate').value = '4';
                document.getElementById('jet-a-price').value = '5.50';
                document.getElementById('avgas-price').value = '6.50';
                document.getElementById('planned-passengers').value = '4';
                document.getElementById('passenger-pay').value = '0';
                document.getElementById('charter-trips').value = '0';

                // Clear active filters
                activeFilters = {};

                // Reload aircraft data
                loadAircraftData();

                // Show toast notification
                showToast('Financial inputs reset to defaults', 'success');
            }

        // Function to reset a custom multi-select
        function resetCustomMultiSelect(containerId, inputId) {
                console.log(`Resetting custom multi-select: ${containerId}`);
                const container = document.getElementById(containerId);
                if (!container) return;

                const selectedOptionsContainer = container.querySelector('.selected-options');
                const optionItems = container.querySelectorAll('.option-item');
                const hiddenInput = document.getElementById(inputId);

                // Clear selected options display
                selectedOptionsContainer.innerHTML = '<span class="text-secondary">Select options...</span>';

                // Clear selected class from all options
                optionItems.forEach(option => {
                    option.classList.remove('selected');
                });

                // Clear multiSelectValues
                multiSelectValues[inputId] = [];

                // Clear hidden input value
                if (hiddenInput) {
                    hiddenInput.value = '';
                }

                // Function to update placeholder text
                function updatePlaceholderText() {
                    if (multiSelectValues[inputId].length === 0) {
                        selectedOptionsContainer.innerHTML = '<span class="text-secondary">Select options...</span>';
                    }
                }
            }

        // Function to setup event listeners
        function setupEventListeners() {
                console.log('Setting up event listeners');

                // Toggle advanced inputs
                const advancedInputsToggle = document.querySelector('[data-bs-target="#advancedInputs"]');
                if (advancedInputsToggle) {
                    advancedInputsToggle.addEventListener('click', function () {
                        const toggleText = this.querySelector('.toggle-text');
                        if (toggleText) {
                            if (this.getAttribute('aria-expanded') === 'true') {
                                toggleText.textContent = 'Hide';
                            } else {
                                toggleText.textContent = 'Show';
                            }
                        }
                    });
                }

                // Basic input fields
                const basicInputs = [
                    'year-min', 'range-min', 'passengers-min', 'price-max',
                    'years-ownership', 'num-trips'
                ];

                basicInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('change', function () {
                            loadAircraftData();
                        });
                    }
                });

                // Multi-select fields
                const multiSelects = [
                    'manufacturer', 'aircraft-type'
                ];

                multiSelects.forEach(inputId => {
                    const select = document.getElementById(inputId);
                    if (select) {
                        select.addEventListener('change', function () {
                            loadAircraftData();
                        });
                    }
                });

                // Dropdown select fields
                const dropdownSelects = [
                    'multi-engine', 'min-crew'
                ];

                dropdownSelects.forEach(inputId => {
                    const select = document.getElementById(inputId);
                    if (select) {
                        select.addEventListener('change', function () {
                            loadAircraftData();
                        });
                    }
                });

                // Other advanced input fields
                const advancedInputs = [
                    'max-altitude', 'balanced-field-length', 'aircraft-height',
                    'aircraft-wingspan', 'aircraft-length', 'cabin-height',
                    'cabin-width', 'cabin-length', 'baggage-volume',
                    'speed-min', 'depreciation-rate', 'jet-a-price',
                    'avgas-price', 'planned-passengers', 'passenger-pay',
                    'charter-trips'
                ];

                advancedInputs.forEach(inputId => {
                    const input = document.getElementById(inputId);
                    if (input) {
                        input.addEventListener('change', function () {
                            loadAircraftData();
                        });
                    }
                });

                // Airport search
                const airportSearch = document.getElementById('airport-search');
                const searchAirportBtn = document.getElementById('search-airport-btn');

                // Add debounce to prevent too many requests
                let searchTimeout;

                if (airportSearch) {
                    airportSearch.addEventListener('input', function () {
                        const query = this.value.trim();

                        // Clear previous timeout
                        clearTimeout(searchTimeout);

                        // Set new timeout to delay the search
                        searchTimeout = setTimeout(() => {
                            if (query) {
                                searchAirports(query);
                            } else {
                                document.getElementById('airport-results').classList.add('d-none');
                            }
                        }, 300); // 300ms delay
                    });

                    airportSearch.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            const query = this.value.trim();
                            if (query) {
                                searchAirports(query);
                            }
                            e.preventDefault();
                        }
                    });
                }

                if (searchAirportBtn) {
                    searchAirportBtn.addEventListener('click', function () {
                        const query = airportSearch.value.trim();
                        if (query) {
                            searchAirports(query);
                        }
                    });
                }

                // Clear filters button
                const clearFiltersBtn = document.getElementById('clear-filters');
                if (clearFiltersBtn) {
                    clearFiltersBtn.addEventListener('click', function () {
                        // Reset all filter inputs
                        resetFinancialInputs();

                        // Clear active filters
                        activeFilters = {};
                        document.getElementById('active-filters').classList.add('d-none');

                        // Reload aircraft data
                        loadAircraftData();

                        // Show success message
                        showToast('All filters cleared', 'info');
                    });
                }

                // Update calculations button
                const updateCalculationsBtn = document.getElementById('update-calculations');
                if (updateCalculationsBtn) {
                    console.log('Found update-calculations button, adding event listener');
                    updateCalculationsBtn.addEventListener('click', function () {
                        console.log('Update calculations button clicked');
                        updateFinancialCalculations();
                    });
                } else {
                    console.warn('Update calculations button not found');
                }

                // Reset financial inputs button
                const resetFinancialInputsBtn = document.getElementById('reset-financial-inputs');
                if (resetFinancialInputsBtn) {
                    resetFinancialInputsBtn.addEventListener('click', function () {
                        resetFinancialInputs();
                    });
                }

                // Location search (original functionality)
                const locationSearch = document.getElementById('location-search');
                if (locationSearch) {
                    locationSearch.addEventListener('keypress', function (e) {
                        if (e.key === 'Enter') {
                            const query = this.value.trim();
                            if (query && geocoder) {
                                geocoder.geocode({ address: query }, function (results, status) {
                                    if (status === 'OK' && results[0]) {
                                        const location = results[0].geometry.location;
                                        map.setCenter(location);

                                        // Update marker
                                        if (marker) {
                                            marker.setPosition(location);
                                        } else {
                                            marker = new google.maps.Marker({
                                                position: location,
                                                map: map,
                                                title: results[0].formatted_address
                                            });
                                        }

                                        // Update circle
                                        const radius = parseInt(document.getElementById('range-slider').value) * 1852; // Convert nm to meters
                                        if (circle) {
                                            circle.setCenter(location);
                                            circle.setRadius(radius);
                                        } else {
                                            circle = new google.maps.Circle({
                                                strokeColor: '#FF0000',
                                                strokeOpacity: 0.8,
                                                strokeWeight: 2,
                                                fillColor: '#FF0000',
                                                fillOpacity: 0.1,
                                                map: map,
                                                center: location,
                                                radius: radius
                                            });
                                        }
                                    }
                                });
                            }
                        }
                    });
                }

                // Add leg button
                const addLegBtn = document.getElementById('add-leg-btn');
                if (addLegBtn) {
                    addLegBtn.addEventListener('click', function () {
                        if (selectedAirport) {
                            addLegToRoute(selectedAirport);
                        } else {
                            showToast('Please select an airport first', 'warning');
                        }
                    });
                }

                // Clear legs button
                const clearLegsBtn = document.getElementById('clear-legs-btn');
                if (clearLegsBtn) {
                    clearLegsBtn.addEventListener('click', function () {
                        clearRouteLegs();
                    });
                }

                // Set current year in footer
                const currentYearElement = document.getElementById('current-year');
                if (currentYearElement) {
                    currentYearElement.textContent = new Date().getFullYear();
                }

                // From airport search
                const fromAirportInput = document.getElementById('from-airport');
                const fromAirportResults = document.getElementById('from-airport-results');
                const fromAirportList = document.getElementById('from-airport-list');
                const searchFromBtn = document.getElementById('search-from-btn');

                if (fromAirportInput) {
                    fromAirportInput.addEventListener('input', function () {
                        const query = this.value.trim();
                        if (query.length >= 2) {
                            searchAirports(query, fromAirportList, fromAirportResults, 'from');
                        } else {
                            fromAirportResults.classList.add('d-none');
                        }
                    });
                }

                if (searchFromBtn) {
                    searchFromBtn.addEventListener('click', function () {
                        const query = fromAirportInput.value.trim();
                        if (query.length >= 2) {
                            searchAirports(query, fromAirportList, fromAirportResults, 'from');
                        }
                    });
                }

                // To airport search
                const toAirportInput = document.getElementById('to-airport');
                const toAirportResults = document.getElementById('to-airport-results');
                const toAirportList = document.getElementById('to-airport-list');
                const searchToBtn = document.getElementById('search-to-btn');

                if (toAirportInput) {
                    toAirportInput.addEventListener('input', function () {
                        const query = this.value.trim();
                        if (query.length >= 2) {
                            searchAirports(query, toAirportList, toAirportResults, 'to');
                        } else {
                            toAirportResults.classList.add('d-none');
                        }
                    });
                }

                if (searchToBtn) {
                    searchToBtn.addEventListener('click', function () {
                        const query = toAirportInput.value.trim();
                        if (query.length >= 2) {
                            searchAirports(query, toAirportList, toAirportResults, 'to');
                        }
                    });
                }

                // Add route button
                const addRouteBtn = document.getElementById('add-route-btn');
                if (addRouteBtn) {
                    addRouteBtn.addEventListener('click', function () {
                        const fromAirport = selectedFromAirport;
                        const toAirport = selectedToAirport;

                        if (!fromAirport || !toAirport) {
                            showToast('Please select both airports', 'warning');
                            return;
                        }

                        if (fromAirport.iata === toAirport.iata) {
                            showToast('Please select different airports', 'warning');
                            return;
                        }

                        addRoutePair(fromAirport, toAirport);

                        // Clear inputs
                        fromAirportInput.value = '';
                        toAirportInput.value = '';
                        selectedFromAirport = null;
                        selectedToAirport = null;
                    });
                }

                // Clear routes button
                const clearRoutesBtn = document.getElementById('clear-routes-btn');
                if (clearRoutesBtn) {
                    clearRoutesBtn.addEventListener('click', function () {
                        clearAllRoutes();
                    });
                }

                // Toggle range circles
                const showRangesToggle = document.getElementById('show-ranges');
                if (showRangesToggle) {
                    showRangesToggle.addEventListener('change', function () {
                        toggleAircraftRanges(this.checked);
                    });
                }

                // Close airport results when clicking outside
                document.addEventListener('click', function (e) {
                    if (!e.target.closest('#from-airport-results') && !e.target.closest('#from-airport')) {
                        fromAirportResults.classList.add('d-none');
                    }
                    if (!e.target.closest('#to-airport-results') && !e.target.closest('#to-airport')) {
                        toAirportResults.classList.add('d-none');
                    }
                });
            }

        // Function to load saved financial inputs
        function loadSavedFinancialInputs() {
                const savedInputs = localStorage.getItem('financialInputs');

                // Set default values first
                document.getElementById('depreciation-rate').value = financialInputs.depreciationRate;
                document.getElementById('years-ownership').value = financialInputs.yearsOwnership;
                document.getElementById('jet-a-price').value = financialInputs.jetAPrice;
                document.getElementById('avgas-price').value = financialInputs.avgasPrice;
                document.getElementById('avg-trip-length').value = financialInputs.avgTripLength;
                document.getElementById('num-trips').value = financialInputs.numTrips;
                document.getElementById('planned-passengers').value = financialInputs.plannedPassengers;
                document.getElementById('passenger-pay').value = financialInputs.passengerPay;
                document.getElementById('charter-rate').value = financialInputs.charterRate;
                document.getElementById('charter-trip-length').value = financialInputs.charterTripLength;
                document.getElementById('charter-trips').value = financialInputs.charterTrips;
                document.getElementById('charter-profit').value = financialInputs.charterProfit;

                // Then override with saved values if they exist
                if (savedInputs) {
                    try {
                        const inputs = JSON.parse(savedInputs);

                        // Set input values from saved data
                        if (inputs.depreciation_rate) document.getElementById('depreciation-rate').value = inputs.depreciation_rate;
                        if (inputs.years_ownership) document.getElementById('years-ownership').value = inputs.years_ownership;
                        if (inputs.jet_a_price) document.getElementById('jet-a-price').value = inputs.jet_a_price;
                        if (inputs.avgas_price) document.getElementById('avgas-price').value = inputs.avgas_price;
                        if (inputs.avg_trip_length) document.getElementById('avg-trip-length').value = inputs.avg_trip_length;
                        if (inputs.num_trips) document.getElementById('num-trips').value = inputs.num_trips;
                        if (inputs.planned_passengers) document.getElementById('planned-passengers').value = inputs.planned_passengers;
                        if (inputs.passenger_pay) document.getElementById('passenger-pay').value = inputs.passenger_pay;
                        if (inputs.charter_rate) document.getElementById('charter-rate').value = inputs.charter_rate;
                        if (inputs.charter_trip_length) document.getElementById('charter-trip-length').value = inputs.charter_trip_length;
                        if (inputs.charter_trips) document.getElementById('charter-trips').value = inputs.charter_trips;
                        if (inputs.charter_profit) document.getElementById('charter-profit').value = inputs.charter_profit;

                        console.log('Loaded saved financial inputs:', inputs);
                    } catch (error) {
                        console.error('Error loading saved financial inputs:', error);
                    }
                } else {
                    console.log('No saved financial inputs found, using defaults');
                }
            }

        // Initialize custom multi-select inputs
        function initCustomMultiSelect() {
                console.log('Initializing custom multi-select inputs');

                // No more custom multi-select inputs to initialize
            }

        // Setup a single custom multi-select
        function setupCustomMultiSelect(containerId, inputId) {
                const container = document.getElementById(containerId);
                if (!container) return;

                const optionsList = container.querySelector('.options-list');
                const optionItems = container.querySelectorAll('.option-item');
                const selectedOptionsContainer = container.querySelector('.selected-options');
                const hiddenInput = document.getElementById(inputId);

                // Initialize with empty array if not already set
                if (!multiSelectValues[inputId]) {
                    multiSelectValues[inputId] = [];
                }

                // Add click handler to the container to handle focus
                container.addEventListener('click', function (e) {
                    // Prevent click from immediately closing the dropdown
                    e.stopPropagation();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!container.contains(e.target)) {
                        container.blur();
                    }
                });

                // Click handler for options
                optionItems.forEach(option => {
                    option.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const value = option.getAttribute('data-value');

                        // Toggle selection for the clicked option
                        if (option.classList.contains('selected')) {
                            // Remove from selection
                            option.classList.remove('selected');
                            multiSelectValues[inputId] = multiSelectValues[inputId].filter(v => v !== value);

                            // Remove from selected options display
                            const selectedOption = selectedOptionsContainer.querySelector(`[data-value="${value}"]`);
                            if (selectedOption) {
                                selectedOption.remove();
                            }
                        } else {
                            // Add to selection
                            option.classList.add('selected');
                            multiSelectValues[inputId].push(value);

                            // Add to selected options display
                            const selectedOption = document.createElement('div');
                            selectedOption.className = 'selected-option';
                            selectedOption.setAttribute('data-value', value);
                            selectedOption.innerHTML = `
                    ${value}
                    <span class="remove-option">&times;</span>
                `;
                            selectedOptionsContainer.appendChild(selectedOption);

                            // Add click handler to remove button
                            const removeBtn = selectedOption.querySelector('.remove-option');
                            removeBtn.addEventListener('click', (e) => {
                                e.stopPropagation();
                                // Remove from selection
                                option.classList.remove('selected');
                                multiSelectValues[inputId] = multiSelectValues[inputId].filter(v => v !== value);
                                selectedOption.remove();
                                updateHiddenInput();
                                updatePlaceholderText();
                                loadAircraftData();
                            });
                        }

                        // Update hidden input value
                        updateHiddenInput();

                        // Update the display text if no options selected
                        updatePlaceholderText();

                        // Trigger search update when selection changes
                        loadAircraftData();

                        // Keep the dropdown open after selection
                        e.preventDefault();
                    });
                });

                // Function to update hidden input with comma-separated values
                function updateHiddenInput() {
                    if (hiddenInput) {
                        hiddenInput.value = multiSelectValues[inputId].join(',');
                    }
                }

                // Function to update placeholder text
                function updatePlaceholderText() {
                    if (multiSelectValues[inputId].length === 0) {
                        selectedOptionsContainer.innerHTML = '<span class="text-secondary">Select options...</span>';
                    }
                }

                // Initialize placeholder text
                updatePlaceholderText();

                // Initialize selected options from existing values
                multiSelectValues[inputId].forEach(value => {
                    const option = Array.from(optionItems).find(opt => opt.getAttribute('data-value') === value);
                    if (option) {
                        option.classList.add('selected');

                        const selectedOption = document.createElement('div');
                        selectedOption.className = 'selected-option';
                        selectedOption.setAttribute('data-value', value);
                        selectedOption.innerHTML = `
                ${value}
                <span class="remove-option">&times;</span>
            `;
                        selectedOptionsContainer.appendChild(selectedOption);

                        const removeBtn = selectedOption.querySelector('.remove-option');
                        removeBtn.addEventListener('click', (e) => {
                            e.stopPropagation();
                            option.classList.remove('selected');
                            multiSelectValues[inputId] = multiSelectValues[inputId].filter(v => v !== value);
                            selectedOption.remove();
                            updateHiddenInput();
                            updatePlaceholderText();
                            loadAircraftData();
                        });
                    }
                });
            }

        // Initialize column selector
        function initColumnSelector() {
                console.log('Initializing column selector');

                const columnSelector = document.getElementById('column-selector');
                if (!columnSelector) return;

                // Define all available columns with user-friendly names
                const allColumns = [
                    { id: 'model', name: 'Model' },
                    { id: 'manufacturer', name: 'Manufacturer' },
                    { id: 'type', name: 'Type' },
                    { id: 'multiEngine', name: 'Multi Engine' },
                    { id: 'dateRange', name: 'Date Range' },
                    { id: 'minCrewRequired', name: 'Min Crew' },
                    { id: 'maxOperatingAltitude', name: 'Max Altitude' },
                    { id: 'balancedFieldLength', name: 'Field Length' },
                    { id: 'aircraftHeight', name: 'Height' },
                    { id: 'wingspan', name: 'Wingspan' },
                    { id: 'aircraftLength', name: 'Length' },
                    { id: 'aircraftVolume', name: 'Volume' },
                    { id: 'cabinHeight', name: 'Cabin Height' },
                    { id: 'cabinWidth', name: 'Cabin Width' },
                    { id: 'cabinLength', name: 'Cabin Length' },
                    { id: 'cabinVolume', name: 'Cabin Volume' },
                    { id: 'baggageVolume', name: 'Baggage Volume' },
                    { id: 'cabinAircraftVolumeRatio', name: 'Cabin/Aircraft Ratio' },
                    { id: 'range', name: 'Range' },
                    { id: 'cruiseSpeed', name: 'Speed' },
                    { id: 'passengers', name: 'Passengers' },
                    { id: 'price', name: 'Price' },
                    { id: 'speed_per_dollar', name: 'Speed/$' },
                    { id: 'range_per_dollar', name: 'Range/$' },
                    { id: 'annualCosts.total', name: 'Annual Cost' },
                    { id: 'columnCalculations.as', name: 'Multi-Year Cost' },
                    { id: 'annualCosts.fuel', name: 'Annual Fuel Cost' },
                    { id: 'columnCalculations.bd', name: 'Performance/$' },
                    { id: 'columnCalculations.bg', name: 'Efficiency/$' },
                    { id: 'columnCalculations.bj', name: 'All-Around/$' }
                ];

                // Create checkboxes for each column
                allColumns.forEach(column => {
                    const columnToggle = document.createElement('div');
                    columnToggle.className = 'column-toggle';

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `column-${column.id}`;
                    checkbox.checked = visibleColumns.has(column.id);

                    const label = document.createElement('label');
                    label.htmlFor = `column-${column.id}`;
                    label.textContent = column.name;

                    columnToggle.appendChild(checkbox);
                    columnToggle.appendChild(label);
                    columnSelector.appendChild(columnToggle);

                    // Add event listener
                    checkbox.addEventListener('change', () => {
                        if (checkbox.checked) {
                            visibleColumns.add(column.id);
                        } else {
                            visibleColumns.delete(column.id);
                        }
                        // Re-render the table with updated columns
                        renderAircraftTable();
                    });
                });
            }

        // Get values from custom multi-select
        function getMultiSelectValues(inputId) {
                return multiSelectValues[inputId] || [];
            }

        // Function to populate select elements with unique values
        function populateDataLists() {
                console.log('Populating select elements with unique values');

                // Populate manufacturer dropdown
                const manufacturerContainer = document.getElementById('manufacturer-container');
                if (manufacturerContainer) {
                    const optionsDropdown = manufacturerContainer.querySelector('.options-dropdown');

                    // Save the "Any" option if it exists
                    const anyOption = optionsDropdown.querySelector('.option-item[data-value=""]');

                    // Clear existing options
                    optionsDropdown.innerHTML = '';

                    // Add back the "Any" option
                    if (anyOption) {
                        optionsDropdown.appendChild(anyOption);
                    } else {
                        const option = document.createElement('div');
                        option.className = 'option-item';
                        option.setAttribute('data-value', '');
                        option.textContent = 'Any';
                        optionsDropdown.appendChild(option);
                    }

                    // Get unique manufacturers from the aircraft data
                    const uniqueManufacturers = [...new Set(aircraftData.map(aircraft => aircraft.manufacturer))].filter(Boolean).sort();

                    // Add options to the dropdown
                    uniqueManufacturers.forEach(manufacturer => {
                        const option = document.createElement('div');
                        option.className = 'option-item';
                        option.setAttribute('data-value', manufacturer);
                        option.textContent = manufacturer;
                        optionsDropdown.appendChild(option);
                    });

                    // Initialize the dropdown
                    setupCustomDropdown('manufacturer-container', 'manufacturer');
                }

                // Populate aircraft type dropdown
                const aircraftTypeContainer = document.getElementById('aircraft-type-container');
                if (aircraftTypeContainer) {
                    const optionsDropdown = aircraftTypeContainer.querySelector('.options-dropdown');

                    // Save the "Any" option if it exists
                    const anyOption = optionsDropdown.querySelector('.option-item[data-value=""]');

                    // Clear existing options
                    optionsDropdown.innerHTML = '';

                    // Add back the "Any" option
                    if (anyOption) {
                        optionsDropdown.appendChild(anyOption);
                    } else {
                        const option = document.createElement('div');
                        option.className = 'option-item';
                        option.setAttribute('data-value', '');
                        option.textContent = 'Any';
                        optionsDropdown.appendChild(option);
                    }

                    // Get unique aircraft types from the aircraft data
                    const uniqueTypes = [...new Set(aircraftData.map(aircraft => aircraft.type))].filter(Boolean).sort();

                    // Add options to the dropdown
                    uniqueTypes.forEach(type => {
                        const option = document.createElement('div');
                        option.className = 'option-item';
                        option.setAttribute('data-value', type);
                        option.textContent = type;
                        optionsDropdown.appendChild(option);
                    });

                    // Initialize the dropdown
                    setupCustomDropdown('aircraft-type-container', 'aircraft-type');
                }
            }

        // Setup a custom dropdown multi-select
        function setupCustomDropdown(containerId, inputId) {
                console.log(`Setting up custom dropdown for ${containerId}`);
                const container = document.getElementById(containerId);
                if (!container) {
                    console.error(`Container ${containerId} not found`);
                    return;
                }

                const selectedOptions = container.querySelector('.selected-options');
                const optionsDropdown = container.querySelector('.options-dropdown');
                const hiddenInput = container.querySelector('input[type="hidden"]');

                // Function to update the hidden input with selected values
                function updateHiddenInput() {
                    const selectedValues = Array.from(optionsDropdown.querySelectorAll('.option-item.selected'))
                        .map(option => option.getAttribute('data-value'))
                        .filter(value => value !== '');
                    hiddenInput.value = selectedValues.join(',');
                }

                // Function to update the placeholder text
                function updatePlaceholderText() {
                    const selectedItems = optionsDropdown.querySelectorAll('.option-item.selected');
                    if (selectedItems.length === 0) {
                        selectedOptions.innerHTML = '<span class="text-secondary">Select options...</span>';
                    } else {
                        selectedOptions.innerHTML = '';
                        selectedItems.forEach(item => {
                            const value = item.getAttribute('data-value');
                            if (value) {
                                const selectedOption = document.createElement('div');
                                selectedOption.className = 'selected-option';
                                selectedOption.innerHTML = `
                        ${item.textContent}
                        <span class="remove-option" data-value="${value}">×</span>
                    `;
                                selectedOptions.appendChild(selectedOption);
                            }
                        });
                    }
                }

                // Handle option selection
                optionsDropdown.addEventListener('click', function (e) {
                    const optionItem = e.target.closest('.option-item');
                    if (!optionItem) return;

                    const value = optionItem.getAttribute('data-value');
                    if (!value) return; // Skip the "Any" option

                    // Toggle selection
                    optionItem.classList.toggle('selected');

                    // If "Any" is selected, deselect all other options
                    if (value === '') {
                        optionsDropdown.querySelectorAll('.option-item.selected').forEach(item => {
                            if (item !== optionItem) {
                                item.classList.remove('selected');
                            }
                        });
                    } else {
                        // If a specific option is selected, deselect "Any"
                        const anyOption = optionsDropdown.querySelector('.option-item[data-value=""]');
                        if (anyOption) {
                            anyOption.classList.remove('selected');
                        }
                    }

                    updateHiddenInput();
                    updatePlaceholderText();
                    loadAircraftData(); // Reload data when selections change
                });

                // Handle removing selected options
                selectedOptions.addEventListener('click', function (e) {
                    const removeButton = e.target.closest('.remove-option');
                    if (!removeButton) return;

                    const value = removeButton.getAttribute('data-value');
                    const optionItem = optionsDropdown.querySelector(`.option-item[data-value="${value}"]`);
                    if (optionItem) {
                        optionItem.classList.remove('selected');
                        updateHiddenInput();
                        updatePlaceholderText();
                        loadAircraftData(); // Reload data when selections change
                    }
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', function (e) {
                    if (!container.contains(e.target)) {
                        container.classList.remove('open');
                    }
                });

                // Toggle dropdown
                container.addEventListener('click', function (e) {
                    if (e.target.closest('.remove-option')) return;
                    container.classList.toggle('open');
                });

                // Initialize the dropdown state
                updatePlaceholderText();
                updateHiddenInput();
            }

        // Function to reset a custom dropdown multi-select
        function resetCustomDropdown(containerId, inputId) {
                console.log(`Resetting custom dropdown: ${containerId}`);
                const container = document.getElementById(containerId);
                if (!container) return;

                const selectedOptionsContainer = container.querySelector('.selected-options');
                const optionItems = container.querySelectorAll('.option-item');
                const hiddenInput = document.getElementById(inputId);

                // Clear selected options display
                selectedOptionsContainer.innerHTML = '<span class="text-secondary">Select options...</span>';

                // Clear selected class from all options
                optionItems.forEach(option => {
                    option.classList.remove('selected');
                });

                // Clear multiSelectValues
                multiSelectValues[inputId] = [];

                // Clear hidden input value
                if (hiddenInput) {
                    hiddenInput.value = '';
                }
            }

        // Initialize custom dropdowns
        function initCustomDropdowns() {
                console.log('Initializing custom dropdowns');

                // Initialize manufacturer dropdown
                setupCustomDropdown('manufacturer-container', 'manufacturer');

                // Initialize aircraft type dropdown
                setupCustomDropdown('aircraft-type-container', 'aircraft-type');

                console.log('Custom dropdowns initialized');
            }

        // Add these variables at the top with other globals
        let selectedFromAirport = null;
        let selectedToAirport = null;
        let homeAirport = null;
        let rangeCircle = null;
    }
