{% extends "base.html" %}

{% block title %}Aircraft Scoring System - Jet Finder{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row justify-content-center">
        <div class="col-12 col-xl-10">
            <h1 class="text-center mb-4 text-white">
                <i class="fas fa-chart-line me-3"></i>Aircraft Scoring System
            </h1>
            <p class="text-center text-muted mb-5">
                Our advanced scoring system provides three distinct scores to help you find the perfect aircraft
            </p>

            <!-- Scoring Overview Cards -->
            <div class="row mb-5">
                <div class="col-md-4 mb-4">
                    <div class="card bg-dark border-info h-100">
                        <div class="card-header bg-info text-dark text-center">
                            <h4 class="mb-0"><i class="fas fa-star me-2"></i>Priority Score</h4>
                        </div>
                        <div class="card-body text-white">
                            <p class="card-text">How "attractive" the aircraft is compared to others of the same type.
                            </p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-cog me-2 text-info"></i>Engine hours remaining vs TBO</li>
                                <li><i class="fas fa-couch me-2 text-info"></i>Interior quality rating</li>
                                <li><i class="fas fa-microchip me-2 text-info"></i>Avionics sophistication</li>
                                <li><i class="fas fa-tools me-2 text-info"></i>Maintenance recency</li>
                                <li><i class="fas fa-palette me-2 text-info"></i>Paint condition</li>
                            </ul>
                            <small class="text-muted">Best listing of each type = 100, others scale down</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="card bg-dark border-success h-100">
                        <div class="card-header bg-success text-dark text-center">
                            <h4 class="mb-0"><i class="fas fa-clipboard-check me-2"></i>Data Score</h4>
                        </div>
                        <div class="card-body text-white">
                            <p class="card-text">How complete and trustworthy the listing information is.</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-percentage me-2 text-success"></i>% of fields completed</li>
                                <li><i class="fas fa-shield-alt me-2 text-success"></i>Verification status</li>
                                <li><i class="fas fa-images me-2 text-success"></i>Photos uploaded</li>
                                <li><i class="fas fa-file-alt me-2 text-success"></i>Maintenance logs</li>
                                <li><i class="fas fa-check-circle me-2 text-success"></i>FAA registry match</li>
                            </ul>
                            <small class="text-muted">Incentivizes sellers to complete their listings</small>
                        </div>
                    </div>
                </div>

                <div class="col-md-4 mb-4">
                    <div class="card bg-dark border-warning h-100">
                        <div class="card-header bg-warning text-dark text-center">
                            <h4 class="mb-0"><i class="fas fa-bullseye me-2"></i>Match Score</h4>
                        </div>
                        <div class="card-body text-white">
                            <p class="card-text">How well the listing fits your specific preferences.</p>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-clock me-2 text-warning"></i>Total hours preference</li>
                                <li><i class="fas fa-cog me-2 text-warning"></i>Engine hours remaining</li>
                                <li><i class="fas fa-microchip me-2 text-warning"></i>Avionics preference</li>
                                <li><i class="fas fa-couch me-2 text-warning"></i>Interior condition</li>
                                <li><i class="fas fa-calendar me-2 text-warning"></i>Maintenance recency</li>
                            </ul>
                            <small class="text-muted">Like Zillow's "great match" system</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Buyer Preferences Form -->
            <div class="card bg-dark border-secondary mb-5">
                <div class="card-header">
                    <h3 class="text-white mb-0"><i class="fas fa-sliders-h me-2"></i>Set Your Preferences</h3>
                    <small class="text-muted">Configure your preferences to get personalized match scores</small>
                </div>
                <div class="card-body">
                    <form id="buyerPreferencesForm">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxTotalHours" class="form-label text-white">Maximum Total Hours</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary"
                                    id="maxTotalHours" placeholder="e.g., 5000">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="minEngineHours" class="form-label text-white">Minimum Engine Hours
                                    Remaining</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary"
                                    id="minEngineHours" placeholder="e.g., 1500">
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="preferredAvionics" class="form-label text-white">Preferred Avionics</label>
                                <select class="form-select bg-dark text-white border-secondary" id="preferredAvionics">
                                    <option value="">No preference</option>
                                    <option value="g5000">Garmin G5000</option>
                                    <option value="g3000">Garmin G3000</option>
                                    <option value="pro line fusion">Collins Pro Line Fusion</option>
                                    <option value="g1000">Garmin G1000</option>
                                    <option value="pro line 21">Collins Pro Line 21</option>
                                </select>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="minInteriorRating" class="form-label text-white">Minimum Interior
                                    Rating</label>
                                <select class="form-select bg-dark text-white border-secondary" id="minInteriorRating">
                                    <option value="0">No preference</option>
                                    <option value="3">Good or better</option>
                                    <option value="4">Very Good or better</option>
                                    <option value="5">Excellent only</option>
                                </select>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxMaintenanceAge" class="form-label text-white">Max Maintenance Age
                                    (months)</label>
                                <input type="number" class="form-control bg-dark text-white border-secondary"
                                    id="maxMaintenanceAge" placeholder="e.g., 12">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="minPaintRating" class="form-label text-white">Minimum Paint Rating</label>
                                <select class="form-select bg-dark text-white border-secondary" id="minPaintRating">
                                    <option value="0">No preference</option>
                                    <option value="3">Good or better</option>
                                    <option value="4">Very Good or better</option>
                                    <option value="5">Excellent only</option>
                                </select>
                            </div>
                        </div>

                        <h5 class="text-white mt-4 mb-3">Priority Weights</h5>
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="engineWeight" class="form-label text-white">Engine Hours Weight</label>
                                <input type="range" class="form-range" id="engineWeight" min="0" max="1" step="0.1"
                                    value="0.2">
                                <span class="text-muted" id="engineWeightValue">20%</span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="interiorWeight" class="form-label text-white">Interior Weight</label>
                                <input type="range" class="form-range" id="interiorWeight" min="0" max="1" step="0.1"
                                    value="0.2">
                                <span class="text-muted" id="interiorWeightValue">20%</span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="avionicsWeight" class="form-label text-white">Avionics Weight</label>
                                <input type="range" class="form-range" id="avionicsWeight" min="0" max="1" step="0.1"
                                    value="0.2">
                                <span class="text-muted" id="avionicsWeightValue">20%</span>
                            </div>
                        </div>

                        <div class="text-center">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-save me-2"></i>Save Preferences & Calculate Scores
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsSection" class="d-none">
                <h3 class="text-white mb-4"><i class="fas fa-chart-bar me-2"></i>Scoring Results</h3>

                <!-- Summary Stats -->
                <div class="row mb-4" id="summaryStats">
                    <!-- Stats will be populated by JavaScript -->
                </div>

                <!-- Aircraft Results -->
                <div class="card bg-dark border-secondary">
                    <div class="card-header">
                        <h4 class="text-white mb-0">Top Aircraft Matches</h4>
                    </div>
                    <div class="card-body">
                        <div id="aircraftResults">
                            <!-- Results will be populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Loading State -->
            <div id="loadingState" class="text-center d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p class="text-white mt-3">Calculating scores...</p>
            </div>
        </div>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Update weight display values
        const weightInputs = ['engineWeight', 'interiorWeight', 'avionicsWeight'];
        weightInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            const display = document.getElementById(inputId + 'Value');

            input.addEventListener('input', function () {
                display.textContent = Math.round(this.value * 100) + '%';
            });
        });

        // Handle form submission
        document.getElementById('buyerPreferencesForm').addEventListener('submit', function (e) {
            e.preventDefault();
            saveBuyerPreferences();
        });
    });

    function saveBuyerPreferences() {
        const formData = {
            max_total_hours: parseInt(document.getElementById('maxTotalHours').value) || null,
            min_engine_hours_remaining: parseInt(document.getElementById('minEngineHours').value) || null,
            preferred_avionics: document.getElementById('preferredAvionics').value || null,
            min_interior_rating: parseInt(document.getElementById('minInteriorRating').value) || 0,
            max_maintenance_age_months: parseInt(document.getElementById('maxMaintenanceAge').value) || null,
            min_paint_rating: parseInt(document.getElementById('minPaintRating').value) || 0,
            engine_hours_weight: parseFloat(document.getElementById('engineWeight').value),
            interior_weight: parseFloat(document.getElementById('interiorWeight').value),
            avionics_weight: parseFloat(document.getElementById('avionicsWeight').value),
            maintenance_weight: 0.2,
            paint_weight: 0.2
        };

        // Show loading state
        document.getElementById('loadingState').classList.remove('d-none');
        document.getElementById('resultsSection').classList.add('d-none');

        // Save preferences
        fetch('/api/scoring/buyer-preferences', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(formData)
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Calculate match scores
                    return fetch('/api/scoring/match-scores', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        }
                    });
                } else {
                    throw new Error(data.error || 'Failed to save preferences');
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    displayResults(data);
                } else {
                    throw new Error(data.error || 'Failed to calculate scores');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error calculating scores: ' + error.message);
            })
            .finally(() => {
                document.getElementById('loadingState').classList.add('d-none');
            });
    }

    function displayResults(data) {
        // Show results section
        document.getElementById('resultsSection').classList.remove('d-none');

        // Display summary stats
        const summaryStats = document.getElementById('summaryStats');
        summaryStats.innerHTML = `
        <div class="col-md-4">
            <div class="card bg-info text-dark text-center">
                <div class="card-body">
                    <h5 class="card-title">${data.total_aircraft}</h5>
                    <p class="card-text">Total Aircraft Evaluated</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-success text-dark text-center">
                <div class="card-body">
                    <h5 class="card-title">${data.aircraft_matches.filter(a => a.match_score >= 85).length}</h5>
                    <p class="card-text">Excellent Matches (85%+)</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card bg-warning text-dark text-center">
                <div class="card-body">
                    <h5 class="card-title">${data.aircraft_matches.filter(a => a.match_score >= 75).length}</h5>
                    <p class="card-text">Very Good Matches (75%+)</p>
                </div>
            </div>
        </div>
    `;

        // Display aircraft results
        const aircraftResults = document.getElementById('aircraftResults');
        let resultsHTML = '<div class="row">';

        data.aircraft_matches.slice(0, 12).forEach(match => {
            const aircraft = match.aircraft;
            const badgeClass = getScoreBadgeClass(match.match_score);

            resultsHTML += `
            <div class="col-md-6 col-lg-4 mb-4">
                <div class="card bg-secondary h-100">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h6 class="mb-0 text-white">${aircraft.manufacturer || 'Unknown'} ${aircraft.model || 'Unknown'}</h6>
                        <span class="badge ${badgeClass}">${match.match_score}% Match</span>
                    </div>
                    <div class="card-body text-white">
                        <div class="row text-center mb-3">
                            <div class="col-4">
                                <small class="text-muted">Priority</small><br>
                                <strong>--</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Data</small><br>
                                <strong>--</strong>
                            </div>
                            <div class="col-4">
                                <small class="text-muted">Match</small><br>
                                <strong>${match.match_score}</strong>
                            </div>
                        </div>
                        <p class="mb-1"><strong>Year:</strong> ${aircraft.year || 'N/A'}</p>
                        <p class="mb-1"><strong>Price:</strong> $${(aircraft.price || 0).toLocaleString()}</p>
                        <p class="mb-1"><strong>Range:</strong> ${(aircraft.range || 0).toLocaleString()} nm</p>
                        <p class="mb-1"><strong>Passengers:</strong> ${aircraft.passengers || 'N/A'}</p>
                        <div class="mt-3">
                            <span class="badge bg-primary">${match.match_label}</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
        });

        resultsHTML += '</div>';
        aircraftResults.innerHTML = resultsHTML;
    }

    function getScoreBadgeClass(score) {
        if (score >= 95) return 'bg-success';
        if (score >= 85) return 'bg-info';
        if (score >= 75) return 'bg-warning';
        if (score >= 65) return 'bg-primary';
        return 'bg-secondary';
    }
</script>
{% endblock %}