<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jet Marketplace - Listings</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Google Fonts - Modern Sharp Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;500;600;700&family=Orbitron:wght@400;500;600;700;800;900&display=swap"
        rel="stylesheet">
    <!-- Animation Library -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Leaflet CSS (placed before our custom CSS) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <!-- Custom CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/marketplace/listings.css') }}">
    <script>
        // Set global variables for use in JS files
        window.jetFinderUrl = "{{ jet_finder_url }}";
    </script>
</head>

<body class="bg-black text-white">
    <!-- Video Background -->
    <div class="video-background">
        <video autoplay muted loop id="sky-video">
            <source src="{{ url_for('static', filename='videos/sky_background.mp4') }}" type="video/mp4">
            Your browser does not support the video tag.
        </video>
        <div class="video-overlay"></div>
    </div>

    <header class="bg-black p-3 shadow-sm position-relative">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <img src="{{ url_for('static', filename='images/jetschool-logo2.png') }}" alt="Jetschool"
                    class="img-fluid" style="max-height: 60px;">
                <nav>
                    <ul class="nav">
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{{ url_for('home') }}">Jet Finder</a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link text-danger" href="{{ url_for('marketplace.listings') }}">Marketplace</a>
                        </li>
                        {% if current_user.is_authenticated %}
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle text-white" href="#" id="navbarDropdown" role="button"
                                data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="fas fa-user-circle me-1"></i> {{ current_user.first_name }}
                            </a>
                            <ul class="dropdown-menu dropdown-menu-dark dropdown-menu-end"
                                aria-labelledby="navbarDropdown">
                                <li><a class="dropdown-item" href="{{ url_for('marketplace.dashboard') }}">Dashboard</a>
                                </li>
                                <li><a class="dropdown-item" href="{{ url_for('marketplace.my_listings') }}">My
                                        Listings</a></li>
                                <li><a class="dropdown-item" href="{{ url_for('marketplace.saved_listings') }}">Saved
                                        Listings</a></li>
                                <li>
                                    <hr class="dropdown-divider">
                                </li>
                                <li><a class="dropdown-item" href="{{ url_for('marketplace.logout') }}">Logout</a></li>
                            </ul>
                        </li>
                        {% else %}
                        <li class="nav-item">
                            <a class="nav-link text-white" href="{{ url_for('marketplace.login') }}">Login</a>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <!-- Remove toggle button and replace with integrated title -->
    <div class="container-fluid py-2 bg-dark border-bottom border-danger sticky-top">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h5 class="m-0 text-white">Integrated Aircraft Marketplace & Jet Finder</h5>
                </div>
                <div>
                    <span class="badge bg-danger">All-In-One Tool</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Jet Finder Section (always visible) -->
    <div id="jet-finder-section" class="py-4 position-relative bg-black">
        <div class="container">
            <div class="row">
                <div class="col-lg-6">
                    <div class="card bg-dark mb-4">
                        <div class="card-header bg-black">
                            <h5 class="mb-0 text-white">Range Calculator</h5>
                        </div>
                        <div class="card-body">
                            <div class="mb-3">
                                <label class="form-label text-white">Home Airport</label>
                                <div class="input-group">
                                    <input type="text" id="home-airport-search"
                                        class="form-control bg-black text-white border-secondary"
                                        placeholder="Search airports...">
                                    <button class="btn btn-outline-danger" id="search-home-btn">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div id="home-airport-results" class="position-absolute w-100 z-3 mt-1 d-none">
                                    <div class="list-group" id="home-airport-list">
                                        <!-- Airport results will be added here -->
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label text-white">Range (NM)</label>
                                <input type="range" class="form-range" id="range-slider" min="0" max="8000" step="100"
                                    value="1000">
                                <div class="d-flex justify-content-between">
                                    <span class="text-secondary">0</span>
                                    <span id="range-value" class="text-danger">1,000 NM</span>
                                    <span class="text-secondary">8,000</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="card bg-dark mb-4">
                        <div class="card-header bg-black">
                            <h5 class="mb-0 text-white">Trip Planner</h5>
                        </div>
                        <div class="card-body">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label class="form-label text-white">From Airport</label>
                                    <div class="input-group">
                                        <input type="text" id="from-airport"
                                            class="form-control bg-black text-white border-secondary"
                                            placeholder="Origin">
                                        <button class="btn btn-outline-danger" id="search-from-btn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div id="from-airport-results" class="position-absolute w-100 z-3 mt-1 d-none">
                                        <div class="list-group" id="from-airport-list">
                                            <!-- Results will be added here -->
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label text-white">To Airport</label>
                                    <div class="input-group">
                                        <input type="text" id="to-airport"
                                            class="form-control bg-black text-white border-secondary"
                                            placeholder="Destination">
                                        <button class="btn btn-outline-danger" id="search-to-btn">
                                            <i class="fas fa-search"></i>
                                        </button>
                                    </div>
                                    <div id="to-airport-results" class="position-absolute w-100 z-3 mt-1 d-none">
                                        <div class="list-group" id="to-airport-list">
                                            <!-- Results will be added here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button id="add-route-btn" class="btn btn-danger">
                                    <i class="fas fa-plus me-2"></i> Add Route
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-6">
                    <div class="card bg-dark" style="height: 100%;">
                        <div class="card-header bg-black">
                            <h5 class="mb-0 text-white">Map View</h5>
                        </div>
                        <div class="card-body p-0">
                            <div id="map" style="height: 500px;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Interactive Aircraft Finder -->
    <section class="py-4 position-relative bg-dark">
        <div class="container">
            <div class="text-center mb-4">
                <h2 class="display-5 fw-bold text-white">Find Your Perfect Aircraft</h2>
                <p class="lead text-secondary">Tell us your needs and we'll recommend the best options</p>
            </div>

            <form id="aircraft-finder-form" action="{{ url_for('marketplace.listings') }}" method="get" class="mb-4">
                <!-- Hidden inputs for Jet Finder data -->
                <input type="hidden" id="home_airport" name="home_airport" value="{{ criteria.home_airport }}">
                <input type="hidden" id="trip_origin" name="trip_origin" value="{{ criteria.trip_origin }}">
                <input type="hidden" id="trip_destination" name="trip_destination"
                    value="{{ criteria.trip_destination }}">
                <input type="hidden" id="sort" name="sort" value="{{ sort_by }}">

                <div class="row g-3">
                    <div class="col-md-6 col-lg-3">
                        <label for="budget" class="form-label text-white">Budget (USD)</label>
                        <select class="form-select bg-black text-white border-secondary" id="budget" name="budget">
                            <option value="5000000" {% if criteria.budget=='5000000' %}selected{% endif %}>Up to $5M
                            </option>
                            <option value="10000000" {% if criteria.budget=='10000000' %}selected{% endif %}>Up to $10M
                            </option>
                            <option value="20000000" {% if criteria.budget=='20000000' %}selected{% endif %}>Up to $20M
                            </option>
                            <option value="50000000" {% if criteria.budget=='50000000' %}selected{% endif %}>Up to $50M
                            </option>
                            <option value="100000000" {% if criteria.budget=='100000000' %}selected{% endif %}>$50M+
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="min_range" class="form-label text-white">Minimum Range (NM)</label>
                        <select class="form-select bg-black text-white border-secondary" id="min_range"
                            name="min_range">
                            <option value="0" {% if criteria.min_range=='0' %}selected{% endif %}>Any Range</option>
                            <option value="1000" {% if criteria.min_range=='1000' %}selected{% endif %}>1,000+ NM
                            </option>
                            <option value="2000" {% if criteria.min_range=='2000' %}selected{% endif %}>2,000+ NM
                            </option>
                            <option value="3000" {% if criteria.min_range=='3000' %}selected{% endif %}>3,000+ NM
                            </option>
                            <option value="4000" {% if criteria.min_range=='4000' %}selected{% endif %}>4,000+ NM
                            </option>
                            <option value="5000" {% if criteria.min_range=='5000' %}selected{% endif %}>5,000+ NM
                            </option>
                        </select>
                        <small class="text-secondary"><i class="fas fa-link me-1"></i> Connected to Range
                            Calculator</small>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label for="min_speed" class="form-label text-white">Min. Speed (KTAS)</label>
                        <select class="form-select bg-black text-white border-secondary" id="min_speed"
                            name="min_speed">
                            <option value="0" {% if criteria.min_speed=='0' %}selected{% endif %}>Any Speed</option>
                            <option value="300" {% if criteria.min_speed=='300' %}selected{% endif %}>300+ KTAS</option>
                            <option value="400" {% if criteria.min_speed=='400' %}selected{% endif %}>400+ KTAS</option>
                            <option value="450" {% if criteria.min_speed=='450' %}selected{% endif %}>450+ KTAS</option>
                            <option value="500" {% if criteria.min_speed=='500' %}selected{% endif %}>500+ KTAS</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label for="pax" class="form-label text-white">Passengers</label>
                        <select class="form-select bg-black text-white border-secondary" id="pax" name="pax">
                            <option value="4" {% if criteria.pax=='4' %}selected{% endif %}>4+ Passengers</option>
                            <option value="6" {% if criteria.pax=='6' %}selected{% endif %}>6+ Passengers</option>
                            <option value="8" {% if criteria.pax=='8' %}selected{% endif %}>8+ Passengers</option>
                            <option value="10" {% if criteria.pax=='10' %}selected{% endif %}>10+ Passengers</option>
                            <option value="14" {% if criteria.pax=='14' %}selected{% endif %}>14+ Passengers</option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-2">
                        <label for="purpose" class="form-label text-white">Primary Purpose</label>
                        <select class="form-select bg-black text-white border-secondary" id="purpose" name="purpose">
                            <option value="business" {% if criteria.purpose=='business' %}selected{% endif %}>Business
                            </option>
                            <option value="leisure" {% if criteria.purpose=='leisure' %}selected{% endif %}>Leisure
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3">
                        <label for="category" class="form-label text-white">Aircraft Type</label>
                        <select class="form-select bg-black text-white border-secondary" id="category" name="category">
                            <option value="" {% if criteria.category=='' %}selected{% endif %}>All Types</option>
                            <option value="jet" {% if criteria.category=='jet' %}selected{% endif %}>Jets</option>
                            <option value="turboprop" {% if criteria.category=='turboprop' %}selected{% endif %}>
                                Turboprops</option>
                            <option value="piston" {% if criteria.category=='piston' %}selected{% endif %}>Piston
                            </option>
                        </select>
                    </div>
                    <div class="col-md-6 col-lg-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-danger w-100">
                            <i class="fas fa-search me-2"></i> Find Aircraft
                        </button>
                    </div>
                </div>
            </form>
        </div>
    </section>

    {% if top_recommendation %}
    <!-- Top Recommendation Section -->
    <section class="py-4 position-relative highlight-section">
        <div class="container">
            <div class="text-center mb-4">
                <h3 class="text-white">Your Top Recommendation</h3>
                <p class="text-secondary">Based on your criteria</p>
            </div>
            <div class="row">
                <div class="col-lg-8 offset-lg-2">
                    <div class="card top-recommendation bg-dark border-danger h-100 animate__animated animate__pulse">
                        <div class="card-header position-relative p-0">
                            <img src="{{ top_recommendation.listing.images[0]|aircraft_image }}"
                                alt="{{ top_recommendation.listing.title }}" class="card-img-top recommendation-image">
                            <span class="badge bg-danger position-absolute top-0 start-0 m-2">Top Pick</span>
                            <span class="badge bg-success position-absolute top-0 end-0 m-2">{{
                                top_recommendation.score|int }}% Match</span>
                        </div>
                        <div class="card-body">
                            <h4 class="text-white mb-2">{{ top_recommendation.listing.title }}</h4>
                            <p class="text-danger fw-bold mb-2">${{ '{:,}'.format(top_recommendation.listing.price) }}
                            </p>
                            <div class="specs">
                                <span class="text-white"><i class="fas fa-plane-departure me-1"></i> {{
                                    top_recommendation.listing.total_time }} Hours</span>
                                <span class="text-white"><i class="fas fa-tachometer-alt me-1"></i> {{
                                    top_recommendation.listing.max_speed }} KTAS</span>
                                <span class="text-white"><i class="fas fa-route me-1"></i> {{
                                    top_recommendation.listing.range }} NM</span>
                                <span class="text-white"><i class="fas fa-users me-1"></i> {{
                                    top_recommendation.listing.seats }} PAX</span>
                            </div>
                            <div class="mt-3">
                                <h6 class="text-white">Why This Aircraft:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="fas fa-check-circle text-success me-2"></i> Perfect match for your
                                        requirements</li>
                                    <li><i class="fas fa-check-circle text-success me-2"></i> Offers excellent value and
                                        performance</li>
                                </ul>
                            </div>

                            <!-- Add value metrics to top recommendation -->
                            <div class="mt-3 border-top border-secondary pt-3">
                                <h6 class="text-white">Cost & Value Analysis:</h6>
                                <div class="row g-2">
                                    <div class="col-6">
                                        <div class="bg-black rounded p-2 text-center">
                                            <small class="text-secondary d-block">5-Year Total</small>
                                            <span class="text-danger fw-bold">${{
                                                '{:,.0f}'.format(top_recommendation['metrics']['five_year_cost'])
                                                }}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-black rounded p-2 text-center">
                                            <small class="text-secondary d-block">Hourly Cost</small>
                                            <span class="text-danger fw-bold">${{
                                                '{:,.0f}'.format(top_recommendation['metrics']['hourly_cost']) }}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-black rounded p-2 text-center">
                                            <small class="text-secondary d-block">Efficiency</small>
                                            <span class="text-danger fw-bold">{{
                                                '{:.1f}'.format(top_recommendation['metrics']['efficiency']) }}</span>
                                        </div>
                                    </div>
                                    <div class="col-6">
                                        <div class="bg-black rounded p-2 text-center">
                                            <small class="text-secondary d-block">Performance</small>
                                            <span class="text-danger fw-bold">{{
                                                '{:.1f}'.format(top_recommendation['metrics']['performance']) }}</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-footer bg-black d-flex justify-content-between align-items-center">
                            <button class="btn btn-sm btn-outline-danger jet-finder-btn"
                                data-aircraft="{{ top_recommendation.listing.model|lower|replace(' ', '-') }}">
                                <i class="fas fa-calculator me-1"></i> Cost Analysis
                            </button>
                            <a href="{{ url_for('marketplace.listing_detail', listing_id=top_recommendation.listing.id) }}"
                                class="btn btn-sm btn-danger">
                                View Details
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
    {% endif %}

    <!-- All Listings Section -->
    <section class="py-4 position-relative">
        <div class="container">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h4 class="mb-0 text-white">{{ listings|length }} Aircraft Matching Your Criteria</h4>
                <div class="d-flex align-items-center">
                    <label class="text-white me-2">Sort by:</label>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="sort-select">
                        <option value="match" {% if sort_by=='match' %}selected{% endif %}>Best Match</option>
                        <option value="price_low" {% if sort_by=='price_low' %}selected{% endif %}>Price: Low to High
                        </option>
                        <option value="price_high" {% if sort_by=='price_high' %}selected{% endif %}>Price: High to Low
                        </option>
                        <option value="year_new" {% if sort_by=='year_new' %}selected{% endif %}>Year: Newest First
                        </option>
                        <option value="year_old" {% if sort_by=='year_old' %}selected{% endif %}>Year: Oldest First
                        </option>
                        <option value="range_high" {% if sort_by=='range_high' %}selected{% endif %}>Range: Highest
                            First</option>
                        <option value="speed_high" {% if sort_by=='speed_high' %}selected{% endif %}>Speed: Fastest
                            First</option>
                        <option value="efficiency" {% if sort_by=='efficiency' %}selected{% endif %}>Efficiency
                            (Range/$)</option>
                        <option value="performance" {% if sort_by=='performance' %}selected{% endif %}>Performance
                            (Speed/$)</option>
                        <option value="all_around" {% if sort_by=='all_around' %}selected{% endif %}>All-Around Value
                        </option>
                    </select>
                </div>
            </div>

            <div class="row" id="listings-container">
                {% for listing in listings %}
                <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card listing-card bg-dark h-100 animate__animated animate__fadeIn"
                        data-price="{{ listing.price }}" data-year="{{ listing.year }}">
                        <div class="card-header position-relative p-0">
                            <img src="{{ listing.images[0]|aircraft_image }}" alt="{{ listing.title }}"
                                class="card-img-top listing-image">
                            {% if listing.featured %}
                            <span class="badge bg-danger position-absolute top-0 start-0 m-2">Featured</span>
                            {% endif %}
                            <span class="badge bg-secondary position-absolute top-0 end-0 m-2">{{
                                listing.category|capitalize }}</span>
                            <button class="btn btn-sm btn-outline-light position-absolute top-0 end-0 m-2 favorite-btn"
                                data-listing-id="{{ listing.id }}">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h5 class="text-white">{{ listing.title }}</h5>
                            <p class="text-danger fw-bold mb-2">${{ '{:,}'.format(listing.price) }}</p>
                            <div class="specs">
                                <span class="text-white"><i class="fas fa-plane-departure me-1"></i> {{
                                    listing.total_time }} Hours</span>
                                <span class="text-white"><i class="fas fa-tachometer-alt me-1"></i> {{ listing.max_speed
                                    }} KTAS</span>
                                <span class="text-white"><i class="fas fa-route me-1"></i> {{ listing.range }} NM</span>
                                <span class="text-white"><i class="fas fa-users me-1"></i> {{ listing.seats }}
                                    PAX</span>
                            </div>

                            <!-- Add value metrics -->
                            <div class="mt-2 mb-2">
                                <small class="text-secondary">5-Year Total Cost Estimate:</small>
                                <span class="d-block text-danger">${{
                                    '{:,.0f}'.format(recommendation_scores[listing.id]['metrics']['five_year_cost'])
                                    }}</span>

                                <div class="progress mt-1 bg-dark" style="height: 8px;">
                                    <div class="progress-bar bg-danger" role="progressbar"
                                        style="width: {{ recommendation_scores[listing.id]['score'] }}%;"
                                        aria-valuenow="{{ recommendation_scores[listing.id]['score']|int }}"
                                        aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <small class="text-secondary">Match Score: {{
                                        recommendation_scores[listing.id]['score']|int }}%</small>
                                    <small class="text-secondary">Value: {{
                                        recommendation_scores[listing.id]['metrics']['all_around']|int }}</small>
                                </div>
                            </div>

                            <p class="text-secondary small mt-2">{{ listing.description|truncate(100) }}</p>
                        </div>
                        <div
                            class="card-footer bg-dark border-top border-secondary d-flex justify-content-between align-items-center">
                            <a href="{{ url_for('marketplace.listing_detail', listing_id=listing.id) }}"
                                class="btn btn-sm btn-outline-danger">
                                View Details
                            </a>
                            <button class="btn btn-sm btn-outline-light jet-finder-btn"
                                data-aircraft="{{ listing.model|lower|replace(' ', '-') }}">
                                <i class="fas fa-calculator me-1"></i> Cost Analysis
                            </button>
                            <div class="btn-group">
                                <button class="btn btn-sm btn-outline-secondary favorite-btn"
                                    data-listing-id="{{ listing.id }}">
                                    <i class="far fa-heart"></i>
                                </button>
                                <button class="btn btn-sm btn-outline-secondary share-btn"
                                    data-share-url="{{ url_for('marketplace.listing_detail', listing_id=listing.id, _external=True) }}"
                                    data-share-title="{{ listing.title }}">
                                    <i class="fas fa-share"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            {% if not listings %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-secondary mb-3"></i>
                <h4 class="text-white">No aircraft match your criteria</h4>
                <p class="text-secondary">Try adjusting your search parameters</p>
            </div>
            {% endif %}

            <!-- Pagination -->
            {% if listings|length > 12 %}
            <nav aria-label="Listing pagination" class="mt-4">
                <ul class="pagination justify-content-center">
                    <li class="page-item disabled">
                        <a class="page-link bg-dark text-white border-secondary" href="#" tabindex="-1"
                            aria-disabled="true">Previous</a>
                    </li>
                    <li class="page-item active"><a class="page-link bg-danger border-danger" href="#">1</a></li>
                    <li class="page-item"><a class="page-link bg-dark text-white border-secondary" href="#">2</a></li>
                    <li class="page-item"><a class="page-link bg-dark text-white border-secondary" href="#">3</a></li>
                    <li class="page-item">
                        <a class="page-link bg-dark text-white border-secondary" href="#">Next</a>
                    </li>
                </ul>
            </nav>
            {% endif %}
        </div>
    </section>

    <footer class="bg-transparent p-3 border-top border-secondary mt-4 position-relative">
        <div class="container text-center text-white">
            <p class="m-0">Â© <span id="current-year"></span> JETSCHOOL. All rights reserved.</p>
        </div>
    </footer>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/marketplace/listings.js') }}"></script>
    <script>
        document.getElementById('current-year').textContent = new Date().getFullYear();

        // Favorite button toggle with backend persistence
        document.querySelectorAll('.favorite-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const icon = this.querySelector('i');
                const listingId = this.getAttribute('data-listing-id');
                const isFavorite = icon.classList.contains('fas');
                try {
                    const endpoint = isFavorite ? '{{ url_for("marketplace.remove_favorite") }}' : '{{ url_for("marketplace.add_favorite") }}';
                    const resp = await fetch(endpoint, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ listing_id: listingId })
                    });
                    const data = await resp.json();
                    if (resp.ok && data.success) {
                        if (isFavorite) {
                            icon.classList.remove('fas');
                            icon.classList.add('far');
                            icon.style.color = '';
                        } else {
                            icon.classList.remove('far');
                            icon.classList.add('fas');
                            icon.style.color = '#F05545';
                        }
                    } else if (resp.status === 401) {
                        window.location.href = '{{ url_for("marketplace.login") }}';
                    } else {
                        alert(data.message || 'Unable to update favorites');
                    }
                } catch (e) {
                    alert('Network error updating favorites');
                }
            });
        });

        // Share button using universal share helper
        document.querySelectorAll('.share-btn').forEach(btn => {
            btn.addEventListener('click', async function () {
                const url = this.getAttribute('data-share-url');
                const title = this.getAttribute('data-share-title');
                if (window.universalShare) {
                    await window.universalShare({ title, url });
                } else if (navigator.share) {
                    await navigator.share({ title, url });
                } else {
                    await navigator.clipboard.writeText(url);
                    alert('Link copied to clipboard');
                }
            });
        });

        // Jet Finder integration
        document.querySelectorAll('.jet-finder-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const aircraft = this.getAttribute('data-aircraft');
                // Logic to open Jet Finder with this aircraft pre-selected would go here
                window.location.href = "{{ jet_finder_url }}?aircraft=" + aircraft;
            });
        });

        // Sorting functionality
        document.getElementById('sort-select').addEventListener('change', function () {
            const container = document.getElementById('listings-container');
            const listings = Array.from(container.children);
            const sortValue = this.value;

            listings.sort((a, b) => {
                const itemA = a.querySelector('.listing-card');
                const itemB = b.querySelector('.listing-card');

                if (sortValue === 'price_low') {
                    return parseFloat(itemA.dataset.price) - parseFloat(itemB.dataset.price);
                } else if (sortValue === 'price_high') {
                    return parseFloat(itemB.dataset.price) - parseFloat(itemA.dataset.price);
                } else if (sortValue === 'year_new') {
                    return parseFloat(itemB.dataset.year) - parseFloat(itemA.dataset.year);
                } else if (sortValue === 'year_old') {
                    return parseFloat(itemA.dataset.year) - parseFloat(itemB.dataset.year);
                }
                return 0;
            });

            // Clear container and append sorted items
            container.innerHTML = '';
            listings.forEach(listing => container.appendChild(listing));
        });

        document.addEventListener('DOMContentLoaded', function () {
            // Handle sort select change
            const sortSelect = document.getElementById('sort-select');
            if (sortSelect) {
                sortSelect.addEventListener('change', function () {
                    // Get current URL
                    const url = new URL(window.location.href);

                    // Update or add the sort parameter
                    url.searchParams.set('sort', this.value);

                    // Navigate to the new URL
                    window.location.href = url.toString();
                });
            }
        });

        // Range slider functionality
        const rangeSlider = document.getElementById('range-slider');
        const rangeValue = document.getElementById('range-value');

        if (rangeSlider && rangeValue) {
            rangeSlider.addEventListener('input', function () {
                const value = this.value;
                rangeValue.textContent = value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",") + ' NM';
                // If we had the full Jet Finder JS, would call updateRangeCircles(value) here
            });
        }

        // Load Jet Finder script conditionally
        function loadJetFinderScript() {
            if (document.getElementById('jet-finder-script')) return;

            const script = document.createElement('script');
            script.id = 'jet-finder-script';
            script.src = "{{ url_for('static', filename='js/script.js') }}";
            document.body.appendChild(script);
        }

        // Optional: Load Jet Finder CSS
        function loadJetFinderCSS() {
            if (document.getElementById('jet-finder-css')) return;

            const link = document.createElement('link');
            link.id = 'jet-finder-css';
            link.rel = 'stylesheet';
            link.href = "{{ url_for('static', filename='css/jetfinder.css') }}";
            document.head.appendChild(link);
        }
    </script>
</body>

</html>