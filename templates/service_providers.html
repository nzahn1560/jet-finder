{% extends "base.html" %}

{% block title %}Service Providers - Jet Finder{% endblock %}

{% block additional_css %}
<style>
    .service-provider-card {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.02), rgba(0, 0, 0, 0.8));
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 24px;
        margin-bottom: 20px;
        transition: all 0.3s ease;
        cursor: pointer;
        position: relative;
    }

    .service-provider-card:hover {
        border-color: #F05545;
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(240, 85, 69, 0.2);
    }

    .match-score {
        position: absolute;
        top: 15px;
        right: 15px;
        background: linear-gradient(135deg, #10b981, #047857);
        color: white;
        padding: 8px 12px;
        border-radius: 50px;
        font-weight: 700;
        font-size: 0.9rem;
    }

    .rating-stars {
        color: #fbbf24;
        font-size: 1.1rem;
    }

    .specialty-badge {
        background: rgba(240, 85, 69, 0.1);
        color: #F05545;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }

    .certification-badge {
        background: rgba(16, 185, 129, 0.1);
        color: #10b981;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
        margin-right: 8px;
        margin-bottom: 8px;
        display: inline-block;
    }

    .parts-available {
        background: rgba(59, 130, 246, 0.1);
        color: #3b82f6;
        padding: 8px 16px;
        border-radius: 8px;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .finder-form {
        background: linear-gradient(145deg, rgba(255, 255, 255, 0.03), rgba(0, 0, 0, 0.7));
        border-radius: 16px;
        padding: 30px;
        margin-bottom: 30px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .form-control {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        color: white;
        padding: 12px 16px;
    }

    .form-control:focus {
        background: rgba(255, 255, 255, 0.08);
        border-color: #F05545;
        box-shadow: 0 0 0 3px rgba(240, 85, 69, 0.1);
        color: white;
    }

    .btn-primary {
        background: linear-gradient(135deg, #F05545, #d44437);
        border: none;
        padding: 12px 30px;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-primary:hover {
        background: linear-gradient(135deg, #d44437, #F05545);
        transform: translateY(-2px);
    }

    .urgency-high {
        background: #ef4444;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }

    .urgency-normal {
        background: #10b981;
        color: white;
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 600;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-5">
    <div class="row">
        <div class="col-12 text-center mb-5">
            <h1 class="display-4 text-white mb-3">Service Providers & Parts</h1>
            <p class="lead text-muted">Find the perfect maintenance provider and parts for your aircraft</p>
        </div>
    </div>

    <!-- AI Service Finder Form -->
    <div class="row mb-5">
        <div class="col-lg-10 mx-auto">
            <div class="finder-form">
                <h3 class="text-white mb-4">AI Service & Parts Finder</h3>
                <form id="service-finder-form">
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-white">Aircraft Type</label>
                            <select class="form-control" id="aircraft-type">
                                <option value="">Select your aircraft</option>
                                <option value="Citation CJ3+">Citation CJ3+</option>
                                <option value="Citation Sovereign+">Citation Sovereign+</option>
                                <option value="Citation Latitude">Citation Latitude</option>
                                <option value="Gulfstream G650">Gulfstream G650</option>
                                <option value="Challenger 350">Challenger 350</option>
                                <option value="Legacy 450">Legacy 450</option>
                                <option value="Falcon 2000LXS">Falcon 2000LXS</option>
                                <option value="King Air 350i">King Air 350i</option>
                                <option value="PC-12 NGX">PC-12 NGX</option>
                            </select>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label text-white">Service Type</label>
                            <select class="form-control" id="service-type">
                                <option value="">What do you need?</option>
                                <option value="Annual Inspection">Annual Inspection</option>
                                <option value="Engine Overhaul">Engine Overhaul</option>
                                <option value="Avionics Upgrade">Avionics Upgrade</option>
                                <option value="Paint Services">Paint Services</option>
                                <option value="Interior Refurbishment">Interior Refurbishment</option>
                                <option value="Pre-Purchase Inspection">Pre-Purchase Inspection</option>
                                <option value="Emergency Repair">Emergency Repair</option>
                                <option value="Line Maintenance">Line Maintenance</option>
                                <option value="Modification">Modification</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-white">Urgency</label>
                            <select class="form-control" id="urgency">
                                <option value="normal">Normal</option>
                                <option value="emergency">Emergency (AOG)</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-white">Budget Priority</label>
                            <select class="form-control" id="budget-priority">
                                <option value="balanced">Balanced</option>
                                <option value="low_cost">Lowest Cost</option>
                                <option value="premium">Premium Service</option>
                            </select>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label text-white">Location</label>
                            <input type="text" class="form-control" id="location" placeholder="City or Airport Code">
                        </div>
                        <div class="col-12 mb-3">
                            <label class="form-label text-white">Specific Parts Needed (optional)</label>
                            <input type="text" class="form-control" id="parts-needed"
                                placeholder="e.g., Engine starter, Avionics display, Landing gear">
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary btn-lg">
                                <i class="fas fa-magic me-2"></i>Find Best Matches
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Search and Sort Controls -->
    <div class="row mb-4">
        <div class="col-md-6">
            <input type="text" class="form-control" id="search-input" placeholder="Search providers...">
        </div>
        <div class="col-md-6">
            <select class="form-control" id="sort-select">
                <option value="match">Best Match</option>
                <option value="rating">Highest Rated</option>
                <option value="cost">Lowest Cost</option>
                <option value="experience">Most Experience</option>
                <option value="proximity">Nearest Location</option>
            </select>
        </div>
    </div>

    <!-- Service Providers Grid -->
    <div class="row">
        <div class="col-12">
            <h3 class="text-white mb-4">Service Providers</h3>
            <div id="providers-grid">
                <!-- Provider cards will be populated here -->
            </div>
        </div>
    </div>
</div>

<script>
    let serviceProviders = [];
    let partsInventory = {};
    let aircraftPartsMapping = {};
    let filteredProviders = [];
    let currentUserNeeds = {};

    // Load data when page loads
    document.addEventListener('DOMContentLoaded', function () {
        loadServiceData();
        setupEventListeners();
    });

    async function loadServiceData() {
        try {
            // Load service providers
            const providersResponse = await fetch('/static/data/service_providers.json');
            const providersData = await providersResponse.json();
            serviceProviders = Object.values(providersData);

            // Load parts catalog
            const partsResponse = await fetch('/static/data/parts_catalog.json');
            partsInventory = await partsResponse.json();

            // Load aircraft parts mapping
            const mappingResponse = await fetch('/static/data/aircraft_parts_mapping.json');
            aircraftPartsMapping = await mappingResponse.json();

            filteredProviders = [...serviceProviders];
            renderProvidersGrid();

        } catch (error) {
            console.error('Error loading service data:', error);
            // Fallback to sample data
            serviceProviders = getSampleProviders();
            filteredProviders = [...serviceProviders];
            renderProvidersGrid();
        }
    }

    function setupEventListeners() {
        // AI Service Finder form
        document.getElementById('service-finder-form').addEventListener('submit', function (e) {
            e.preventDefault();
            performAIMatching();
        });

        // Search functionality
        document.getElementById('search-input').addEventListener('input', function () {
            const searchQuery = this.value.toLowerCase();
            filterProviders(searchQuery);
        });

        // Sort functionality
        document.getElementById('sort-select').addEventListener('change', function () {
            sortProviders(this.value);
        });
    }

    function performAIMatching() {
        const userNeeds = {
            aircraft_type: document.getElementById('aircraft-type').value,
            service_type: document.getElementById('service-type').value,
            urgency: document.getElementById('urgency').value,
            budget_priority: document.getElementById('budget-priority').value,
            location: document.getElementById('location').value,
            parts_needed_text: document.getElementById('parts-needed').value
        };

        if (!userNeeds.aircraft_type) {
            alert('Please select your aircraft type for better matching');
            return;
        }

        currentUserNeeds = userNeeds;

        // Parse parts needed
        if (userNeeds.parts_needed_text) {
            userNeeds.parts_needed = parsePartsNeeded(userNeeds.parts_needed_text, userNeeds.aircraft_type);
        }

        // Calculate match scores
        filteredProviders = serviceProviders.map(provider => ({
            ...provider,
            matchScore: calculateMatchScore(userNeeds, provider)
        })).sort((a, b) => b.matchScore - a.matchScore);

        renderProvidersGrid();

        // Scroll to results
        document.getElementById('providers-grid').scrollIntoView({ behavior: 'smooth' });
    }

    function parsePartsNeeded(partsText, aircraftType) {
        const text = partsText.toLowerCase();
        const relevantParts = aircraftPartsMapping[aircraftType] || [];
        const matchedParts = [];

        // Simple keyword matching for demo
        for (const partNum of relevantParts) {
            const part = partsInventory[partNum];
            if (!part) continue;

            const partName = part.name.toLowerCase();
            const partCategory = part.category.toLowerCase();

            if (text.includes(partName) || text.includes(partCategory) ||
                text.includes('engine') && partCategory.includes('engine') ||
                text.includes('avionics') && partCategory.includes('avionics') ||
                text.includes('landing') && partCategory.includes('landing') ||
                text.includes('gear') && partCategory.includes('landing')) {
                matchedParts.push(partNum);
            }
        }

        return matchedParts;
    }

    function calculateMatchScore(userNeeds, provider) {
        let score = 100;

        // Aircraft type matching
        if (userNeeds.aircraft_type) {
            const aircraftSpecialties = {
                'citation': ['Citation Specialist', 'Textron Authorized'],
                'gulfstream': ['Gulfstream Specialist', 'Gulfstream Authorized'],
                'challenger': ['Bombardier Specialist', 'Bombardier Authorized'],
                'king air': ['King Air Specialist', 'Beechcraft Authorized'],
                'falcon': ['Falcon Specialist', 'Dassault Authorized'],
                'legacy': ['Embraer Specialist', 'Embraer Authorized'],
                'pc-12': ['Pilatus Specialist', 'Pilatus Authorized']
            };

            const aircraftLower = userNeeds.aircraft_type.toLowerCase();
            let matchingSpecialties = [];

            for (const [aircraft, specialties] of Object.entries(aircraftSpecialties)) {
                if (aircraftLower.includes(aircraft)) {
                    matchingSpecialties = specialties;
                    break;
                }
            }

            const providerSpecs = [...provider.specialties, ...provider.certifications];
            if (matchingSpecialties.some(spec => providerSpecs.includes(spec))) {
                score += 25;
            } else {
                score -= 15;
            }
        }

        // Service type matching
        if (userNeeds.service_type) {
            if (provider.specialties.includes(userNeeds.service_type)) {
                score += 20;
            }
        }

        // Parts availability
        if (userNeeds.parts_needed && userNeeds.parts_needed.length > 0) {
            const availableParts = userNeeds.parts_needed.filter(part =>
                provider.parts_inventory.includes(part)
            ).length;

            if (availableParts > 0) {
                score += (availableParts / userNeeds.parts_needed.length) * 30;
            } else {
                score -= 10;
            }
        }

        // Rating bonus
        score += (provider.average_rating - 3.0) * 10;

        // Experience bonus
        score += Math.min(provider.years_in_business * 0.5, 15);

        // Budget consideration
        if (userNeeds.budget_priority === 'low_cost') {
            if (provider.hourly_rate < 170) score += 15;
            else if (provider.hourly_rate < 190) score += 10;
            else if (provider.hourly_rate > 200) score -= 10;
        } else if (userNeeds.budget_priority === 'premium') {
            if (provider.hourly_rate > 190) score += 10;
        }

        // Urgency handling
        if (userNeeds.urgency === 'emergency') {
            if (provider.certifications.includes('24/7 Service') ||
                provider.specialties.includes('AOG Service') ||
                provider.specialties.includes('Emergency Repair')) {
                score += 20;
            } else {
                score -= 5;
            }
        }

        return Math.max(0, Math.min(100, Math.round(score)));
    }

    function filterProviders(searchQuery) {
        if (!searchQuery) {
            filteredProviders = [...serviceProviders];
        } else {
            filteredProviders = serviceProviders.filter(provider =>
                provider.name.toLowerCase().includes(searchQuery) ||
                provider.location.toLowerCase().includes(searchQuery) ||
                provider.specialties.some(spec => spec.toLowerCase().includes(searchQuery)) ||
                provider.certifications.some(cert => cert.toLowerCase().includes(searchQuery))
            );
        }

        renderProvidersGrid();
    }

    function sortProviders(sortBy) {
        switch (sortBy) {
            case 'rating':
                filteredProviders.sort((a, b) => b.average_rating - a.average_rating);
                break;
            case 'cost':
                filteredProviders.sort((a, b) => a.hourly_rate - b.hourly_rate);
                break;
            case 'experience':
                filteredProviders.sort((a, b) => b.years_in_business - a.years_in_business);
                break;
            case 'proximity':
                // Would need actual distance calculation in real implementation
                filteredProviders.sort((a, b) => a.location.localeCompare(b.location));
                break;
            case 'match':
            default:
                filteredProviders.sort((a, b) => (b.matchScore || 0) - (a.matchScore || 0));
                break;
        }

        renderProvidersGrid();
    }

    function renderProvidersGrid() {
        const grid = document.getElementById('providers-grid');

        if (filteredProviders.length === 0) {
            grid.innerHTML = `
            <div class="text-center py-5">
                <h4 class="text-muted">No service providers found</h4>
                <p class="text-muted">Try adjusting your search criteria</p>
            </div>
        `;
            return;
        }

        grid.innerHTML = filteredProviders.map(provider => `
        <div class="service-provider-card">
            ${provider.matchScore ? `<div class="match-score">${provider.matchScore}% Match</div>` : ''}
            
            <div class="row">
                <div class="col-md-8">
                    <h4 class="text-white mb-2">${provider.name}</h4>
                    <div class="mb-3">
                        <i class="fas fa-map-marker-alt text-danger me-2"></i>
                        <span class="text-white">${provider.location}</span>
                        <span class="text-muted ms-3">${provider.service_radius} mile radius</span>
                    </div>
                    
                    <div class="mb-3">
                        <div class="rating-stars me-2">
                            ${'★'.repeat(Math.floor(provider.average_rating))}${'☆'.repeat(5 - Math.floor(provider.average_rating))}
                        </div>
                        <span class="text-white">${provider.average_rating} (${provider.total_reviews} reviews)</span>
                        <span class="text-muted ms-3">${provider.years_in_business} years in business</span>
                    </div>
                    
                    <div class="mb-3">
                        <strong class="text-white">Specialties:</strong><br>
                        ${provider.specialties.map(spec => `<span class="specialty-badge">${spec}</span>`).join('')}
                    </div>
                    
                    <div class="mb-3">
                        <strong class="text-white">Certifications:</strong><br>
                        ${provider.certifications.map(cert => `<span class="certification-badge">${cert}</span>`).join('')}
                    </div>
                    
                    <div class="mb-3">
                        <span class="parts-available">
                            <i class="fas fa-cog me-1"></i>${provider.parts_inventory.length} Parts in Stock
                        </span>
                    </div>
                </div>
                
                <div class="col-md-4 text-end">
                    <div class="mb-3">
                        <div class="text-white h5">$${provider.hourly_rate}/hour</div>
                        <small class="text-muted">Labor rate</small>
                    </div>
                    
                    ${currentUserNeeds.urgency === 'emergency' ?
                `<div class="mb-3">
                            <span class="${provider.certifications.includes('24/7 Service') ? 'urgency-normal' : 'urgency-high'}">
                                ${provider.certifications.includes('24/7 Service') ? 'Emergency Ready' : 'Standard Hours'}
                            </span>
                        </div>` : ''
            }
                    
                    <button class="btn btn-primary mb-2 w-100" onclick="contactProvider('${provider.id}')">
                        <i class="fas fa-phone me-1"></i>Contact Now
                    </button>
                    <button class="btn btn-outline-light w-100" onclick="viewProviderDetails('${provider.id}')">
                        <i class="fas fa-info-circle me-1"></i>View Details
                    </button>
                </div>
            </div>
        </div>
    `).join('');
    }

    function contactProvider(providerId) {
        const provider = serviceProviders.find(p => p.id === providerId);
        const message = currentUserNeeds.aircraft_type ?
            `Contact request for ${currentUserNeeds.aircraft_type} ${currentUserNeeds.service_type || 'service'}` :
            'Service inquiry from Jet Finder';

        alert(`Contacting ${provider.name}\\n\\nPhone: ${provider.contact_info.phone}\\nEmail: ${provider.contact_info.email}\\n\\n${message}`);
    }

    function viewProviderDetails(providerId) {
        const provider = serviceProviders.find(p => p.id === providerId);
        console.log('Provider details:', provider);
        // This would open a detailed modal or navigate to provider detail page
    }

    function getSampleProviders() {
        // Fallback sample data if JSON files not available
        return [
            {
                id: "SP001",
                name: "Elite Aviation Services",
                location: "Van Nuys, CA",
                specialties: ["Engine Overhaul", "Avionics Upgrade", "Annual Inspection"],
                certifications: ["FAA Part 145", "EASA 145"],
                years_in_business: 25,
                average_rating: 4.8,
                total_reviews: 156,
                hourly_rate: 185,
                parts_inventory: ["ENG001", "AVI001", "LG002"],
                service_radius: 100,
                contact_info: { "phone": "(818) 555-0123", "email": "service@eliteaviation.com" }
            }
        ];
    }
</script>
{% endblock %}