<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Airport Search Debug</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #2b2b2b;
            color: white;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
        }

        input {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px;
            width: 300px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .results {
            background-color: #333;
            border: 1px solid #555;
            max-height: 300px;
            overflow-y: auto;
            width: 320px;
            display: none;
            border-radius: 4px;
            margin-top: 5px;
        }

        .airport-item {
            padding: 10px;
            border-bottom: 1px solid #555;
            cursor: pointer;
        }

        .airport-item:hover {
            background-color: #444;
        }

        .airport-item:last-child {
            border-bottom: none;
        }

        .debug-log {
            background-color: #1a1a1a;
            border: 1px solid #555;
            padding: 10px;
            margin-top: 20px;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
        }

        button {
            background-color: #F05545;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }

        button:hover {
            background-color: #d63b2b;
        }

        .error {
            color: #ff6b6b;
            background-color: #2d1b1b;
            border: 1px solid #ff6b6b;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }

        .success {
            color: #51cf66;
            background-color: #1b2d1b;
            border: 1px solid #51cf66;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>üîç Airport Search Debug Tool</h1>

        <div>
            <h3>Test Home Airport Search (ID: home-airport-search)</h3>
            <input type="text" id="home-airport-search" placeholder="Type LAX, SFO, JFK..." />
            <button id="search-home-btn">üîç Search</button>

            <div id="home-airport-results" class="results">
                <div id="home-airport-list"></div>
            </div>

            <div id="home-airport-error" class="error" style="display: none;">
                <span id="home-airport-error-text">Error message will appear here</span>
            </div>
        </div>

        <div>
            <h3>Test Controls</h3>
            <button onclick="testAPI()">üß™ Test API Directly</button>
            <button onclick="testDOMElements()">üîç Check DOM Elements</button>
            <button onclick="clearLog()">üßπ Clear Log</button>
        </div>

        <div id="debug-log" class="debug-log">Debug log will appear here...\n</div>
    </div>

    <script>
        let debugLog = document.getElementById('debug-log');

        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            debugLog.textContent += `[${timestamp}] ${message}\n`;
            debugLog.scrollTop = debugLog.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            debugLog.textContent = 'Debug log cleared...\n';
        }

        function testAPI() {
            log('Testing API directly...');
            fetch('/api/airports?q=LAX')
                .then(response => {
                    log(`API Response Status: ${response.status}`);
                    return response.json();
                })
                .then(data => {
                    log(`API Response Data: ${JSON.stringify(data, null, 2)}`);
                    if (data.length > 0) {
                        log('‚úÖ API is working correctly!');
                    } else {
                        log('‚ö†Ô∏è API returned empty results');
                    }
                })
                .catch(error => {
                    log(`‚ùå API Error: ${error.message}`);
                });
        }

        function testDOMElements() {
            log('Testing DOM elements...');

            const elements = {
                'home-airport-search': document.getElementById('home-airport-search'),
                'search-home-btn': document.getElementById('search-home-btn'),
                'home-airport-results': document.getElementById('home-airport-results'),
                'home-airport-list': document.getElementById('home-airport-list'),
                'home-airport-error': document.getElementById('home-airport-error'),
                'home-airport-error-text': document.getElementById('home-airport-error-text')
            };

            for (const [id, element] of Object.entries(elements)) {
                if (element) {
                    log(`‚úÖ Found element: ${id}`);
                } else {
                    log(`‚ùå Missing element: ${id}`);
                }
            }
        }

        function searchHomeAirport(query, resultsList, resultsContainer) {
            log(`searchHomeAirport called with query: "${query}"`);

            if (!query.trim()) {
                resultsContainer.style.display = 'none';
                document.getElementById('home-airport-error').style.display = 'none';
                return;
            }

            if (query.length < 2) {
                const errorDiv = document.getElementById('home-airport-error');
                const errorText = document.getElementById('home-airport-error-text');
                if (errorDiv && errorText) {
                    errorText.textContent = 'Please enter at least 2 characters to search for airports';
                    errorDiv.style.display = 'block';
                }
                resultsContainer.style.display = 'none';
                return;
            }

            resultsList.innerHTML = '<div class="airport-item">üîÑ Searching airports...</div>';
            resultsContainer.style.display = 'block';

            // Hide any previous error
            document.getElementById('home-airport-error').style.display = 'none';

            log(`Fetching: /api/airports?q=${encodeURIComponent(query)}`);

            fetch(`/api/airports?q=${encodeURIComponent(query)}`)
                .then(response => {
                    log(`Response status: ${response.status}`);
                    if (!response.ok) {
                        throw new Error(`Server error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(airports => {
                    log(`Received ${airports.length} airports`);
                    resultsList.innerHTML = '';

                    if (airports.length === 0) {
                        resultsList.innerHTML = '<div class="airport-item">‚ùå No airports found</div>';

                        const errorDiv = document.getElementById('home-airport-error');
                        const errorText = document.getElementById('home-airport-error-text');
                        if (errorDiv && errorText) {
                            errorText.textContent = `No airports found for "${query}". Try searching by IATA code (LAX), ICAO code (KLAX), or city name (Los Angeles).`;
                            errorDiv.style.display = 'block';
                        }
                        return;
                    }

                    airports.forEach(airport => {
                        const item = document.createElement('div');
                        item.className = 'airport-item';
                        item.innerHTML = `
                            <div><strong>${airport.iata || 'N/A'}</strong> - ${airport.icao || 'N/A'}</div>
                            <div>${airport.name}</div>
                            <small>${airport.city}, ${airport.country}</small>
                        `;

                        item.addEventListener('click', function () {
                            log(`Selected airport: ${airport.iata} - ${airport.name}`);
                            document.getElementById('home-airport-search').value = `${airport.iata} - ${airport.city}`;
                            resultsContainer.style.display = 'none';
                        });

                        resultsList.appendChild(item);
                    });

                    log('‚úÖ Airport results displayed successfully');
                })
                .catch(error => {
                    log(`‚ùå Error searching airports: ${error.message}`);
                    resultsList.innerHTML = '<div class="airport-item">‚ùå Error loading airports</div>';

                    const errorDiv = document.getElementById('home-airport-error');
                    const errorText = document.getElementById('home-airport-error-text');
                    if (errorDiv && errorText) {
                        errorText.textContent = `Failed to search airports: ${error.message}. Please check your internet connection and try again.`;
                        errorDiv.style.display = 'block';
                    }
                });
        }

        // Setup event listeners
        document.addEventListener('DOMContentLoaded', function () {
            log('üöÄ Page loaded, setting up event listeners...');

            const homeAirportInput = document.getElementById('home-airport-search');
            const searchHomeBtn = document.getElementById('search-home-btn');
            const homeAirportResults = document.getElementById('home-airport-results');
            const homeAirportList = document.getElementById('home-airport-list');

            if (homeAirportInput) {
                log('‚úÖ Setting up input event listener');
                homeAirportInput.addEventListener('input', function () {
                    log(`Input changed: "${this.value}"`);
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchHomeAirport(query, homeAirportList, homeAirportResults);
                    } else {
                        homeAirportResults.style.display = 'none';
                    }
                });
            } else {
                log('‚ùå Could not find home-airport-search input');
            }

            if (searchHomeBtn) {
                log('‚úÖ Setting up search button event listener');
                searchHomeBtn.addEventListener('click', function () {
                    const query = homeAirportInput.value.trim();
                    log(`Search button clicked with query: "${query}"`);
                    if (query.length >= 2) {
                        searchHomeAirport(query, homeAirportList, homeAirportResults);
                    } else {
                        log('Query too short, need at least 2 characters');
                    }
                });
            } else {
                log('‚ùå Could not find search-home-btn button');
            }

            log('üéØ Event listeners setup complete!');
            testDOMElements();
        });
    </script>
</body>

</html>