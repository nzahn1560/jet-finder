<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Buy Aircraft - Jet Finder</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
    <style>
        .aircraft-card {
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
        }

        .aircraft-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .search-sticky {
            position: sticky;
            top: 20px;
            background: white;
            z-index: 100;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }

        .tab-content {
            min-height: 600px;
        }

        .quick-filter {
            cursor: pointer;
            transition: all 0.2s;
        }

        .quick-filter:hover {
            background-color: #f8f9fa;
        }

        .quick-filter.active {
            background-color: #0d6efd;
            color: white;
        }
    </style>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container">
            <a class="navbar-brand" href="/">
                <i class="bi bi-airplane"></i> Jet Finder
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link active" href="/buy-aircraft">Buy Aircraft</a>
                <a class="nav-link" href="/services-parts">Services & Parts</a>
                <a class="nav-link" href="/charter">Charter</a>
                <a class="nav-link" href="/stock-market">Stock Market</a>
            </div>
        </div>
    </nav>

    <div class="container-fluid py-4" x-data="aircraftBuyer()">
        <div class="row">
            <!-- Left Sidebar - Search & Filters -->
            <div class="col-lg-3">
                <div class="search-sticky p-4">
                    <h4 class="mb-3"><i class="bi bi-search"></i> Find Your Aircraft</h4>

                    <!-- Universal Search -->
                    <div class="mb-3">
                        <input type="text" class="form-control form-control-lg"
                            placeholder="Search aircraft, manufacturer, model..." x-model="searchQuery"
                            @input="debounceSearch()">
                    </div>

                    <!-- Quick Filters -->
                    <div class="mb-4">
                        <h6>Quick Filters</h6>
                        <div class="d-flex flex-wrap gap-2">
                            <span class="badge quick-filter"
                                :class="selectedCategory === 'all' ? 'active' : 'bg-light text-dark'"
                                @click="setCategory('all')">All</span>
                            <span class="badge quick-filter"
                                :class="selectedCategory === 'light' ? 'active' : 'bg-light text-dark'"
                                @click="setCategory('light')">Light Jets</span>
                            <span class="badge quick-filter"
                                :class="selectedCategory === 'midsize' ? 'active' : 'bg-light text-dark'"
                                @click="setCategory('midsize')">Midsize</span>
                            <span class="badge quick-filter"
                                :class="selectedCategory === 'heavy' ? 'active' : 'bg-light text-dark'"
                                @click="setCategory('heavy')">Heavy Jets</span>
                        </div>
                    </div>

                    <!-- Advanced Filters -->
                    <div class="accordion" id="filtersAccordion">
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#priceFilter">
                                    Price Range
                                </button>
                            </h2>
                            <div id="priceFilter" class="accordion-collapse collapse"
                                data-bs-parent="#filtersAccordion">
                                <div class="accordion-body">
                                    <div class="row">
                                        <div class="col-6">
                                            <label class="form-label">Min Price</label>
                                            <select class="form-select" x-model="filters.minPrice">
                                                <option value="">Any</option>
                                                <option value="1000000">$1M+</option>
                                                <option value="5000000">$5M+</option>
                                                <option value="10000000">$10M+</option>
                                                <option value="25000000">$25M+</option>
                                            </select>
                                        </div>
                                        <div class="col-6">
                                            <label class="form-label">Max Price</label>
                                            <select class="form-select" x-model="filters.maxPrice">
                                                <option value="">Any</option>
                                                <option value="5000000">$5M</option>
                                                <option value="10000000">$10M</option>
                                                <option value="25000000">$25M</option>
                                                <option value="50000000">$50M</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#specsFilter">
                                    Specifications
                                </button>
                            </h2>
                            <div id="specsFilter" class="accordion-collapse collapse"
                                data-bs-parent="#filtersAccordion">
                                <div class="accordion-body">
                                    <div class="mb-3">
                                        <label class="form-label">Year Range</label>
                                        <div class="row">
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="From"
                                                    x-model="filters.yearFrom">
                                            </div>
                                            <div class="col-6">
                                                <input type="number" class="form-control" placeholder="To"
                                                    x-model="filters.yearTo">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Passengers</label>
                                        <select class="form-select" x-model="filters.passengers">
                                            <option value="">Any</option>
                                            <option value="4">4+</option>
                                            <option value="6">6+</option>
                                            <option value="8">8+</option>
                                            <option value="12">12+</option>
                                        </select>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Range (nm)</label>
                                        <select class="form-select" x-model="filters.range">
                                            <option value="">Any</option>
                                            <option value="1000">1,000+</option>
                                            <option value="2000">2,000+</option>
                                            <option value="3000">3,000+</option>
                                            <option value="5000">5,000+</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Saved Searches -->
                    <div class="mt-4">
                        <h6>Saved Searches</h6>
                        <div class="list-group list-group-flush">
                            <template x-for="search in savedSearches">
                                <a href="#" class="list-group-item list-group-item-action py-2"
                                    @click="loadSavedSearch(search)" x-text="search.name"></a>
                            </template>
                        </div>
                        <button class="btn btn-outline-primary btn-sm mt-2" @click="saveCurrentSearch()">
                            <i class="bi bi-bookmark"></i> Save Current Search
                        </button>
                    </div>
                </div>
            </div>

            <!-- Main Content Area -->
            <div class="col-lg-9">
                <!-- Results Header -->
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2>Aircraft for Sale</h2>
                    <div class="d-flex gap-2">
                        <select class="form-select" x-model="sortBy" @change="loadAircraft()">
                            <option value="price_asc">Price: Low to High</option>
                            <option value="price_desc">Price: High to Low</option>
                            <option value="year_desc">Newest First</option>
                            <option value="year_asc">Oldest First</option>
                            <option value="match_score">Best Match</option>
                        </select>
                        <div class="btn-group" role="group">
                            <button type="button" class="btn btn-outline-secondary"
                                :class="viewMode === 'grid' ? 'active' : ''" @click="viewMode = 'grid'">
                                <i class="bi bi-grid"></i>
                            </button>
                            <button type="button" class="btn btn-outline-secondary"
                                :class="viewMode === 'list' ? 'active' : ''" @click="viewMode = 'list'">
                                <i class="bi bi-list"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Loading State -->
                <div x-show="loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Finding aircraft...</p>
                </div>

                <!-- Aircraft Results -->
                <div x-show="!loading" class="row" x-transition>
                    <template x-for="aircraft in filteredAircraft" :key="aircraft.id">
                        <div class="col-lg-4 col-md-6 mb-4" x-show="viewMode === 'grid'">
                            <div class="card aircraft-card h-100" @click="showAircraftDetails(aircraft)">
                                <img :src="aircraft.image || '/static/images/aircraft-placeholder.jpg'"
                                    class="card-img-top" style="height: 200px; object-fit: cover;">
                                <div class="card-body">
                                    <h5 class="card-title" x-text="aircraft.manufacturer + ' ' + aircraft.model"></h5>
                                    <p class="card-text">
                                        <small class="text-muted" x-text="aircraft.year"></small><br>
                                        <strong x-text="formatPrice(aircraft.price)"></strong>
                                    </p>
                                    <div class="d-flex justify-content-between align-items-center">
                                        <small class="text-muted" x-text="aircraft.location"></small>
                                        <div>
                                            <button class="btn btn-sm btn-outline-primary"
                                                @click.stop="bookmarkAircraft(aircraft)">
                                                <i class="bi bi-bookmark"></i>
                                            </button>
                                            <button class="btn btn-sm btn-primary"
                                                @click.stop="contactSeller(aircraft)">
                                                Contact
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </template>
                </div>

                <!-- List View -->
                <div x-show="!loading && viewMode === 'list'" class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Aircraft</th>
                                <th>Year</th>
                                <th>Price</th>
                                <th>Location</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <template x-for="aircraft in filteredAircraft" :key="aircraft.id">
                                <tr style="cursor: pointer;" @click="showAircraftDetails(aircraft)">
                                    <td>
                                        <div class="d-flex align-items-center">
                                            <img :src="aircraft.image || '/static/images/aircraft-placeholder.jpg'"
                                                class="rounded me-3"
                                                style="width: 60px; height: 40px; object-fit: cover;">
                                            <div>
                                                <strong
                                                    x-text="aircraft.manufacturer + ' ' + aircraft.model"></strong><br>
                                                <small class="text-muted" x-text="aircraft.description"></small>
                                            </div>
                                        </div>
                                    </td>
                                    <td x-text="aircraft.year"></td>
                                    <td x-text="formatPrice(aircraft.price)"></td>
                                    <td x-text="aircraft.location"></td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                            @click.stop="bookmarkAircraft(aircraft)">
                                            <i class="bi bi-bookmark"></i>
                                        </button>
                                        <button class="btn btn-sm btn-primary" @click.stop="contactSeller(aircraft)">
                                            Contact
                                        </button>
                                    </td>
                                </tr>
                            </template>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Aircraft Details Modal -->
    <div class="modal fade" id="aircraftModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" x-show="selectedAircraft">
                <div class="modal-header">
                    <h5 class="modal-title" x-text="selectedAircraft?.manufacturer + ' ' + selectedAircraft?.model">
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-8">
                            <div id="aircraftCarousel" class="carousel slide mb-4">
                                <div class="carousel-inner">
                                    <div class="carousel-item active">
                                        <img :src="selectedAircraft?.image || '/static/images/aircraft-placeholder.jpg'"
                                            class="d-block w-100" style="height: 300px; object-fit: cover;">
                                    </div>
                                </div>
                            </div>
                            <ul class="nav nav-tabs mb-3">
                                <li class="nav-item">
                                    <button class="nav-link active" data-bs-toggle="tab"
                                        data-bs-target="#overview">Overview</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#specifications">Specifications</button>
                                </li>
                                <li class="nav-item">
                                    <button class="nav-link" data-bs-toggle="tab"
                                        data-bs-target="#maintenance">Maintenance</button>
                                </li>
                            </ul>
                            <div class="tab-content">
                                <div class="tab-pane fade show active" id="overview">
                                    <h6>Description</h6>
                                    <p x-text="selectedAircraft?.description"></p>
                                    <h6>Key Features</h6>
                                    <ul>
                                        <li>Year: <span x-text="selectedAircraft?.year"></span></li>
                                        <li>Passengers: <span x-text="selectedAircraft?.passenger_capacity"></span></li>
                                        <li>Range: <span x-text="selectedAircraft?.range_nm"></span> nm</li>
                                        <li>Max Speed: <span x-text="selectedAircraft?.max_speed"></span> kts</li>
                                    </ul>
                                </div>
                                <div class="tab-pane fade" id="specifications">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6>Performance</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td>Max Speed:</td>
                                                    <td x-text="selectedAircraft?.max_speed + ' kts'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Cruise Speed:</td>
                                                    <td x-text="selectedAircraft?.cruise_speed + ' kts'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Range:</td>
                                                    <td x-text="selectedAircraft?.range_nm + ' nm'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Service Ceiling:</td>
                                                    <td x-text="selectedAircraft?.service_ceiling + ' ft'"></td>
                                                </tr>
                                            </table>
                                        </div>
                                        <div class="col-md-6">
                                            <h6>Dimensions</h6>
                                            <table class="table table-sm">
                                                <tr>
                                                    <td>Length:</td>
                                                    <td x-text="selectedAircraft?.aircraft_length + ' ft'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Height:</td>
                                                    <td x-text="selectedAircraft?.aircraft_height + ' ft'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Wingspan:</td>
                                                    <td x-text="selectedAircraft?.wingspan + ' ft'"></td>
                                                </tr>
                                                <tr>
                                                    <td>Passengers:</td>
                                                    <td x-text="selectedAircraft?.passenger_capacity"></td>
                                                </tr>
                                            </table>
                                        </div>
                                    </div>
                                </div>
                                <div class="tab-pane fade" id="maintenance">
                                    <h6>Maintenance Information</h6>
                                    <p>Total Time: <span x-text="selectedAircraft?.airframe_total_time || 'TBD'"></span>
                                        hours</p>
                                    <p>Last Annual: <span
                                            x-text="selectedAircraft?.last_annual_date || 'Contact seller'"></span></p>
                                    <p>Maintenance Program: <span
                                            x-text="selectedAircraft?.maintenance_program || 'Contact seller'"></span>
                                    </p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card">
                                <div class="card-body">
                                    <h4 class="text-primary" x-text="formatPrice(selectedAircraft?.price)"></h4>
                                    <p class="text-muted" x-text="selectedAircraft?.location"></p>
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-primary" @click="contactSeller(selectedAircraft)">
                                            <i class="bi bi-envelope"></i> Contact Seller
                                        </button>
                                        <button class="btn btn-outline-primary"
                                            @click="bookmarkAircraft(selectedAircraft)">
                                            <i class="bi bi-bookmark"></i> Save Aircraft
                                        </button>
                                        <button class="btn btn-outline-secondary">
                                            <i class="bi bi-share"></i> Share
                                        </button>
                                    </div>
                                    <hr>
                                    <div class="text-center">
                                        <div class="row text-center">
                                            <div class="col-4">
                                                <div class="h6 mb-0" x-text="selectedAircraft?.csv_match_score || '0'">
                                                </div>
                                                <small class="text-muted">Match Score</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="h6 mb-0" x-text="selectedAircraft?.views || '0'"></div>
                                                <small class="text-muted">Views</small>
                                            </div>
                                            <div class="col-4">
                                                <div class="h6 mb-0" x-text="selectedAircraft?.inquiries || '0'"></div>
                                                <small class="text-muted">Inquiries</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Contact Modal -->
    <div class="modal fade" id="contactModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Contact Seller</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form @submit.prevent="sendContactMessage()">
                        <div class="mb-3">
                            <label class="form-label">Your Name</label>
                            <input type="text" class="form-control" x-model="contactForm.name" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Email</label>
                            <input type="email" class="form-control" x-model="contactForm.email" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Phone</label>
                            <input type="tel" class="form-control" x-model="contactForm.phone">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Message</label>
                            <textarea class="form-control" rows="4" x-model="contactForm.message" required></textarea>
                        </div>
                        <div class="d-grid">
                            <button type="submit" class="btn btn-primary">Send Message</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function aircraftBuyer() {
            return {
                searchQuery: '',
                selectedCategory: 'all',
                sortBy: 'match_score',
                viewMode: 'grid',
                loading: false,
                aircraft: [],
                filteredAircraft: [],
                selectedAircraft: null,
                filters: {
                    minPrice: '',
                    maxPrice: '',
                    yearFrom: '',
                    yearTo: '',
                    passengers: '',
                    range: ''
                },
                savedSearches: [
                    { name: 'Light Jets under $5M', filters: { maxPrice: '5000000', category: 'light' } },
                    { name: 'Midsize Jets 2015+', filters: { yearFrom: '2015', category: 'midsize' } }
                ],
                contactForm: {
                    name: '',
                    email: '',
                    phone: '',
                    message: ''
                },
                searchTimeout: null,

                init() {
                    this.loadAircraft();
                },

                debounceSearch() {
                    clearTimeout(this.searchTimeout);
                    this.searchTimeout = setTimeout(() => {
                        this.filterAircraft();
                    }, 300);
                },

                setCategory(category) {
                    this.selectedCategory = category;
                    this.filterAircraft();
                },

                async loadAircraft() {
                    this.loading = true;
                    try {
                        const response = await fetch('/api/listings/search?' + new URLSearchParams({
                            sort: this.sortBy,
                            ...this.filters
                        }));
                        const data = await response.json();
                        this.aircraft = data.listings || [];
                        this.filterAircraft();
                    } catch (error) {
                        console.error('Error loading aircraft:', error);
                    } finally {
                        this.loading = false;
                    }
                },

                filterAircraft() {
                    let filtered = this.aircraft;

                    // Search query filter
                    if (this.searchQuery) {
                        const query = this.searchQuery.toLowerCase();
                        filtered = filtered.filter(aircraft =>
                            aircraft.manufacturer.toLowerCase().includes(query) ||
                            aircraft.model.toLowerCase().includes(query) ||
                            aircraft.description?.toLowerCase().includes(query)
                        );
                    }

                    // Category filter
                    if (this.selectedCategory !== 'all') {
                        filtered = filtered.filter(aircraft => {
                            const category = this.getAircraftCategory(aircraft);
                            return category === this.selectedCategory;
                        });
                    }

                    this.filteredAircraft = filtered;
                },

                getAircraftCategory(aircraft) {
                    const passengers = aircraft.passenger_capacity || 0;
                    if (passengers <= 6) return 'light';
                    if (passengers <= 9) return 'midsize';
                    return 'heavy';
                },

                showAircraftDetails(aircraft) {
                    this.selectedAircraft = aircraft;
                    new bootstrap.Modal(document.getElementById('aircraftModal')).show();
                },

                contactSeller(aircraft) {
                    this.selectedAircraft = aircraft;
                    this.contactForm.message = `I'm interested in your ${aircraft.manufacturer} ${aircraft.model}. Please contact me with more information.`;
                    new bootstrap.Modal(document.getElementById('contactModal')).show();
                },

                async sendContactMessage() {
                    try {
                        const response = await fetch(`/api/listings/${this.selectedAircraft.id}/contact`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(this.contactForm)
                        });

                        if (response.ok) {
                            alert('Message sent successfully!');
                            bootstrap.Modal.getInstance(document.getElementById('contactModal')).hide();
                            this.contactForm = { name: '', email: '', phone: '', message: '' };
                        }
                    } catch (error) {
                        alert('Error sending message. Please try again.');
                    }
                },

                bookmarkAircraft(aircraft) {
                    // Add bookmark functionality
                    alert('Aircraft bookmarked!');
                },

                saveCurrentSearch() {
                    const name = prompt('Name for this search:');
                    if (name) {
                        this.savedSearches.push({
                            name: name,
                            filters: { ...this.filters, category: this.selectedCategory }
                        });
                    }
                },

                loadSavedSearch(search) {
                    this.filters = { ...search.filters };
                    this.selectedCategory = search.filters.category || 'all';
                    this.loadAircraft();
                },

                formatPrice(price) {
                    if (!price) return 'Contact for price';
                    return new Intl.NumberFormat('en-US', {
                        style: 'currency',
                        currency: 'USD',
                        minimumFractionDigits: 0
                    }).format(price);
                }
            }
        }
    </script>
</body>

</html>