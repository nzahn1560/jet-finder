{% extends "base.html" %}

{% block title %}Aircraft Data - Jet Finder{% endblock %}

{% block extra_css %}
<style>
    .csv-data-container {
        overflow-x: auto;
        max-width: 100%;
    }

    .data-table {
        font-size: 0.85rem;
    }

    .data-table th {
        position: sticky;
        top: 0;
        background-color: #1a1a1a;
        z-index: 10;
    }

    .data-field {
        max-width: 200px;
        overflow: hidden;
        text-overflow: ellipsis;
        white-space: nowrap;
    }

    .user-inputs-card {
        position: sticky;
        top: 20px;
    }

    .input-group-sm .form-control,
    .input-group-sm .input-group-text {
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="row">
        <!-- User Inputs Section -->
        <div class="col-lg-4 col-xl-3 mb-4">
            <div class="card bg-dark border border-secondary user-inputs-card">
                <div class="card-header bg-black">
                    <h5 class="mb-0">User Requirements</h5>
                </div>
                <div class="card-body">
                    <form id="user-inputs-form">
                        <div class="mb-3">
                            <label for="yearly-usage" class="form-label">Yearly Usage (Hours)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control bg-black text-white border-secondary"
                                    id="yearly-usage" name="yearly_usage" value="{{ user_inputs.yearly_usage }}">
                                <span class="input-group-text bg-black text-white border-secondary">hours</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="purpose" class="form-label">Primary Purpose</label>
                            <select class="form-select form-select-sm bg-black text-white border-secondary" id="purpose"
                                name="purpose">
                                <option value="business" {% if user_inputs.purpose=='business' %}selected{% endif %}>
                                    Business</option>
                                <option value="leisure" {% if user_inputs.purpose=='leisure' %}selected{% endif %}>
                                    Leisure</option>
                                <option value="mixed" {% if user_inputs.purpose=='mixed' %}selected{% endif %}>Mixed
                                </option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="passengers" class="form-label">Passengers</label>
                            <input type="number"
                                class="form-control form-control-sm bg-black text-white border-secondary"
                                id="passengers" name="passengers" value="{{ user_inputs.passengers }}">
                        </div>

                        <div class="mb-3">
                            <label for="range-required" class="form-label">Range Required (nm)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control bg-black text-white border-secondary"
                                    id="range-required" name="range_required" value="{{ user_inputs.range_required }}">
                                <span class="input-group-text bg-black text-white border-secondary">nm</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="speed-required" class="form-label">Speed Required (kts)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control bg-black text-white border-secondary"
                                    id="speed-required" name="speed_required" value="{{ user_inputs.speed_required }}">
                                <span class="input-group-text bg-black text-white border-secondary">kts</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="budget" class="form-label">Budget ($)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-black text-white border-secondary">$</span>
                                <input type="number" class="form-control bg-black text-white border-secondary"
                                    id="budget" name="budget" value="{{ user_inputs.budget }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="home-airport" class="form-label">Home Airport</label>
                            <input type="text" class="form-control form-control-sm bg-black text-white border-secondary"
                                id="home-airport" name="home_airport" value="{{ user_inputs.home_airport }}">
                        </div>

                        <div class="mb-3">
                            <label for="primary-destination" class="form-label">Primary Destination</label>
                            <input type="text" class="form-control form-control-sm bg-black text-white border-secondary"
                                id="primary-destination" name="primary_destination"
                                value="{{ user_inputs.primary_destination }}">
                        </div>

                        <div class="mb-3">
                            <label for="trip-frequency" class="form-label">Trip Frequency (per year)</label>
                            <div class="input-group input-group-sm">
                                <input type="number" class="form-control bg-black text-white border-secondary"
                                    id="trip-frequency" name="trip_frequency" value="{{ user_inputs.trip_frequency }}">
                                <span class="input-group-text bg-black text-white border-secondary">trips</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-danger btn-sm">
                                <i class="fas fa-filter me-2"></i>Apply Filters
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-sm" id="reset-filters">
                                <i class="fas fa-undo me-2"></i>Reset Filters
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <div class="card bg-dark border border-secondary mt-3">
                <div class="card-header bg-black">
                    <h5 class="mb-0">Recommended Aircraft</h5>
                </div>
                <div class="card-body">
                    <div id="recommendations-container">
                        <div class="text-center py-3">
                            <p class="text-secondary">Apply filters to see recommendations</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- CSV Data Section -->
        <div class="col-lg-8 col-xl-9">
            <div class="card bg-dark border border-secondary">
                <div class="card-header bg-black">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Raw CSV Data</h5>
                        <div>
                            <input type="text" class="form-control form-control-sm bg-black text-white border-secondary"
                                id="data-search" placeholder="Search data...">
                        </div>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="csv-data-container">
                        <table class="table table-dark table-striped table-hover data-table mb-0">
                            <thead>
                                <tr>
                                    <th>#</th>
                                    {% for col in column_names %}
                                    <th>{{ col }}</th>
                                    {% endfor %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for row in data_rows %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    {% for cell in row %}
                                    <td class="data-field">{{ cell }}</td>
                                    {% endfor %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="p-3 bg-black border-top border-secondary text-center">
                        <p class="text-secondary mb-0">
                            Showing {{ data_rows|length }} of {{ total_rows }} rows
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Form submission handler
        const userInputsForm = document.getElementById('user-inputs-form');
        userInputsForm.addEventListener('submit', function (e) {
            e.preventDefault();

            // Collect form data
            const formData = new FormData(userInputsForm);
            const filters = {};
            for (const [key, value] of formData.entries()) {
                filters[key] = value;
            }

            // Show a loading state
            const recommendationsContainer = document.getElementById('recommendations-container');
            recommendationsContainer.innerHTML = '<div class="text-center py-3"><div class="spinner-border text-danger" role="status"></div><p class="mt-2">Finding the best aircraft for you...</p></div>';

            // Call the filtering API
            fetch('/api/aircraft-recommendations', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filters),
            })
                .then(response => response.json())
                .then(data => {
                    // Display the recommendations
                    displayRecommendations(data);
                })
                .catch(error => {
                    console.error('Error:', error);
                    recommendationsContainer.innerHTML = '<div class="alert alert-danger">Error finding recommendations. Please try again.</div>';
                });
        });

        // Reset filters handler
        const resetFiltersBtn = document.getElementById('reset-filters');
        resetFiltersBtn.addEventListener('click', function () {
            userInputsForm.reset();
        });

        // Data search functionality
        const dataSearch = document.getElementById('data-search');
        dataSearch.addEventListener('input', function () {
            const searchTerm = this.value.toLowerCase();
            const rows = document.querySelectorAll('.data-table tbody tr');

            rows.forEach(row => {
                const text = row.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });

        // Function to display recommendations
        function displayRecommendations(data) {
            const recommendationsContainer = document.getElementById('recommendations-container');

            if (!data || data.length === 0) {
                recommendationsContainer.innerHTML = '<div class="alert alert-warning">No matching aircraft found. Try adjusting your filters.</div>';
                return;
            }

            let html = '';
            data.forEach((aircraft, index) => {
                const score = aircraft.score || 100 - (index * 10);

                html += `
                <div class="card bg-black text-white mb-2 border border-secondary">
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between mb-1">
                            <h6 class="mb-0">${aircraft.manufacturer} ${aircraft.model}</h6>
                            <span class="badge bg-${score > 80 ? 'success' : score > 60 ? 'warning' : 'danger'}">${score}%</span>
                        </div>
                        <div class="small text-secondary mb-1">
                            <span class="me-2"><i class="fas fa-ruler-horizontal me-1"></i>${aircraft.range || 'N/A'} nm</span>
                            <span class="me-2"><i class="fas fa-tachometer-alt me-1"></i>${aircraft.speed || 'N/A'} kts</span>
                            <span><i class="fas fa-users me-1"></i>${aircraft.passengers || 'N/A'}</span>
                        </div>
                        <div class="small fw-bold">${formatCurrency(aircraft.price || 0)}</div>
                    </div>
                </div>
                `;
            });

            recommendationsContainer.innerHTML = html;
        }

        // Helper function to format currency
        function formatCurrency(value) {
            return new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(value);
        }
    });
</script>
{% endblock %}