{% extends "base.html" %}

<!-- Rolling Stock Ticker -->
<div id="stockTicker" class="stock-ticker">
    <div class="ticker-wrapper">
        <div class="ticker-content" id="tickerContent">
            <!-- Dynamic content loaded via JavaScript -->
        </div>
    </div>
</div>

{% block title %}Jet Finder - JetSchool{% endblock %}

{% block additional_css %}
<!-- Leaflet CSS for maps -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
<!-- Leaflet Geocoder for airport search -->
<link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css" />

<style>
    /* Stock Ticker Styles */
    .stock-ticker {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        border-bottom: 2px solid #F05545;
        padding: 8px 0;
        overflow: hidden;
        white-space: nowrap;
        position: relative;
        font-family: 'Rajdhani', sans-serif;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
    }

    .ticker-wrapper {
        width: 100%;
        overflow: hidden;
    }

    .ticker-content {
        display: inline-block;
        animation: scroll-left 60s linear infinite;
        color: white;
        font-size: 14px;
        font-weight: 600;
    }

    .ticker-item {
        display: inline-block;
        margin-right: 40px;
        padding: 4px 12px;
        background: rgba(240, 85, 69, 0.1);
        border-radius: 20px;
        border: 1px solid rgba(240, 85, 69, 0.3);
    }

    .ticker-item.positive {
        color: #00ff88;
        border-color: rgba(0, 255, 136, 0.3);
        background: rgba(0, 255, 136, 0.1);
    }

    .ticker-item.negative {
        color: #ff4757;
        border-color: rgba(255, 71, 87, 0.3);
        background: rgba(255, 71, 87, 0.1);
    }

    @keyframes scroll-left {
        0% {
            transform: translateX(100%);
        }

        100% {
            transform: translateX(-100%);
        }
    }

    /* Custom styles for route planning */
    .distance-label {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        border: 1px solid #F05545;
        white-space: nowrap;
    }

    /* Styling for range ring tooltips */
    .range-tooltip {
        background-color: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        border: 1px solid #F05545 !important;
        border-radius: 4px !important;
        padding: 5px 10px !important;
        font-family: 'Rajdhani', sans-serif !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    }

    .range-tooltip:before {
        border-color: transparent !important;
    }

    /* Range rings legend styling */
    .range-legend {
        font-family: 'Rajdhani', sans-serif;
        margin-bottom: 10px !important;
    }

    .range-legend .bg-dark {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        transition: opacity 0.3s;
    }

    .range-legend:hover .bg-dark {
        opacity: 0.95;
    }

    .route-icon {
        background-color: #F05545;
        color: white;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        width: 100%;
        height: 100%;
    }

    .airport-icon {
        background-color: #343a40;
        color: white;
        border: 2px solid #F05545;
        border-radius: 4px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        width: 100%;
        height: 100%;
    }

    /* Auto-update notification */
    .auto-update-info {
        font-size: 0.8rem;
        color: #6c757d;
        font-style: italic;
        margin-top: 0.25rem;
    }

    /* Financial inputs styling */
    .financial-input-group.updating .form-control {
        border-color: #ffc107;
        box-shadow: 0 0 0 0.25rem rgba(255, 193, 7, 0.25);
        transition: border-color 0.3s, box-shadow 0.3s;
    }

    .form-control.applied {
        border-color: #28a745;
        box-shadow: 0 0 0 0.25rem rgba(40, 167, 69, 0.25);
        animation: pulse-success 1s;
    }

    @keyframes pulse-success {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }

    #aircraft-table.loading {
        opacity: 0.6;
        pointer-events: none;
    }

    /* Custom multi-select styling */
    .custom-multi-select {
        max-height: none;
        height: 38px;
        /* Match Bootstrap form-control height */
        overflow: hidden;
        transition: height 0.3s ease;
        position: relative;
    }

    .custom-multi-select:focus-within {
        height: 38px;
        overflow: visible;
        z-index: 1000;
    }

    .custom-multi-select:focus-within .selected-options {
        border-bottom-left-radius: 0;
        border-bottom-right-radius: 0;
        box-shadow: 0 0 0 0.25rem rgba(240, 85, 69, 0.25);
        border-color: #F05545;
    }

    .custom-multi-select .options-list {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 0;
        overflow: hidden;
        transition: max-height 0.3s ease;
        background-color: #212529;
        border: 1px solid #F05545;
        border-top: none;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        z-index: 1001;
    }

    .custom-multi-select:focus-within .options-list {
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .custom-multi-select .option-item {
        padding: 6px 10px;
        cursor: pointer;
        border-radius: 4px;
        margin-bottom: 2px;
        transition: background-color 0.2s;
    }

    .custom-multi-select .option-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .custom-multi-select .option-item.selected {
        background-color: rgba(240, 85, 69, 0.2);
        border-left: 3px solid #F05545;
    }

    .custom-multi-select .selected-options {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        min-height: 24px;
        background-color: #212529;
        border-radius: 4px;
    }

    .custom-multi-select .selected-option {
        background-color: #F05545;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
    }

    .custom-multi-select .selected-option .remove-option {
        margin-left: 5px;
        cursor: pointer;
        opacity: 0.7;
    }

    .custom-multi-select .selected-option .remove-option:hover {
        opacity: 1;
    }

    /* Priority Sorter Styles */
    .metrics-list {
        display: flex;
        flex-direction: column;
        gap: 4px;
    }

    .metric-chip {
        background-color: #495057;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        cursor: grab;
        user-select: none;
        border: 1px solid #6c757d;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 4px;
        width: 100%;
        justify-content: flex-start;
    }

    .metric-chip:hover {
        background-color: #6c757d;
        border-color: #adb5bd;
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .metric-chip.dragging {
        opacity: 0.5;
        cursor: grabbing;
        transform: rotate(5deg);
    }


    .metric-icon {
        font-size: 0.7rem;
        opacity: 0.8;
    }

    /* Preset button animations */
    .btn-outline-success:hover,
    .btn-outline-danger:hover,
    .btn-outline-info:hover,
    .btn-outline-primary:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    }

    .custom-multi-select .selected-option .remove-option {
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    /* Column selector styling */
    #column-selector {
        max-height: 300px;
        overflow-y: auto;
    }

    .column-toggle {
        margin-right: 10px;
        margin-bottom: 10px;
        white-space: nowrap;
    }

    .column-toggle label {
        margin-left: 5px;
        cursor: pointer;
    }

    .dropdown-menu.bg-dark .dropdown-header {
        color: #F05545;
    }

    /* Individual Metric Scores Styles */
    .individual-metrics {
        margin-top: 1rem;
        padding: 1rem;
        background-color: rgba(0, 0, 0, 0.1);
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .individual-metrics h6 {
        margin-bottom: 1rem;
        font-size: 0.9rem;
        font-weight: 600;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 1rem;
    }

    .metric-category {
        background-color: rgba(0, 0, 0, 0.2);
        padding: 0.75rem;
        border-radius: 6px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .metric-category h7 {
        display: block;
        font-size: 0.8rem;
        font-weight: 600;
        margin-bottom: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .metric-row {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 0.5rem;
        padding: 0.25rem 0;
    }

    .metric-row:last-child {
        margin-bottom: 0;
    }

    .metric-row.highlight {
        background-color: rgba(255, 193, 7, 0.1);
        border-radius: 4px;
        padding: 0.25rem 0.5rem;
        margin: 0.25rem -0.5rem;
    }

    .metric-label {
        font-size: 0.75rem;
        color: #adb5bd;
        min-width: 80px;
        flex-shrink: 0;
    }

    .metric-score-bar {
        flex: 1;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        margin-left: 0.5rem;
    }

    .score-bar {
        flex: 1;
        height: 8px;
        background: linear-gradient(90deg, #dc3545 0%, #ffc107 50%, #28a745 100%);
        border-radius: 4px;
        position: relative;
        overflow: hidden;
        min-width: 60px;
    }

    .score-text {
        font-size: 0.7rem;
        font-weight: 600;
        color: #fff;
        min-width: 35px;
        text-align: right;
    }

    /* Responsive adjustments */
    @media (min-width: 768px) {
        .metrics-grid {
            grid-template-columns: repeat(3, 1fr);
        }
    }

    @media (max-width: 767px) {
        .metric-score-bar {
            flex-direction: column;
            align-items: stretch;
            gap: 0.25rem;
        }

        .score-text {
            text-align: center;
        }
    }

    /* Custom dropdown multi-select styling */
    .custom-dropdown {
        position: relative;
        height: auto;
        min-height: 38px;
        background-color: #212529;
        border: 1px solid #F05545;
        border-radius: 4px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .custom-dropdown.open {
        z-index: 1000;
    }

    .custom-dropdown .selected-options {
        display: flex;
        flex-wrap: wrap;
        gap: 5px;
        padding: 5px;
        min-height: 24px;
    }

    .custom-dropdown .selected-option {
        background-color: #F05545;
        color: white;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 0.8rem;
        display: flex;
        align-items: center;
        margin: 2px;
    }

    .custom-dropdown .selected-option .remove-option {
        margin-left: 5px;
        cursor: pointer;
        font-weight: bold;
    }

    .custom-dropdown .options-dropdown {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        max-height: 0;
        overflow: hidden;
        background-color: #212529;
        border: 1px solid #F05545;
        border-top: none;
        border-bottom-left-radius: 4px;
        border-bottom-right-radius: 4px;
        z-index: 1001;
        transition: max-height 0.3s ease;
    }

    .custom-dropdown.open .options-dropdown {
        max-height: 200px;
        overflow-y: auto;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
    }

    .custom-dropdown .option-item {
        padding: 8px 12px;
        cursor: pointer;
        transition: background-color 0.2s;
    }

    .custom-dropdown .option-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .custom-dropdown .option-item.selected {
        background-color: rgba(240, 85, 69, 0.2);
        border-left: 3px solid #F05545;
    }

    .custom-dropdown .option-item[data-value=""] {
        color: #6c757d;
        font-style: italic;
    }

    .custom-dropdown .option-item[data-value=""]:hover {
        background-color: rgba(108, 117, 125, 0.1);
    }

    .custom-dropdown .option-item[data-value=""].selected {
        background-color: rgba(108, 117, 125, 0.2);
        border-left: 3px solid #6c757d;
    }

    /* Route planning styles */
    .airport-results {
        position: absolute;
        width: 100%;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
    }

    .route-item {
        background-color: rgba(33, 37, 41, 0.8);
        transition: background-color 0.2s;
    }

    .route-item:hover {
        background-color: rgba(33, 37, 41, 1);
    }

    .route-item .delete-route {
        opacity: 0;
        transition: opacity 0.2s;
    }

    .route-item:hover .delete-route {
        opacity: 1;
    }

    /* Aircraft range circles */
    .range-circle {
        stroke-dasharray: 5, 5;
        animation: dash 20s linear infinite;
    }

    @keyframes dash {
        to {
            stroke-dashoffset: 1000;
        }
    }

    /* Route lines */
    .route-line {
        stroke-dasharray: 5, 5;
        animation: dash 20s linear infinite;
        pointer-events: none;
    }

    .route-marker {
        pointer-events: auto;
        cursor: pointer;
    }

    /* Airport search results */
    .airport-results .list-group-item {
        border-radius: 0;
        border-left: none;
        border-right: none;
        transition: all 0.2s;
    }

    .airport-results .list-group-item:first-child {
        border-top: none;
    }

    .airport-results .list-group-item:last-child {
        border-bottom: none;
    }

    .airport-results .list-group-item:hover {
        background-color: rgba(240, 85, 69, 0.1) !important;
        border-left: 3px solid #F05545;
    }

    /* Map container */
    #map {
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: border-color 0.3s;
    }

    #map:hover {
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Routes container */
    #routes-container {
        scrollbar-width: thin;
        scrollbar-color: #F05545 #212529;
    }

    #routes-container::-webkit-scrollbar {
        width: 6px;
    }

    #routes-container::-webkit-scrollbar-track {
        background: #212529;
    }

    #routes-container::-webkit-scrollbar-thumb {
        background-color: #F05545;
        border-radius: 3px;
    }

    /* Add CSS for dark-theme popups */
    .dark-popup .leaflet-popup-content-wrapper {
        background-color: #1a202c;
        color: white;
        border-radius: 5px;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
    }

    .dark-popup .leaflet-popup-tip {
        background-color: #1a202c;
    }

    .leaflet-container {
        background-color: #1a202c;
        outline: 0;
    }

    /* Improve visibility of map controls on dark background */
    .leaflet-control-zoom a {
        background-color: #2d3748 !important;
        color: white !important;
        border-color: #4a5568 !important;
    }

    .leaflet-control-zoom a:hover {
        background-color: #4a5568 !important;
    }

    /* Make attribution more visible on dark background */
    .leaflet-control-attribution {
        background-color: rgba(0, 0, 0, 0.5) !important;
        color: rgba(255, 255, 255, 0.7) !important;
    }

    .leaflet-control-attribution a {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    /* Aircraft count display */
    .aircraft-count-display {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(18, 19, 24, 0.92);
        color: #f4f4f4;
        padding: 0.5rem 0.85rem;
        border-radius: 0;
        margin-left: 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .aircraft-count-label {
        font-size: 0.75rem;
        color: rgba(244, 244, 244, 0.65);
        letter-spacing: 0.35px;
        text-transform: uppercase;
        margin-right: 6px;
    }

    .aircraft-count-value {
        font-weight: 700;
        color: #F05545;
        font-size: 1rem;
    }

    .listings-aircraft-remaining {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        background: rgba(18, 19, 24, 0.92);
        border-radius: 0;
        padding: 0.5rem 0.85rem;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .listings-aircraft-remaining .aircraft-count-label {
        font-size: 0.75rem;
        text-transform: uppercase;
        letter-spacing: 0.35px;
        color: rgba(244, 244, 244, 0.65);
    }

    .listings-aircraft-remaining .aircraft-count-value {
        font-size: 0.95rem;
        font-weight: 700;
        color: #F05545;
    }


    /* Clean Aircraft Grid Layout */
    .aircraft-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 3rem;
        padding: 2rem;
        width: 100%;
        margin: 0 auto;
        justify-items: center;
        align-items: start;
    }

    /* Clean Container Layout */
    .aircraft-listings-container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 0 2rem;
        width: 100%;
        box-sizing: border-box;
    }

    .aircraft-card {
        background: linear-gradient(145deg, #1a1a1a, #2d2d2d);
        border: 1px solid #404040;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
        min-height: 520px;
        width: 100%;
        max-width: 350px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.4);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        position: relative;
        align-self: stretch;
        margin: 0 auto;
    }

    .aircraft-content {
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
    }

    .price-badge {
        position: absolute;
        top: 1rem;
        right: 1rem;
        z-index: 2;
    }

    .price-badge .badge {
        background: linear-gradient(135deg, #F05545, #ff6b5b);
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 20px;
        font-weight: 600;
        font-size: 0.9rem;
        box-shadow: 0 2px 8px rgba(240, 85, 69, 0.3);
    }

    .spec-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 0.75rem;
        margin: 1rem 0;
        flex-grow: 1;
    }

    .spec-item {
        display: flex;
        flex-direction: column;
        padding: 0.5rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .spec-label {
        font-size: 0.75rem;
        color: #888;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .spec-value {
        font-size: 0.9rem;
        color: white;
        font-weight: 600;
    }

    .aircraft-name {
        color: white;
        font-size: 1.1rem;
        font-weight: 700;
        margin-bottom: 1rem;
        line-height: 1.3;
    }

    .aircraft-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 16px 48px rgba(240, 85, 69, 0.3);
        border-color: #F05545;
    }

    .aircraft-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
    }

    .aircraft-card:hover {
        transform: translateY(-8px);
        box-shadow: 0 12px 40px rgba(0, 0, 0, 0.5);
        border-color: #F05545;
    }

    .aircraft-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 25px rgba(240, 85, 69, 0.3);
        border-color: #F05545;
    }

    .aircraft-image {
        height: 250px;
        overflow: hidden;
        background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        position: relative;
        flex-shrink: 0;
    }

    .aircraft-image::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(180deg, transparent 0%, rgba(0, 0, 0, 0.3) 100%);
        z-index: 1;
    }

    .aircraft-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        z-index: 2;
        position: relative;
    }

    .aircraft-card:hover .aircraft-image img {
        transform: scale(1.05);
    }

    .final-score-overlay {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
    }

    .final-score-badge {
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-size: 1.1rem;
        font-weight: 800;
        text-align: center;
        min-width: 70px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.6);
        border: 3px solid rgba(255, 255, 255, 0.4);
        backdrop-filter: blur(10px);
        background: rgba(0, 0, 0, 0.8);
    }

    .final-score-badge.excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-color: rgba(40, 167, 69, 0.6);
    }

    .final-score-badge.very-good {
        background: linear-gradient(135deg, #007bff, #17a2b8);
        color: white;
        border-color: rgba(0, 123, 255, 0.6);
    }

    .final-score-badge.good {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #000;
        border-color: rgba(255, 193, 7, 0.6);
    }

    .final-score-badge.fair {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border-color: rgba(108, 117, 125, 0.6);
    }

    .final-score-badge.poor {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        border-color: rgba(220, 53, 69, 0.6);
    }

    .aircraft-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .aircraft-card:hover .aircraft-image img {
        transform: scale(1.05);
    }

    .aircraft-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .score-overlay {
        position: absolute;
        top: -10px;
        right: -10px;
        z-index: 10;
    }

    .score-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        color: white;
        border: 3px solid #212529;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
    }

    .score-circle.excellent {
        background: linear-gradient(135deg, #F05545, #d44437);
    }

    .score-circle.very-good {
        background: linear-gradient(135deg, #ff6b5b, #F05545);
    }

    .score-circle.good {
        background: linear-gradient(135deg, #ff8a80, #ff6b5b);
    }

    .score-circle.fair {
        background: linear-gradient(135deg, #ffab91, #ff8a80);
    }

    .score-circle.poor {
        background: linear-gradient(135deg, #ffcdd2, #ffab91);
    }

    .aircraft-content {
        padding: 1rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        overflow-y: auto;
        min-height: 350px;
    }

    .aircraft-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
    }

    .aircraft-title {
        flex: 1;
    }

    .aircraft-name {
        font-size: 1rem;
        font-weight: 700;
        color: #F05545;
        margin: 0 0 0.25rem 0;
        line-height: 1.2;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .aircraft-category {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .score-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        min-width: 40px;
        text-align: center;
    }

    .aircraft-info {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.4rem;
        margin-bottom: 0.25rem;
        flex-shrink: 0;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        gap: 0.5rem;
        margin-bottom: 0.2rem;
        font-size: 0.75rem;
    }

    .info-item {
        flex: 1;
    }

    .info-label {
        font-size: 0.65rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.2rem;
    }

    .info-value {
        font-size: 0.8rem;
        font-weight: 600;
        color: #F05545;
    }

    .specifications {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.4rem;
        margin-bottom: 0.25rem;
        flex-shrink: 0;
    }

    .spec-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.4rem;
    }

    .spec-item {
        text-align: center;
    }

    .spec-value {
        font-size: 0.8rem;
        font-weight: 600;
        color: #17a2b8;
        margin-bottom: 0.2rem;
    }

    .spec-label {
        font-size: 0.6rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .aircraft-name {
        font-size: 1.1rem;
        font-weight: bold;
        color: #F05545;
        margin: 0;
        line-height: 1.3;
    }

    .aircraft-category {
        font-size: 0.75rem;
        color: #6c757d;
    }

    .aircraft-price-hours {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding: 0.5rem;
        background: rgba(240, 85, 69, 0.1);
        border-radius: 8px;
    }

    .price-section .price-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #F05545;
    }

    .hours-section {
        text-align: right;
    }

    .hours-value {
        font-size: 0.9rem;
        font-weight: bold;
        color: #17a2b8;
    }

    .hours-label {
        font-size: 0.7rem;
        color: #6c757d;
    }

    .enhanced-specs-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.75rem;
        margin-bottom: 0;
        padding: 1rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .operating-costs {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.3rem;
        margin-bottom: 0.2rem;
        flex-shrink: 0;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.1rem;
    }

    .cost-label {
        font-size: 0.6rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .cost-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #28a745;
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 0.25rem 0;
        border-bottom: 1px solid rgba(108, 117, 125, 0.2);
    }

    .cost-item:last-child {
        border-bottom: none;
    }

    .cost-label {
        font-size: 0.8rem;
        color: #6c757d;
    }

    .cost-value {
        font-size: 0.9rem;
        font-weight: bold;
        color: #17a2b8;
    }

    .card-actions {
        margin-top: auto;
        display: flex;
        gap: 0.5rem;
        justify-content: center;
        padding-top: 0.5rem;
        border-top: 2px solid rgba(240, 85, 69, 0.2);
        flex-shrink: 0;
    }

    .card-actions .btn {
        flex: 1;
        font-size: 0.8rem;
        font-weight: 600;
        padding: 0.75rem;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .card-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .add-to-compare-btn {
        border-color: rgba(240, 85, 69, 0.6);
        color: rgba(240, 85, 69, 0.9);
        background: rgba(240, 85, 69, 0.08);
        transition: all 0.3s ease;
    }

    .add-to-compare-btn:hover {
        background: linear-gradient(135deg, rgba(240, 85, 69, 0.85), rgba(240, 85, 69, 0.65));
        color: #fff;
        border-color: transparent;
    }

    .add-to-compare-btn.active {
        background: linear-gradient(135deg, #f05545, #d63c2d);
        color: #fff;
        border-color: transparent;
        box-shadow: 0 12px 20px rgba(240, 85, 69, 0.35);
    }

    .primary-action-btn {
        background: linear-gradient(135deg, #F05545, #d63c2d) !important;
        border: none;
        color: #ffffff;
        font-weight: 600;
        letter-spacing: 0.4px;
        text-transform: uppercase;
    }

    .primary-action-btn:hover,
    .primary-action-btn:focus {
        background: linear-gradient(135deg, #d63c2d, #b9251a) !important;
        box-shadow: 0 8px 18px rgba(240, 85, 69, 0.28);
    }

    .card:not(.aircraft-card) {
        border-radius: 0;
    }

    .compare-section {
        border-radius: 0;
        overflow: hidden;
        border: 1px solid rgba(255, 255, 255, 0.06);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.45);
        backdrop-filter: blur(10px);
    }

    .compare-icon {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: rgba(240, 85, 69, 0.18);
        color: #f05545;
        font-size: 1.1rem;
    }

    .compare-count {
        background: rgba(255, 255, 255, 0.08);
        border: 1px solid rgba(255, 255, 255, 0.16);
        color: #f0f2f5;
        font-weight: 600;
        padding: 0.35rem 0.7rem;
        letter-spacing: 0.4px;
    }

    .compare-limit-notice {
        min-width: 140px;
        text-align: right;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .compare-limit-notice.active {
        opacity: 1;
    }

    .compare-empty {
        border: 1px dashed rgba(255, 255, 255, 0.15);
        border-radius: 12px;
        background: rgba(15, 23, 42, 0.35);
    }

    .compare-content {
        display: flex;
        flex-direction: column;
        gap: 1.75rem;
    }

    .compare-aircraft-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
    }

    .compare-aircraft-card {
        position: relative;
        border-radius: 0;
        background: rgba(17, 26, 48, 0.65);
        border: 1px solid rgba(255, 255, 255, 0.08);
        padding: 1.1rem;
        overflow: hidden;
        box-shadow: 0 20px 35px rgba(0, 0, 0, 0.35);
    }

    .compare-aircraft-card::before {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border: 2px solid transparent;
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.05), rgba(255, 255, 255, 0)) border-box;
        -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
    }

    .compare-aircraft-card::after {
        content: '';
        position: absolute;
        inset: 0;
        border-radius: inherit;
        border-left: 5px solid var(--accent, rgba(240, 85, 69, 0.9));
        opacity: 0.85;
    }

    .compare-card-header {
        position: relative;
        z-index: 1;
        display: flex;
        align-items: flex-start;
        justify-content: space-between;
        gap: 0.75rem;
        margin-bottom: 0.75rem;
    }

    .compare-card-title {
        font-size: 0.95rem;
        font-weight: 700;
        color: #fff;
        margin-bottom: 0.1rem;
    }

    .compare-card-subtitle {
        font-size: 0.75rem;
        color: rgba(255, 255, 255, 0.6);
    }

    .compare-remove-btn {
        border-radius: 50%;
        width: 32px;
        height: 32px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        border: 1px solid rgba(255, 255, 255, 0.25);
        color: rgba(255, 255, 255, 0.65);
        backdrop-filter: blur(6px);
    }

    .compare-remove-btn:hover {
        color: #fff;
        border-color: rgba(255, 255, 255, 0.45);
        background: rgba(255, 255, 255, 0.12);
    }

    .compare-pill-group {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 0.75rem;
        flex-wrap: wrap;
    }

    .compare-pill {
        display: flex;
        flex-direction: column;
        padding: 0.45rem 0.7rem;
        border-radius: 8px;
        background: rgba(24, 24, 30, 0.9);
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .compare-pill span {
        font-size: 0.55rem;
        text-transform: uppercase;
        color: rgba(240, 242, 245, 0.55);
        letter-spacing: 0.4px;
    }

    .compare-pill strong {
        color: #f0f2f5;
        font-size: 0.85rem;
    }

    .compare-metrics {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.6rem;
        margin-bottom: 0.6rem;
    }

    .compare-metric {
        padding: 0.5rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.04);
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .compare-metric span {
        display: block;
        font-size: 0.55rem;
        text-transform: uppercase;
        color: rgba(255, 255, 255, 0.55);
        margin-bottom: 0.15rem;
        letter-spacing: 0.35px;
    }

    .compare-metric strong {
        color: #f7f7f7;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .compare-chart-card {
        padding: 1rem;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.06);
        background: rgba(18, 19, 24, 0.92);
        backdrop-filter: blur(10px);
        box-shadow: 0 16px 30px rgba(0, 0, 0, 0.35);
        min-height: 320px;
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .chart-header h6 {
        font-weight: 700;
        letter-spacing: 0.4px;
    }

    .chart-header small {
        color: rgba(255, 255, 255, 0.55);
    }

    .chart-wrapper {
        flex: 1;
        position: relative;
    }

    .compare-cost-charts {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: 1rem;
        margin-top: 0.85rem;
    }

    .compare-cost-charts .chart-card {
        min-height: 240px;
        border-radius: 0;
        border: 1px solid rgba(255, 255, 255, 0.07);
        background: rgba(12, 13, 18, 0.95);
        box-shadow: 0 10px 24px rgba(0, 0, 0, 0.35);
    }

    .cost-chart-selectors {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 0.75rem;
        margin-top: 1rem;
        background: rgba(15, 15, 18, 0.9);
        padding: 0.85rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.06);
    }

    .cost-metric-selector label {
        display: block;
        font-size: 0.6rem;
        text-transform: uppercase;
        color: rgba(240, 242, 245, 0.6);
        letter-spacing: 0.4px;
        margin-bottom: 0.35rem;
    }

    .cost-metric-select {
        width: 100%;
        background: rgba(19, 19, 24, 0.92);
        color: #f7f7f7;
        border: 1px solid rgba(255, 255, 255, 0.16);
        border-radius: 6px;
        padding: 0.4rem 0.55rem;
        font-size: 0.78rem;
        transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    .cost-metric-select:hover,
    .cost-metric-select:focus {
        outline: none;
        border-color: rgba(240, 85, 69, 0.75);
        box-shadow: 0 0 0 2px rgba(240, 85, 69, 0.2);
    }

    .compare-placeholder {
        background: rgba(255, 255, 255, 0.02);
        border: 1px dashed rgba(255, 255, 255, 0.12);
        color: rgba(255, 255, 255, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        text-align: center;
        font-size: 0.75rem;
        padding: 1.5rem 0.75rem;
        border-radius: 12px;
        min-height: 200px;
        flex-direction: column;
        gap: 0.35rem;
    }

    .compare-placeholder i {
        color: rgba(240, 85, 69, 0.6);
    }

    @media (max-width: 992px) {
        .cost-chart-selectors {
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
        }
    }

    @media (max-width: 768px) {
        .compare-section .card-header {
            flex-direction: column;
            align-items: flex-start !important;
        }

        .compare-section .card-header>.d-flex.align-items-center.gap-2,
        .compare-section .card-header>.d-flex.align-items-center.gap-3 {
            width: 100%;
        }
    }

    .card-actions .btn {
        flex: 1;
        font-size: 0.75rem;
        padding: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 0.25rem;
    }

    .card-actions .btn {
        flex: 1;
        max-width: 120px;
    }

    /* Pagination Styling */
    .pagination .page-link {
        background: linear-gradient(145deg, #212529, #343a40);
        border: 1px solid #495057;
        color: #F05545;
        padding: 0.75rem 1rem;
        margin: 0 2px;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .pagination .page-link:hover {
        background: linear-gradient(145deg, #F05545, #d44437);
        border-color: #F05545;
        color: white;
        transform: translateY(-2px);
    }

    .pagination .page-item.active .page-link {
        background: linear-gradient(135deg, #F05545, #d44437);
        border-color: #F05545;
        color: white;
        box-shadow: 0 4px 12px rgba(240, 85, 69, 0.3);
    }

    .pagination .page-item.disabled .page-link {
        background: rgba(255, 255, 255, 0.1);
        border-color: rgba(255, 255, 255, 0.2);
        color: rgba(255, 255, 255, 0.5);
        cursor: not-allowed;
    }

    .pagination-section {
        background: rgba(18, 19, 24, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 0;
        padding: 0.85rem 1rem;
        margin: 1.5rem 0;
    }

    .pagination-info span {
        color: #f4f4f4;
        font-weight: 500;
        letter-spacing: 0.3px;
    }

    .pagination-info span span {
        color: #F05545;
        font-weight: 700;
    }

    .btn-outline-light {
        border-color: rgba(244, 244, 244, 0.35);
        color: #f4f4f4;
        background: rgba(255, 255, 255, 0.02);
        transition: all 0.25s ease;
    }

    .btn-outline-light:hover,
    .btn-outline-light:focus,
    .btn-outline-light.active {
        background: linear-gradient(135deg, #F05545, #d44437);
        border-color: rgba(240, 85, 69, 0.85);
        color: #ffffff;
        box-shadow: 0 6px 16px rgba(240, 85, 69, 0.25);
    }

    .text-muted {
        color: rgba(240, 240, 244, 0.65) !important;
    }

    .alert-info {
        background: rgba(18, 19, 24, 0.92);
        border: 1px solid rgba(240, 85, 69, 0.35);
        color: #f4f4f4;
    }

    /* Responsive Grid Adjustments */
    @media (max-width: 1200px) {
        .aircraft-listings-container {
            max-width: 1200px;
            padding: 0 1rem;
        }

        .aircraft-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 2.5rem;
            padding: 1.5rem;
            justify-items: center;
        }

        .aircraft-card {
            max-width: 320px;
            min-height: 500px;
        }

        .aircraft-image {
            height: 160px;
        }

        .aircraft-content {
            min-height: 320px;
            padding: 0.6rem;
        }
    }

    @media (max-width: 992px) {
        .aircraft-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    @media (max-width: 768px) {
        .aircraft-listings-container {
            max-width: 100%;
            padding: 0 1rem;
        }

        .aircraft-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            padding: 1rem;
            justify-items: center;
        }

        .aircraft-card {
            max-width: 100%;
            min-height: 480px;
        }

        .aircraft-image {
            height: 140px;
        }

        .aircraft-content {
            min-height: 320px;
            padding: 0.6rem;
        }
    }

    @media (max-width: 480px) {
        .aircraft-listings-container {
            max-width: 100%;
            padding: 0 0.5rem;
        }

        .aircraft-grid {
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
            padding: 0;
            justify-items: center;
        }

        .aircraft-card {
            max-width: 100%;
            min-height: 450px;
        }

        .aircraft-image {
            height: 120px;
        }

        .aircraft-content {
            min-height: 310px;
            padding: 0.5rem;
        }
    }

    /* Sorting Controls Styles */
    .sorting-controls {
        background: linear-gradient(145deg, #212529, #343a40);
        border: 1px solid #495057;
        border-radius: 12px;
        padding: 1rem;
        margin-bottom: 2rem;
    }

    .sorting-controls .form-select {
        background: #343a40;
        border: 1px solid #495057;
        color: white;
        border-radius: 8px;
    }

    .sorting-controls .form-select:focus {
        background: #495057;
        border-color: #F05545;
        color: white;
        box-shadow: 0 0 0 0.2rem rgba(240, 85, 69, 0.25);
    }

    .sorting-controls .form-select option {
        background: #343a40;
        color: white;
    }

    .sorting-controls .btn-group .btn {
        background: #343a40;
        border: 1px solid #495057;
        color: #adb5bd;
        border-radius: 8px;
        transition: all 0.3s ease;
    }

    .sorting-controls .btn-group .btn:hover,
    .sorting-controls .btn-group .btn.active {
        background: #F05545;
        border-color: #F05545;
        color: white;
    }

    .sorting-controls .btn-group .btn:first-child {
        border-top-right-radius: 0;
        border-bottom-right-radius: 0;
    }

    .sorting-controls .btn-group .btn:last-child {
        border-top-left-radius: 0;
        border-bottom-left-radius: 0;
    }

    /* List View Styles */
    .aircraft-grid.list-view {
        display: block;
    }

    .aircraft-grid.list-view .aircraft-card {
        display: flex;
        flex-direction: row;
        height: auto;
        min-height: 200px;
        max-height: none;
        margin-bottom: 1rem;
    }

    .aircraft-grid.list-view .aircraft-image {
        width: 200px;
        height: 200px;
        flex-shrink: 0;
    }

    .aircraft-grid.list-view .aircraft-details {
        flex: 1;
        padding: 1.5rem;
    }

    .aircraft-grid.list-view .enhanced-specs-grid {
        display: grid;
        grid-template-columns: repeat(6, 1fr);
        gap: 1rem;
        margin: 1rem 0;
    }

    .aircraft-grid.list-view .operating-costs {
        display: flex;
        gap: 2rem;
        margin: 1rem 0;
    }

    .aircraft-grid.list-view .priority-indicators {
        margin: 1rem 0;
    }

    .aircraft-grid.list-view .card-actions {
        margin-top: auto;
    }

    /* Professional Action Buttons */
    .card-actions {
        margin-top: 1.5rem;
        display: flex;
        gap: 0.75rem;
        padding-top: 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
    }

    .card-actions .btn {
        flex: 1;
        font-size: 0.85rem;
        padding: 0.75rem 1rem;
        border-radius: 12px;
        font-weight: 600;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        border-width: 2px;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .card-actions .btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    .card-actions .btn-outline-primary {
        border-color: #3b82f6;
        color: #3b82f6;
    }

    .card-actions .btn-outline-primary:hover {
        background: #3b82f6;
        border-color: #3b82f6;
        color: white;
    }

    .card-actions .btn-outline-success {
        border-color: #10b981;
        color: #10b981;
    }

    .card-actions .btn-outline-success:hover {
        background: #10b981;
        border-color: #10b981;
        color: white;
    }

    /* Professional Aircraft Header */
    .aircraft-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 1.25rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .aircraft-title-section {
        margin-bottom: 0.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid rgba(240, 85, 69, 0.3);
        position: relative;
        flex-shrink: 0;
    }

    .aircraft-title-section::after {
        content: '';
        position: absolute;
        bottom: -2px;
        left: 0;
        width: 50px;
        height: 2px;
        background: linear-gradient(90deg, #F05545, transparent);
    }

    .score-section {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.3rem;
        margin-bottom: 0.2rem;
        flex-shrink: 0;
    }

    .score-section:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
        border-color: rgba(255, 255, 255, 0.2);
    }

    .score-header {
        display: flex;
        align-items: center;
        gap: 0.25rem;
        margin-bottom: 0.1rem;
    }

    .score-header i {
        font-size: 0.6rem;
        color: #6c757d;
    }

    .score-header span {
        font-size: 0.6rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .score-display {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .score-value {
        font-size: 1rem;
        font-weight: 700;
        color: #F05545;
    }

    .score-label {
        font-size: 0.55rem;
        color: #6c757d;
    }

    .card-actions {
        display: flex;
        gap: 0.25rem;
        padding: 0.3rem;
        margin-top: auto;
        flex-shrink: 0;
    }

    .card-actions .btn {
        flex: 1;
        font-size: 0.6rem;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .informational-score .score-header {
        color: #17a2b8;
    }

    .score-display {
        text-align: center;
    }

    .score-value {
        font-size: 1.25rem;
        font-weight: 800;
        margin-bottom: 0.25rem;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .informational-score .score-value {
        color: #17a2b8;
    }

    .priority-score .score-value {
        color: #ffc107;
    }

    .score-label {
        font-size: 0.65rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .aircraft-name {
        font-size: 1.2rem;
        font-weight: 700;
        margin-bottom: 0.5rem;
        line-height: 1.3;
        color: #ffffff;
        letter-spacing: -0.02em;
    }

    .aircraft-category {
        font-size: 0.85rem;
        color: #9ca3af;
        margin-bottom: 0;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    .score-display {
        margin-left: 0.75rem;
    }

    .score-badge {
        padding: 0.5rem 0.75rem;
        border-radius: 20px;
        font-size: 0.8rem;
        font-weight: 700;
        text-align: center;
        min-width: 50px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        border: 2px solid rgba(255, 255, 255, 0.1);
    }

    .score-badge.excellent {
        background: linear-gradient(135deg, #00ff88, #00cc6a);
        color: #000;
    }

    .score-badge.very-good {
        background: linear-gradient(135deg, #4CAF50, #45a049);
        color: white;
    }

    .score-badge.good {
        background: linear-gradient(135deg, #ffd700, #ffb347);
        color: #000;
    }

    .score-badge.fair {
        background: linear-gradient(135deg, #ff9800, #f57c00);
        color: white;
    }

    .score-badge.poor {
        background: linear-gradient(135deg, #ff4757, #ee5a52);
        color: white;
    }

    /* Enhanced Aircraft Details */
    .aircraft-details {
        overflow: visible;
        padding: 1.5rem;
        flex-grow: 1;
        display: flex;
        flex-direction: column;
        background: linear-gradient(180deg, rgba(45, 45, 45, 0.8), rgba(26, 26, 26, 0.9));
    }

    /* Professional Specifications Grid */
    .enhanced-specs-grid {
        margin: 1.5rem 0;
        display: grid;
        grid-template-columns: repeat(5, 1fr);
        gap: 0.75rem;
        padding: 1rem;
        background: rgba(0, 0, 0, 0.2);
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .spec-item {
        text-align: center;
        padding: 0.5rem;
        border-radius: 8px;
        background: rgba(255, 255, 255, 0.03);
        transition: all 0.3s ease;
    }

    .spec-item:hover {
        background: rgba(255, 255, 255, 0.08);
        transform: translateY(-2px);
    }

    .spec-value {
        font-size: 1rem;
        font-weight: 700;
        color: #ffffff;
        margin-bottom: 0.25rem;
    }

    .spec-label {
        font-size: 0.7rem;
        color: #9ca3af;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.05em;
    }

    /* Professional Operating Costs */
    .operating-costs {
        margin: 1.5rem 0;
        padding: 1rem;
        background: rgba(240, 85, 69, 0.1);
        border-radius: 12px;
        border: 1px solid rgba(240, 85, 69, 0.2);
    }

    .cost-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .cost-item:last-child {
        margin-bottom: 0;
    }

    .cost-label {
        font-size: 0.85rem;
        color: #9ca3af;
        font-weight: 500;
    }

    .cost-value {
        font-size: 1rem;
        font-weight: 700;
        color: #F05545;
    }

    /* Professional Priority Indicators */
    .priority-indicators {
        margin: 1.5rem 0;
    }

    /* Ensure proper spacing */
    /* Removed conflicting aircraft-card rule */

    .count-details {
        margin-top: 0.25rem;
    }

    .count-details small {
        font-size: 0.75rem;
        opacity: 0.8;
    }

    .aircraft-price {
        font-size: 1.4rem;
        font-weight: bold;
        color: #28a745;
        margin-bottom: 1rem;
    }

    .key-specs-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.75rem;
        margin-bottom: 1rem;
    }

    .spec-item {
        text-align: center;
        padding: 0.75rem 0.5rem;
        background: #343a40;
        border-radius: 8px;
        border: 1px solid #495057;
    }

    .spec-value {
        font-size: 1rem;
        font-weight: bold;
        color: #F05545;
        margin-bottom: 0.25rem;
    }

    .spec-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .operating-cost {
        background: #2c3034;
        border-radius: 8px;
        padding: 0.75rem;
        margin-bottom: 1rem;
        border-left: 4px solid #28a745;
    }

    .cost-label {
        font-size: 0.75rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.25rem;
    }

    .cost-value {
        font-size: 1.1rem;
        font-weight: bold;
        color: #28a745;
    }

    .value-rating {
        text-align: center;
        padding: 0.5rem;
        border-radius: 8px;
        font-weight: bold;
        font-size: 0.9rem;
        margin-bottom: 1rem;
    }

    .value-rating.excellent {
        background: rgba(40, 167, 69, 0.2);
        color: #28a745;
        border: 1px solid rgba(40, 167, 69, 0.3);
    }

    .value-rating.very-good {
        background: rgba(23, 162, 184, 0.2);
        color: #17a2b8;
        border: 1px solid rgba(23, 162, 184, 0.3);
    }

    .value-rating.good {
        background: rgba(255, 193, 7, 0.2);
        color: #ffc107;
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .value-rating.fair {
        background: rgba(253, 126, 20, 0.2);
        color: #fd7e14;
        border: 1px solid rgba(253, 126, 20, 0.3);
    }

    .value-rating.poor {
        background: rgba(220, 53, 69, 0.2);
        color: #dc3545;
        border: 1px solid rgba(220, 53, 69, 0.3);
    }

    .card-actions {
        margin-top: auto;
        text-align: center;
    }

    .card-actions .btn {
        width: 100%;
        border-radius: 8px;
        font-weight: 500;
    }

    .score-breakdown {
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(40, 167, 69, 0.1) 100%);
        border-radius: 12px;
        border-left: 4px solid #F05545;
    }

    .score-breakdown h6 {
        color: #F05545;
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .score-breakdown h6 i {
        margin-right: 8px;
    }

    .score-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }

    .score-metric {
        text-align: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
    }

    .score-metric .metric-value {
        font-size: 1.1rem;
        font-weight: 700;
        color: white;
        margin-bottom: 2px;
    }

    .score-metric .metric-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .value-rating {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        margin-top: 8px;
    }

    .value-rating.excellent {
        background: rgba(40, 167, 69, 0.9);
        color: white;
    }

    .value-rating.very-good {
        background: rgba(0, 123, 255, 0.9);
        color: white;
    }

    .value-rating.good {
        background: rgba(255, 193, 7, 0.9);
        color: #000;
    }

    .value-rating.fair {
        background: rgba(108, 117, 125, 0.9);
        color: white;
    }

    .value-rating.poor {
        background: rgba(220, 53, 69, 0.9);
        color: white;
    }

    .aircraft-actions {
        display: flex;
        gap: 12px;
        margin-top: 20px;
    }

    .aircraft-actions button {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-weight: 600;
        font-size: 0.9rem;
        transition: all 0.2s ease;
        border: 1px solid;
    }

    .aircraft-actions .btn-outline-info {
        color: #17a2b8;
        border-color: #17a2b8;
        background: transparent;
    }

    .aircraft-actions .btn-outline-info:hover {
        background: #17a2b8;
        color: white;
        transform: translateY(-1px);
    }

    /* Score Overlay Styles */
    .score-overlay {
        position: absolute;
        top: 10px;
        right: 10px;
        z-index: 10;
    }

    .score-circle {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        border: 2px solid rgba(255, 255, 255, 0.3);
    }

    .score-circle.excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
    }

    .score-circle.very-good {
        background: linear-gradient(135deg, #007bff, #17a2b8);
    }

    .score-circle.good {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
    }

    .score-circle.fair {
        background: linear-gradient(135deg, #6c757d, #495057);
    }

    .score-circle.poor {
        background: linear-gradient(135deg, #dc3545, #e83e8c);
    }

    /* Aircraft Category Styles */
    .aircraft-category {
        background: rgba(240, 85, 69, 0.2);
        color: #F05545;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.7rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border: 1px solid rgba(240, 85, 69, 0.3);
    }

    /* Performance Metrics Styles */
    .performance-metrics {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(23, 162, 184, 0.1);
        border-radius: 12px;
        border-left: 4px solid #17a2b8;
    }

    .performance-metrics h6 {
        color: #17a2b8;
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .performance-metrics h6 i {
        margin-right: 8px;
    }

    .metrics-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .metric-item {
        text-align: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        transition: background 0.2s ease;
    }

    .metric-item:hover {
        background: rgba(23, 162, 184, 0.1);
    }

    .metric-item .metric-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .metric-item .metric-value {
        font-size: 0.9rem;
        font-weight: 700;
        color: white;
    }

    /* Cost Analysis Styles */
    .cost-analysis {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(40, 167, 69, 0.1);
        border-radius: 12px;
        border-left: 4px solid #28a745;
    }

    .cost-analysis h6 {
        color: #28a745;
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .cost-analysis h6 i {
        margin-right: 8px;
    }

    .cost-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
    }

    .cost-item {
        text-align: center;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        transition: background 0.2s ease;
    }

    .cost-item:hover {
        background: rgba(40, 167, 69, 0.1);
    }

    .cost-item .cost-label {
        font-size: 0.7rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .cost-item .cost-value {
        font-size: 0.9rem;
        font-weight: 700;
        color: #28a745;
    }

    /* Value Performance Metrics Styles */
    .value-metrics {
        margin-bottom: 20px;
        padding: 16px;
        background: rgba(255, 193, 7, 0.1);
        border-radius: 12px;
        border-left: 4px solid #ffc107;
    }

    .value-metrics h6 {
        color: #ffc107;
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .value-metrics h6 i {
        margin-right: 8px;
    }

    .value-grid {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }

    .value-item {
        text-align: center;
        padding: 6px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        transition: background 0.2s ease;
    }

    .value-item.highlight {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid rgba(255, 193, 7, 0.3);
    }

    .value-item:hover {
        background: rgba(255, 193, 7, 0.1);
    }

    .value-item .value-label {
        font-size: 0.6rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 2px;
    }

    .value-item .value-score {
        font-size: 0.8rem;
        font-weight: 700;
        padding: 2px 4px;
        border-radius: 4px;
    }

    .value-score.excellent {
        background: rgba(40, 167, 69, 0.9);
        color: white;
    }

    .value-score.good {
        background: rgba(0, 123, 255, 0.9);
        color: white;
    }

    .value-score.fair {
        background: rgba(255, 193, 7, 0.9);
        color: #000;
    }

    .value-score.poor {
        background: rgba(220, 53, 69, 0.9);
        color: white;
    }

    /* Enhanced Score Breakdown Styles */
    .score-breakdown {
        margin-bottom: 20px;
        padding: 16px;
        background: linear-gradient(135deg, rgba(0, 123, 255, 0.1) 0%, rgba(40, 167, 69, 0.1) 100%);
        border-radius: 12px;
        border-left: 4px solid #F05545;
    }

    .score-breakdown h6 {
        color: #F05545;
        font-size: 0.9rem;
        margin-bottom: 12px;
        font-weight: 600;
        display: flex;
        align-items: center;
    }

    .score-breakdown h6 i {
        margin-right: 8px;
    }

    .score-metrics {
        display: grid;
        grid-template-columns: 1fr 1fr 1fr;
        gap: 12px;
        margin-bottom: 12px;
    }

    .score-metric.final {
        background: rgba(240, 85, 69, 0.2);
        border: 1px solid rgba(240, 85, 69, 0.3);
    }

    .score-metric.final .metric-value {
        color: #F05545;
        font-size: 1.2rem;
    }

    .aircraft-actions .btn-outline-warning {
        color: #ffc107;
        border-color: #ffc107;
        background: transparent;
    }

    .aircraft-actions .btn-outline-warning:hover {
        background: #ffc107;
        color: #000;
        transform: translateY(-1px);
    }

    /* Remove old badge styles */
    .score-badge,
    .price-badge {
        display: none;
    }

    /* Score Badge Styles */
    .score-badge {
        position: absolute;
        top: 15px;
        right: 15px;
        padding: 8px 12px;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1.1rem;
        text-align: center;
        min-width: 65px;
        box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        border: 2px solid rgba(255, 255, 255, 0.2);
        z-index: 5;
    }

    .score-badge.excellent {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
        animation: pulse-success 2s infinite;
    }

    .score-badge.very-good {
        background: linear-gradient(135deg, #007bff, #17a2b8);
        color: white;
        border-color: rgba(255, 255, 255, 0.3);
    }

    .score-badge.good {
        background: linear-gradient(135deg, #ffc107, #fd7e14);
        color: #000;
        border-color: rgba(0, 0, 0, 0.1);
    }

    .score-badge.fair {
        background: linear-gradient(135deg, #6c757d, #495057);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
    }

    .score-badge.poor {
        background: linear-gradient(135deg, #dc3545, #c82333);
        color: white;
        border-color: rgba(255, 255, 255, 0.2);
    }

    @keyframes pulse-success {

        0%,
        100% {
            transform: scale(1);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.4);
        }

        50% {
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.5);
        }
    }

    /* Price Badge Styles */
    .price-badge {
        background-color: #ff6b5b;
        color: white;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 0.75rem;
        margin-bottom: 5px;
    }

    .price-badge.poa {
        background-color: #6c757d;
        color: white;
    }

    /* Value Rating Styles */
    .value-rating {
        position: absolute;
        top: 70px;
        right: 15px;
        padding: 4px 8px;
        border-radius: 15px;
        font-size: 0.75rem;
        font-weight: 600;
        text-align: center;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        z-index: 4;
    }

    .value-rating.excellent {
        background: rgba(40, 167, 69, 0.9);
        color: white;
    }

    .value-rating.very-good {
        background: rgba(0, 123, 255, 0.9);
        color: white;
    }

    .value-rating.good {
        background: rgba(255, 193, 7, 0.9);
        color: #000;
    }

    .value-rating.fair {
        background: rgba(108, 117, 125, 0.9);
        color: white;
    }

    .value-rating.poor {
        background: rgba(220, 53, 69, 0.9);
        color: white;
    }

    /* Score Breakdown Styles */
    .score-breakdown-section {
        margin-bottom: 15px;
        padding: 10px;
        background: rgba(0, 123, 255, 0.1);
        border-radius: 6px;
        border-left: 3px solid #007bff;
    }

    .score-breakdown-section h6 {
        color: #007bff;
        font-size: 0.8rem;
        margin-bottom: 5px;
    }

    .score-breakdown-section .spec-row {
        color: white;
        font-size: 0.9rem;
    }

    .score-breakdown-section .spec-label {
        font-weight: 500;
    }

    .score-breakdown-section .spec-value {
        font-weight: bold;
    }

    /* Aircraft Actions Styles */
    .aircraft-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 10px;
    }

    .aircraft-actions button {
        flex: 1;
        margin-right: 10px;
    }

    .aircraft-actions button:last-child {
        margin-right: 0;
    }

    /* Pagination Styles */
    .pagination {
        display: flex;
        justify-content: center;
        margin-top: 20px;
    }

    .pagination .page-item {
        margin: 0 5px;
    }

    .pagination .page-link {
        background-color: #343a40;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 4px;
        transition: background-color 0.3s;
    }

    .pagination .page-link:hover {
        background-color: #4a5568;
    }

    .pagination .active .page-link {
        background-color: #F05545;
        border-color: #F05545;
    }

    .pagination .disabled .page-link {
        background-color: #6c757d;
        pointer-events: none;
    }

    .score-metric.final .metric-value {
        color: #F05545;
        font-size: 1.2rem;
    }

    /* Scoring Explanation Styles */
    .scoring-explanation {
        margin-bottom: 30px;
    }

    .formula-breakdown {
        margin-top: 15px;
    }

    .formula-step {
        display: flex;
        align-items: flex-start;
        margin-bottom: 12px;
        padding: 8px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 8px;
        border-left: 3px solid #17a2b8;
    }

    .step-number {
        background: #17a2b8;
        color: white;
        width: 24px;
        height: 24px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: 700;
        font-size: 0.8rem;
        margin-right: 12px;
        flex-shrink: 0;
    }

    .step-text {
        color: #e9ecef;
        font-size: 0.9rem;
        line-height: 1.4;
    }

    .score-ranges {
        margin-top: 15px;
    }

    .score-range {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 8px 12px;
        margin-bottom: 8px;
        border-radius: 6px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .score-range.excellent {
        background: rgba(40, 167, 69, 0.2);
        border: 1px solid rgba(40, 167, 69, 0.3);
        color: #28a745;
    }

    .score-range.very-good {
        background: rgba(0, 123, 255, 0.2);
        border: 1px solid rgba(0, 123, 255, 0.3);
        color: #007bff;
    }

    .score-range.good {
        background: rgba(255, 193, 7, 0.2);
        border: 1px solid rgba(255, 193, 7, 0.3);
        color: #ffc107;
    }

    .score-range.fair {
        background: rgba(108, 117, 125, 0.2);
        border: 1px solid rgba(108, 117, 125, 0.3);
        color: #6c757d;
    }

    .score-range.poor {
        background: rgba(220, 53, 69, 0.2);
        border: 1px solid rgba(220, 53, 69, 0.3);
        color: #dc3545;
    }

    .range-label {
        font-weight: 700;
    }

    .range-description {
        font-weight: 500;
    }

    .aircraft-image {
        height: 180px;
        overflow: hidden;
        background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
        position: relative;
        flex-shrink: 0;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .aircraft-image:hover {
        transform: scale(1.02);
        box-shadow: 0 4px 12px rgba(240, 85, 69, 0.3);
    }

    /* Photo Gallery Styles */
    .photo-overlay {
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        background: linear-gradient(transparent, rgba(0, 0, 0, 0.8));
        color: white;
        padding: 0.5rem;
        opacity: 0;
        transition: opacity 0.3s ease;
        font-size: 0.8rem;
        text-align: center;
    }

    .aircraft-image:hover .photo-overlay {
        opacity: 1;
    }

    /* Photo Gallery Modal */
    .photo-gallery-modal {
        display: none;
        position: fixed;
        z-index: 10000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
    }

    .photo-gallery-content {
        position: relative;
        width: 90%;
        height: 90%;
        margin: 5% auto;
        background: #1a1a1a;
        border-radius: 12px;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .gallery-header {
        background: #2d2d2d;
        padding: 1rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 1px solid #404040;
    }

    .gallery-title {
        color: #F05545;
        font-size: 1.2rem;
        font-weight: bold;
        flex: 1;
    }

    .gallery-close {
        background: none;
        border: none;
        color: #fff;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0.5rem;
        border-radius: 50%;
        transition: background 0.3s ease;
    }

    .gallery-close:hover {
        background: rgba(255, 255, 255, 0.1);
    }

    .gallery-main {
        flex: 1;
        display: flex;
        position: relative;
        overflow: hidden;
    }

    .gallery-image-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        background: #000;
    }

    .gallery-main-image {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
        transition: transform 0.3s ease;
    }

    .zoom-controls {
        position: absolute;
        bottom: 20px;
        right: 20px;
        display: flex;
        gap: 10px;
    }

    .zoom-btn {
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #F05545;
        color: white;
        padding: 8px 12px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .zoom-btn:hover {
        background: #F05545;
    }

    .gallery-nav {
        position: absolute;
        top: 50%;
        transform: translateY(-50%);
        background: rgba(0, 0, 0, 0.7);
        border: 1px solid #F05545;
        color: white;
        padding: 12px 16px;
        border-radius: 50%;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.2rem;
    }

    .gallery-nav:hover {
        background: #F05545;
    }

    .gallery-prev {
        left: 20px;
    }

    .gallery-next {
        right: 20px;
    }

    /* Score Breakdown Styles */
    .score-breakdown-section {
        background: linear-gradient(135deg, #2d2d2d, #1a1a1a);
        border: 1px solid #F05545;
        border-radius: 8px;
        padding: 1rem;
        margin: 0.5rem 0;
    }

    .final-score-display {
        text-align: center;
        margin-bottom: 1rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #404040;
    }

    .final-score-value {
        font-size: 2rem;
        font-weight: bold;
        color: #F05545;
        margin: 0.5rem 0;
    }

    .score-calculation {
        font-size: 0.8rem;
        color: #aaa;
        font-style: italic;
    }

    .component-scores {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    .component-score {
        background: rgba(240, 85, 69, 0.1);
        border: 1px solid rgba(240, 85, 69, 0.3);
        border-radius: 6px;
        padding: 0.75rem;
        text-align: center;
    }

    .component-label {
        font-size: 0.8rem;
        color: #ccc;
        margin-bottom: 0.5rem;
    }

    .component-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: #F05545;
    }

    /* Filter Display Styles */
    .filter-tags .badge {
        font-size: 0.75rem;
        padding: 0.5rem 0.75rem;
    }

    /* Toast Notification Styles */
    .toast-notification {
        animation: slideInRight 0.3s ease-out;
    }

    @keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }

        to {
            transform: translateX(0);
            opacity: 1;
        }
    }

    .aircraft-content {
        padding: 0.75rem;
        flex: 1;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
        overflow-y: auto;
        min-height: 340px;
    }

    .aircraft-name {
        font-size: 0.95rem;
        font-weight: 700;
        color: #F05545;
        margin: 0 0 0.2rem 0;
        line-height: 1.2;
        text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
    }

    .aircraft-info {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.3rem;
        margin-bottom: 0.2rem;
        flex-shrink: 0;
    }

    .info-row {
        display: flex;
        justify-content: space-between;
        gap: 0.4rem;
        margin-bottom: 0.15rem;
        font-size: 0.7rem;
    }

    .info-label {
        font-size: 0.6rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.15rem;
    }

    .info-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #F05545;
    }

    .specifications {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 6px;
        padding: 0.3rem;
        margin-bottom: 0.2rem;
        flex-shrink: 0;
    }

    .spec-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.3rem;
    }

    .spec-value {
        font-size: 0.75rem;
        font-weight: 600;
        color: #17a2b8;
        margin-bottom: 0.15rem;
    }

    .spec-label {
        font-size: 0.55rem;
        color: #6c757d;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Standardized Spacing System */
    .container {
        padding-left: 1.5rem;
        padding-right: 1.5rem;
    }

    .container .row {
        margin-left: -0.75rem;
        margin-right: -0.75rem;
    }

    .container .row>[class*="col-"] {
        padding-left: 0.75rem;
        padding-right: 0.75rem;
    }

    /* Consistent Card Spacing */
    .card {
        margin-bottom: 1.5rem;
    }

    .card-header {
        padding: 1rem 1.25rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
    }

    .card-body {
        padding: 1.25rem;
    }

    /* Standardized Section Spacing */
    .row.mb-4,
    .row.mt-4 {
        margin-bottom: 2rem !important;
    }

    .row.mb-3,
    .row.mt-3 {
        margin-bottom: 1.5rem !important;
    }

    /* Consistent Form Group Spacing */
    .form-group {
        margin-bottom: 1.25rem;
    }

    .form-group.mb-3 {
        margin-bottom: 1rem;
    }

    .form-group.mb-4 {
        margin-bottom: 1.5rem;
    }

    /* Standardized Grid Gap */
    .aircraft-grid {
        gap: 3rem;
    }

    /* Consistent Pagination Spacing */
    .pagination-section {
        margin: 1.5rem 0;
    }

    /* Standardized Compare Section */
    .compare-section {
        margin-bottom: 2rem;
    }

    /* Consistent Listings Container */
    .aircraft-listings-container {
        padding: 0 1.5rem;
    }

    /* Standardized Button Spacing */
    .btn-group,
    .d-flex.gap-2,
    .d-flex.gap-3 {
        gap: 0.75rem;
    }

    /* Consistent Input Group Spacing */
    .input-group {
        margin-bottom: 0;
    }

    .input-group+.form-text,
    .input-group+small {
        margin-top: 0.5rem;
        display: block;
    }

    /* Empty State Styling */
    .no-listings-state {
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 500px;
        padding: 2rem;
    }

    .empty-state-card {
        background: rgba(18, 19, 24, 0.92);
        border: 1px solid rgba(255, 255, 255, 0.06);
        border-radius: 0;
        padding: 3rem;
        text-align: center;
        max-width: 500px;
        width: 100%;
    }

    .empty-state-content h3 {
        color: #f4f4f4;
        font-weight: 600;
    }

    /* User Listings Grid */
    .user-listings-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 3rem;
        padding: 2rem;
        width: 100%;
        margin: 0 auto;
        justify-items: center;
        align-items: start;
    }

    /* Performance Profiles Grid */
    .performance-profiles-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        max-height: 400px;
        overflow-y: auto;
        padding: 1rem;
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0;
        background: rgba(0, 0, 0, 0.2);
    }

    .performance-profile-card {
        background: rgba(18, 19, 24, 0.95);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 0;
        padding: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .performance-profile-card:hover {
        border-color: #F05545;
        background: rgba(240, 85, 69, 0.05);
    }

    .performance-profile-card.selected {
        border-color: #F05545;
        background: rgba(240, 85, 69, 0.1);
        box-shadow: 0 0 20px rgba(240, 85, 69, 0.2);
    }

    .profile-header {
        display: flex;
        justify-content: between;
        align-items: center;
        margin-bottom: 0.75rem;
    }

    .profile-title {
        font-size: 0.9rem;
        font-weight: 600;
        color: #f4f4f4;
        margin: 0;
    }

    .profile-category {
        font-size: 0.7rem;
        color: #F05545;
        background: rgba(240, 85, 69, 0.1);
        padding: 0.2rem 0.5rem;
        border-radius: 0;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .profile-specs {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        font-size: 0.75rem;
    }

    .profile-spec {
        display: flex;
        justify-content: space-between;
        color: #adb5bd;
    }

    .profile-spec-value {
        color: #f4f4f4;
        font-weight: 500;
    }

    /* Step Navigation */
    .step-header {
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        padding-bottom: 1rem;
    }

    .step-actions {
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        padding-top: 1rem;
    }

    /* Modal Enhancements */
    .modal-xl {
        max-width: 1200px;
    }

    /* Responsive adjustments for new layout */
    @media (max-width: 1200px) {
        .user-listings-grid {
            grid-template-columns: repeat(3, 1fr);
            gap: 2.5rem;
            padding: 1.5rem;
        }
    }

    @media (max-width: 992px) {
        .user-listings-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 2rem;
        }
    }

    @media (max-width: 768px) {
        .user-listings-grid {
            grid-template-columns: repeat(2, 1fr);
            gap: 1.5rem;
            padding: 1rem;
        }

        .performance-profiles-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
{% endblock %}
{% block content %}
<div class="container py-4 position-relative">
    <!-- Route Planning Tools Section -->
    <div class="row mb-4">
        <!-- Range Filter Tool (Left Column) -->
        <div class="col-md-6">
            <div class="card bg-black border border-secondary h-100">
                <div class="card-header d-flex align-items-center">
                    <h4 class="mb-0 me-auto">Range Filter Tool</h4>
                </div>
                <div class="card-body">
                    <div class="mb-4">
                        <!-- Home Airport Selection -->
                        <div class="form-group mb-3">
                            <label for="home-airport-search" class="form-label">Select Home Airport</label>
                            <div class="input-group">
                                <input type="text" class="form-control bg-dark text-white border-secondary"
                                    id="home-airport-search" placeholder="Search for airport...">
                                <button class="btn btn-outline-danger" type="button" id="search-home-btn">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="home-airport-results" class="airport-results d-none">
                                <div id="home-airport-list" class="list-group"></div>
                            </div>
                        </div>

                        <!-- Range Slider -->
                        <div class="form-group mb-3">
                            <label for="range-slider" class="form-label">Range Filter (nm)</label>
                            <div class="d-flex align-items-center gap-2">
                                <input type="range" class="form-range flex-grow-1" id="range-slider" min="0" max="7000"
                                    step="50" value="500">
                                <span id="range-value" class="badge bg-secondary">500</span>
                                <button id="reset-range-btn" class="btn btn-sm btn-outline-secondary"
                                    title="Reset to average trip length">
                                    <i class="fas fa-undo"></i>
                                </button>
                            </div>
                            <small class="text-muted">Filter aircraft by range from home airport</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Route Planning Tool (Right Column) -->
        <div class="col-md-6">
            <div class="card bg-black border border-secondary h-100">
                <div class="card-header d-flex align-items-center justify-content-between">
                    <h4 class="mb-0">Route Planning Tool</h4>
                    <div class="d-flex gap-2">
                        <button id="clear-routes-btn" class="btn btn-sm btn-outline-danger">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Route Selection -->
                    <div class="row mb-3">
                        <div class="col-md-5">
                            <label for="from-airport" class="form-label">From</label>
                            <div class="position-relative">
                                <input type="text" class="form-control bg-dark text-white border-secondary"
                                    id="from-airport" placeholder="Search airports...">
                                <div id="from-airport-results" class="airport-results d-none">
                                    <div id="from-airport-list" class="list-group"></div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-2 d-flex align-items-end justify-content-center">
                            <button id="add-route-btn" class="btn btn-danger mb-2" title="Add Route">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <div class="col-md-5">
                            <label for="to-airport" class="form-label">To</label>
                            <div class="position-relative">
                                <input type="text" class="form-control bg-dark text-white border-secondary"
                                    id="to-airport" placeholder="Search airports...">
                                <div id="to-airport-results" class="airport-results d-none">
                                    <div id="to-airport-list" class="list-group"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Route Summary -->
                    <div class="mb-3">
                        <h6 class="text-secondary">Route Summary</h6>
                        <div class="small text-muted">
                            Total: <span id="total-distance" class="text-danger">0 nm avg, 0 nm longest, 0 trips</span>
                        </div>
                    </div>

                    <!-- Routes List -->
                    <div id="routes-container" style="max-height: 200px; overflow-y: auto;">
                        <div class="text-secondary text-center">No routes added</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Map Container -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-black border border-secondary">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            Range Map
                            <span class="aircraft-count-display ms-3">
                                <span class="aircraft-count-label">Aircraft Remaining</span>
                                <span class="aircraft-count-value" id="range-aircraft-remaining">0</span>
                            </span>
                        </h4>
                    </div>
                    <div class="card-body p-0">
                        <div id="map" style="height: 500px; border-radius: 0 0 8px 8px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Unified Aircraft Selection Inputs -->
        <div class="row">
            <div class="col-12">
                <div class="card bg-black border border-secondary">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">Aircraft Selection Parameters</h4>
                        <div class="text-muted small">
                            <i class="fas fa-calculator me-1"></i>
                            Configure your aircraft requirements and financial parameters
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- Basic Requirements -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <h6 class="text-warning mb-2"><i class="fas fa-plane me-2"></i>Basic Requirements</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="range-input" class="form-label text-white small">Range Requirement
                                    (NM)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="range-input" placeholder="Auto-calculated from routes"
                                    value="{{ request.args.get('range_requirement', '') }}">
                                <small class="text-muted">Auto-updates from route planning</small>
                            </div>
                            <div class="col-md-3">
                                <label for="passengers" class="form-label text-white small">Passengers</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="passengers" placeholder="e.g. 6"
                                    value="{{ request.args.get('passengers', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="budget" class="form-label text-white small">Average Price ($)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary" id="budget"
                                    placeholder="e.g. 5,000,000" value="{{ request.args.get('budget', '') }}">
                            </div>
                            <div class="col-md-3">
                                <label for="lowest-year" class="form-label text-white small">Lowest Acceptable
                                    Year</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="lowest-year" placeholder="e.g. 2000" min="1950" max="2024"
                                    value="{{ request.args.get('lowest_year', '') }}">
                            </div>
                        </div>

                        <!-- Trip Planning -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <h6 class="text-info mb-2"><i class="fas fa-route me-2"></i>Trip Planning</h6>
                            </div>
                            <div class="col-md-3">
                                <label for="avg-trip-length" class="form-label text-white small">Average Trip Length
                                    (NM)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="avg-trip-length" placeholder="Auto-calculated from routes"
                                    value="{{ request.args.get('avg_trip_length', '') }}">
                                <small class="text-muted">Auto-updates from route planning</small>
                            </div>
                            <div class="col-md-3">
                                <label for="number-of-trips" class="form-label text-white small"># of Trips</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="number-of-trips" placeholder="Auto-calculated from routes"
                                    value="{{ request.args.get('yearly_trips', '') }}">
                                <small class="text-muted">Auto-updates from route planning</small>
                            </div>
                            <div class="col-md-3">
                                <label for="yearsOfOwnership" class="form-label text-white small">Years of
                                    Ownership</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="yearsOfOwnership" placeholder="e.g. 5" min="1" max="20">
                            </div>
                            <div class="col-md-3">
                                <label for="speed" class="form-label text-white small">Speed (KTS)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary" id="speed"
                                    placeholder="e.g. 400" min="0">
                            </div>
                        </div>

                        <!-- Aircraft Specifications -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <h6 class="text-success mb-2"><i class="fas fa-cogs me-2"></i>Aircraft Specifications
                                </h6>
                            </div>
                            <div class="col-md-3">
                                <label for="lowestYear" class="form-label text-white small">Lowest Year</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="lowestYear" placeholder="e.g. 1990" min="1950" max="2024">
                            </div>
                            <div class="col-md-3">
                                <label for="highestYear" class="form-label text-white small">Highest Year</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="highestYear" placeholder="e.g. 2024" min="1950" max="2024">
                            </div>
                            <div class="col-md-3">
                                <label for="minCrewRequired" class="form-label text-white small">Min Crew
                                    Required</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="minCrewRequired" placeholder="e.g. 1" min="1" max="5">
                            </div>
                            <div class="col-md-3">
                                <label for="maxOperatingAltitude" class="form-label text-white small">Max Operating
                                    Altitude
                                    (ft)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="maxOperatingAltitude" placeholder="e.g. 45,000" min="0">
                            </div>
                            <div class="col-md-3">
                                <label for="balancedFieldLength" class="form-label text-white small">Balanced Field
                                    Length
                                    (ft)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="balancedFieldLength" placeholder="e.g. 5,000" min="0">
                            </div>
                            <div class="col-md-3">
                                <label for="aircraftHeight" class="form-label text-white small">Aircraft Height
                                    (ft)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="aircraftHeight" placeholder="e.g. 15.0" min="0" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label for="wingspan" class="form-label text-white small">Wingspan (ft)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="wingspan" placeholder="e.g. 65.0" min="0" step="0.1">
                            </div>
                            <div class="col-md-3">
                                <label for="aircraftLength" class="form-label text-white small">Aircraft Length
                                    (ft)</label>
                                <input type="number"
                                    class="form-control form-control-sm bg-dark text-white border-secondary"
                                    id="aircraftLength" placeholder="e.g. 55.0" min="0" step="0.1">
                            </div>
                        </div>


                        <!-- Aircraft Categories -->
                        <div class="row g-2 mb-3">
                            <div class="col-12">
                                <h6 class="text-light mb-2"><i class="fas fa-tags me-2"></i>Aircraft Categories</h6>
                            </div>
                            <div class="col-md-4">
                                <label for="manufacturer" class="form-label text-white small">Manufacturer</label>
                                <select class="form-select form-select-sm bg-dark text-white border-secondary"
                                    id="manufacturer">
                                    <option value="">-- Any Manufacturer --</option>
                                    <option value="AIRBUS">AIRBUS</option>
                                    <option value="ATR">ATR</option>
                                    <option value="BAE">BAE</option>
                                    <option value="BEECH">BEECH</option>
                                    <option value="BEECHCRAFT">BEECHCRAFT</option>
                                    <option value="BOEING">BOEING</option>
                                    <option value="BOMBARDIER">BOMBARDIER</option>
                                    <option value="CESSNA">CESSNA</option>
                                    <option value="CIRRUS">CIRRUS</option>
                                    <option value="DAHER">DAHER</option>
                                    <option value="DASSAULT">DASSAULT</option>
                                    <option value="DIAMOND">DIAMOND</option>
                                    <option value="ECLIPSE">ECLIPSE</option>
                                    <option value="EMBRAER">EMBRAER</option>
                                    <option value="FAIRCHILD">FAIRCHILD</option>
                                    <option value="GULFSTREAM">GULFSTREAM</option>
                                    <option value="HONDA">HONDA</option>
                                    <option value="IAI">IAI</option>
                                    <option value="MITSUBISHI">MITSUBISHI</option>
                                    <option value="MOONEY">MOONEY</option>
                                    <option value="NEXTANT">NEXTANT</option>
                                    <option value="PIAGGIO">PIAGGIO</option>
                                    <option value="PILATUS">PILATUS</option>
                                    <option value="PIPER">PIPER</option>
                                    <option value="ROCKWELL">ROCKWELL</option>
                                    <option value="SOCATA">SOCATA</option>
                                    <option value="VIKING/DEHAVILLAND">VIKING/DEHAVILLAND</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="type" class="form-label text-white small">Type</label>
                                <select class="form-select form-select-sm bg-dark text-white border-secondary"
                                    id="type">
                                    <option value="">-- Any Type --</option>
                                    <option value="Piston">Piston</option>
                                    <option value="Turboprop">Turboprop</option>
                                    <option value="Business Jet">Business Jet</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label for="multiEngine" class="form-label text-white small">Multi Engine</label>
                                <select class="form-select form-select-sm bg-dark text-white border-secondary"
                                    id="multiEngine">
                                    <option value="">-- Any Configuration --</option>
                                    <option value="Yes">Yes</option>
                                    <option value="No">No</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Compare Section -->
        <div class="compare-section card bg-dark border-secondary mb-4" id="compareSection">
            <div class="card-header d-flex flex-wrap align-items-center justify-content-between gap-3"
                style="background: linear-gradient(135deg, rgba(240, 85, 69, 0.85), rgba(52, 58, 64, 0.95)); border-bottom: 1px solid rgba(255, 255, 255, 0.08);">
                <div class="d-flex align-items-center gap-3">
                    <span class="compare-icon d-flex align-items-center justify-content-center">
                        <i class="fas fa-balance-scale"></i>
                    </span>
                    <div>
                        <h5 class="mb-1 text-white">Compare Aircraft</h5>
                        <p class="mb-0 text-white-50 small">Pin up to four aircraft to visualize performance and
                            lifetime
                            costs side-by-side.</p>
                    </div>
                </div>
                <div class="d-flex align-items-center gap-2">
                    <span class="badge rounded-pill compare-count" id="compareSelectedCount">0 / 4 selected</span>
                    <span class="compare-limit-notice text-warning small" id="compareLimitNotice"></span>
                    <button type="button" class="btn btn-sm btn-outline-light" id="clearCompareBtn" disabled>
                        <i class="fas fa-times me-1"></i>Clear All
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="compareEmptyState" class="compare-empty text-center text-white-50 py-4">
                    <i class="fas fa-balance-scale fa-2x mb-3"></i>
                    <p class="mb-1">Use the Add to Compare button on any aircraft card to build your shortlist.</p>
                    <small>Selections persist while you filter or paginate.</small>
                </div>
                <div id="compareContent" class="compare-content d-none">
                    <div class="compare-aircraft-grid" id="compareAircraftContainer"></div>
                    <div class="compare-chart-card">
                        <div class="chart-header">
                            <h6 class="mb-1 text-white">Cost Outlook</h6>
                            <small class="text-white-50">Select any three Excel columns (LBO) to visualize
                                side-by-side.</small>
                        </div>
                        <div class="compare-cost-charts" id="costChartsContainer"></div>
                        <div class="cost-chart-selectors">
                            <div class="cost-metric-selector">
                                <label for="costMetricSelect0">Column 1</label>
                                <select class="cost-metric-select" id="costMetricSelect0" data-index="0"></select>
                            </div>
                            <div class="cost-metric-selector">
                                <label for="costMetricSelect1">Column 2</label>
                                <select class="cost-metric-select" id="costMetricSelect1" data-index="1"></select>
                            </div>
                            <div class="cost-metric-selector">
                                <label for="costMetricSelect2">Column 3</label>
                                <select class="cost-metric-select" id="costMetricSelect2" data-index="2"></select>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>
</div>
</div>
</div>

<!-- Aircraft Listings Section -->
{% if filtered_aircraft %}
<div class="row mt-5">
    <div class="col-12">
        <!-- Sorting Controls -->
        <div class="sorting-controls mb-4">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <div class="d-flex align-items-center">
                        <label for="sortSelect" class="form-label me-3 mb-0 text-white">
                            <i class="fas fa-sort me-1"></i>Sort by:
                        </label>
                        <select id="sortSelect" class="form-select form-select-sm" style="max-width: 200px;">
                            <option value="best_speed_dollar">Best Speed/$</option>
                            <option value="best_range_dollar">Best Range/$</option>
                            <option value="best_performance_dollar">Best Performance/$</option>
                            <option value="best_efficiency_dollar">Best Efficiency/$</option>
                            <option value="best_all_around_dollar">Best All-Around/$</option>
                            <option value="price_low">Price: Low to High</option>
                            <option value="price_high">Price: High to Low</option>
                            <option value="range">Range: High to Low</option>
                            <option value="speed">Speed: High to Low</option>
                            <option value="passengers">Passengers: High to Low</option>
                            <option value="year_new">Year: Newest First</option>
                            <option value="year_old">Year: Oldest First</option>
                            <option value="hourly_cost_low">Hourly Cost: Low to High</option>
                            <option value="hourly_cost_high">Hourly Cost: High to Low</option>
                            <option value="annual_budget">Annual Budget: Low to High</option>
                            <option value="multi_year_total_cost">Multi-Year Total Cost: Low to High</option>
                            <option value="cost_to_charter">Cost to Charter: Low to High</option>
                            <option value="total_hourly_cost">Total Hourly Cost: Low to High</option>
                            <option value="average_trip_time">Average Trip Time: Low to High</option>
                            <option value="total_trip_time">Total Trip Time: Low to High</option>
                            <option value="cabin_volume">Cabin Volume: High to Low</option>
                            <option value="baggage_volume">Baggage Volume: High to Low</option>
                            <option value="aircraft_length">Aircraft Length: High to Low</option>
                            <option value="wingspan">Wingspan: High to Low</option>
                            <option value="aircraft_height">Aircraft Height: High to Low</option>
                            <option value="runway_length">Runway Length: Low to High</option>
                            <option value="altitude">Max Altitude: High to Low</option>
                            <option value="manufacturer">Manufacturer: A to Z</option>
                            <option value="aircraft_name">Aircraft Name: A to Z</option>
                        </select>
                    </div>
                </div>
                <div class="col-md-6 text-md-end">
                    <div class="d-flex align-items-center justify-content-md-end">
                        <div class="listings-aircraft-remaining me-3">
                            <span class="aircraft-count-label">Aircraft Remaining</span>
                            <span class="aircraft-count-value" id="listings-aircraft-remaining-count">0</span>
                        </div>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-light" onclick="toggleView('grid')"
                                id="gridViewBtn">
                                <i class="fas fa-th"></i>
                            </button>
                            <button type="button" class="btn btn-outline-light" onclick="toggleView('list')"
                                id="listViewBtn">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- Aircraft Grid -->
        <div class="aircraft-listings-container">
            <div class="aircraft-grid" id="aircraftGrid">
                <div class="loading-placeholder"
                    style="text-align: center; padding: 40px; color: #f4f4f4; background: rgba(18, 19, 24, 0.92); border: 1px dashed rgba(240, 85, 69, 0.4); border-radius: 10px;">
                    <i class="fas fa-plane fa-2x mb-3" style="color: #F05545;"></i>
                    <p class="mb-1">Loading aircraft listings...</p>
                </div>
            </div>

            <!-- Bottom Pagination Controls (Centered) -->
            <div class="pagination-section mt-5 mb-4">
                <nav aria-label="Aircraft listings pagination" class="d-flex justify-content-center">
                    <ul class="pagination mb-0" id="pagination-bottom">
                        <!-- Pagination will be populated by JavaScript -->
                    </ul>
                </nav>
            </div>
        </div>
    </div>
</div>
{% endif %}
</div>

<!-- Create Listing Modal -->
<div class="modal fade" id="createListingModal" tabindex="-1" aria-labelledby="createListingModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="createListingModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Create New Aircraft Listing
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <!-- Step 1: Performance Profile Selection -->
                    <div class="col-12" id="profileSelectionStep">
                        <div class="step-header mb-4">
                            <h6 class="text-primary mb-2">Step 1: Select Performance Profile</h6>
                            <p class="text-muted">Choose an aircraft performance profile that matches your listing</p>
                        </div>

                        <!-- Search and Filter Controls -->
                        <div class="row mb-4">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Search Profiles</label>
                                    <input type="text" class="form-control" id="profileSearch"
                                        placeholder="Search by manufacturer, model...">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="profileCategoryFilter">
                                        <option value="">All Categories</option>
                                        <option value="Piston">Piston</option>
                                        <option value="Turboprop">Turboprop</option>
                                        <option value="Business Jet">Business Jet</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="form-group">
                                    <label class="form-label">Passengers</label>
                                    <select class="form-select" id="profilePassengerFilter">
                                        <option value="">Any</option>
                                        <option value="1-4">1-4 Passengers</option>
                                        <option value="5-8">5-8 Passengers</option>
                                        <option value="9+">9+ Passengers</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Performance Profiles Grid -->
                        <div class="performance-profiles-container">
                            <div class="performance-profiles-grid" id="performanceProfilesGrid">
                                <!-- Performance profiles will be loaded here -->
                            </div>
                        </div>

                        <!-- Selected Profile Preview -->
                        <div class="selected-profile-preview d-none" id="selectedProfilePreview">
                            <div class="card bg-secondary mt-4">
                                <div class="card-header">
                                    <h6 class="mb-0">Selected Performance Profile</h6>
                                </div>
                                <div class="card-body" id="selectedProfileDetails">
                                    <!-- Selected profile details will be shown here -->
                                </div>
                            </div>
                        </div>

                        <div class="step-actions mt-4 text-end">
                            <button class="btn btn-primary" id="continueToListingDetails" disabled>
                                Continue to Listing Details <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Step 2: Listing Details -->
                    <div class="col-12 d-none" id="listingDetailsStep">
                        <div class="step-header mb-4">
                            <h6 class="text-primary mb-2">Step 2: Listing Details</h6>
                            <p class="text-muted">Add specific details about your aircraft listing</p>
                        </div>

                        <form id="listingDetailsForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Listing Title</label>
                                        <input type="text" class="form-control" id="listingTitle"
                                            placeholder="e.g., 2018 Cessna Citation CJ3+ - Low Hours">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Year</label>
                                        <input type="number" class="form-control" id="listingYear" min="1950"
                                            max="2025">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Price ($)</label>
                                        <input type="number" class="form-control" id="listingPrice" placeholder="0">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Total Hours</label>
                                        <input type="number" class="form-control" id="listingHours" placeholder="0">
                                    </div>
                                </div>
                            </div>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Location</label>
                                        <input type="text" class="form-control" id="listingLocation"
                                            placeholder="Airport code or city">
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="form-group mb-3">
                                        <label class="form-label">Contact Email</label>
                                        <input type="email" class="form-control" id="listingEmail"
                                            placeholder="your@email.com">
                                    </div>
                                </div>
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">Description</label>
                                <textarea class="form-control" id="listingDescription" rows="4"
                                    placeholder="Describe your aircraft, maintenance history, upgrades, etc."></textarea>
                            </div>

                            <div class="form-group mb-3">
                                <label class="form-label">Images (Optional)</label>
                                <input type="file" class="form-control" id="listingImages" multiple accept="image/*">
                                <small class="form-text text-muted">Upload up to 10 images of your aircraft</small>
                            </div>
                        </form>

                        <div class="step-actions mt-4 d-flex justify-content-between">
                            <button class="btn btn-outline-secondary" id="backToProfileSelection">
                                <i class="fas fa-arrow-left me-2"></i>Back to Profile Selection
                            </button>
                            <button class="btn btn-success" id="createListingBtn">
                                <i class="fas fa-check me-2"></i>Create Listing
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

<!-- Aircraft Comparison Modal -->
<div class="modal fade" id="comparisonModal" tabindex="-1" aria-labelledby="comparisonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="comparisonModalLabel">
                    <i class="fas fa-chart-radar me-2"></i>Aircraft Comparison
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Performance Radar Chart</h6>
                        <canvas id="performanceRadarChart" width="400" height="400"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Cost Comparison</h6>
                        <canvas id="costComparisonChart" width="400" height="400"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-warning mb-3">Detailed Comparison Table</h6>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="comparisonTable">
                                <thead>
                                    <tr id="comparisonTableHeader">
                                        <th>Metric</th>
                                    </tr>
                                </thead>
                                <tbody id="comparisonTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <div id="comparisonAircraft" class="me-auto">
                    <small class="text-muted">Select aircraft to compare (max 4)</small>
                </div>
                <button type="button" class="btn btn-outline-danger" id="clearComparisonBtn">
                    <i class="fas fa-trash me-1"></i>Clear All
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<!-- Aircraft Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="detailsModalLabel">
                    <i class="fas fa-plane me-2"></i>Aircraft Details
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="detailsModalBody">
                <!-- Details will be populated here -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-info" id="addCurrentToComparisonBtn">
                    <i class="fas fa-plus me-1"></i>Add to Comparison
                </button>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Market Intelligence Modal -->
<div class="modal fade" id="marketInsightsModal" tabindex="-1" aria-labelledby="marketInsightsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="marketInsightsModalLabel">
                    <i class="fas fa-chart-line me-2"></i>Market Intelligence Dashboard
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Price Distribution</h6>
                        <canvas id="priceDistributionChart" width="400" height="300"></canvas>
                    </div>
                    <div class="col-md-6">
                        <h6 class="text-warning mb-3">Manufacturer Market Share</h6>
                        <canvas id="manufacturerChart" width="400" height="300"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h5 class="text-info" id="avgPrice">$0</h5>
                                <small>Average Price</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h5 class="text-success" id="avgRange">0 nm</h5>
                                <small>Average Range</small>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card bg-secondary">
                            <div class="card-body text-center">
                                <h5 class="text-warning" id="avgSpeed">0 kts</h5>
                                <small>Average Speed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- AI Recommendations Modal -->
<div class="modal fade" id="aiRecommendationsModal" tabindex="-1" aria-labelledby="aiRecommendationsModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="aiRecommendationsModalLabel">
                    <i class="fas fa-robot me-2"></i>AI-Powered Recommendations
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body" id="aiRecommendationsBody">
                <!-- AI recommendations will be populated here -->
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- Scenario Analysis Modal -->
<div class="modal fade" id="scenarioAnalysisModal" tabindex="-1" aria-labelledby="scenarioAnalysisModalLabel"
    aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content bg-dark text-light">
            <div class="modal-header border-secondary">
                <h5 class="modal-title" id="scenarioAnalysisModalLabel">
                    <i class="fas fa-calculator me-2"></i>What-If Scenario Analysis
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-warning mb-3">Scenario Parameters</h6>
                        <div class="mb-3">
                            <label class="form-label">Annual Flight Hours</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                id="scenarioHours" value="100">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Fuel Price ($/gallon)</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                id="scenarioFuelPrice" value="6.50" step="0.10">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Ownership Years</label>
                            <input type="number" class="form-control bg-dark text-light border-secondary"
                                id="scenarioYears" value="5">
                        </div>
                        <button class="btn btn-warning" id="runScenarioBtn">
                            <i class="fas fa-play me-1"></i>Run Analysis
                        </button>
                    </div>
                    <div class="col-md-8">
                        <h6 class="text-warning mb-3">Cost Comparison</h6>
                        <canvas id="scenarioChart" width="600" height="400"></canvas>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12">
                        <h6 class="text-warning mb-3">Detailed Analysis</h6>
                        <div class="table-responsive">
                            <table class="table table-dark table-striped" id="scenarioTable">
                                <thead>
                                    <tr>
                                        <th>Aircraft</th>
                                        <th>Annual Cost</th>
                                        <th>Total Cost</th>
                                        <th>Cost/Hour</th>
                                        <th>Net Cost</th>
                                    </tr>
                                </thead>
                                <tbody id="scenarioTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

{% block additional_js %}
<!-- Leaflet JS for maps -->
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
<!-- Leaflet Geocoder -->
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<!-- Custom JavaScript -->
<script src="{{ url_for('static', filename='js/script.js') }}"></script>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<!-- Real-Time Aircraft Filtering System -->
<script>
    console.log('Aircraft filtering system initialized');

    // Real-time filtering system initialized

    // Global variables for aircraft data
    let allAircraftData = [];
    let filteredAircraftData = [];
    let currentFilters = {};

    // Compare module state
    const MAX_COMPARE_SELECTIONS = 4;
    const COMPARE_COLORS = [
        { base: '#f05545', rgba: 'rgba(240, 85, 69, ALPHA)' },
        { base: '#3b82f6', rgba: 'rgba(59, 130, 246, ALPHA)' },
        { base: '#10b981', rgba: 'rgba(16, 185, 129, ALPHA)' },
        { base: '#a855f7', rgba: 'rgba(168, 85, 247, ALPHA)' },
        { base: '#f97316', rgba: 'rgba(249, 115, 22, ALPHA)' }
    ];
    const COST_METRIC_OPTIONS = [
        { key: 'L', label: 'Column L  Charter Rate %', type: 'percent', precision: 2, getValue: metrics => metrics.columnValues?.L ?? null },
        { key: 'M', label: 'Column M  Piston Pilot Pay ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.M ?? null },
        { key: 'N', label: 'Column N  Turboprop Pilot Pay ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.N ?? null },
        { key: 'O', label: 'Column O  Business Jet Pilot Pay ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.O ?? null },
        { key: 'P', label: 'Column P  Planned Passengers', type: 'number', precision: 0, getValue: metrics => metrics.columnValues?.P ?? null },
        { key: 'Q', label: 'Column Q  Passenger Pay ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.Q ?? null },
        { key: 'R', label: 'Column R  Charter Rate %', type: 'percent', precision: 2, getValue: metrics => metrics.columnValues?.R ?? null },
        { key: 'S', label: 'Column S  Avg Charter Trip Length (NM)', type: 'number', precision: 0, getValue: metrics => metrics.columnValues?.S ?? null },
        { key: 'T', label: 'Column T  Charter Trips per Year', type: 'number', precision: 0, getValue: metrics => metrics.columnValues?.T ?? null },
        { key: 'AB', label: 'Column AB  Depreciated Price ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AB ?? null },
        { key: 'AC', label: 'Column AC  Average Trip Time (hrs)', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AC ?? null },
        { key: 'AD', label: 'Column AD  Total Trip Time (hrs)', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AD ?? null },
        { key: 'AE', label: 'Column AE  Passenger Revenue ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AE ?? null },
        { key: 'AF', label: 'Column AF  Charter Hourly Cost ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.AF ?? null },
        { key: 'AG', label: 'Column AG  Charter Leg Time (hrs)', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AG ?? null },
        { key: 'AH', label: 'Column AH  Charter Hours (hrs)', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AH ?? null },
        { key: 'AI', label: 'Column AI  Charter Revenue ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AI ?? null },
        { key: 'AJ', label: 'Column AJ  Total Fixed Cost ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AJ ?? null },
        { key: 'AK', label: 'Column AK  Total Variable Cost ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AK ?? null },
        { key: 'AL', label: 'Column AL  Fuel Cost ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AL ?? null },
        { key: 'AM', label: 'Column AM  Total Operating Cost ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AM ?? null },
        { key: 'AN', label: 'Column AN  Annual Budget ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AN ?? null },
        { key: 'AO', label: 'Column AO  Multi-Year Total Cost ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AO ?? null },
        { key: 'AP', label: 'Column AP  Net Cost After Sale ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AP ?? null },
        { key: 'AQ', label: 'Column AQ  Cost to Charter ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AQ ?? null },
        { key: 'AR', label: 'Column AR  Own vs Charter Ratio', type: 'ratio', precision: 2, getValue: metrics => metrics.columnValues?.AR ?? null },
        { key: 'AS', label: 'Column AS  Ownership Advantage ($)', type: 'currency', precision: 0, getValue: metrics => metrics.columnValues?.AS ?? null },
        { key: 'AT', label: 'Column AT  Speed per Dollar', type: 'number', precision: 4, getValue: metrics => metrics.columnValues?.AT ?? null },
        { key: 'AU', label: 'Column AU  Normalized Speed', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AU ?? null },
        { key: 'AV', label: 'Column AV  Speed per Dollar per Seat', type: 'number', precision: 4, getValue: metrics => metrics.columnValues?.AV ?? null },
        { key: 'AW', label: 'Column AW  Range per Dollar', type: 'number', precision: 4, getValue: metrics => metrics.columnValues?.AW ?? null },
        { key: 'AX', label: 'Column AX  Normalized Range', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AX ?? null },
        { key: 'AY', label: 'Column AY  Range per Dollar per Seat', type: 'number', precision: 4, getValue: metrics => metrics.columnValues?.AY ?? null },
        { key: 'AZ', label: 'Column AZ  Performance Score', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.AZ ?? null },
        { key: 'BA', label: 'Column BA  Normalized Performance', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BA ?? null },
        { key: 'BB', label: 'Column BB  Performance per Seat', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BB ?? null },
        { key: 'BC', label: 'Column BC  Efficiency Score', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BC ?? null },
        { key: 'BD', label: 'Column BD  Normalized Efficiency', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BD ?? null },
        { key: 'BE', label: 'Column BE  Efficiency per Seat', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BE ?? null },
        { key: 'BF', label: 'Column BF  All-Around Score', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BF ?? null },
        { key: 'BG', label: 'Column BG  All-Around per Seat', type: 'number', precision: 2, getValue: metrics => metrics.columnValues?.BG ?? null },
        { key: 'BH', label: 'Column BH  Total Hourly Cost ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BH ?? null },
        { key: 'BI', label: 'Column BI  Hourly Cost per Seat ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BI ?? null },
        { key: 'BJ', label: 'Column BJ  Cost per NM ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BJ ?? null },
        { key: 'BK', label: 'Column BK  Cost per Seat NM ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BK ?? null },
        { key: 'BL', label: 'Column BL  Hourly Variable Cost ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BL ?? null },
        { key: 'BM', label: 'Column BM  Variable Cost per Seat ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BM ?? null },
        { key: 'BN', label: 'Column BN  Variable Cost per NM ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BN ?? null },
        { key: 'BO', label: 'Column BO  Variable Cost per Seat NM ($)', type: 'currency', precision: 2, getValue: metrics => metrics.columnValues?.BO ?? null }
    ];
    const DEFAULT_COST_METRIC_KEYS = ['AN', 'AO', 'AQ'];
    let compareSelections = []; // [{ id, colorIndex }]
    let compareCostMetricKeys = [...DEFAULT_COST_METRIC_KEYS];
    let costCharts = [];
    let compareLimitNoticeTimer = null;

    // Pagination variables
    let currentPage = 1;
    let itemsPerPage = 12;
    let totalPages = 1;

    // Load approved user listings from server
    async function loadAllAircraftData() {
        console.log(' Loading approved aircraft listings from server...');
        try {
            const response = await fetch('/api/user-listings', {
                method: 'GET',
                headers: {
                    'Accept': 'application/json',
                }
            });

            if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }

            const listingData = await response.json();
            if (!Array.isArray(listingData) || listingData.length === 0) {
                console.warn(' No approved listings available yet');
                allAircraftData = [];
                filteredAircraftData = [];
                return true;
            }

            allAircraftData = listingData.map((listing, index) => ({
                ...listing,
                id: listing.listing_id || listing.id || index + 1,
                aircraft_name: listing.aircraft_name || listing.name || 'Unknown Aircraft',
                name: listing.aircraft_name || listing.name || 'Unknown Aircraft',
                price: listing.price || listing.listing_price || 0,
                listing_title: listing.listing_title || listing.title,
                listing_description: listing.listing_description || listing.description,
                contact_email: listing.contact_email || listing.email,
                location: listing.location || 'Contact for location',
                engine_type: listing.engine_type || listing.category || '',
                manufacturer: listing.manufacturer || '',
                image: listing.image || '/static/images/aircraft_placeholder.jpg',
                images: listing.images || [],
                is_user_listing: true
            }));

            filteredAircraftData = [...allAircraftData];
            console.log(` Loaded ${allAircraftData.length} approved listings`);
            return true;
        } catch (error) {
            console.error(' Error loading approved listings:', error);
            allAircraftData = [];
            filteredAircraftData = [];
            return false;
        }
    }

    // Helper functions for extracting data from parsed HTML cards
    function extractPriceFromCard(card) {
        // First try data attribute (most reliable)
        if (card.dataset.price) {
            return parseFloat(card.dataset.price) || 0;
        }

        // Fall back to parsing the price badge display
        const priceBadge = card.querySelector('.price-badge .badge');
        if (priceBadge) {
            const priceText = priceBadge.textContent || '';
            const priceMatch = priceText.replace(/[,$]/g, '').match(/(\d+(?:\.\d+)?)/);
            return priceMatch ? parseFloat(priceMatch[1]) : 0;
        }

        // Legacy: check for .aircraft-price
        const priceElement = card.querySelector('.aircraft-price');
        if (priceElement) {
            const priceText = priceElement.textContent || '';
            const priceMatch = priceText.replace(/[,$]/g, '').match(/(\d+(?:\.\d+)?)/);
            return priceMatch ? parseFloat(priceMatch[1]) : 0;
        }

        return 0;
    }

    function extractRangeFromCard(card) {
        return extractSpecValueFromCard(card, 'range');
    }

    function extractPassengersFromCard(card) {
        return extractSpecValueFromCard(card, 'passenger');
    }

    function extractSpeedFromCard(card) {
        return extractSpecValueFromCard(card, 'speed');
    }

    function extractAltitudeFromCard(card) {
        return extractSpecValueFromCard(card, 'altitude');
    }

    function extractYearFromCard(card) {
        return extractSpecValueFromCard(card, 'year');
    }

    function extractCabinVolumeFromCard(card) {
        return extractSpecValueFromCard(card, 'cabin volume');
    }

    function extractRunwayLengthFromCard(card) {
        return extractSpecValueFromCard(card, 'runway');
    }

    function extractAnnualCostFromCard(card) {
        return extractSpecValueFromCard(card, 'annual');
    }

    function extractHourlyCostFromCard(card) {
        return extractSpecValueFromCard(card, 'hourly cost');
    }

    function extractBaggageVolumeFromCard(card) {
        return extractSpecValueFromCard(card, 'baggage volume');
    }

    function extractSpecValueFromCard(card, labelText) {
        const specItems = card.querySelectorAll('.spec-item');
        for (let item of specItems) {
            const label = item.querySelector('.spec-label')?.textContent?.trim();
            const value = item.querySelector('.spec-value')?.textContent?.trim();
            if (label && label.toLowerCase().includes(labelText.toLowerCase()) && value && value !== 'N/A') {
                const numberMatch = value.replace(/,/g, '').match(/(\d+(?:\.\d+)?)/);
                return numberMatch ? parseFloat(numberMatch[1]) : 0;
            }
        }
        return 0;
    }

    // Load aircraft from current page (fallback)
    function loadCurrentPageAircraft() {
        console.log(' Loading aircraft from current page (fallback)...');
        const aircraftCards = document.querySelectorAll('.aircraft-card');
        allAircraftData = [];

        console.log(` Found ${aircraftCards.length} aircraft cards in HTML`);

        aircraftCards.forEach((card, index) => {
            // Get aircraft ID from button or create one
            const aircraftId = card.querySelector('[data-aircraft-id]')?.dataset.aircraftId ||
                card.id ||
                `aircraft-${index}`;

            const aircraft = {
                id: aircraftId,
                name: card.querySelector('.aircraft-name')?.textContent?.trim() || 'Unknown Aircraft',
                price: extractPrice(card),
                range: extractRange(card),
                passengers: extractPassengers(card),
                speed: extractSpeed(card),
                max_altitude: extractAltitude(card),
                year: extractYear(card),
                cabin_volume: extractCabinVolume(card),
                runway_length: extractRunwayLength(card),
                baggage_volume: extractBaggageVolume(card),
                total_hourly_cost: extractHourlyCost(card),
                average_trip_time: extractAverageTripTime(card),
                total_trip_time: extractTotalTripTime(card),
                annual_budget: extractAnnualBudget(card),
                multi_year_total_cost: extractMultiYearTotalCost(card),
                cost_to_charter: extractCostToCharter(card),
                best_speed_dollar: extractBestSpeedDollar(card),
                best_range_dollar: extractBestRangeDollar(card),
                best_performance_dollar: extractBestPerformanceDollar(card),
                best_efficiency_dollar: extractBestEfficiencyDollar(card),
                best_all_around_dollar: extractBestAllAroundDollar(card),
                // Extract data attributes for calculations
                total_fixed_cost: parseFloat(card.dataset.totalFixedCost) || 0,
                total_variable_cost: parseFloat(card.dataset.totalVariableCost) || 0,
                depreciation_rate: parseFloat(card.dataset.depreciationValue) || 0, // This is actually depreciation VALUE
                category: card.dataset.category || card.dataset.aircraftType || '',
                // Extract normalized values from CSV
                normalized_speed_dollar: parseFloat(card.dataset.normalizedSpeedDollar) || 0,
                normalized_range_dollar: parseFloat(card.dataset.normalizedRangeDollar) || 0,
                normalized_performance_dollar: parseFloat(card.dataset.normalizedPerformanceDollar) || 0,
                normalized_efficiency_dollar: parseFloat(card.dataset.normalizedEfficiencyDollar) || 0,
                image: card.querySelector('.aircraft-image img')?.src || '/static/images/aircraft_placeholder.jpg',
                element: card
            };

            // Debug: Log aircraft data for first few aircraft
            if (allAircraftData.length < 5) {
                console.log(` Aircraft ${allAircraftData.length + 1}:`, {
                    name: aircraft.name,
                    range: aircraft.range,
                    dataRange: card.dataset.range,
                    cardText: card.textContent.substring(0, 200) + '...'
                });
            }

            allAircraftData.push(aircraft);
        });

        filteredAircraftData = [...allAircraftData];
        console.log(` Loaded ${allAircraftData.length} aircraft from current page`);
        console.log(` Total aircraft available for interpretation: ${allAircraftData.length}`);
    }

    // Helper functions to extract data from aircraft cards
    function extractSpecValue(card, labelText) {
        const specItems = card.querySelectorAll('.spec-item');
        for (let item of specItems) {
            const label = item.querySelector('.spec-label')?.textContent?.trim();
            const value = item.querySelector('.spec-value')?.textContent?.trim();
            if (label && label.toLowerCase().includes(labelText.toLowerCase()) && value && value !== 'N/A') {
                // Remove commas and extract number
                const numberMatch = value.replace(/,/g, '').match(/(\d+(?:\.\d+)?)/);
                return numberMatch ? parseFloat(numberMatch[1]) : 0;
            }
        }
        return 0;
    }

    function extractPrice(card) {
        // Look for price in aircraft-price class or in specs
        const priceElement = card.querySelector('.aircraft-price');
        if (priceElement) {
            const priceText = priceElement.textContent;
            const priceMatch = priceText.match(/[\$,\d]+/);
            return priceMatch ? parseInt(priceMatch[0].replace(/[\$,]/g, '')) : 0;
        }

        // Fallback to looking in text content
        const priceText = card.textContent;
        const priceMatch = priceText.match(/\$([0-9,]+)/);
        return priceMatch ? parseInt(priceMatch[1].replace(/,/g, '')) : 0;
    }

    function extractRange(card) {
        // First try to get from data-range attribute
        const dataRange = card.dataset.range;
        if (dataRange) {
            return parseInt(dataRange) || 0;
        }

        // Try to extract from spec items
        return extractSpecValue(card, 'range');
    }

    function extractPassengers(card) {
        return extractSpecValue(card, 'passengers');
    }

    function extractSpeed(card) {
        return extractSpecValue(card, 'speed');
    }

    function extractAltitude(card) {
        return extractSpecValue(card, 'altitude');
    }

    function extractYear(card) {
        // Look for year in aircraft name or specs
        const yearMatch = card.textContent.match(/(\d{4})/);
        return yearMatch ? parseInt(yearMatch[1]) : 0;
    }

    function extractCabinVolume(card) {
        return extractSpecValue(card, 'cabin volume');
    }

    function extractRunwayLength(card) {
        return extractSpecValue(card, 'runway');
    }

    function extractAnnualCost(card) {
        return extractSpecValue(card, 'annual') || extractSpecValue(card, 'yearly');
    }

    function extractHourlyCost(card) {
        return extractSpecValue(card, 'hourly cost');
    }

    function extractBaggageVolume(card) {
        return extractSpecValue(card, 'baggage volume');
    }

    function extractAverageTripTime(card) {
        return extractSpecValue(card, 'avg trip time');
    }

    function extractTotalTripTime(card) {
        return extractSpecValue(card, 'total trip time');
    }

    function extractAnnualBudget(card) {
        return extractSpecValue(card, 'annual budget');
    }

    function extractMultiYearTotalCost(card) {
        return extractSpecValue(card, 'multi-year total cost');
    }

    function extractCostToCharter(card) {
        return extractSpecValue(card, 'cost to charter');
    }

    function extractBestSpeedDollar(card) {
        const text = card.textContent;
        const match = text.match(/Best Speed\/\$:\s*([\d.]+)/);
        return match ? parseFloat(match[1]) : 0;
    }

    function extractBestRangeDollar(card) {
        const text = card.textContent;
        const match = text.match(/Best Range\/\$:\s*([\d.]+)/);
        return match ? parseFloat(match[1]) : 0;
    }

    function extractBestPerformanceDollar(card) {
        const text = card.textContent;
        const match = text.match(/Best Performance\/\$:\s*([\d.]+)/);
        return match ? parseFloat(match[1]) : 0;
    }

    function extractBestEfficiencyDollar(card) {
        const text = card.textContent;
        const match = text.match(/Best Efficiency\/\$:\s*([\d.]+)/);
        return match ? parseFloat(match[1]) : 0;
    }

    function extractBestAllAroundDollar(card) {
        const text = card.textContent;
        const match = text.match(/Best All-Around\/\$:\s*([\d.]+)/);
        return match ? parseFloat(match[1]) : 0;
    }

    // Calculate relative "Best All-Around/$" score comparing to all unfiltered aircraft
    function calculateRelativeAllAroundScore(aircraft, allFilteredAircraft) {
        if (!aircraft.best_all_around_dollar || allFilteredAircraft.length <= 1) {
            return 0;
        }

        // Get all non-zero all-around scores from filtered aircraft
        const allAroundScores = allFilteredAircraft
            .map(a => a.best_all_around_dollar || 0)
            .filter(score => score > 0);

        if (allAroundScores.length === 0) return 0;

        // Sort scores (lower is better)
        const sortedScores = [...allAroundScores].sort((a, b) => a - b);
        const aircraftScore = aircraft.best_all_around_dollar;

        // Find percentile rank (lower scores rank higher)
        const rank = sortedScores.findIndex(score => score >= aircraftScore);
        const percentile = rank === -1 ? 100 : (rank / (sortedScores.length - 1)) * 100;

        // Convert to 0-100 scale where higher is better
        return Math.round(100 - percentile);
    }

    // Update trip times for all aircraft (using CSV data)
    function updateAllTripTimes() {
        // Trip times are already loaded from CSV, just update the display
        if (filteredAircraftData.length > 0) {
            updateAircraftDisplay();
        }
    }

    // Get trip times from aircraft data (loaded from CSV)
    function getTripTimes(aircraft) {
        // Use the actual data from the CSV columns
        return {
            averageTripTime: aircraft.average_trip_time || 0,
            totalTripTime: aircraft.total_trip_time || 0
        };
    }
    // Real-time filtering function
    function applyRealTimeFiltering() {
        console.log(' Applying real-time filtering...');

        // Get current filter values
        currentFilters = {
            range: document.getElementById('range-input')?.value || '',
            passengers: document.getElementById('passengers')?.value || '',
            budget: document.getElementById('budget')?.value || '',
            minYear: document.getElementById('lowest-year')?.value || '',
            minSpeed: document.getElementById('advanced_min_speed')?.value || '',
            minAltitude: document.getElementById('advanced_min_altitude')?.value || '',
            maxRunway: document.getElementById('advanced_max_runway')?.value || '',
            minCabinVolume: document.getElementById('advanced_min_cabin_volume')?.value || '',
            maxAnnualCost: document.getElementById('advanced_max_annual_cost')?.value || '',
            maxHourlyCost: document.getElementById('advanced_max_hourly_cost')?.value || '',
            fuelPrice: document.getElementById('advanced_fuel_price')?.value || '',
            ownershipYears: document.getElementById('advanced_ownership_years')?.value || ''
        };

        console.log(' Current filters:', currentFilters);

        // Check if any filters are active
        const hasActiveFilters = Object.values(currentFilters).some(value => value && value !== '');

        if (!hasActiveFilters) {
            console.log(' No active filters - showing all aircraft');
            filteredAircraftData = [...allAircraftData];
            currentPage = 1; // Reset to page 1 when clearing filters
            updatePagination();
            updateAircraftDisplay();
            return;
        }

        // Apply client-side filtering (same as other inputs)
        applyClientSideFiltering();
    }

    // Client-side filtering (main filtering logic)
    function applyClientSideFiltering() {
        console.log(' Applying client-side filtering...');

        // Start with all aircraft
        filteredAircraftData = [...allAircraftData];
        let visibleCount = 0;

        // Apply each filter
        filteredAircraftData = filteredAircraftData.filter(aircraft => {
            let matches = true;
            let filterReasons = [];

            // Range filter
            if (currentFilters.range && aircraft.range > 0) {
                const requiredRange = parseInt(currentFilters.range);
                console.log(` Range check: ${aircraft.name} - Range: ${aircraft.range}nm, Required: ${requiredRange}nm`);
                if (aircraft.range < requiredRange) {
                    matches = false;
                    filterReasons.push(`Range ${aircraft.range}nm < ${requiredRange}nm`);
                    console.log(` ${aircraft.name}: Range ${aircraft.range}nm < ${requiredRange}nm - FILTERED OUT`);
                } else {
                    console.log(` ${aircraft.name}: Range ${aircraft.range}nm >= ${requiredRange}nm - PASSES`);
                }
            } else if (currentFilters.range) {
                console.log(` ${aircraft.name}: Range filter active but aircraft.range = ${aircraft.range}`);
            }

            // Passenger filter
            if (currentFilters.passengers && aircraft.passengers > 0) {
                const requiredPassengers = parseInt(currentFilters.passengers);
                if (aircraft.passengers < requiredPassengers) {
                    matches = false;
                    filterReasons.push(`Passengers ${aircraft.passengers} < ${requiredPassengers}`);
                }
            }

            // Budget filter
            if (currentFilters.budget && aircraft.price > 0) {
                const maxBudget = parseInt(currentFilters.budget);
                if (aircraft.price > maxBudget) {
                    matches = false;
                    filterReasons.push(`Price $${aircraft.price} > $${maxBudget}`);
                }
            }

            // Speed filter
            if (currentFilters.minSpeed && aircraft.speed > 0) {
                const minSpeed = parseInt(currentFilters.minSpeed);
                if (aircraft.speed < minSpeed) {
                    matches = false;
                    filterReasons.push(`Speed ${aircraft.speed}kts < ${minSpeed}kts`);
                }
            }

            // Altitude filter
            if (currentFilters.minAltitude && aircraft.altitude > 0) {
                const minAltitude = parseInt(currentFilters.minAltitude);
                if (aircraft.altitude < minAltitude) {
                    matches = false;
                    filterReasons.push(`Altitude ${aircraft.altitude}ft < ${minAltitude}ft`);
                }
            }

            // Year filter
            if (currentFilters.minYear && aircraft.year > 0) {
                const minYear = parseInt(currentFilters.minYear);
                if (aircraft.year < minYear) {
                    matches = false;
                    filterReasons.push(`Year ${aircraft.year} < ${minYear}`);
                }
            }

            // Cabin Volume filter
            if (currentFilters.minCabinVolume && aircraft.cabinVolume > 0) {
                const minCabinVolume = parseInt(currentFilters.minCabinVolume);
                if (aircraft.cabinVolume < minCabinVolume) {
                    matches = false;
                    filterReasons.push(`Cabin Volume ${aircraft.cabinVolume}cu ft < ${minCabinVolume}cu ft`);
                }
            }

            // Runway Length filter (aircraft needs shorter runway than max allowed)
            if (currentFilters.maxRunway && aircraft.runwayLength > 0) {
                const maxRunway = parseInt(currentFilters.maxRunway);
                if (aircraft.runwayLength > maxRunway) {
                    matches = false;
                    filterReasons.push(`Runway Length ${aircraft.runwayLength}ft > ${maxRunway}ft`);
                }
            }

            // Annual Cost filter
            if (currentFilters.maxAnnualCost && aircraft.annualCost > 0) {
                const maxAnnualCost = parseInt(currentFilters.maxAnnualCost);
                if (aircraft.annualCost > maxAnnualCost) {
                    matches = false;
                    filterReasons.push(`Annual Cost $${aircraft.annualCost} > $${maxAnnualCost}`);
                }
            }

            // Hourly Cost filter
            if (currentFilters.maxHourlyCost && aircraft.hourlyCost > 0) {
                const maxHourlyCost = parseInt(currentFilters.maxHourlyCost);
                if (aircraft.hourlyCost > maxHourlyCost) {
                    matches = false;
                    filterReasons.push(`Hourly Cost $${aircraft.hourlyCost} > $${maxHourlyCost}`);
                }
            }

            if (matches) {
                visibleCount++;
            } else if (filterReasons.length > 0) {
                console.log(` Aircraft ${aircraft.name} filtered out: ${filterReasons.join(', ')}`);
            }

            return matches;
        });

        console.log(` Client-side filtering: ${filteredAircraftData.length} aircraft match criteria (${visibleCount} visible)`);

        // Shopping site logic: Reset to page 1 when filtering (brings remaining aircraft forward)
        currentPage = 1;
        console.log(` Reset to page 1 after filtering`);

        // Update pagination and display
        updatePagination();
        updateAircraftDisplay();
    }

    // Update aircraft display based on filtered results with pagination
    function updateAircraftDisplay() {
        console.log(' Updating aircraft display...');
        const aircraftGrid = document.getElementById('aircraftGrid');
        if (!aircraftGrid) return;

        // Calculate pagination for current page
        const startIndex = (currentPage - 1) * itemsPerPage;
        const endIndex = startIndex + itemsPerPage;
        const currentPageAircraft = filteredAircraftData.slice(startIndex, endIndex);

        console.log(` Filtered aircraft: ${filteredAircraftData.length}, Current page: ${currentPageAircraft.length}`);

        // Clear the grid and rebuild with current page aircraft
        aircraftGrid.innerHTML = '';

        if (filteredAircraftData.length === 0) {
            aircraftGrid.innerHTML = `
                <div class="empty-state-card text-center w-100">
                    <div class="empty-state-content">
                        <i class="fas fa-plane-slash fa-3x mb-3" style="color: #F05545;"></i>
                        <h4 class="mb-2">No approved listings yet</h4>
                        <p class="text-muted mb-0">Check back soonaircraft listings appear here once the owner approves them.</p>
                    </div>
                </div>
            `;
            totalPages = 1;
            updatePagination();
            updatePaginationInfo();
            updateFilterStatus();
            updateCompareUI();
            return;
        }

        // Create aircraft cards for current page
        currentPageAircraft.forEach((aircraft, index) => {
            const aircraftCard = createAircraftCardHTML(aircraft, startIndex + index);
            aircraftGrid.appendChild(aircraftCard);
        });

        console.log(` Displayed ${currentPageAircraft.length} aircraft on page ${currentPage} (${filteredAircraftData.length} total filtered)`);

        // Populate relative performance scores after all cards are created
        populateRelativePerformanceScores(currentPageAircraft);

        // Attach compare button handlers
        attachCompareButtonHandlers();

        // Refresh pagination state
        updatePagination();

        // Update pagination info
        updatePaginationInfo();

        // Update filter status
        updateFilterStatus();

        // Refresh compare section with latest metrics
        updateCompareUI();
    }

    // Get current user inputs for calculations
    function getUserInputs() {
        const inputs = {
            // TEST SCENARIO VALUES - Use these as defaults for debugging
            averageTripLength: parseFloat(document.getElementById('avg-trip-length')?.value) || 971,
            numberOfTrips: parseFloat(document.getElementById('number-of-trips')?.value) || 120,
            yearsOfOwnership: parseFloat(document.getElementById('yearsOfOwnership')?.value) || 10,
            jetAPrice: parseFloat(document.getElementById('jetAPrice')?.value) || 6.50,
            depreciationRate: parseFloat(document.getElementById('depreciationRate')?.value) || 4.00,
            costToCharter: parseFloat(document.getElementById('costToCharter')?.value) || 200,
            pistonPilotPay: parseFloat(document.getElementById('pistonPilotPay')?.value) || 65000,
            turbopropPilotPay: parseFloat(document.getElementById('turbopropPilotPay')?.value) || 82500,
            businessJetPilotPay: parseFloat(document.getElementById('businessJetPilotPay')?.value) || 130000,
            plannedPax: parseFloat(document.getElementById('plannedPax')?.value) || 0,
            passengerPay: parseFloat(document.getElementById('passengerPay')?.value) || 0,
            charterRatePercentage: parseFloat(document.getElementById('charterRatePercentage')?.value) || 50,
            averageCharterTripLength: parseFloat(document.getElementById('averageCharterTripLength')?.value) || 0,
            charterTrips: parseFloat(document.getElementById('charterTrips')?.value) || 0
        };

        // DEBUG: Log user inputs for PIPER M600 calculations
        console.log(' getUserInputs() called:', inputs);

        return inputs;
    }

    // Compare module helpers
    function formatNumber(value, decimals = 0) {
        if (value === null || value === undefined || isNaN(value)) {
            return '--';
        }
        return Number(value).toLocaleString(undefined, {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        });
    }

    function formatCurrency(value, decimals = 0) {
        if (value === null || value === undefined || isNaN(value)) {
            return '$--';
        }
        return new Intl.NumberFormat('en-US', {
            style: 'currency',
            currency: 'USD',
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(Number(value));
    }

    function getCostMetricOption(key) {
        return COST_METRIC_OPTIONS.find(option => option.key === key) || null;
    }

    function formatMetricValue(option, value) {
        if (value === null || value === undefined || isNaN(value)) {
            return '--';
        }
        const precision = option?.precision ?? 2;
        switch (option?.type) {
            case 'currency':
                return formatCurrency(value, precision);
            case 'percent':
                return `${formatNumber(value, precision)}%`;
            default:
                return formatNumber(value, precision);
        }
    }

    function formatTickForType(type, value, precision = 0) {
        switch (type) {
            case 'currency':
                return formatCurrency(value, 0);
            case 'percent':
                return `${formatNumber(value, precision)}%`;
            default:
                return formatNumber(value, precision);
        }
    }

    function ensureCostMetricDefaults() {
        compareCostMetricKeys = compareCostMetricKeys
            .filter(key => getCostMetricOption(key));

        DEFAULT_COST_METRIC_KEYS.forEach(defaultKey => {
            if (compareCostMetricKeys.length >= 3) {
                return;
            }
            if (!compareCostMetricKeys.includes(defaultKey)) {
                compareCostMetricKeys.push(defaultKey);
            }
        });

        while (compareCostMetricKeys.length < 3) {
            const fallbackOption = COST_METRIC_OPTIONS[compareCostMetricKeys.length % COST_METRIC_OPTIONS.length];
            compareCostMetricKeys.push(fallbackOption.key);
        }

        if (compareCostMetricKeys.length > 3) {
            compareCostMetricKeys = compareCostMetricKeys.slice(0, 3);
        }
    }

    function populateCostMetricSelectors() {
        const selectors = document.querySelectorAll('.cost-metric-select');
        selectors.forEach(select => {
            const previousValue = select.value;
            select.innerHTML = COST_METRIC_OPTIONS
                .map(option => `<option value="${option.key}">${option.label}</option>`)
                .join('');
            if (previousValue && getCostMetricOption(previousValue)) {
                select.value = previousValue;
            }
        });
    }

    function syncCostMetricSelectors() {
        const selectors = document.querySelectorAll('.cost-metric-select');
        selectors.forEach((select, index) => {
            const key = compareCostMetricKeys[index];
            if (key && getCostMetricOption(key)) {
                select.value = key;
            }
        });
    }

    function attachCostMetricSelectorListeners() {
        const selectors = document.querySelectorAll('.cost-metric-select');
        selectors.forEach(select => {
            if (select.dataset.listenerAttached === 'true') {
                return;
            }
            select.addEventListener('change', event => {
                const { value, dataset } = event.target;
                const option = getCostMetricOption(value);
                if (!option) {
                    return;
                }
                const index = Number(dataset.index || 0);
                compareCostMetricKeys[index] = option.key;
                ensureCostMetricDefaults();
                syncCostMetricSelectors();
                updateCompareUI();
            });
            select.dataset.listenerAttached = 'true';
        });
    }

    function getCompareColor(index, alpha = 1) {
        const color = COMPARE_COLORS[index % COMPARE_COLORS.length];
        if (alpha >= 1) {
            return color.base;
        }
        return color.rgba.replace('ALPHA', alpha.toString());
    }

    function getNextCompareColorIndex() {
        const used = compareSelections.map(selection => selection.colorIndex);
        for (let i = 0; i < COMPARE_COLORS.length; i++) {
            if (!used.includes(i)) {
                return i;
            }
        }
        return compareSelections.length % COMPARE_COLORS.length;
    }

    function findAircraftById(aircraftId) {
        const normalizedId = String(aircraftId);
        return allAircraftData.find(aircraft => String(aircraft.id) === normalizedId)
            || filteredAircraftData.find(aircraft => String(aircraft.id) === normalizedId)
            || null;
    }

    function isAircraftInCompare(aircraftId) {
        return compareSelections.some(selection => selection.id === String(aircraftId));
    }

    function showCompareLimitNotice() {
        const notice = document.getElementById('compareLimitNotice');
        if (!notice) return;

        notice.textContent = `Maximum of ${MAX_COMPARE_SELECTIONS} aircraft reached.`;
        notice.classList.add('active');

        if (compareLimitNoticeTimer) {
            clearTimeout(compareLimitNoticeTimer);
        }
        compareLimitNoticeTimer = setTimeout(() => {
            notice.classList.remove('active');
        }, 2500);
    }

    function toggleCompareSelection(aircraftId) {
        if (!aircraftId) return;

        const normalizedId = String(aircraftId);
        const existingIndex = compareSelections.findIndex(selection => selection.id === normalizedId);

        if (existingIndex !== -1) {
            compareSelections.splice(existingIndex, 1);
        } else {
            if (compareSelections.length >= MAX_COMPARE_SELECTIONS) {
                showCompareLimitNotice();
                return;
            }

            compareSelections.push({
                id: normalizedId,
                colorIndex: getNextCompareColorIndex()
            });
        }

        updateCompareUI();
    }

    function removeFromCompare(aircraftId) {
        const normalizedId = String(aircraftId);
        const index = compareSelections.findIndex(selection => selection.id === normalizedId);
        if (index !== -1) {
            compareSelections.splice(index, 1);
            updateCompareUI();
        }
    }

    function clearCompareSelections() {
        compareSelections = [];
        updateCompareUI();
    }

    function getAircraftShortLabel(aircraft) {
        const year = aircraft.year ? `${aircraft.year} ` : '';
        const name = aircraft.aircraft_name || aircraft.name || 'Unknown Aircraft';
        const label = `${year}${name}`.trim();
        return label.length > 32 ? `${label.slice(0, 29)}` : label;
    }

    function attachCompareButtonHandlers() {
        const buttons = document.querySelectorAll('.add-to-compare-btn');
        buttons.forEach(button => {
            if (!button.dataset.compareListenerAttached) {
                button.addEventListener('click', (event) => {
                    const target = event.currentTarget;
                    const aircraftId = target.dataset.compareId;
                    toggleCompareSelection(aircraftId);
                });
                button.dataset.compareListenerAttached = 'true';
            }
        });
        updateCompareButtonStates();
    }

    function updateCompareButtonStates() {
        const buttons = document.querySelectorAll('.add-to-compare-btn');
        buttons.forEach(button => {
            const aircraftId = button.dataset.compareId;
            const isSelected = isAircraftInCompare(aircraftId);
            if (isSelected) {
                button.classList.add('active');
                button.innerHTML = '<i class="fas fa-check me-2"></i>In Compare';
            } else {
                button.classList.remove('active');
                button.innerHTML = '<i class="fas fa-plus me-2"></i>Add to Compare';
            }
        });
    }

    function destroyCompareCharts() {
        if (Array.isArray(costCharts)) {
            costCharts.forEach(chart => chart && chart.destroy());
        }
        costCharts = [];
    }

    function buildCostCharts(selectionData) {
        const container = document.getElementById('costChartsContainer');
        if (!container) return;

        ensureCostMetricDefaults();
        const metricOptions = compareCostMetricKeys.map(key => getCostMetricOption(key));

        destroyCompareCharts();
        container.innerHTML = '';

        const aircraftLabels = selectionData.map(({ aircraft }) => getAircraftShortLabel(aircraft));

        metricOptions.forEach((option, metricIndex) => {
            if (!option) return;

            const chartCard = document.createElement('div');
            chartCard.className = 'chart-card';
            chartCard.innerHTML = `
                <div class="chart-header">
                    <h6 class="mb-1 text-white">${option.label}</h6>
                    <small class="text-white-50">Independent scale per metric for apples-to-apples comparison.</small>
                </div>
                <div class="chart-wrapper">
                    <canvas id="compareCostChart-${metricIndex}"></canvas>
                </div>
            `;
            container.appendChild(chartCard);

            const canvas = chartCard.querySelector('canvas');
            const ctx = canvas.getContext('2d');

            const rawValues = selectionData.map(({ metrics }) =>
                option.getValue ? option.getValue(metrics) : null
            );
            const numericValues = rawValues.map(value => Number.isFinite(value) ? value : 0);
            const colors = selectionData.map(({ colorIndex }) => getCompareColor(colorIndex, 0.6));
            const borderColors = selectionData.map(({ colorIndex }) => getCompareColor(colorIndex, 0.95));

            const chart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: aircraftLabels,
                    datasets: [{
                        label: option.label,
                        data: numericValues,
                        metaValues: rawValues,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 1.5,
                        maxBarThickness: 36
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const aircraftLabel = context.label || '';
                                    const value = context.dataset.metaValues
                                        ? context.dataset.metaValues[context.dataIndex]
                                        : context.parsed.y;
                                    return `${aircraftLabel}: ${formatMetricValue(option, value)}`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'rgba(255,255,255,0.75)'
                            },
                            grid: {
                                display: false
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: 'rgba(255,255,255,0.75)',
                                callback: (value) => formatTickForType(option.type, value, option.precision)
                            },
                            grid: {
                                color: 'rgba(255,255,255,0.12)'
                            }
                        }
                    }
                }
            });

            costCharts.push(chart);
        });
    }

    function updateCompareUI() {
        const countElement = document.getElementById('compareSelectedCount');
        const clearButton = document.getElementById('clearCompareBtn');
        const emptyState = document.getElementById('compareEmptyState');
        const content = document.getElementById('compareContent');
        const container = document.getElementById('compareAircraftContainer');

        if (!countElement || !container) {
            return;
        }

        compareSelections = compareSelections.filter(selection => !!findAircraftById(selection.id));
        compareSelections.forEach((selection, idx) => {
            if (selection.colorIndex === undefined) {
                selection.colorIndex = idx % COMPARE_COLORS.length;
            }
        });

        ensureCostMetricDefaults();
        syncCostMetricSelectors();

        countElement.textContent = `${compareSelections.length} / ${MAX_COMPARE_SELECTIONS} selected`;
        if (clearButton) {
            clearButton.disabled = compareSelections.length === 0;
        }

        if (compareSelections.length === 0) {
            emptyState?.classList.remove('d-none');
            content?.classList.add('d-none');
            container.innerHTML = '';
            destroyCompareCharts();
            updateCompareButtonStates();
            return;
        }

        emptyState?.classList.add('d-none');
        content?.classList.remove('d-none');

        const userInputs = getUserInputs();
        const selectionData = compareSelections
            .map((selection, index) => {
                const aircraft = findAircraftById(selection.id);
                if (!aircraft) {
                    return null;
                }
                const metrics = calculateDynamicMetrics(aircraft, userInputs);
                return {
                    aircraft,
                    metrics,
                    colorIndex: selection.colorIndex ?? index
                };
            })
            .filter(Boolean);

        container.innerHTML = '';

        selectionData.forEach(({ aircraft, metrics, colorIndex }) => {
            const card = document.createElement('div');
            card.className = 'compare-aircraft-card';
            card.style.setProperty('--accent', getCompareColor(colorIndex, 1));

            card.innerHTML = `
                <div class="compare-card-header">
                    <div>
                        <div class="compare-card-title">${getAircraftShortLabel(aircraft)}</div>
                        <div class="compare-card-subtitle">${formatNumber(aircraft.speed, 0)} kts  ${formatNumber(aircraft.range, 0)} nm  ${formatNumber(aircraft.passengers, 0)} pax</div>
                </div>
                    <button type="button" class="compare-remove-btn" data-remove-id="${aircraft.id}">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="compare-pill-group">
                    <div class="compare-pill">
                        <span>Annual Budget</span>
                        <strong>${formatCurrency(metrics.annualBudget || 0)}</strong>
                    </div>
                    <div class="compare-pill">
                        <span>Multi-Year Cost</span>
                        <strong>${formatCurrency(metrics.multiYearTotalCost || 0)}</strong>
                    </div>
                    <div class="compare-pill">
                        <span>Cost to Charter</span>
                        <strong>${formatCurrency(metrics.costToCharter || 0)}</strong>
                    </div>
                </div>
                <div class="compare-metrics">
                    <div class="compare-metric">
                        <span>Speed / $</span>
                        <strong>${formatNumber(metrics.bestSpeedDollar || 0, 2)}</strong>
                    </div>
                    <div class="compare-metric">
                        <span>Range / $</span>
                        <strong>${formatNumber(metrics.bestRangeDollar || 0, 2)}</strong>
                    </div>
                    <div class="compare-metric">
                        <span>Performance / $</span>
                        <strong>${formatNumber(metrics.bestPerformanceDollar || 0, 2)}</strong>
                    </div>
                    <div class="compare-metric">
                        <span>Efficiency / $</span>
                        <strong>${formatNumber(metrics.bestEfficiencyDollar || 0, 2)}</strong>
                    </div>
                    <div class="compare-metric">
                        <span>All-Around / $</span>
                        <strong>${formatNumber(metrics.bestAllAroundDollar || 0, 2)}</strong>
                    </div>
                    <div class="compare-metric">
                        <span>Hourly Cost</span>
                        <strong>${formatCurrency(metrics.totalHourlyCost || 0)}</strong>
                    </div>
                </div>
            `;

            const removeButton = card.querySelector('.compare-remove-btn');
            if (removeButton) {
                removeButton.addEventListener('click', () => {
                    removeFromCompare(aircraft.id);
                });
            }

            container.appendChild(card);
        });

        buildCostCharts(selectionData);
        updateCompareButtonStates();
    }

    // Helper functions for performance score display - RANK-BASED PERCENTAGE
    function getPerformancePercentage(score, metricType, allVisibleAircraft) {
        // Use ALL aircraft data for consistent percentage calculations, not just visible aircraft
        const aircraftToCompare = filteredAircraftData.length > 0 ? filteredAircraftData : allAircraftData;

        // Get all scores for this metric from ALL aircraft with aircraft reference
        const allScoresWithAircraft = [];

        aircraftToCompare.forEach(aircraft => {
            const metrics = calculateDynamicMetrics(aircraft, getUserInputs());
            let metricScore;

            switch (metricType) {
                case 'speed': metricScore = metrics.bestSpeedDollar; break;
                case 'range': metricScore = metrics.bestRangeDollar; break;
                case 'performance': metricScore = metrics.bestPerformanceDollar; break;
                case 'efficiency': metricScore = metrics.bestEfficiencyDollar; break;
                case 'allAround': metricScore = metrics.bestAllAroundDollar; break;
                default: metricScore = 0;
            }

            if (metricScore && metricScore > 0 && !isNaN(metricScore)) {
                allScoresWithAircraft.push({
                    score: metricScore,
                    aircraft: aircraft,
                    aircraftName: aircraft.aircraft_name || aircraft.name || 'Unknown'
                });
            }
        });

        if (allScoresWithAircraft.length === 0) return 50;

        // Sort scores in ascending order (lowest scores first, since lower is better)
        allScoresWithAircraft.sort((a, b) => a.score - b.score);

        // Find the rank of the current score
        let rank = 1;
        for (let i = 0; i < allScoresWithAircraft.length; i++) {
            if (Math.abs(allScoresWithAircraft[i].score - score) < 0.001) {
                rank = i + 1;
                break;
            }
        }

        // Calculate percentage based on rank
        // Best aircraft (rank 1) gets 100%, next best gets 99%, etc.
        const totalAircraft = allScoresWithAircraft.length;
        const percentage = Math.max(1, 101 - rank);

        // Debug logging for percentage calculation
        if (metricType === 'performance' || metricType === 'allAround') {
            console.log(` ${metricType} Rank Calc: Score=${score.toFixed(2)}, Rank=${rank}/${totalAircraft}, Percentage=${percentage}%`);
        }

        return Math.round(Math.max(1, Math.min(100, percentage)));
    }

    function getPerformanceColor(percentage) {
        // Color gradient from red (bad) to green (good)
        if (percentage >= 80) return 'linear-gradient(135deg, #28a745, #20c997)';  // Green - Excellent
        if (percentage >= 60) return 'linear-gradient(135deg, #17a2b8, #28a745)';  // Blue-Green - Good
        if (percentage >= 40) return 'linear-gradient(135deg, #ffc107, #17a2b8)';  // Yellow-Blue - Fair
        if (percentage >= 20) return 'linear-gradient(135deg, #fd7e14, #ffc107)';  // Orange-Yellow - Poor
        return 'linear-gradient(135deg, #dc3545, #fd7e14)';  // Red-Orange - Very Poor
    }

    // Populate relative performance scores for all visible aircraft
    function populateRelativePerformanceScores(currentPageAircraft) {
        const metrics = ['speed', 'range', 'performance', 'efficiency', 'allAround'];
        const metricLabels = ['Best Speed/$', 'Best Range/$', 'Best Performance/$', 'Best Efficiency/$', 'Best All-Around/$'];

        // Use ALL aircraft for consistent comparison
        const allAircraft = filteredAircraftData.length > 0 ? filteredAircraftData : allAircraftData;

        currentPageAircraft.forEach((aircraft, index) => {
            const performanceContainer = document.getElementById(`performance-scores-${index}`);
            if (!performanceContainer) return;

            const displayMetrics = calculateDynamicMetrics(aircraft, getUserInputs());
            let html = '';

            // Debug: Log performance scores for M600
            if (aircraft.aircraft_name && aircraft.aircraft_name.toUpperCase().includes('M600')) {
                console.log(' M600 Performance Scores in Display:');
                console.log('  bestPerformanceDollar:', displayMetrics.bestPerformanceDollar);
                console.log('  bestAllAroundDollar:', displayMetrics.bestAllAroundDollar);
            }

            // Display metrics should already be calculated by calculateDynamicMetrics
            // Just log if we're getting 0 values (which should not happen)
            if (displayMetrics.bestPerformanceDollar === 0 || isNaN(displayMetrics.bestPerformanceDollar)) {
                console.warn(' Performance score is 0 or NaN for aircraft:', aircraft.aircraft_name || aircraft.name);
            }
            if (displayMetrics.bestAllAroundDollar === 0 || isNaN(displayMetrics.bestAllAroundDollar)) {
                console.warn(' All-Around score is 0 or NaN for aircraft:', aircraft.aircraft_name || aircraft.name);
            }

            metrics.forEach((metricType, i) => {
                let score, percentage;

                switch (metricType) {
                    case 'speed':
                        score = displayMetrics.bestSpeedDollar;
                        percentage = getPerformancePercentage(score, metricType, allAircraft);
                        break;
                    case 'range':
                        score = displayMetrics.bestRangeDollar;
                        percentage = getPerformancePercentage(score, metricType, allAircraft);
                        break;
                    case 'performance':
                        // Performance/$ needs relative comparison using raw AZ2 values
                        score = displayMetrics.bestPerformanceDollar;
                        percentage = getPerformancePercentage(score, metricType, allAircraft);
                        // Ensure percentage is logical (not 50% for all)
                        if (percentage === 50 && score > 0) {
                            percentage = Math.min(100, Math.max(0, score * 2)); // Simple scaling
                        }
                        break;
                    case 'efficiency':
                        score = displayMetrics.bestEfficiencyDollar;
                        percentage = getPerformancePercentage(score, metricType, allAircraft);
                        // Ensure percentage is logical
                        if (percentage === 50 && score > 0) {
                            percentage = Math.min(100, Math.max(0, score * 10)); // Simple scaling
                        }
                        break;
                    case 'allAround':
                        // All-Around/$ needs relative comparison using raw BF2 values
                        score = displayMetrics.bestAllAroundDollar;
                        percentage = getPerformancePercentage(score, metricType, allAircraft);
                        // Ensure percentage is logical
                        if (percentage === 50 && score > 0) {
                            percentage = Math.min(100, Math.max(0, score * 2)); // Simple scaling
                        }
                        break;
                }

                const color = getPerformanceColor(percentage);

                // Debug logging for M600 and first few aircraft
                if (aircraft.aircraft_name && aircraft.aircraft_name.toUpperCase().includes('M600')) {
                    console.log(` M600 ${metricLabels[i]}: Value=${score.toFixed(2)}, Percentage=${percentage}%`);
                }
                if (index < 3) {
                    console.log(` Aircraft ${index + 1} (${aircraft.aircraft_name}) - ${metricLabels[i]}: Value=${score.toFixed(2)}, Percentage=${percentage}%`);
                }

                html += `
                    <div class="performance-score-item" style="margin-bottom: 8px;">
                        <div class="performance-label" style="font-size: 0.75rem; font-weight: 600; color: #666; margin-bottom: 3px;">
                            ${metricLabels[i]}
                    </div>
                        <div class="performance-bar" style="background: ${color}; color: white; padding: 8px 12px; border-radius: 6px; text-align: center; font-weight: 700;">
                            ${percentage}%
                            <small style="opacity: 0.8; font-size: 0.7em; margin-left: 8px;">(${score.toFixed(2)})</small>
                    </div>
                </div>
            `;
            });

            performanceContainer.innerHTML = html;
        });
    }

    // Create HTML for an aircraft card
    function createAircraftCardHTML(aircraft, index) {
        const card = document.createElement('div');

        // ALWAYS calculate dynamically using the Excel formulas with current user inputs
        // This ensures all displayed metrics match the user's specific scenario
        const displayMetrics = calculateDynamicMetrics(aircraft, userInputs);

        card.className = 'aircraft-card-wrapper';
        card.style.cssText = 'margin-bottom: 2rem; padding: 0;';

        const listingTitle = (aircraft.listing_title || aircraft.title || `${aircraft.manufacturer || ''} ${aircraft.aircraft_name || aircraft.name || 'Unknown Aircraft'}`.trim()).trim();
        const listingDescription = aircraft.listing_description || aircraft.description || '';
        const listingLocation = aircraft.location || 'Location on request';
        const engineType = aircraft.engine_type || aircraft.category || 'Unknown';
        const priceValue = aircraft.listing_price || aircraft.price || 0;
        const primaryImage = aircraft.image || '/static/images/aircraft_placeholder.jpg';
        const contactEmail = aircraft.contact_email || aircraft.email || '';

        card.innerHTML = `
            <div class="aircraft-card" id="aircraft-${index}" 
                data-aircraft-id="${aircraft.id}"
                data-price="${priceValue}"
                data-range="${aircraft.range || 0}"
                data-speed="${aircraft.speed || 0}"
                data-passengers="${aircraft.passengers || 0}"
                data-total-fixed-cost="${aircraft.total_fixed_cost || 0}"
                data-total-variable-cost="${aircraft.total_variable_cost || 0}"
                data-depreciation-value="${aircraft.depreciation_rate || 0}"
                data-category="${aircraft.category || ''}"
                data-aircraft-type="${aircraft.category || ''}"
                data-normalized-speed-dollar="${aircraft.normalized_speed_dollar || 0}"
                data-normalized-range-dollar="${aircraft.normalized_range_dollar || 0}"
                data-normalized-performance-dollar="${aircraft.normalized_performance_dollar || 0}"
                data-normalized-efficiency-dollar="${aircraft.normalized_efficiency_dollar || 0}"
                data-best-speed-dollar="${aircraft.best_speed_dollar || 0}"
                data-best-range-dollar="${aircraft.best_range_dollar || 0}"
                data-best-performance-dollar="${aircraft.best_performance_dollar || 0}"
                data-best-efficiency-dollar="${aircraft.best_efficiency_dollar || 0}"
                style="background: white; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); overflow: hidden; transition: transform 0.2s ease, box-shadow 0.2s ease;">
                
                <!-- Aircraft Image - Fixed Aspect Ratio -->
                <div class="aircraft-image" style="position: relative; width: 100%; height: 220px; overflow: hidden; background: #f8f9fa;">
                    <img src="${primaryImage}" alt="${listingTitle}" 
                         style="width: 100%; height: 100%; object-fit: cover; object-position: center;">
                    </div>
                
                <div class="aircraft-content" style="padding: 20px;">
                    <h5 class="aircraft-name">${listingTitle}</h5>
                    <div class="text-muted mb-2" style="font-size: 0.85rem;">
                        <i class="fas fa-map-marker-alt me-1"></i>${listingLocation}  
                        <i class="fas fa-cog me-1"></i>${engineType}
                    </div>
                    
                    <!-- PRICE - Directly Under Title -->
                    <div class="aircraft-price" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; padding: 12px 15px; text-align: center; border-radius: 8px; margin: 10px 0 15px 0; box-shadow: 0 3px 10px rgba(0,0,0,0.2);">
                        <div style="font-size: 1.6rem; font-weight: 900; letter-spacing: 0.5px;">
                            $${(priceValue || 0).toLocaleString()}
                                </div>
                        <div style="font-size: 0.7rem; font-weight: 600; opacity: 0.9; margin-top: 2px; text-transform: uppercase;">Seller Asking Price</div>
                                </div>
                    
                    <!-- Performance Scores - Relative Comparison (Stacked Vertically) -->
                    <div class="performance-scores mb-3" id="performance-scores-${index}">
                        <!-- Performance scores will be populated after all cards are created -->
                            </div>
                    
                    <div class="spec-grid">
                    <div class="spec-item">
                            <span class="spec-label">Range:</span>
                            <span class="spec-value">${aircraft.range || 0} nm</span>
                                </div>
                    <div class="spec-item">
                            <span class="spec-label">Speed:</span>
                            <span class="spec-value">${aircraft.speed || 0} kts</span>
                                </div>
                    <div class="spec-item">
                            <span class="spec-label">Manufacturer:</span>
                            <span class="spec-value">${aircraft.manufacturer || 'Unknown'}</span>
                                </div>
                    <div class="spec-item">
                            <span class="spec-label">Avg Trip Time:</span>
                            <span class="spec-value">${displayMetrics.averageTripTime.toFixed(1)} hrs</span>
                            </div>
                    <div class="spec-item">
                            <span class="spec-label">Total Trip Time:</span>
                            <span class="spec-value">${displayMetrics.totalTripTime.toFixed(1)} hrs</span>
                        </div>
                    <div class="spec-item">
                            <span class="spec-label">Cabin Volume:</span>
                            <span class="spec-value">${aircraft.cabin_volume || 0} cu ft</span>
                    </div>
                        <div class="spec-item">
                            <span class="spec-label">Baggage Volume:</span>
                            <span class="spec-value">${aircraft.baggage_volume || 0} cu ft</span>
                </div>
                        <div class="spec-item">
                            <span class="spec-label">Annual Budget:</span>
                            <span class="spec-value">$${displayMetrics.annualBudget.toLocaleString()}</span>
            </div>
                        <div class="spec-item">
                            <span class="spec-label">Multi-Year Total Cost:</span>
                            <span class="spec-value">$${displayMetrics.multiYearTotalCost.toLocaleString()}</span>
                        </div>
                        <div class="spec-item">
                            <span class="spec-label">Cost to Charter:</span>
                            <span class="spec-value">$${displayMetrics.costToCharter.toLocaleString()}</span>
                    </div>
                        </div>
                        
                        ${listingDescription ? `
                        <div class="mt-3">
                            <span class="spec-label">Seller Notes:</span>
                            <p class="text-muted mb-0" style="font-size: 0.9rem;">${listingDescription}</p>
                        </div>` : ''}
                        
                        <!-- Card Actions -->
                        <div class="card-actions" style="padding: 15px 20px; border-top: 1px solid #eee; background: #f8f9fa;">
                            <button class="btn add-to-compare-btn" type="button"
                                    data-compare-id="${aircraft.id}"
                                    data-compare-name="${aircraft.manufacturer || ''} ${aircraft.aircraft_name || aircraft.name || 'Unknown Aircraft'}">
                                <i class="fas fa-plus me-2"></i>Add to Compare
                            </button>
                            ${contactEmail ? `
                            <a class="btn primary-action-btn" href="mailto:${contactEmail}" style="width: 100%; padding: 12px; font-weight: 600; border-radius: 8px; border: none; background: linear-gradient(135deg, #F05545, #d63c2d); color: #ffffff; transition: all 0.2s ease;">
                                <i class="fas fa-envelope me-2"></i>Contact Seller
                            </a>` : ''}
                    </div>
                    </div> <!-- End aircraft-content -->
                </div> <!-- End aircraft-card -->
            </div> <!-- End aircraft-card-wrapper -->
        `;

        // Add hover effects
        card.addEventListener('mouseenter', function () {
            const aircraftCard = this.querySelector('.aircraft-card');
            if (aircraftCard) {
                aircraftCard.style.transform = 'translateY(-5px)';
                aircraftCard.style.boxShadow = '0 8px 25px rgba(0,0,0,0.15)';
            }
        });

        card.addEventListener('mouseleave', function () {
            const aircraftCard = this.querySelector('.aircraft-card');
            if (aircraftCard) {
                aircraftCard.style.transform = 'translateY(0)';
                aircraftCard.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
            }
        });

        return card;
    }

    // Find the HTML card that corresponds to an aircraft object
    function findAircraftCard(aircraft, aircraftCards) {
        // Try multiple methods to match aircraft to card
        for (let card of aircraftCards) {
            // Method 1: Match by aircraft element reference
            if (aircraft.element === card) {
                return card;
            }

            // Method 2: Match by aircraft ID
            if (aircraft.id && card.id === aircraft.id) {
                return card;
            }

            // Method 3: Match by aircraft name
            const cardName = card.querySelector('.aircraft-name')?.textContent?.trim() || '';
            if (aircraft.name && cardName === aircraft.name) {
                return card;
            }

            // Method 4: Match by data-aircraft-id
            const cardAircraftId = card.querySelector('[data-aircraft-id]')?.dataset.aircraftId;
            if (aircraft.id && cardAircraftId === aircraft.id) {
                return card;
            }
        }

        console.log(` Could not find card for aircraft: ${aircraft.name}`);
        return null;
    }
    // Load more aircraft from next pages to fill current page
    function loadMoreAircraftFromNextPages(currentVisible) {
        const needed = itemsPerPage - currentVisible;
        const aircraftCards = document.querySelectorAll('.aircraft-card');
        let loaded = 0;

        // Try to load from next pages
        for (let page = currentPage + 1; page <= totalPages && loaded < needed; page++) {
            const pageStartIndex = (page - 1) * itemsPerPage;
            const pageEndIndex = pageStartIndex + itemsPerPage;
            const pageAircraft = filteredAircraftData.slice(pageStartIndex, pageEndIndex);

            pageAircraft.forEach((aircraft, index) => {
                if (loaded >= needed) return;

                const cardIndex = pageStartIndex + index;
                if (cardIndex < aircraftCards.length) {
                    const card = aircraftCards[cardIndex];
                    card.style.display = 'block';
                    card.classList.add('filtered-match');
                    loaded++;
                }
            });
        }

        console.log(` Loaded ${loaded} additional aircraft from next pages`);
    }

    // Update pagination controls
    function updatePagination() {
        totalPages = Math.ceil(filteredAircraftData.length / itemsPerPage);
        if (totalPages === 0) totalPages = 1;

        // Shopping site logic: If current page is beyond available pages, reset to page 1
        if (currentPage > totalPages) {
            currentPage = 1;
        }

        renderPagination();
    }

    // Render pagination controls
    function renderPagination() {
        const paginationBottom = document.getElementById('pagination-bottom');

        if (!paginationBottom) {
            console.log(' Pagination element not found');
            return;
        }

        // Clear pagination control
        paginationBottom.innerHTML = '';

        if (totalPages <= 1) {
            // Show a single page indicator even for 1 page
            const singlePageLi = document.createElement('li');
            singlePageLi.className = 'page-item active';
            singlePageLi.innerHTML = '<span class="page-link">1</span>';

            paginationBottom.appendChild(singlePageLi);
            paginationBottom.style.display = 'flex';
            return;
        }

        paginationBottom.style.display = 'flex';

        // Create pagination content
        const paginationContent = createPaginationContent();

        // Add to bottom pagination only (centered)
        paginationBottom.innerHTML = paginationContent;

        // Add click event listener
        addPaginationEventListeners(paginationBottom);
    }

    // Create pagination content - simplified Previous/Page Number/Next format
    function createPaginationContent() {
        let content = '';

        // Previous button
        content += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage - 1}">Previous</a>
        </li>`;

        // Current page number in the middle (highlighted)
        content += `<li class="page-item active">
            <span class="page-link">${currentPage}</span>
        </li>`;

        // Next button
        content += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
            <a class="page-link" href="#" data-page="${currentPage + 1}">Next</a>
        </li>`;

        return content;
    }

    // Add click event listeners to pagination
    function addPaginationEventListeners(pagination) {
        pagination.addEventListener('click', function (e) {
            e.preventDefault();

            if (e.target.tagName === 'A' && e.target.dataset.page) {
                const page = parseInt(e.target.dataset.page);

                if (page >= 1 && page <= totalPages && page !== currentPage) {
                    currentPage = page;
                    // Force pagination update to ensure only selected page is highlighted
                    updatePagination();
                    updateAircraftDisplay();
                }
            }
        });
    }

    // Update pagination info display
    function updatePaginationInfo() {
        const startIndex = (currentPage - 1) * itemsPerPage + 1;
        const endIndex = Math.min(currentPage * itemsPerPage, filteredAircraftData.length);

        // Update top pagination info
        const showingStartTop = document.getElementById('showing-start-top');
        const showingEndTop = document.getElementById('showing-end-top');
        const totalResultsTop = document.getElementById('total-results-top');

        if (showingStartTop) showingStartTop.textContent = startIndex;
        if (showingEndTop) showingEndTop.textContent = endIndex;
        if (totalResultsTop) totalResultsTop.textContent = filteredAircraftData.length;

        // Update bottom pagination info
        const showingStartBottom = document.getElementById('showing-start-bottom');
        const showingEndBottom = document.getElementById('showing-end-bottom');
        const totalResultsBottom = document.getElementById('total-results-bottom');

        if (showingStartBottom) showingStartBottom.textContent = startIndex;
        if (showingEndBottom) showingEndBottom.textContent = endIndex;
        if (totalResultsBottom) totalResultsBottom.textContent = filteredAircraftData.length;

        updateAircraftCounters();
    }

    function updateAircraftCounters() {
        const remaining = filteredAircraftData.length;
        const total = allAircraftData.length;
        const rangeCountElement = document.getElementById('range-aircraft-remaining');
        if (rangeCountElement) {
            rangeCountElement.textContent = remaining.toLocaleString();
        }
        const listingsCountElement = document.getElementById('listings-aircraft-remaining-count');
        if (listingsCountElement) {
            listingsCountElement.textContent = remaining.toLocaleString();
        }
    }

    // Update filter status display
    function updateFilterStatus() {
        const statusElement = document.getElementById('filter-status');
        if (statusElement) {
            const totalAircraft = allAircraftData.length;
            const visibleAircraft = filteredAircraftData.length;
            const hiddenAircraft = totalAircraft - visibleAircraft;

            statusElement.innerHTML = `
                <div class="alert alert-info">
                    <strong>Filter Status:</strong> 
                    Showing ${visibleAircraft} of ${totalAircraft} aircraft
                    ${hiddenAircraft > 0 ? `(${hiddenAircraft} hidden by filters)` : ''}
                    </div>
            `;
        }
    }

    // Define ALL functions with actual filtering logic
    function runAnalysis() {
        console.log(' runAnalysis called!');
        console.log(' Applying real-time filtering...');

        // Ensure we have aircraft data loaded
        if (allAircraftData.length === 0) {
            loadCurrentPageAircraft();
        }

        applyRealTimeFiltering();
    }

    function applyImmediateRangeFilter(rangeReq) {
        console.log(' applyImmediateRangeFilter called with:', rangeReq);

        // Set the range input value
        const rangeInput = document.getElementById('range-input');
        if (rangeInput) {
            rangeInput.value = rangeReq;
            console.log(` Set range input to ${rangeReq}nm`);
        }

        // Ensure we have aircraft data loaded
        if (allAircraftData.length === 0) {
            loadCurrentPageAircraft();
        }

        // Apply filtering
        applyRealTimeFiltering();

        // Show results and test Mooney filtering
        const aircraftCards = document.querySelectorAll('.aircraft-card');
        const visibleCards = Array.from(aircraftCards).filter(card => card.style.display !== 'none');
        console.log(` Range filter applied: ${visibleCards.length} aircraft visible`);

        // Test: Check if Mooney aircraft are properly filtered
        const mooneyCards = Array.from(aircraftCards).filter(card =>
            card.textContent.toLowerCase().includes('mooney')
        );
        console.log(` Mooney aircraft found: ${mooneyCards.length}`);
        mooneyCards.forEach(card => {
            const isVisible = card.style.display !== 'none';
            const aircraftName = card.querySelector('.aircraft-name')?.textContent?.trim() || 'Unknown';
            console.log(`  - ${aircraftName}: ${isVisible ? 'VISIBLE' : 'FILTERED OUT'}`);
        });
    }

    // Test functions removed - core functionality preserved

    function clearAllFilters() {
        console.log(' clearAllFilters called!');

        // Clear all input values
        const filterInputs = [
            'range-input', 'passengers', 'budget', 'lowest-year',
            'advanced_min_speed', 'advanced_min_altitude',
            'advanced_max_runway', 'advanced_min_cabin_volume',
            'advanced_max_annual_cost', 'advanced_max_hourly_cost',
            'advanced_fuel_price', 'advanced_ownership_years'
        ];

        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.value = '';
            }
        });

        // Reset pagination to page 1 (shopping site logic)
        currentPage = 1;
        console.log(' Reset to page 1 after clearing all filters');

        // Reset filtered data to show all aircraft
        filteredAircraftData = [...allAircraftData];

        // Update pagination and display
        updatePagination();
        updateAircraftDisplay();

        console.log(' All filters cleared - showing all aircraft');
    }

    function resetAircraftView() {
        console.log(' resetAircraftView called!');

        // Clear all filters first
        clearAllFilters();

        // Reset to page 1
        currentPage = 1;
        updatePagination();
        updateAircraftDisplay();

        console.log(` Reset view - showing all aircraft`);
    }

    // Test pagination functionality
    function testPagination() {
        console.log(' Testing pagination functionality...');
        console.log(` Current state: Page ${currentPage} of ${totalPages}, ${filteredAircraftData.length} aircraft`);

        // Test navigation to different pages
        if (totalPages > 1) {
            console.log(' Testing page navigation...');

            // Test going to page 2 if available
            if (totalPages >= 2) {
                console.log(' Testing navigation to page 2');
                currentPage = 2;
                updateAircraftDisplay();
            }

            // Test going to last page
            if (totalPages > 2) {
                setTimeout(() => {
                    console.log(' Testing navigation to last page');
                    currentPage = totalPages;
                    updateAircraftDisplay();
                }, 1000);
            }

            // Return to page 1
            setTimeout(() => {
                console.log(' Returning to page 1');
                currentPage = 1;
                updateAircraftDisplay();
            }, 2000);
        } else {
            console.log(' Only 1 page available - no pagination needed');
        }
    }

    // Force pagination initialization
    function forcePaginationInit() {
        console.log(' FORCING PAGINATION INITIALIZATION...');

        // Ensure aircraft data is loaded
        if (allAircraftData.length === 0) {
            console.log(' Loading aircraft data first...');
            loadCurrentPageAircraft();
        }

        // Force update pagination
        console.log(` Aircraft data: ${allAircraftData.length} total, ${filteredAircraftData.length} filtered`);
        updatePagination();
        updateAircraftDisplay();

        console.log(' Pagination initialization complete!');
    }

    // Make core functions global
    window.runAnalysis = runAnalysis;
    window.applyImmediateRangeFilter = applyImmediateRangeFilter;
    window.clearAllFilters = clearAllFilters;
    window.resetAircraftView = resetAircraftView;
    window.testPagination = testPagination;
    window.forcePaginationInit = forcePaginationInit;

    // Functions are now globally available

    // User inputs for dynamic calculations - start blank unless filled by user
    const userInputs = {
        // Basic Requirements
        rangeRequirement: null,
        passengers: null,
        budget: null,
        lowestAcceptableYear: null,

        // Trip Planning
        averageTripLength: null,
        numberOfTrips: null,
        yearsOfOwnership: null,
        speed: null,

        // Aircraft Specifications
        lowestYear: null,
        highestYear: null,
        minCrewRequired: null,
        maxOperatingAltitude: null,
        balancedFieldLength: null,
        aircraftHeight: null,
        wingspan: null,
        aircraftLength: null,

        // Fuel & Operating Costs
        jetAPrice: null,
        avgasPrice: null,
        depreciationRate: null,
        costToCharter: null,

        // Pilot Costs
        pistonPilotPay: null,
        turbopropPilotPay: null,
        businessJetPilotPay: null,

        // Charter Operations
        plannedPax: null,
        passengerPay: null,
        charterRatePercentage: null,
        averageCharterTripLength: null,

        // Aircraft Categories
        manufacturer: null,
        type: null,
        multiEngine: null
    };
    function toNumber(value) {
        if (typeof value === 'number') return Number.isFinite(value) ? value : 0;
        if (typeof value === 'string') {
            const cleaned = value.replace(/[^0-9.-]/g, '');
            const parsed = parseFloat(cleaned);
            return Number.isFinite(parsed) ? parsed : 0;
        }
        const parsed = Number(value);
        return Number.isFinite(parsed) ? parsed : 0;
    }

    function roundTo(value, decimals = 2) {
        if (!Number.isFinite(value)) return 0;
        const factor = Math.pow(10, decimals);
        return Math.round(value * factor) / factor;
    }

    function getAircraftCacheKey(aircraft) {
        if (aircraft && aircraft.id != null) {
            return `id_${aircraft.id}`;
        }
        const name = aircraft?.aircraft_name || aircraft?.name || aircraft?.model || '';
        const manufacturer = aircraft?.manufacturer || '';
        return `${manufacturer}_${name}`.toUpperCase();
    }

    function buildScenarioParams(inputs = {}) {
        const params = {
            F2: toNumber(inputs.averageTripLength) || 0,
            G2: toNumber(inputs.numberOfTrips) || 0,
            H2: toNumber(inputs.yearsOfOwnership) || 0,
            I2: toNumber(inputs.jetAPrice) || 0,
            J2: toNumber(inputs.avgasPrice) || 0,
            K2: (toNumber(inputs.depreciationRate) || 0) / 100,
            L2: (toNumber(inputs.costToCharter) || 0) / 100,
            M2: toNumber(inputs.pistonPilotPay) || 0,
            N2: toNumber(inputs.turbopropPilotPay) || 0,
            O2: toNumber(inputs.businessJetPilotPay) || 0,
            P2: toNumber(inputs.plannedPax) || 0,
            Q2: toNumber(inputs.passengerPay) || 0,
            R2: (toNumber(inputs.charterRatePercentage) || 0) / 100,
            S2: toNumber(inputs.averageCharterTripLength) || 0,
            T2: toNumber(inputs.charterTrips) || 0
        };

        params.cacheKey = [
            params.F2, params.G2, params.H2, params.I2,
            params.K2, params.L2, params.M2, params.N2,
            params.O2, params.P2, params.Q2, params.R2,
            params.S2, params.T2
        ].join('|');

        return params;
    }

    function computeMetricsForAircraft(aircraft, params) {
        const key = getAircraftCacheKey(aircraft);
        const Y2 = toNumber(aircraft?.speed);
        const X2 = toNumber(aircraft?.range);
        const Z2 = toNumber(aircraft?.passengers);
        const AA2 = toNumber(aircraft?.price);
        const AJ2 = toNumber(aircraft?.total_fixed_cost);
        const AK2 = toNumber(aircraft?.total_variable_cost);

        const AB2 = AA2 * Math.pow(1 - params.K2, params.H2);
        const AC2 = Y2 > 0 ? params.F2 / Y2 : 0;
        const AD2 = AC2 * params.G2;
        const AE2 = (params.Q2 * params.P2) * AD2;
        const BL2 = AK2 / 450;
        const AF2 = BL2 * params.R2;
        const AG2 = Y2 > 0 ? params.S2 / Y2 : 0;
        const AH2 = AG2 * params.T2;
        const AI2 = AH2 * AF2;
        const AL2 = ((BL2 / 6) * params.I2) * AD2;
        const AM2 = AJ2 + AK2;

        const aircraftType = (aircraft?.category || '').toLowerCase();
        let pilotPay = params.N2;
        if (aircraftType.includes('piston')) {
            pilotPay = params.M2;
        } else if (aircraftType.includes('business') || aircraftType.includes('jet')) {
            pilotPay = params.O2;
        }

        const AN2 = (AL2 + AJ2) - AI2 + AE2 - pilotPay;
        const AO2 = ((AN2 * params.H2) + AA2) + (AA2 - AB2);
        const AP2 = AO2 - AB2;
        const AQ2 = (((BL2 * params.L2) * AD2) * params.H2) + (AE2 * params.H2);
        const AR2 = AQ2 !== 0 ? AP2 / AQ2 : 0;
        const AS2 = AP2 - AQ2;
        const AT2 = Y2 > 0 ? (AO2 / Y2) / 1000 : 0;
        const AW2 = X2 > 0 ? (AO2 / X2) / 100 : 0;
        const AV2 = Z2 > 0 ? AT2 / Z2 : 0;
        const AY2 = Z2 > 0 ? AW2 / Z2 : 0;
        const BN2 = Y2 > 0 ? BL2 / Y2 : 0;
        const BC2 = ((2 * BN2) * AO2) / 1000000;
        const BH2 = (AJ2 + AK2) / 450;
        const BI2 = Z2 > 0 ? BH2 / Z2 : 0;
        const BJ2 = Y2 > 0 ? BH2 / Y2 : 0;
        const BK2 = Y2 > 0 ? BI2 / Y2 : 0;
        const BM2 = Z2 > 0 ? BL2 / Z2 : 0;
        const BO2 = Y2 > 0 ? BM2 / Y2 : 0;

        return {
            key,
            Y2,
            X2,
            Z2,
            AA2,
            AJ2,
            AK2,
            AB2,
            AC2,
            AD2,
            AE2,
            AF2,
            AG2,
            AH2,
            AI2,
            AL2,
            AM2,
            AN2,
            AO2,
            AP2,
            AQ2,
            AR2,
            AS2,
            AT2,
            AW2,
            AV2,
            AY2,
            BN2,
            BC2,
            BL2,
            BH2,
            BI2,
            BJ2,
            BK2,
            BM2,
            BO2,
            AU2: 0,
            AX2: 0,
            AZ2: 0,
            BA2: 0,
            BD2: 0,
            BF2: 0,
            BB2: 0,
            BE2: 0,
            BG2: 0
        };
    }

    function applyNormalizationToMetrics(metrics, cache) {
        metrics.AU2 = (cache.maxAT2 > cache.minAT2)
            ? ((metrics.AT2 - cache.minAT2) / (cache.maxAT2 - cache.minAT2)) * 1000
            : 0;
        metrics.AX2 = (cache.maxAW2 > cache.minAW2)
            ? ((metrics.AW2 - cache.minAW2) / (cache.maxAW2 - cache.minAW2)) * 1000
            : 0;
        metrics.BD2 = (cache.maxBC2 > cache.minBC2)
            ? ((metrics.BC2 - cache.minBC2) / (cache.maxBC2 - cache.minBC2)) * 1000
            : 0;
        metrics.AZ2 = (metrics.AU2 + metrics.AX2) / 2;
        metrics.BA2 = (cache.maxAZ2 > cache.minAZ2)
            ? ((metrics.AZ2 - cache.minAZ2) / (cache.maxAZ2 - cache.minAZ2)) * 1000
            : 0;
        metrics.BF2 = (metrics.BA2 + metrics.BD2) / 2;
        const Z2 = metrics.Z2 || 0;
        metrics.AV2 = Z2 > 0 ? metrics.AT2 / Z2 : 0;
        metrics.AY2 = Z2 > 0 ? metrics.AW2 / Z2 : 0;
        metrics.BB2 = Z2 > 0 ? metrics.AZ2 / Z2 : 0;
        metrics.BE2 = Z2 > 0 ? metrics.BC2 / Z2 : 0;
        metrics.BG2 = Z2 > 0 ? metrics.BF2 / Z2 : 0;
    }

    function buildScenarioCache(params) {
        const metricsById = {};
        const allAT2 = [];
        const allAW2 = [];
        const allBC2 = [];

        allAircraftData.forEach(aircraftItem => {
            const metrics = computeMetricsForAircraft(aircraftItem, params);
            metricsById[metrics.key] = metrics;
            if (metrics.AT2 > 0) allAT2.push(metrics.AT2);
            if (metrics.AW2 > 0) allAW2.push(metrics.AW2);
            if (metrics.BC2 > 0) allBC2.push(metrics.BC2);
        });

        const minAT2 = allAT2.length ? Math.min(...allAT2) : 0;
        const maxAT2 = allAT2.length ? Math.max(...allAT2) : 0;
        const minAW2 = allAW2.length ? Math.min(...allAW2) : 0;
        const maxAW2 = allAW2.length ? Math.max(...allAW2) : 0;
        const minBC2 = allBC2.length ? Math.min(...allBC2) : 0;
        const maxBC2 = allBC2.length ? Math.max(...allBC2) : 0;

        let minAZ2 = Infinity;
        let maxAZ2 = -Infinity;

        Object.values(metricsById).forEach(metrics => {
            metrics.AU2 = (maxAT2 > minAT2)
                ? ((metrics.AT2 - minAT2) / (maxAT2 - minAT2)) * 1000
                : 0;
            metrics.AX2 = (maxAW2 > minAW2)
                ? ((metrics.AW2 - minAW2) / (maxAW2 - minAW2)) * 1000
                : 0;
            metrics.BD2 = (maxBC2 > minBC2)
                ? ((metrics.BC2 - minBC2) / (maxBC2 - minBC2)) * 1000
                : 0;
            metrics.AZ2 = (metrics.AU2 + metrics.AX2) / 2;
            if (metrics.AZ2 > 0) {
                if (metrics.AZ2 < minAZ2) minAZ2 = metrics.AZ2;
                if (metrics.AZ2 > maxAZ2) maxAZ2 = metrics.AZ2;
            }
        });

        if (!Number.isFinite(minAZ2)) {
            minAZ2 = 0;
            maxAZ2 = 0;
        }

        Object.values(metricsById).forEach(metrics => {
            metrics.BA2 = (maxAZ2 > minAZ2)
                ? ((metrics.AZ2 - minAZ2) / (maxAZ2 - minAZ2)) * 1000
                : 0;
            metrics.BF2 = (metrics.BA2 + metrics.BD2) / 2;
            const Z2 = metrics.Z2 || 0;
            metrics.AV2 = Z2 > 0 ? metrics.AT2 / Z2 : 0;
            metrics.AY2 = Z2 > 0 ? metrics.AW2 / Z2 : 0;
            metrics.BB2 = Z2 > 0 ? metrics.AZ2 / Z2 : 0;
            metrics.BE2 = Z2 > 0 ? metrics.BC2 / Z2 : 0;
            metrics.BG2 = Z2 > 0 ? metrics.BF2 / Z2 : 0;
        });

        return {
            minAT2,
            maxAT2,
            minAW2,
            maxAW2,
            minBC2,
            maxBC2,
            minAZ2,
            maxAZ2,
            metricsById
        };
    }

    function calculateDynamicMetrics(aircraft, inputs) {
        const scenarioParams = buildScenarioParams(inputs);

        if (!window.dynamicNormalizationCache) {
            window.dynamicNormalizationCache = {};
        }

        if (!window.dynamicNormalizationCache[scenarioParams.cacheKey]) {
            window.dynamicNormalizationCache[scenarioParams.cacheKey] = buildScenarioCache(scenarioParams);
        }

        const cache = window.dynamicNormalizationCache[scenarioParams.cacheKey];
        const key = getAircraftCacheKey(aircraft);
        let metrics = cache.metricsById[key];

        if (!metrics) {
            metrics = computeMetricsForAircraft(aircraft, scenarioParams);
            applyNormalizationToMetrics(metrics, cache);
            cache.metricsById[key] = metrics;
        }

        const columnValues = {
            L: (scenarioParams.L2 || 0) * 100,
            M: scenarioParams.M2 || 0,
            N: scenarioParams.N2 || 0,
            O: scenarioParams.O2 || 0,
            P: scenarioParams.P2 || 0,
            Q: scenarioParams.Q2 || 0,
            R: (scenarioParams.R2 || 0) * 100,
            S: scenarioParams.S2 || 0,
            T: scenarioParams.T2 || 0,
            AB: metrics.AB2 || 0,
            AC: metrics.AC2 || 0,
            AD: metrics.AD2 || 0,
            AE: metrics.AE2 || 0,
            AF: metrics.AF2 || 0,
            AG: metrics.AG2 || 0,
            AH: metrics.AH2 || 0,
            AI: metrics.AI2 || 0,
            AJ: metrics.AJ2 || 0,
            AK: metrics.AK2 || 0,
            AL: metrics.AL2 || 0,
            AM: metrics.AM2 || 0,
            AN: metrics.AN2 || 0,
            AO: metrics.AO2 || 0,
            AP: metrics.AP2 || 0,
            AQ: metrics.AQ2 || 0,
            AR: metrics.AR2 || 0,
            AS: metrics.AS2 || 0,
            AT: metrics.AT2 || 0,
            AU: metrics.AU2 || 0,
            AV: metrics.AV2 || 0,
            AW: metrics.AW2 || 0,
            AX: metrics.AX2 || 0,
            AY: metrics.AY2 || 0,
            AZ: metrics.AZ2 || 0,
            BA: metrics.BA2 || 0,
            BB: metrics.BB2 || 0,
            BC: metrics.BC2 || 0,
            BD: metrics.BD2 || 0,
            BE: metrics.BE2 || 0,
            BF: metrics.BF2 || 0,
            BG: metrics.BG2 || 0,
            BH: metrics.BH2 || 0,
            BI: metrics.BI2 || 0,
            BJ: metrics.BJ2 || 0,
            BK: metrics.BK2 || 0,
            BL: metrics.BL2 || 0,
            BM: metrics.BM2 || 0,
            BN: metrics.BN2 || 0,
            BO: metrics.BO2 || 0
        };

        return {
            averageTripTime: roundTo(metrics.AC2),
            totalTripTime: roundTo(metrics.AD2),
            annualBudget: Math.round(metrics.AN2),
            adjustedAnnualBudget: Math.round(metrics.AN2),
            multiYearTotalCost: Math.round(metrics.AO2),
            mytcWithSale: Math.round(metrics.AP2),
            costToCharter: Math.round(metrics.AQ2),
            bestSpeedDollar: roundTo(metrics.AT2),
            bestRangeDollar: roundTo(metrics.AW2),
            bestPerformanceDollar: roundTo(metrics.AZ2),
            bestEfficiencyDollar: roundTo(metrics.BC2),
            bestAllAroundDollar: roundTo(metrics.BF2),
            totalHourlyCost: roundTo(metrics.BH2),
            hourlyVariableCost: roundTo(metrics.BL2),
            columnValues
        };
    }

    // NOTE: Total Fixed Cost (AJ) and Total Variable Cost (AK) have no formulas in the equations CSV
    // These are static values from the aircraft data CSV and should not be recalculated
    // Sort aircraft based on selected criteria
    function sortAircraft(sortBy) {
        console.log(` Sorting aircraft by: ${sortBy}`);

        if (!sortBy || sortBy === '') return;

        // Debug: Log the first few aircraft before sorting
        console.log(' Before sorting - first 3 aircraft:');
        filteredAircraftData.slice(0, 3).forEach((aircraft, index) => {
            console.log(`  ${index + 1}. ${aircraft.aircraft_name || aircraft.name} - Price: ${aircraft.price}, Range: ${aircraft.range}`);
        });

        filteredAircraftData.sort((a, b) => {
            let aValue, bValue;

            switch (sortBy) {
                case 'best_speed_dollar':
                    // Sort by percentage score (higher percentage = better)
                    const aSpeedMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bSpeedMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = getPerformancePercentage(aSpeedMetrics.bestSpeedDollar, 'speed', filteredAircraftData);
                    bValue = getPerformancePercentage(bSpeedMetrics.bestSpeedDollar, 'speed', filteredAircraftData);
                    console.log(` Speed/$ - ${a.aircraft_name}: ${aValue.toFixed(1)}% (raw: ${aSpeedMetrics.bestSpeedDollar}) vs ${b.aircraft_name}: ${bValue.toFixed(1)}% (raw: ${bSpeedMetrics.bestSpeedDollar})`);
                    return bValue - aValue; // Higher percentage first

                case 'best_range_dollar':
                    // Sort by percentage score (higher percentage = better)
                    const aRangeMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bRangeMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = getPerformancePercentage(aRangeMetrics.bestRangeDollar, 'range', filteredAircraftData);
                    bValue = getPerformancePercentage(bRangeMetrics.bestRangeDollar, 'range', filteredAircraftData);
                    return bValue - aValue; // Higher percentage first

                case 'best_performance_dollar':
                    // Sort by percentage score (higher percentage = better)
                    const aPerfMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bPerfMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = getPerformancePercentage(aPerfMetrics.bestPerformanceDollar, 'performance', filteredAircraftData);
                    bValue = getPerformancePercentage(bPerfMetrics.bestPerformanceDollar, 'performance', filteredAircraftData);
                    return bValue - aValue; // Higher percentage first

                case 'best_efficiency_dollar':
                    // Sort by percentage score (higher percentage = better)
                    const aEffMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bEffMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = getPerformancePercentage(aEffMetrics.bestEfficiencyDollar, 'efficiency', filteredAircraftData);
                    bValue = getPerformancePercentage(bEffMetrics.bestEfficiencyDollar, 'efficiency', filteredAircraftData);
                    return bValue - aValue; // Higher percentage first

                case 'best_all_around_dollar':
                    // Sort by percentage score (higher percentage = better)
                    const aAllMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bAllMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = getPerformancePercentage(aAllMetrics.bestAllAroundDollar, 'allAround', filteredAircraftData);
                    bValue = getPerformancePercentage(bAllMetrics.bestAllAroundDollar, 'allAround', filteredAircraftData);
                    return bValue - aValue; // Higher percentage first

                case 'price_low':
                    aValue = a.price || 0;
                    bValue = b.price || 0;
                    return aValue - bValue; // Lower price first

                case 'price_high':
                    aValue = a.price || 0;
                    bValue = b.price || 0;
                    return bValue - aValue; // Higher price first

                case 'range':
                    aValue = a.range || 0;
                    bValue = b.range || 0;
                    return bValue - aValue;

                case 'speed':
                    aValue = a.speed || 0;
                    bValue = b.speed || 0;
                    return bValue - aValue;

                case 'passengers':
                    aValue = a.passengers || 0;
                    bValue = b.passengers || 0;
                    return bValue - aValue;

                case 'year_new':
                    aValue = a.year || 0;
                    bValue = b.year || 0;
                    return bValue - aValue; // Newer year first

                case 'year_old':
                    aValue = a.year || 0;
                    bValue = b.year || 0;
                    return aValue - bValue; // Older year first

                case 'hourly_cost_low':
                    aValue = a.total_hourly_cost || 0;
                    bValue = b.total_hourly_cost || 0;
                    return aValue - bValue; // Lower cost first

                case 'hourly_cost_high':
                    aValue = a.total_hourly_cost || 0;
                    bValue = b.total_hourly_cost || 0;
                    return bValue - aValue; // Higher cost first

                case 'runway_length':
                    aValue = a.runway_length || 0;
                    bValue = b.runway_length || 0;
                    return aValue - bValue; // Shorter runway first

                case 'altitude':
                    aValue = a.max_altitude || 0;
                    bValue = b.max_altitude || 0;
                    return bValue - aValue; // Higher altitude first

                // Financial metrics - calculate dynamically
                case 'annual_budget':
                    const aAnnualMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bAnnualMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = aAnnualMetrics.annualBudget || 0;
                    bValue = bAnnualMetrics.annualBudget || 0;
                    console.log(` Annual Budget - ${a.aircraft_name}: $${aValue.toLocaleString()} vs ${b.aircraft_name}: $${bValue.toLocaleString()}`);
                    return aValue - bValue; // Lower budget first (more affordable)

                case 'multi_year_total_cost':
                    const aMultiYearMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bMultiYearMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = aMultiYearMetrics.multiYearTotalCost || 0;
                    bValue = bMultiYearMetrics.multiYearTotalCost || 0;
                    return aValue - bValue; // Lower cost first (more affordable)

                case 'cost_to_charter':
                    const aCharterMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bCharterMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = aCharterMetrics.costToCharter || 0;
                    bValue = bCharterMetrics.costToCharter || 0;
                    return aValue - bValue; // Lower cost first (more affordable)

                case 'total_hourly_cost':
                    aValue = a.total_hourly_cost || 0;
                    bValue = b.total_hourly_cost || 0;
                    return aValue - bValue; // Lower cost first (more affordable)

                // Trip time metrics - calculate dynamically
                case 'average_trip_time':
                    const aTripMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bTripMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = aTripMetrics.averageTripTime || 0;
                    bValue = bTripMetrics.averageTripTime || 0;
                    return aValue - bValue; // Shorter trip time first (faster)

                case 'total_trip_time':
                    const aTotalTripMetrics = calculateDynamicMetrics(a, getUserInputs());
                    const bTotalTripMetrics = calculateDynamicMetrics(b, getUserInputs());
                    aValue = aTotalTripMetrics.totalTripTime || 0;
                    bValue = bTotalTripMetrics.totalTripTime || 0;
                    return aValue - bValue; // Less total time first (more efficient)

                // Physical specifications
                case 'cabin_volume':
                    aValue = a.cabin_volume || 0;
                    bValue = b.cabin_volume || 0;
                    return bValue - aValue; // Larger cabin first

                case 'baggage_volume':
                    aValue = a.baggage_volume || 0;
                    bValue = b.baggage_volume || 0;
                    return bValue - aValue; // More baggage space first

                case 'aircraft_length':
                    aValue = a.aircraft_length || 0;
                    bValue = b.aircraft_length || 0;
                    return bValue - aValue; // Longer aircraft first

                case 'wingspan':
                    aValue = a.wingspan || 0;
                    bValue = b.wingspan || 0;
                    return bValue - aValue; // Larger wingspan first

                case 'aircraft_height':
                    aValue = a.aircraft_height || 0;
                    bValue = b.aircraft_height || 0;
                    return bValue - aValue; // Taller aircraft first

                // Manufacturer/Type sorting
                case 'manufacturer':
                    aValue = a.manufacturer || '';
                    bValue = b.manufacturer || '';
                    return aValue.localeCompare(bValue); // Alphabetical

                case 'aircraft_name':
                case 'name':
                    aValue = a.aircraft_name || a.name || '';
                    bValue = b.aircraft_name || b.name || '';
                    return aValue.localeCompare(bValue); // Alphabetical

                default:
                    return 0;
            }
        });

        // Debug: Log the first few aircraft after sorting
        console.log(' After sorting - first 3 aircraft:');
        filteredAircraftData.slice(0, 3).forEach((aircraft, index) => {
            console.log(`  ${index + 1}. ${aircraft.aircraft_name || aircraft.name} - Price: ${aircraft.price}, Range: ${aircraft.range}`);
        });

        // Reset to page 1 and update display
        currentPage = 1;
        updatePagination();
        updateAircraftDisplay();

        console.log(` Aircraft sorted by ${sortBy}`);
    }

    // Set up real-time event listeners
    function setupRealTimeFiltering() {
        console.log(' Setting up real-time event listeners...');

        // Add event listeners to all filter inputs
        const filterInputs = [
            'range-input', 'passengers', 'budget', 'lowest-year',
            'advanced_min_speed', 'advanced_min_altitude',
            'advanced_max_runway', 'advanced_min_cabin_volume',
            'advanced_max_annual_cost', 'advanced_max_hourly_cost',
            'advanced_fuel_price', 'advanced_ownership_years'
        ];

        filterInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', debounce(applyRealTimeFiltering, 300));
                input.addEventListener('change', applyRealTimeFiltering);
                console.log(` Added listener to ${inputId}`);
            } else {
                console.warn(` Input not found: ${inputId}`);
            }
        });

        // Add event listener for sort select
        const sortSelect = document.getElementById('sortSelect');
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                sortAircraft(e.target.value);
            });
            console.log(' Added sort listener');
        }

        // Add event listeners for user input controls
        const userInputControls = [
            'range-input', 'passengers', 'budget', 'lowest-year',
            'avg-trip-length', 'number-of-trips', 'yearsOfOwnership', 'speed',
            'lowestYear', 'highestYear', 'minCrewRequired', 'maxOperatingAltitude',
            'balancedFieldLength', 'aircraftHeight', 'wingspan', 'aircraftLength',
            'jetAPrice', 'avgasPrice', 'depreciationRate', 'costToCharter',
            'pistonPilotPay', 'turbopropPilotPay', 'businessJetPilotPay',
            'plannedPax', 'passengerPay', 'charterRatePercentage', 'averageCharterTripLength',
            'manufacturer', 'type', 'multiEngine'
        ];

        userInputControls.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', debounce(() => {
                    updateUserInputs();
                    recalculateAll();
                }, 500));
                console.log(` Added user input listener to ${inputId}`);
            }
        });
    }

    // Update user inputs from form controls
    function updateUserInputs() {
        const getValue = (id) => {
            const element = document.getElementById(id);
            const value = element?.value?.trim();
            return value && value !== '' ? parseFloat(value) : null;
        };

        // Get values from unified input section
        userInputs.rangeRequirement = getValue('range-input');
        userInputs.passengers = getValue('passengers');
        userInputs.budget = getValue('budget');
        userInputs.lowestAcceptableYear = getValue('lowest-year');
        userInputs.averageTripLength = getValue('avg-trip-length');
        userInputs.numberOfTrips = getValue('number-of-trips');
        userInputs.yearsOfOwnership = getValue('yearsOfOwnership');
        userInputs.speed = getValue('speed');
        userInputs.lowestYear = getValue('lowestYear');
        userInputs.highestYear = getValue('highestYear');
        userInputs.minCrewRequired = getValue('minCrewRequired');
        userInputs.maxOperatingAltitude = getValue('maxOperatingAltitude');
        userInputs.balancedFieldLength = getValue('balancedFieldLength');
        userInputs.aircraftHeight = getValue('aircraftHeight');
        userInputs.wingspan = getValue('wingspan');
        userInputs.aircraftLength = getValue('aircraftLength');
        userInputs.jetAPrice = getValue('jetAPrice');
        userInputs.avgasPrice = getValue('avgasPrice');
        userInputs.depreciationRate = getValue('depreciationRate');
        userInputs.costToCharter = getValue('costToCharter');
        userInputs.pistonPilotPay = getValue('pistonPilotPay');
        userInputs.turbopropPilotPay = getValue('turbopropPilotPay');
        userInputs.businessJetPilotPay = getValue('businessJetPilotPay');
        userInputs.plannedPax = getValue('plannedPax');
        userInputs.passengerPay = getValue('passengerPay');
        userInputs.charterRatePercentage = getValue('charterRatePercentage');
        userInputs.averageCharterTripLength = getValue('averageCharterTripLength');

        // Get dropdown values
        const manufacturerElement = document.getElementById('manufacturer');
        userInputs.manufacturer = manufacturerElement?.value || null;

        const typeElement = document.getElementById('type');
        userInputs.type = typeElement?.value || null;

        const multiEngineElement = document.getElementById('multiEngine');
        userInputs.multiEngine = multiEngineElement?.value || null;

        console.log(' User inputs updated:', userInputs);
    }

    // Auto-calculate range requirement, average trip length, and number of trips from route planning
    function autoCalculateRouteMetrics() {
        // Check if trip planning data is available
        if (window.tripPlanningData && window.tripPlanningData.routes) {
            const routes = window.tripPlanningData.routes;

            if (routes.length > 0) {
                // Calculate range requirement (longest route)
                const maxDistance = Math.max(...routes.map(route => route.distance || 0));
                if (maxDistance > 0) {
                    const rangeInput = document.getElementById('range-input');
                    if (rangeInput && !rangeInput.value) {
                        rangeInput.value = Math.ceil(maxDistance * 1.1); // Add 10% buffer
                        console.log(` Auto-calculated range requirement: ${rangeInput.value} NM`);
                    }
                }

                // Calculate average trip length (weighted by frequency)
                let totalDistance = 0;
                let totalTrips = 0;
                routes.forEach(route => {
                    const frequency = route.frequency || 1;
                    totalDistance += (route.distance || 0) * frequency;
                    totalTrips += frequency;
                });

                if (totalTrips > 0) {
                    const avgDistance = Math.round(totalDistance / totalTrips);
                    const avgTripInput = document.getElementById('avg-trip-length');
                    if (avgTripInput && !avgTripInput.value) {
                        avgTripInput.value = avgDistance;
                        console.log(` Auto-calculated average trip length: ${avgDistance} NM`);
                    }

                    // Set number of trips per year
                    const tripsInput = document.getElementById('number-of-trips');
                    if (tripsInput && !tripsInput.value) {
                        tripsInput.value = totalTrips;
                        console.log(` Auto-calculated number of trips: ${totalTrips} per year`);
                    }
                }
            }
        }

        // Update user inputs after auto-calculation
        updateUserInputs();
    }

    // Reset to default values from User Inputs CSV
    function resetToDefaults() {
        // Reset to User Inputs CSV default values
        const setValueIfExists = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.value = value;
        };

        setValueIfExists('lowest-year', '1995');
        setValueIfExists('avg-trip-length', '500');
        setValueIfExists('number-of-trips', '104');
        setValueIfExists('yearsOfOwnership', '5');
        setValueIfExists('jetAPrice', '6.50');
        setValueIfExists('avgasPrice', '4.00');
        setValueIfExists('depreciationRate', '4.00');
        setValueIfExists('costToCharter', '200');
        setValueIfExists('pistonPilotPay', '65000');
        setValueIfExists('turbopropPilotPay', '82700');
        setValueIfExists('businessJetPilotPay', '130000');
        setValueIfExists('plannedPax', '0');
        setValueIfExists('passengerPay', '0.00');
        setValueIfExists('charterRatePercentage', '50');
        setValueIfExists('averageCharterTripLength', '0');

        updateUserInputs();
        recalculateAll();
    }

    // Recalculate all aircraft with new inputs using Excel equations
    function recalculateAll() {
        updateUserInputs();

        // CRITICAL: Clear the dynamic normalization cache when inputs change
        window.dynamicNormalizationCache = {};
        console.log(' Cleared dynamic normalization cache');

        // Check if user has changed any inputs
        const hasChangedInputs = Object.values(userInputs).some(value => value !== null);

        if (hasChangedInputs) {
            console.log(' User changed inputs - recalculating all aircraft with Excel equations');
            // Recalculate dynamic metrics for all aircraft using Excel equations
            allAircraftData.forEach(aircraft => {
                const dynamicMetrics = calculateDynamicMetrics(aircraft, userInputs);

                // Update aircraft object with calculated values
                aircraft.average_trip_time = dynamicMetrics.averageTripTime;
                aircraft.total_trip_time = dynamicMetrics.totalTripTime;
                aircraft.annual_budget = dynamicMetrics.annualBudget;
                aircraft.adjusted_annual_budget = dynamicMetrics.adjustedAnnualBudget;
                aircraft.multi_year_total_cost = dynamicMetrics.multiYearTotalCost;
                aircraft.mytc_with_aircraft_sale = dynamicMetrics.mytcWithSale;
                aircraft.cost_to_charter = dynamicMetrics.costToCharter;
                aircraft.best_speed_dollar = dynamicMetrics.bestSpeedDollar;
                aircraft.best_range_dollar = dynamicMetrics.bestRangeDollar;
                aircraft.best_performance_dollar = dynamicMetrics.bestPerformanceDollar;
                aircraft.best_efficiency_dollar = dynamicMetrics.bestEfficiencyDollar;
                aircraft.best_all_around_dollar = dynamicMetrics.bestAllAroundDollar;
                aircraft.total_hourly_cost = dynamicMetrics.totalHourlyCost;
            });
            console.log(' Recalculated all aircraft with user-specific Excel equations');
        } else {
            console.log(' Using CSV values (no user inputs changed)');
        }

        updateAircraftDisplay();
    }

    // Debounce function to limit function calls
    function debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', async function () {
        console.log(' DOM loaded - initializing real-time filtering...');

        // Load all aircraft data from server first
        const loadedAll = await loadAllAircraftData();

        // If that fails, fall back to any statically rendered cards (if present)
        if (!loadedAll) {
            console.log(' Falling back to current page aircraft data...');
            loadCurrentPageAircraft();
        }

        setupRealTimeFiltering();

        // Auto-calculate route metrics from trip planning
        autoCalculateRouteMetrics();

        // Initialize user inputs (but don't recalculate - use CSV values by default)
        updateUserInputs();

        populateCostMetricSelectors();
        attachCostMetricSelectorListeners();
        ensureCostMetricDefaults();
        syncCostMetricSelectors();

        const clearCompareButton = document.getElementById('clearCompareBtn');
        if (clearCompareButton) {
            clearCompareButton.addEventListener('click', clearCompareSelections);
        }

        // Initialize pagination
        updatePagination();
        updateAircraftDisplay();

        updateCompareUI();

        console.log(' REAL-TIME FILTERING AND PAGINATION INITIALIZED');
    });

</script>

{% endblock %}