{% extends "base.html" %}

{% block title %}Aircraft Data Analysis{% endblock %}

{% block additional_css %}
<style>
    .input-group-dynamic {
        margin-bottom: 1rem;
    }

    .input-card {
        transition: all 0.3s ease;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .input-card:hover {
        border-color: #F05545;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
    }

    .input-card.updated {
        border-color: #28a745;
        animation: pulse-green 1s;
    }

    @keyframes pulse-green {
        0% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7);
        }

        70% {
            box-shadow: 0 0 0 10px rgba(40, 167, 69, 0);
        }

        100% {
            box-shadow: 0 0 0 0 rgba(40, 167, 69, 0);
        }
    }

    .results-card {
        border: 1px solid rgba(240, 85, 69, 0.3);
        background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(26, 32, 44, 0.8));
    }

    .aircraft-match-card {
        transition: all 0.3s ease;
        cursor: pointer;
    }

    .aircraft-match-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        border-color: #F05545 !important;
    }

    .match-score {
        position: absolute;
        top: 10px;
        right: 10px;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
    }

    .score-excellent {
        background-color: #28a745;
    }

    .score-good {
        background-color: #ffc107;
        color: #000;
    }

    .score-fair {
        background-color: #fd7e14;
    }

    .score-poor {
        background-color: #dc3545;
    }

    .statistics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .stat-card {
        background: rgba(0, 0, 0, 0.5);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        padding: 1.5rem;
        text-align: center;
        transition: all 0.3s ease;
    }

    .stat-card:hover {
        border-color: #F05545;
        transform: scale(1.05);
    }

    .loading-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
        border-radius: 8px;
    }

    .chart-container {
        height: 400px;
        background: rgba(0, 0, 0, 0.3);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Input Controls Panel -->
        <div class="col-lg-4">
            <div class="card bg-black border border-secondary h-100">
                <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Aircraft Analysis Inputs</h4>
                    <div>
                        <button class="btn btn-sm btn-outline-secondary me-2" id="load-defaults-btn">
                            <i class="fas fa-undo me-1"></i>Load Defaults
                        </button>
                        <button class="btn btn-sm btn-outline-danger" id="update-analysis-btn">
                            <i class="fas fa-sync me-1"></i>Update Analysis
                        </button>
                    </div>
                </div>
                <div class="card-body" style="max-height: 80vh; overflow-y: auto;">
                    <div id="inputs-container">
                        <div class="text-center text-secondary py-4">
                            <div class="spinner-border text-danger" role="status"></div>
                            <p class="mt-2">Loading input fields...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Analysis Results Panel -->
        <div class="col-lg-8">
            <div class="row h-100">
                <!-- Statistics Cards -->
                <div class="col-12 mb-4">
                    <div class="card bg-black border border-secondary">
                        <div class="card-header bg-dark">
                            <h5 class="mb-0">Analysis Summary</h5>
                        </div>
                        <div class="card-body">
                            <div class="statistics-grid" id="statistics-container">
                                <div class="stat-card">
                                    <h6 class="text-secondary">Total Aircraft</h6>
                                    <h3 class="text-white mb-0" id="total-aircraft">-</h3>
                                </div>
                                <div class="stat-card">
                                    <h6 class="text-secondary">Matching Criteria</h6>
                                    <h3 class="text-danger mb-0" id="matching-aircraft">-</h3>
                                </div>
                                <div class="stat-card">
                                    <h6 class="text-secondary">Match Percentage</h6>
                                    <h3 class="text-warning mb-0" id="match-percentage">-</h3>
                                </div>
                                <div class="stat-card">
                                    <h6 class="text-secondary">Avg Price (Matching)</h6>
                                    <h3 class="text-success mb-0" id="avg-price">-</h3>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="col-md-6 mb-4">
                    <div class="card bg-black border border-secondary h-100">
                        <div class="card-header bg-dark">
                            <h5 class="mb-0">Price vs Range Analysis</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="price-range-chart">
                                <div class="text-center text-secondary">
                                    <i class="fas fa-chart-scatter fa-3x mb-2"></i>
                                    <p>Chart will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6 mb-4">
                    <div class="card bg-black border border-secondary h-100">
                        <div class="card-header bg-dark">
                            <h5 class="mb-0">Match Score Distribution</h5>
                        </div>
                        <div class="card-body">
                            <div class="chart-container" id="match-distribution-chart">
                                <div class="text-center text-secondary">
                                    <i class="fas fa-chart-bar fa-3x mb-2"></i>
                                    <p>Chart will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Top Matching Aircraft -->
                <div class="col-12">
                    <div class="card bg-black border border-secondary">
                        <div class="card-header bg-dark d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Top Matching Aircraft</h5>
                            <span class="badge bg-danger" id="results-count">0 Results</span>
                        </div>
                        <div class="card-body" style="max-height: 60vh; overflow-y: auto;">
                            <div id="aircraft-results-container">
                                <div class="text-center text-secondary py-4">
                                    <i class="fas fa-plane fa-3x mb-2"></i>
                                    <p>Update analysis to see matching aircraft</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Chart.js for visualizations -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        let userInputs = {};
        let currentAnalysis = {};
        let priceRangeChart = null;
        let matchDistributionChart = null;

        // Load user inputs from CSV
        loadUserInputs();

        // Event listeners
        document.getElementById('load-defaults-btn').addEventListener('click', loadUserInputs);
        document.getElementById('update-analysis-btn').addEventListener('click', updateAnalysis);

        function loadUserInputs() {
            fetch('/api/load-user-inputs')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        userInputs = data.inputs;
                        renderInputFields(data.inputs, data.columns);
                    } else {
                        showError('Failed to load user inputs: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Error loading inputs: ' + error.message);
                });
        }

        function renderInputFields(inputs, columns) {
            const container = document.getElementById('inputs-container');
            container.innerHTML = '';

            // Group inputs by category
            const categories = {
                'Basic Parameters': ['Aircraft Count', 'Lowest Acceptable Year', 'Range(NM)', 'Passengers', 'Average Price'],
                'Trip Planning': ['Average Trip Length', '# of Trips', 'Years of Ownership'],
                'Fuel & Operating': ['JET A Price', 'AVGAS Price', 'Depreciation Rate', 'Cost to Charter'],
                'Crew Costs': ['Piston Pilot Pay Subtraction', 'Turboprop Pilot Pay Subtration', 'Business Jet Pilot Pay Subtraction'],
                'Passenger & Charter': ['Planned Pax.', 'Passenger Pay', 'Charter Rate Percentage', 'Average Charter Trip Length', '# of Charter Trips'],
                'Aircraft Specifications': ['Speed(KTS)', 'Manufacturer', 'Type', 'Multi Engine'],
                'Physical Dimensions': ['Lowest Year', 'Highest Year', 'Min Crew Required', 'Max Operating Altitude (ft)', 'Balanced Field Length (ft)'],
                'Aircraft Dimensions': ['Aircraft Height (ft)', 'Wingspan (ft)', 'Aircraft Length (ft)', 'Aircraft Volume (cubic ft)'],
                'Cabin Specifications': ['Cabin Height (ft)', 'Cabin Width (ft)', 'Cabin Length (ft)', 'Cabin Volume (cubic ft)', 'Baggage Volume (cubic ft)']
            };

            Object.entries(categories).forEach(([category, fields]) => {
                // Create category header
                const categoryDiv = document.createElement('div');
                categoryDiv.className = 'mb-4';

                const categoryHeader = document.createElement('h6');
                categoryHeader.className = 'text-danger border-bottom pb-2 mb-3';
                categoryHeader.innerHTML = `<i class="fas fa-cog me-2"></i>${category}`;
                categoryDiv.appendChild(categoryHeader);

                // Add fields in this category
                fields.forEach(field => {
                    if (inputs[field]) {
                        const inputData = inputs[field];
                        const inputDiv = createInputField(field, inputData);
                        categoryDiv.appendChild(inputDiv);
                    }
                });

                container.appendChild(categoryDiv);
            });
        }

        function createInputField(fieldName, inputData) {
            const div = document.createElement('div');
            div.className = 'input-card p-3 mb-3 rounded';

            const label = document.createElement('label');
            label.className = 'form-label text-white small';
            label.textContent = inputData.display_name;

            let input;

            switch (inputData.type) {
                case 'currency':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.01';
                    input.className = 'form-control form-control-sm bg-dark text-white border-secondary';
                    input.value = inputData.value;

                    const currencyGroup = document.createElement('div');
                    currencyGroup.className = 'input-group input-group-sm';
                    const currencySpan = document.createElement('span');
                    currencySpan.className = 'input-group-text bg-dark text-white border-secondary';
                    currencySpan.textContent = '$';
                    currencyGroup.appendChild(currencySpan);
                    currencyGroup.appendChild(input);
                    div.appendChild(label);
                    div.appendChild(currencyGroup);
                    break;

                case 'percentage':
                    input = document.createElement('input');
                    input.type = 'number';
                    input.step = '0.1';
                    input.className = 'form-control form-control-sm bg-dark text-white border-secondary';
                    input.value = inputData.value;

                    const percentGroup = document.createElement('div');
                    percentGroup.className = 'input-group input-group-sm';
                    percentGroup.appendChild(input);
                    const percentSpan = document.createElement('span');
                    percentSpan.className = 'input-group-text bg-dark text-white border-secondary';
                    percentSpan.textContent = '%';
                    percentGroup.appendChild(percentSpan);
                    div.appendChild(label);
                    div.appendChild(percentGroup);
                    break;

                case 'boolean':
                    input = document.createElement('select');
                    input.className = 'form-select form-select-sm bg-dark text-white border-secondary';
                    input.innerHTML = `
                    <option value="true" ${inputData.value ? 'selected' : ''}>Yes</option>
                    <option value="false" ${!inputData.value ? 'selected' : ''}>No</option>
                `;
                    div.appendChild(label);
                    div.appendChild(input);
                    break;

                default:
                    input = document.createElement('input');
                    input.type = inputData.type === 'text' ? 'text' : 'number';
                    input.className = 'form-control form-control-sm bg-dark text-white border-secondary';
                    input.value = inputData.value;
                    if (inputData.type === 'number') {
                        input.step = '0.01';
                    }
                    div.appendChild(label);
                    div.appendChild(input);
            }

            input.dataset.field = fieldName;
            input.addEventListener('change', function () {
                userInputs[fieldName].value = this.value;
                div.classList.add('updated');
                setTimeout(() => div.classList.remove('updated'), 1000);
            });

            return div;
        }

        function updateAnalysis() {
            const button = document.getElementById('update-analysis-btn');
            const originalHTML = button.innerHTML;
            button.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Updating...';
            button.disabled = true;

            // Prepare data for analysis
            const analysisData = {};
            Object.entries(userInputs).forEach(([key, data]) => {
                analysisData[key] = data.value;
            });

            fetch('/api/update-aircraft-analysis', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(analysisData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        currentAnalysis = data.results;
                        updateStatistics(data.results.statistics);
                        updateAircraftResults(data.results.top_matches);
                        updateCharts(data.results);
                    } else {
                        showError('Analysis failed: ' + data.error);
                    }
                })
                .catch(error => {
                    showError('Error updating analysis: ' + error.message);
                })
                .finally(() => {
                    button.innerHTML = originalHTML;
                    button.disabled = false;
                });
        }

        function updateStatistics(stats) {
            document.getElementById('total-aircraft').textContent = stats.total_aircraft || '-';
            document.getElementById('matching-aircraft').textContent = currentAnalysis.matching_aircraft || '-';
            document.getElementById('match-percentage').textContent = (stats.match_percentage || 0).toFixed(1) + '%';
            document.getElementById('avg-price').textContent = stats.average_price ? '$' + formatNumber(stats.average_price) : '-';
        }

        function updateAircraftResults(aircraft) {
            const container = document.getElementById('aircraft-results-container');
            const resultsCount = document.getElementById('results-count');

            resultsCount.textContent = aircraft.length + ' Results';

            if (aircraft.length === 0) {
                container.innerHTML = `
                <div class="text-center text-secondary py-4">
                    <i class="fas fa-search fa-3x mb-2"></i>
                    <p>No aircraft match your current criteria</p>
                </div>
            `;
                return;
            }

            container.innerHTML = '';

            aircraft.forEach((aircraft, index) => {
                const score = aircraft.match_score || 0;
                const scoreClass = score >= 80 ? 'score-excellent' :
                    score >= 60 ? 'score-good' :
                        score >= 40 ? 'score-fair' : 'score-poor';

                const card = document.createElement('div');
                card.className = 'aircraft-match-card card bg-dark border-secondary mb-3 position-relative';
                card.innerHTML = `
                <div class="match-score ${scoreClass}">
                    ${Math.round(score)}%
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-8">
                            <h5 class="card-title text-white">
                                ${aircraft.year || ''} ${aircraft.manufacturer || ''} ${aircraft.model || ''}
                            </h5>
                            <div class="row g-2 text-secondary small">
                                <div class="col-6">
                                    <i class="fas fa-ruler-horizontal me-1"></i>
                                    Range: ${formatNumber(aircraft.range || 0)} nm
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-users me-1"></i>
                                    Seats: ${aircraft.seats || 'N/A'}
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-tachometer-alt me-1"></i>
                                    Speed: ${formatNumber(aircraft.max_speed || 0)} kts
                                </div>
                                <div class="col-6">
                                    <i class="fas fa-plane me-1"></i>
                                    Type: ${aircraft.category || 'N/A'}
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <h4 class="text-success mb-2">$${formatNumber(aircraft.price || 0)}</h4>
                            <button class="btn btn-sm btn-outline-danger view-details-btn" data-id="${aircraft.id}">
                                <i class="fas fa-eye me-1"></i>View Details
                            </button>
                        </div>
                    </div>
                </div>
            `;

                container.appendChild(card);
            });

            // Add event listeners for view details buttons
            document.querySelectorAll('.view-details-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const aircraftId = this.dataset.id;
                    // Navigate to aircraft details or open modal
                    window.open(`/marketplace/listing/${aircraftId}`, '_blank');
                });
            });
        }

        function updateCharts(results) {
            // Update Price vs Range chart
            updatePriceRangeChart(results.top_matches);

            // Update Match Score distribution
            updateMatchDistributionChart(results.top_matches);
        }

        function updatePriceRangeChart(aircraft) {
            const ctx = document.getElementById('price-range-chart');

            if (priceRangeChart) {
                priceRangeChart.destroy();
            }

            // Clear the placeholder content
            ctx.innerHTML = '';

            // Create canvas
            const canvas = document.createElement('canvas');
            ctx.appendChild(canvas);

            const chartCtx = canvas.getContext('2d');

            priceRangeChart = new Chart(chartCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Aircraft',
                        data: aircraft.map(a => ({
                            x: a.range || 0,
                            y: a.price || 0
                        })),
                        backgroundColor: 'rgba(240, 85, 69, 0.6)',
                        borderColor: '#F05545',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Range (nm)',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Price ($)',
                                color: 'white'
                            },
                            ticks: {
                                color: 'white',
                                callback: function (value) {
                                    return '$' + formatNumber(value);
                                }
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function updateMatchDistributionChart(aircraft) {
            const ctx = document.getElementById('match-distribution-chart');

            if (matchDistributionChart) {
                matchDistributionChart.destroy();
            }

            // Clear the placeholder content
            ctx.innerHTML = '';

            // Create canvas
            const canvas = document.createElement('canvas');
            ctx.appendChild(canvas);

            const chartCtx = canvas.getContext('2d');

            // Group scores into ranges
            const scoreRanges = {
                '90-100%': 0,
                '80-89%': 0,
                '70-79%': 0,
                '60-69%': 0,
                '50-59%': 0,
                'Below 50%': 0
            };

            aircraft.forEach(a => {
                const score = a.match_score || 0;
                if (score >= 90) scoreRanges['90-100%']++;
                else if (score >= 80) scoreRanges['80-89%']++;
                else if (score >= 70) scoreRanges['70-79%']++;
                else if (score >= 60) scoreRanges['60-69%']++;
                else if (score >= 50) scoreRanges['50-59%']++;
                else scoreRanges['Below 50%']++;
            });

            matchDistributionChart = new Chart(chartCtx, {
                type: 'bar',
                data: {
                    labels: Object.keys(scoreRanges),
                    datasets: [{
                        label: 'Number of Aircraft',
                        data: Object.values(scoreRanges),
                        backgroundColor: [
                            '#28a745',
                            '#20c997',
                            '#ffc107',
                            '#fd7e14',
                            '#e83e8c',
                            '#dc3545'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: 'white'
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        },
                        y: {
                            ticks: {
                                color: 'white'
                            },
                            grid: {
                                color: 'rgba(255, 255, 255, 0.1)'
                            }
                        }
                    }
                }
            });
        }

        function formatNumber(num) {
            if (!num) return '0';
            return new Intl.NumberFormat('en-US').format(Math.round(num));
        }

        function showError(message) {
            console.error(message);
            // You could add a toast notification here
        }
    });
</script>
{% endblock %}