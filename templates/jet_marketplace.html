{% extends "base.html" %}

{% block title %}Jet Finder Marketplace{% endblock %}

{% block additional_css %}
<link rel="stylesheet" href="{{ url_for('static', filename='css/marketplace/listings.css') }}">
<style>
    /* Map container styling */
    #map {
        height: 500px;
        width: 100%;
        border-radius: 0.25rem;
        z-index: 1;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: border-color 0.3s;
    }

    #map:hover {
        border-color: rgba(255, 255, 255, 0.2);
    }

    /* Custom styles for route planning */
    .distance-label {
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: bold;
        border: 1px solid #F05545;
        white-space: nowrap;
    }

    /* Styling for range ring tooltips */
    .range-tooltip {
        background-color: rgba(0, 0, 0, 0.8) !important;
        color: white !important;
        border: 1px solid #F05545 !important;
        border-radius: 4px !important;
        padding: 5px 10px !important;
        font-family: 'Rajdhani', sans-serif !important;
        font-weight: 600 !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5) !important;
    }

    .range-tooltip:before {
        border-color: transparent !important;
    }

    /* Range rings legend styling */
    .range-legend {
        font-family: 'Rajdhani', sans-serif;
        margin-bottom: 10px !important;
    }

    .range-legend .bg-dark {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.5);
        transition: opacity 0.3s;
    }

    .range-legend:hover .bg-dark {
        opacity: 0.95;
    }

    /* Airport search results */
    .airport-results {
        position: absolute;
        z-index: 1000;
        width: 100%;
        max-height: 250px;
        overflow-y: auto;
    }

    .airport-results .list-group-item {
        border-radius: 0;
        border-left: none;
        border-right: none;
        transition: all 0.2s;
    }

    .airport-results .list-group-item:first-child {
        border-top: none;
    }

    .airport-results .list-group-item:last-child {
        border-bottom: none;
    }

    .airport-results .list-group-item:hover {
        background-color: rgba(240, 85, 69, 0.1) !important;
        border-left: 3px solid #F05545;
    }

    /* Add CSS for dark-theme popups */
    .dark-popup .leaflet-popup-content-wrapper {
        background-color: #1a202c;
        color: white;
        border-radius: 5px;
        box-shadow: 0 3px 14px rgba(0, 0, 0, 0.4);
    }

    .dark-popup .leaflet-popup-tip {
        background-color: #1a202c;
    }

    .leaflet-container {
        background-color: #1a202c;
        outline: 0;
    }

    /* Improve visibility of map controls on dark background */
    .leaflet-control-zoom a {
        background-color: #2d3748 !important;
        color: white !important;
        border-color: #4a5568 !important;
    }

    .leaflet-control-zoom a:hover {
        background-color: #4a5568 !important;
    }

    /* Make attribution more visible on dark background */
    .leaflet-control-attribution {
        background-color: rgba(0, 0, 0, 0.5) !important;
        color: rgba(255, 255, 255, 0.7) !important;
    }

    .leaflet-control-attribution a {
        color: rgba(255, 255, 255, 0.7) !important;
    }

    /* Aircraft card styling */
    .aircraft-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
        height: 100%;
    }

    .aircraft-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        border-color: #F05545 !important;
    }

    .aircraft-card .card-img-top {
        height: 200px;
        object-fit: cover;
    }

    .price-tag {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-weight: bold;
        border: 1px solid #F05545;
    }

    .favorite-btn {
        position: absolute;
        top: 10px;
        left: 10px;
        background-color: rgba(0, 0, 0, 0.7);
        border: none;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        transition: all 0.3s ease;
    }

    .favorite-btn:hover {
        background-color: rgba(240, 85, 69, 0.8);
    }

    .favorite-btn.active {
        background-color: #F05545;
        color: white;
    }

    /* Sort controls positioning */
    .sort-controls {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 10;
        background-color: rgba(0, 0, 0, 0.7);
        padding: 8px;
        border-radius: 4px;
        border: 1px solid rgba(255, 255, 255, 0.1);
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Sidebar with filters -->
        <div class="col-lg-3 p-3">
            <div class="card bg-dark mb-4">
                <div class="card-header bg-black">
                    <h5 class="mb-0">Filters</h5>
                </div>
                <div class="card-body">
                    <form id="filter-form" method="get">
                        <div class="mb-3">
                            <label for="category" class="form-label">Aircraft Type</label>
                            <select class="form-select bg-dark text-white border-secondary" id="category"
                                name="category">
                                <option value="">All Types</option>
                                <option value="jet" {% if criteria.category=='jet' %}selected{% endif %}>Jet</option>
                                <option value="turboprop" {% if criteria.category=='turboprop' %}selected{% endif %}>
                                    Turboprop</option>
                                <option value="piston" {% if criteria.category=='piston' %}selected{% endif %}>Piston
                                </option>
                                <option value="helicopter" {% if criteria.category=='helicopter' %}selected{% endif %}>
                                    Helicopter</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="budget" class="form-label">Max Budget</label>
                            <div class="input-group">
                                <span class="input-group-text bg-dark text-white border-secondary">$</span>
                                <input type="number" class="form-control bg-dark text-white border-secondary"
                                    id="budget" name="budget" value="{{ criteria.budget }}">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="min_range" class="form-label">Minimum Range (nm)</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="min_range"
                                name="min_range" value="{{ criteria.min_range }}">
                        </div>

                        <div class="mb-3">
                            <label for="min_speed" class="form-label">Minimum Speed (kts)</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="min_speed"
                                name="min_speed" value="{{ criteria.min_speed }}">
                        </div>

                        <div class="mb-3">
                            <label for="pax" class="form-label">Passenger Capacity</label>
                            <input type="number" class="form-control bg-dark text-white border-secondary" id="pax"
                                name="pax" value="{{ criteria.pax }}" min="1">
                        </div>

                        <div class="mb-3">
                            <label for="purpose" class="form-label">Primary Purpose</label>
                            <select class="form-select bg-dark text-white border-secondary" id="purpose" name="purpose">
                                <option value="business" {% if criteria.purpose=='business' %}selected{% endif %}>
                                    Business</option>
                                <option value="leisure" {% if criteria.purpose=='leisure' %}selected{% endif %}>Leisure
                                </option>
                            </select>
                        </div>

                        <div class="d-grid gap-2">
                            <button type="submit" class="btn btn-danger">Apply Filters</button>
                            <a href="{{ url_for('jet_marketplace') }}" class="btn btn-outline-secondary">Reset</a>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Range Filter Tool -->
            <div class="card bg-dark mb-4">
                <div class="card-header bg-black">
                    <h5 class="mb-0">Range Filter Tool</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="home-airport-search" class="form-label">Select Home Airport</label>
                        <div class="input-group">
                            <input type="text" id="home-airport-search"
                                class="form-control bg-dark text-white border-secondary"
                                placeholder="Search airports...">
                            <button class="btn btn-outline-danger" id="search-home-btn" type="button">
                                <i class="fas fa-search"></i>
                            </button>
                        </div>
                        <div id="home-airport-results" class="airport-results d-none">
                            <div class="list-group" id="home-airport-list">
                                <!-- Airport results will be added here -->
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Range Filter (nm)</label>
                        <div class="d-flex align-items-center gap-2">
                            <input type="range" class="form-range flex-grow-1" id="range-slider" min="0" max="7000"
                                step="50" value="{{ criteria.min_range }}">
                            <span id="range-value" class="badge bg-secondary">{{ criteria.min_range }}</span>
                            <button id="reset-range-btn" class="btn btn-sm btn-outline-secondary"
                                title="Reset to average trip length" type="button">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>
                    </div>
                    <p class="text-secondary small">
                        Adjust the slider to filter aircraft by range. Only aircraft with range â‰¥ <span
                            id="range-value-2">{{ criteria.min_range }}</span> nm will be shown.
                    </p>
                </div>
            </div>

            <!-- Trip Planner -->
            <div class="card bg-dark mb-4">
                <div class="card-header bg-black">
                    <h5 class="mb-0">Trip Planner</h5>
                </div>
                <div class="card-body">
                    <!-- Airport Search -->
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="from-airport" class="form-label">From Airport</label>
                            <div class="input-group">
                                <input type="text" id="from-airport"
                                    class="form-control bg-dark text-white border-secondary"
                                    placeholder="Search airports...">
                                <button class="btn btn-outline-danger" id="search-from-btn" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="from-airport-results" class="airport-results d-none">
                                <div id="from-airport-list" class="list-group"></div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="to-airport" class="form-label">To Airport</label>
                            <div class="input-group">
                                <input type="text" id="to-airport"
                                    class="form-control bg-dark text-white border-secondary"
                                    placeholder="Search airports...">
                                <button class="btn btn-outline-danger" id="search-to-btn" type="button">
                                    <i class="fas fa-search"></i>
                                </button>
                            </div>
                            <div id="to-airport-results" class="airport-results d-none">
                                <div id="to-airport-list" class="list-group"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Route Controls -->
                    <div class="d-grid">
                        <button id="add-route-btn" class="btn btn-danger">
                            <i class="fas fa-plus-circle me-1"></i> Add Route
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="col-lg-9 p-3">
            <!-- Page Title & Controls -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2>Jet Finder Marketplace</h2>
                <div class="d-flex align-items-center">
                    <label class="text-white me-2">Sort by:</label>
                    <select class="form-select form-select-sm bg-dark text-white border-secondary" id="sort-select">
                        <option value="recommended">Recommended</option>
                        <option value="price_low">Price: Low to High</option>
                        <option value="price_high">Price: High to Low</option>
                        <option value="newest">Newest Listings</option>
                        <option value="range">Highest Range</option>
                    </select>
                </div>
            </div>

            <!-- Interactive Map -->
            <div class="card bg-dark mb-4">
                <div class="card-header bg-black d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Interactive Map</h5>
                    <button id="toggle-map-btn" class="btn btn-sm btn-outline-light" type="button">
                        <i class="fas fa-chevron-up"></i>
                    </button>
                </div>
                <div class="card-body p-0" id="map-container">
                    <div id="map"></div>
                </div>
            </div>

            <!-- Aircraft Listings -->
            <div class="row" id="listings-container">
                {% if listings %}
                {% for listing in listings %}
                <div class="col-md-6 col-lg-4 mb-4">
                    <div class="card bg-dark border-secondary aircraft-card" data-range="{{ listing.range }}"
                        data-id="{{ listing.id }}">
                        <div class="position-relative">
                            <img src="{{ listing.image | default('/static/images/aircraft_placeholder.jpg') }}"
                                class="card-img-top" alt="{{ listing.manufacturer }} {{ listing.model }}">
                            <div class="price-tag">${{ '{:,}'.format(listing.price) }}</div>
                            <button class="favorite-btn" data-id="{{ listing.id }}" type="button">
                                <i class="far fa-heart"></i>
                            </button>
                        </div>
                        <div class="card-body">
                            <h5 class="card-title">{{ listing.year }} {{ listing.manufacturer }} {{ listing.model }}
                            </h5>
                            <div class="row text-secondary small mb-3">
                                <div class="col-6">
                                    <div><i class="fas fa-ruler-horizontal me-2"></i> {{ listing.range }} nm</div>
                                    <div><i class="fas fa-tachometer-alt me-2"></i> {{ listing.max_speed }} kts</div>
                                </div>
                                <div class="col-6">
                                    <div><i class="fas fa-users me-2"></i> {{ listing.seats }} seats</div>
                                    <div><i class="fas fa-clock me-2"></i> {{ listing.total_time }} hrs</div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-between align-items-center">
                                <button class="btn btn-sm btn-outline-light show-range-btn"
                                    data-range="{{ listing.range }}">
                                    <i class="fas fa-circle-notch me-1"></i> Show Range
                                </button>
                                <a href="{{ url_for('marketplace.listing_detail', listing_id=listing.id) }}"
                                    class="btn btn-sm btn-outline-danger">View Details</a>
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <div class="col-12">
                    <div class="alert alert-secondary">
                        No aircraft listings found matching your criteria. Try adjusting your filters.
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Pagination -->
            {% if total_pages > 1 %}
            <div class="d-flex justify-content-center mt-4">
                <nav aria-label="Page navigation">
                    <ul class="pagination">
                        <li class="page-item {{ 'disabled' if current_page == 1 else '' }}">
                            <a class="page-link bg-dark text-white border-secondary"
                                href="{{ url_for('jet_marketplace', page=current_page-1, **request.args) if current_page > 1 else '#' }}"
                                aria-label="Previous">
                                <span aria-hidden="true">&laquo;</span>
                            </a>
                        </li>
                        {% for page in range(1, total_pages + 1) %}
                        <li class="page-item {{ 'active' if page == current_page else '' }}">
                            <a class="page-link bg-{{ 'danger' if page == current_page else 'dark' }} text-white border-secondary"
                                href="{{ url_for('jet_marketplace', page=page, **request.args) }}">{{ page }}</a>
                        </li>
                        {% endfor %}
                        <li class="page-item {{ 'disabled' if current_page == total_pages else '' }}">
                            <a class="page-link bg-dark text-white border-secondary"
                                href="{{ url_for('jet_marketplace', page=current_page+1, **request.args) if current_page < total_pages else '#' }}"
                                aria-label="Next">
                                <span aria-hidden="true">&raquo;</span>
                            </a>
                        </li>
                    </ul>
                </nav>
            </div>
            {% endif %}
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!-- Load Leaflet map library -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>

<!-- Custom JS for jet marketplace -->
<script src="{{ url_for('static', filename='js/jet_marketplace.js') }}"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Connect range slider with display value
        const rangeSlider = document.getElementById('range-slider');
        const rangeValue = document.getElementById('range-value');
        const rangeValue2 = document.getElementById('range-value-2');
        const resetRangeBtn = document.getElementById('reset-range-btn');

        if (rangeSlider && rangeValue && rangeValue2) {
            rangeSlider.addEventListener('input', function () {
                const value = this.value;
                rangeValue.textContent = value;
                rangeValue2.textContent = value;
            });
        }

        if (resetRangeBtn) {
            resetRangeBtn.addEventListener('click', function () {
                rangeSlider.value = 500;
                rangeValue.textContent = '500';
                rangeValue2.textContent = '500';

                // Trigger the range slider input event to update the UI and map
                rangeSlider.dispatchEvent(new Event('input'));

                // If needed, update the form to apply the filter
                const minRangeInput = document.getElementById('min_range');
                if (minRangeInput) {
                    minRangeInput.value = 500;
                }
            });
        }

        // Toggle map visibility
        document.getElementById('toggle-map-btn').addEventListener('click', function () {
            const mapContainer = document.getElementById('map-container');
            const icon = this.querySelector('i');

            if (mapContainer.style.display === 'none') {
                mapContainer.style.display = 'block';
                icon.className = 'fas fa-chevron-up';

                // Trigger map resize when showing it
                if (window.map) {
                    setTimeout(() => {
                        window.map.invalidateSize();
                    }, 200);
                }
            } else {
                mapContainer.style.display = 'none';
                icon.className = 'fas fa-chevron-down';
            }
        });

        // Add "Show Range" functionality for aircraft cards
        document.querySelectorAll('.show-range-btn').forEach(btn => {
            btn.addEventListener('click', function () {
                const range = parseInt(this.dataset.range);
                const aircraftId = this.closest('.aircraft-card').dataset.id;

                // Call the function to show aircraft range on map
                if (window.showAircraftRange) {
                    window.showAircraftRange(range, aircraftId);
                }

                // Ensure map is visible
                const mapContainer = document.getElementById('map-container');
                if (mapContainer.style.display === 'none') {
                    document.getElementById('toggle-map-btn').click();
                }
            });
        });

        // Handle favorite toggling
        document.querySelectorAll('.favorite-btn').forEach(btn => {
            btn.addEventListener('click', function (e) {
                e.preventDefault();
                e.stopPropagation();
                const icon = this.querySelector('i');
                const isFavorite = icon.classList.contains('fas');
                const listingId = this.dataset.id;

                if (isFavorite) {
                    // Remove from favorites
                    icon.className = 'far fa-heart';
                    this.classList.remove('active');

                    fetch('{{ url_for("marketplace.remove_favorite") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ listing_id: listingId })
                    });
                } else {
                    // Add to favorites
                    icon.className = 'fas fa-heart';
                    this.classList.add('active');

                    fetch('{{ url_for("marketplace.add_favorite") }}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ listing_id: listingId })
                    });
                }
            });
        });
    });
</script>
{% endblock %}