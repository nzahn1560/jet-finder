<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Airport Dropdowns</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #1a1a1a;
            color: white;
        }

        .airport-results {
            position: absolute !important;
            top: 100% !important;
            left: 0 !important;
            right: 0 !important;
            z-index: 9999 !important;
            background: #212529 !important;
            border: 1px solid #495057 !important;
            border-top: none !important;
            border-radius: 0 0 8px 8px !important;
            max-height: 200px !important;
            overflow-y: auto !important;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3) !important;
        }

        .airport-results:not(.d-none) {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
        }

        .input-group,
        .form-group {
            position: relative !important;
        }
    </style>
</head>

<body>
    <div class="container mt-5">
        <h1>Airport Dropdown Debug</h1>

        <!-- Home Airport Test -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h3>Home Airport Search</h3>
                <div class="form-group mb-3">
                    <label for="home-airport-search" class="form-label">Select Home Airport</label>
                    <div class="input-group">
                        <input type="text" class="form-control bg-dark text-white border-secondary"
                            id="home-airport-search" placeholder="Type LAX, SFO, JFK...">
                        <button class="btn btn-outline-danger" type="button" id="search-home-btn">
                            Search
                        </button>
                    </div>
                    <div id="home-airport-results" class="airport-results d-none">
                        <div id="home-airport-list" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Trip Planning Tests -->
        <div class="row mb-4">
            <div class="col-md-6">
                <h3>From Airport</h3>
                <div class="form-group mb-3">
                    <label for="from-airport" class="form-label">From Airport</label>
                    <div class="input-group">
                        <input type="text" id="from-airport" class="form-control bg-dark text-white border-secondary"
                            placeholder="Search airports...">
                        <button class="btn btn-outline-secondary" type="button" id="search-from-btn">
                            Search
                        </button>
                    </div>
                    <div id="from-airport-results" class="airport-results d-none">
                        <div id="from-airport-list" class="list-group"></div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <h3>To Airport</h3>
                <div class="form-group mb-3">
                    <label for="to-airport" class="form-label">To Airport</label>
                    <div class="input-group">
                        <input type="text" id="to-airport" class="form-control bg-dark text-white border-secondary"
                            placeholder="Search airports...">
                        <button class="btn btn-outline-secondary" type="button" id="search-to-btn">
                            Search
                        </button>
                    </div>
                    <div id="to-airport-results" class="airport-results d-none">
                        <div id="to-airport-list" class="list-group"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Debug Log -->
        <div class="row">
            <div class="col-12">
                <h3>Debug Log</h3>
                <div id="debug-log"
                    style="background: #000; padding: 15px; height: 300px; overflow-y: auto; font-family: monospace;">
                </div>
            </div>
        </div>
    </div>

    <script>
        // Debug logging
        function debugLog(message) {
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const logEntry = `[${timestamp}] ${message}`;
            console.log(logEntry);

            const debugDiv = document.getElementById('debug-log');
            debugDiv.innerHTML += logEntry + '\n';
            debugDiv.scrollTop = debugDiv.scrollHeight;
        }

        // Test airport search function
        function searchAirports(query, resultsList, resultsContainer, type = 'test') {
            debugLog(`searchAirports called with query: "${query}", type: "${type}"`);
            debugLog(`resultsList exists: ${!!resultsList}, resultsContainer exists: ${!!resultsContainer}`);

            if (!query.trim()) {
                resultsContainer.classList.add('d-none');
                debugLog('Query empty, hiding results container');
                return;
            }

            // Show loading state
            resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Searching...</div>';
            resultsContainer.classList.remove('d-none');
            debugLog(`Showing results container, removed d-none class. Container classes: ${resultsContainer.className}`);

            // Fetch from actual API
            fetch(`/api/airports?q=${encodeURIComponent(query)}`)
                .then(response => {
                    debugLog(`API response status: ${response.status}`);
                    return response.json();
                })
                .then(airports => {
                    debugLog(`Received ${airports.length} airports from API`);
                    resultsList.innerHTML = '';

                    if (airports.length === 0) {
                        resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">No airports found</div>';
                        debugLog('No airports found');
                        return;
                    }

                    debugLog('Adding airports to dropdown...');
                    airports.forEach((airport, index) => {
                        const item = document.createElement('button');
                        item.type = 'button';
                        item.className = 'list-group-item list-group-item-action bg-dark text-white border-secondary';
                        item.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <strong class="me-2">${airport.iata}</strong>
                                    <span class="text-info">${airport.icao}</span>
                                </div>
                                <span class="badge bg-danger">${airport.size}</span>
                            </div>
                            <div class="text-truncate">${airport.name}</div>
                            <small class="text-secondary text-truncate d-block">${airport.city}, ${airport.country}</small>
                        `;

                        item.addEventListener('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            debugLog(`Airport selected for type ${type}: ${airport.iata}`);

                            // Update input field
                            const inputField = document.getElementById(type === 'home' ? 'home-airport-search' : `${type}-airport`);
                            if (inputField) {
                                inputField.value = `${airport.iata} - ${airport.city}`;
                                debugLog(`Updated input field value to: ${inputField.value}`);
                            }

                            // Hide dropdown
                            resultsContainer.classList.add('d-none');
                            debugLog(`Hiding dropdown, added d-none class. Container classes: ${resultsContainer.className}`);
                        });

                        resultsList.appendChild(item);
                        debugLog(`Added airport ${index + 1}: ${airport.iata}`);
                    });
                    debugLog('All airports added to dropdown');
                })
                .catch(error => {
                    debugLog(`Error fetching airports: ${error.message}`);
                    resultsList.innerHTML = '<div class="list-group-item bg-dark text-white">Error fetching airports</div>';
                });
        }

        // Setup event listeners when DOM is ready
        document.addEventListener('DOMContentLoaded', function () {
            debugLog('DOM Content Loaded - Setting up event listeners');

            // Home airport search
            const homeInput = document.getElementById('home-airport-search');
            const homeResults = document.getElementById('home-airport-results');
            const homeList = document.getElementById('home-airport-list');
            const homeBtn = document.getElementById('search-home-btn');

            debugLog(`Home elements found - Input: ${!!homeInput}, Results: ${!!homeResults}, List: ${!!homeList}, Button: ${!!homeBtn}`);

            if (homeInput) {
                homeInput.addEventListener('input', function () {
                    debugLog(`Home input triggered: "${this.value}"`);
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, homeList, homeResults, 'home');
                    } else {
                        homeResults.classList.add('d-none');
                        debugLog('Home query too short, hiding dropdown');
                    }
                });
            }

            if (homeBtn) {
                homeBtn.addEventListener('click', function () {
                    debugLog('Home search button clicked');
                    const query = homeInput.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, homeList, homeResults, 'home');
                    }
                });
            }

            // From airport search
            const fromInput = document.getElementById('from-airport');
            const fromResults = document.getElementById('from-airport-results');
            const fromList = document.getElementById('from-airport-list');
            const fromBtn = document.getElementById('search-from-btn');

            debugLog(`From elements found - Input: ${!!fromInput}, Results: ${!!fromResults}, List: ${!!fromList}, Button: ${!!fromBtn}`);

            if (fromInput) {
                fromInput.addEventListener('input', function () {
                    debugLog(`From input triggered: "${this.value}"`);
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, fromList, fromResults, 'from');
                    } else {
                        fromResults.classList.add('d-none');
                        debugLog('From query too short, hiding dropdown');
                    }
                });
            }

            if (fromBtn) {
                fromBtn.addEventListener('click', function () {
                    debugLog('From search button clicked');
                    const query = fromInput.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, fromList, fromResults, 'from');
                    }
                });
            }

            // To airport search
            const toInput = document.getElementById('to-airport');
            const toResults = document.getElementById('to-airport-results');
            const toList = document.getElementById('to-airport-list');
            const toBtn = document.getElementById('search-to-btn');

            debugLog(`To elements found - Input: ${!!toInput}, Results: ${!!toResults}, List: ${!!toList}, Button: ${!!toBtn}`);

            if (toInput) {
                toInput.addEventListener('input', function () {
                    debugLog(`To input triggered: "${this.value}"`);
                    const query = this.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, toList, toResults, 'to');
                    } else {
                        toResults.classList.add('d-none');
                        debugLog('To query too short, hiding dropdown');
                    }
                });
            }

            if (toBtn) {
                toBtn.addEventListener('click', function () {
                    debugLog('To search button clicked');
                    const query = toInput.value.trim();
                    if (query.length >= 2) {
                        searchAirports(query, toList, toResults, 'to');
                    }
                });
            }

            // Click outside to close dropdowns
            document.addEventListener('click', function (event) {
                if (homeResults && !homeInput.contains(event.target) && !homeResults.contains(event.target)) {
                    homeResults.classList.add('d-none');
                    debugLog('Clicked outside home dropdown, hiding');
                }

                if (fromResults && !fromInput.contains(event.target) && !fromResults.contains(event.target)) {
                    fromResults.classList.add('d-none');
                    debugLog('Clicked outside from dropdown, hiding');
                }

                if (toResults && !toInput.contains(event.target) && !toResults.contains(event.target)) {
                    toResults.classList.add('d-none');
                    debugLog('Clicked outside to dropdown, hiding');
                }
            });

            debugLog('All event listeners set up successfully');
        });
    </script>
</body>

</html>